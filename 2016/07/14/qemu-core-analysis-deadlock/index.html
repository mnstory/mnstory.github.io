<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="BUG,Qemu,GDB," />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.2" />






<meta name="description" content="main线程8003QEMU出CORE，死在pthread_mutex_lock里：12345678910111213Core was generated by `/usr/bin/kvm -id 3114792937754 -chardev socket,id=qmp,path=/var/run/qemu-server&apos;.Program terminated with signal SIGSEG">
<meta name="keywords" content="BUG,Qemu,GDB">
<meta property="og:type" content="article">
<meta property="og:title" content="QEMU CORE分析之死锁">
<meta property="og:url" content="http://mnstory.net/2016/07/14/qemu-core-analysis-deadlock/index.html">
<meta property="og:site_name" content="码农故事">
<meta property="og:description" content="main线程8003QEMU出CORE，死在pthread_mutex_lock里：12345678910111213Core was generated by `/usr/bin/kvm -id 3114792937754 -chardev socket,id=qmp,path=/var/run/qemu-server&apos;.Program terminated with signal SIGSEG">
<meta property="og:locale" content="zh-Hans">
<meta property="og:updated_time" content="2017-10-17T15:38:27.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="QEMU CORE分析之死锁">
<meta name="twitter:description" content="main线程8003QEMU出CORE，死在pthread_mutex_lock里：12345678910111213Core was generated by `/usr/bin/kvm -id 3114792937754 -chardev socket,id=qmp,path=/var/run/qemu-server&apos;.Program terminated with signal SIGSEG">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.2',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://mnstory.net/2016/07/14/qemu-core-analysis-deadlock/"/>





  <title>QEMU CORE分析之死锁 | 码农故事</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">码农故事</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <h1 class="site-subtitle" itemprop="description"></h1>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://mnstory.net/2016/07/14/qemu-core-analysis-deadlock/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="mnstory.net">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="码农故事">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">QEMU CORE分析之死锁</h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-07-14T23:00:00+08:00">
                2016-07-14
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          
            <span class="post-meta-divider">|</span>
            <span class="page-pv"><i class="fa fa-file-o"></i>
            <span class="busuanzi-value" id="busuanzi_value_page_pv" ></span>
            </span>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="main线程8003"><a href="#main线程8003" class="headerlink" title="main线程8003"></a>main线程8003</h1><p>QEMU出CORE，死在pthread_mutex_lock里：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">Core was generated by `/usr/bin/kvm -id 3114792937754 -chardev socket,id=qmp,path=/var/run/qemu-server'.</div><div class="line">Program terminated with signal SIGSEGV, Segmentation fault.</div><div class="line"><span class="meta">#</span>0  0x00007fe1ed7d8cec in __lll_lock_wait () from /lib/x86_64-linux-gnu/libpthread.so.0</div><div class="line">(gdb) bt</div><div class="line"><span class="meta">#</span>0  0x00007fe1ed7d8cec in __lll_lock_wait () from /lib/x86_64-linux-gnu/libpthread.so.0</div><div class="line"><span class="meta">#</span>1  0x00007fe1ed7d4339 in _L_lock_926 () from /lib/x86_64-linux-gnu/libpthread.so.0</div><div class="line"><span class="meta">#</span>2  0x00007fe1ed7d415b in pthread_mutex_lock () from /lib/x86_64-linux-gnu/libpthread.so.0</div><div class="line"><span class="meta">#</span>3  0x00007fe1f4b84739 in qemu_mutex_lock (mutex=mutex@entry=0x7fe1f5223940 &lt;qemu_global_mutex&gt;) at util/qemu-thread-posix.c:73</div><div class="line"><span class="meta">#</span>4  0x00007fe1f485d096 in qemu_mutex_lock_iothread () at /home/jenkins/workspace/Compile/HCI5.2_Compile/src/app/vtp-qemu-kvm/qemu-2.5.1/cpus.c:1235</div><div class="line"><span class="meta">#</span>5  0x00007fe1f4afb264 in os_host_main_loop_wait (timeout=15740693) at main-loop.c:279</div><div class="line"><span class="meta">#</span>6  main_loop_wait (nonblocking=&lt;optimized out&gt;) at main-loop.c:530</div><div class="line"><span class="meta">#</span>7  0x00007fe1f48290b0 in main_loop () at vl.c:2240</div><div class="line"><span class="meta">#</span>8  main (argc=&lt;optimized out&gt;, argv=&lt;optimized out&gt;, envp=&lt;optimized out&gt;) at vl.c:5167</div></pre></td></tr></table></figure></p>
<a id="more"></a>
<p>查看一下，是在等待qemu_global_mutex锁：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">(gdb) f 3</div><div class="line"><span class="meta">#</span>3  0x00007fe1f4b84739 in qemu_mutex_lock (mutex=mutex@entry=0x7fe1f5223940 &lt;qemu_global_mutex&gt;) at util/qemu-thread-posix.c:73</div><div class="line">73	util/qemu-thread-posix.c: No such file or directory.</div><div class="line">(gdb) p mutex</div><div class="line"><span class="meta">$</span>1 = (QemuMutex *) 0x7fe1f5223940 &lt;qemu_global_mutex&gt;</div><div class="line">(gdb) p *mutex</div><div class="line"><span class="meta">$</span>2 = &#123;lock = &#123;__data = &#123;__lock = 2, __count = 0, __owner = 8417, __nusers = 9, __kind = 0, __spins = 0, __list = &#123;__prev = 0x0, __next = 0x0&#125;&#125;, </div><div class="line">__size = "\002\000\000\000\000\000\000\000\341 \000\000\t", '\000' &lt;repeats 26 times&gt;, __align = 2&#125;&#125;</div></pre></td></tr></table></figure></p>
<p>通过__owner看出，qemu_global_mutex 已经被人加锁了，线程ID为8417。</p>
<h1 id="migrate线程8417"><a href="#migrate线程8417" class="headerlink" title="migrate线程8417"></a>migrate线程8417</h1><p>切换到线程8417：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">(gdb) t 22</div><div class="line">[Switching to thread 22 (Thread 0x7fddd17fa700 (LWP 8417))]</div><div class="line"><span class="meta">#</span>0  0x00007fe1ed7d62d4 in pthread_cond_wait@@GLIBC_2.3.2 () from /lib/x86_64-linux-gnu/libpthread.so.0</div><div class="line">(gdb) bt</div><div class="line"><span class="meta">#</span>0  0x00007fe1ed7d62d4 in pthread_cond_wait@@GLIBC_2.3.2 () from /lib/x86_64-linux-gnu/libpthread.so.0</div><div class="line"><span class="meta">#</span>1  0x00007fe1f4b84959 in qemu_cond_wait (cond=cond@entry=0x7fe1f6e0ce80, mutex=mutex@entry=0x7fe1f6e0ce50) at util/qemu-thread-posix.c:132</div><div class="line"><span class="meta">#</span>2  0x00007fe1f4b9642a in rfifolock_lock (r=r@entry=0x7fe1f6e0ce50) at util/rfifolock.c:59</div><div class="line"><span class="meta">#</span>3  0x00007fe1f4ae8f91 in aio_context_acquire (ctx=ctx@entry=0x7fe1f6e0cdf0) at async.c:371</div><div class="line"><span class="meta">#</span>4  0x00007fe1f4b42fdb in bdrv_drain_all () at block/io.c:299</div><div class="line"><span class="meta">#</span>5  0x00007fe1f485dd15 in do_vm_stop (state=RUN_STATE_FINISH_MIGRATE) at /home/jenkins/workspace/Compile/HCI5.2_Compile/src/app/vtp-qemu-kvm/qemu-2.5.1/cpus.c:737</div><div class="line"><span class="meta">#</span>6  vm_stop (state=state@entry=RUN_STATE_FINISH_MIGRATE) at /home/jenkins/workspace/Compile/HCI5.2_Compile/src/app/vtp-qemu-kvm/qemu-2.5.1/cpus.c:1416</div><div class="line"><span class="meta">#</span>7  0x00007fe1f485ddfc in vm_stop_force_state (state=state@entry=RUN_STATE_FINISH_MIGRATE) at /home/jenkins/workspace/Compile/HCI5.2_Compile/src/app/vtp-qemu-kvm/qemu-2.5.1/cpus.c:1424</div><div class="line"><span class="meta">#</span>8  0x00007fe1f4a94d43 in migration_completion (start_time=&lt;synthetic pointer&gt;, old_vm_running=&lt;synthetic pointer&gt;, current_active_state=4, s=0x7fe1f51a6200 &lt;current_migration&gt;)</div><div class="line">    at migration/migration.c:1614</div><div class="line"><span class="meta">#</span>9  migration_thread (opaque=0x7fe1f51a6200 &lt;current_migration&gt;) at migration/migration.c:1754</div><div class="line"><span class="meta">#</span>10 0x00007fe1ed7d1b50 in start_thread () from /lib/x86_64-linux-gnu/libpthread.so.0</div><div class="line"><span class="meta">#</span>11 0x00007fe1ed51ba7d in clone () from /lib/x86_64-linux-gnu/libc.so.6</div><div class="line"><span class="meta">#</span>12 0x0000000000000000 in ?? ()</div></pre></td></tr></table></figure></p>
<p>可以看到，migration线程是在迁移完成vm_stop时，等待rfifolock_lock：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">(gdb) f 2</div><div class="line">(gdb) p r</div><div class="line"><span class="meta">$</span>13 = (RFifoLock *) 0x7fe1f6e0ce50</div><div class="line">(gdb) p *r</div><div class="line"><span class="meta">$</span>14 = &#123;lock = &#123;lock = &#123;__data = &#123;__lock = 0, __count = 0, __owner = 0, __nusers = 1, __kind = 0, __spins = 0, __list = &#123;__prev = 0x0, __next = 0x0&#125;&#125;, </div><div class="line">      __size = '\000' &lt;repeats 12 times&gt;, "\001", '\000' &lt;repeats 26 times&gt;, __align = 0&#125;&#125;, head = 45679, tail = 45681, cond = &#123;cond = &#123;__data = &#123;__lock = 0, __futex = 85, </div><div class="line">        __total_seq = 43, __wakeup_seq = 42, __woken_seq = 42, __mutex = 0x7fe1f6e0ce50, __nwaiters = 2, __broadcast_seq = 42&#125;, </div><div class="line">      __size = "\000\000\000\000U\000\000\000+\000\000\000\000\000\000\000*\000\000\000\000\000\000\000*\000\000\000\000\000\000\000P\316\340\366\341\177\000\000\002\000\000\000*\000\000", </div><div class="line">      __align = 365072220160&#125;&#125;, owner_thread = &#123;thread = 140608218035968 = 0x7FE1E6E37700 = thread 2&#125;, nesting = 2, cb = 0x7fe1f4ae8c40 &lt;aio_rfifolock_cb&gt;, cb_opaque = 0x7fe1f6e0cdf0&#125;</div></pre></td></tr></table></figure></p>
<p>通过owner_thread可以看出，rfifolock_lock目前被线程 Thread 2 (Thread 0x7fe1e6e37700 (LWP 8240)) 持有。</p>
<h1 id="io线程8240"><a href="#io线程8240" class="headerlink" title="io线程8240"></a>io线程8240</h1><p>切换到线程8240：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">Thread 2 (Thread 0x7fe1e6e37700 (LWP 8240)):</div><div class="line"><span class="meta">#</span>0  0x00007fe1ed7d8cec in __lll_lock_wait () from /lib/x86_64-linux-gnu/libpthread.so.0</div><div class="line"><span class="meta">#</span>1  0x00007fe1ed7d4339 in _L_lock_926 () from /lib/x86_64-linux-gnu/libpthread.so.0</div><div class="line"><span class="meta">#</span>2  0x00007fe1ed7d415b in pthread_mutex_lock () from /lib/x86_64-linux-gnu/libpthread.so.0</div><div class="line"><span class="meta">#</span>3  0x00007fe1f4b84739 in qemu_mutex_lock (mutex=mutex@entry=0x7fe1f5223940 &lt;qemu_global_mutex&gt;) at util/qemu-thread-posix.c:73</div><div class="line"><span class="meta">#</span>4 0x00007fe1f485d096 in qemu_mutex_lock_iothread () at /home/jenkins/workspace/Compile/HCI5.2_Compile/src/app/vtp-qemu-kvm/qemu-2.5.1/cpus.c:1235</div><div class="line"><span class="meta">#</span>5 0x00007fe1f4830335 in prepare_mmio_access (mr=0x7fe1f7743800, mr=0x7fe1f7743800) at /home/jenkins/workspace/Compile/HCI5.2_Compile/src/app/vtp-qemu-kvm/qemu-2.5.1/exec.c:2500</div><div class="line"><span class="meta">#</span>6  0x00007fe1f4835407 in address_space_stl_internal (endian=DEVICE_LITTLE_ENDIAN, result=0x0, attrs=..., val=16481, addr=140608486299080, as=0x90)</div><div class="line">    at /home/jenkins/workspace/Compile/HCI5.2_Compile/src/app/vtp-qemu-kvm/qemu-2.5.1/exec.c:3300</div><div class="line"><span class="meta">#</span>7  address_space_stl_le (as=as@entry=0x7fe1f7e04510, addr=addr@entry=4276092928, val=val@entry=16481, attrs=..., result=result@entry=0x0)</div><div class="line">    at /home/jenkins/workspace/Compile/HCI5.2_Compile/src/app/vtp-qemu-kvm/qemu-2.5.1/exec.c:3349</div><div class="line"><span class="meta">#</span>8  0x00007fe1f4a35b13 in msi_send_message (dev=0x7fe1f7e04310, msg=...) at hw/pci/msi.c:298</div><div class="line"><span class="meta">#</span>9  0x00007fe1f4a3462c in msix_notify (dev=&lt;optimized out&gt;, vector=&lt;optimized out&gt;) at hw/pci/msix.c:450</div><div class="line"><span class="meta">#</span>10 0x00007fe1f48a94ae in virtio_scsi_complete_req (req=0x7fddc40008b0) at /home/jenkins/workspace/Compile/HCI5.2_Compile/src/app/vtp-qemu-kvm/qemu-2.5.1/hw/scsi/virtio-scsi.c:78</div><div class="line"><span class="meta">#</span>11 0x00007fe1f48a9643 in virtio_scsi_complete_cmd_req (req=0x7fddc40008b0) at /home/jenkins/workspace/Compile/HCI5.2_Compile/src/app/vtp-qemu-kvm/qemu-2.5.1/hw/scsi/virtio-scsi.c:438</div><div class="line"><span class="meta">#</span>12 virtio_scsi_command_complete (r=&lt;optimized out&gt;, status=0, resid=0) at /home/jenkins/workspace/Compile/HCI5.2_Compile/src/app/vtp-qemu-kvm/qemu-2.5.1/hw/scsi/virtio-scsi.c:465</div><div class="line"><span class="meta">#</span>13 0x00007fe1f4a4270c in scsi_req_complete (req=0x7fddc4031340, status=&lt;optimized out&gt;) at hw/scsi/scsi-bus.c:1734</div><div class="line"><span class="meta">#</span>14 0x00007fe1f4a3c663 in scsi_write_do_fua (r=0x7fddc4031340) at hw/scsi/scsi-disk.c:235</div><div class="line"><span class="meta">#</span>15 0x00007fe1f4957ef4 in dma_complete (ret=&lt;optimized out&gt;, dbs=0x7fddc4030990) at dma-helpers.c:113</div><div class="line"><span class="meta">#</span>16 dma_blk_cb (opaque=0x7fddc4030990, ret=&lt;optimized out&gt;) at dma-helpers.c:135</div><div class="line"><span class="meta">#</span>17 0x00007fe1f4b401fb in bdrv_co_complete (acb=0x7fddc4031d30) at block/io.c:2114</div><div class="line"><span class="meta">#</span>18 bdrv_co_complete (acb=0x7fddc4031d30) at block/io.c:2110</div><div class="line"><span class="meta">#</span>19 0x00007fe1f4b97b0a in coroutine_trampoline (i0=&lt;optimized out&gt;, i1=&lt;optimized out&gt;) at util/coroutine-ucontext.c:80</div><div class="line"><span class="meta">#</span>20 0x00007fe1ed484020 in ?? () from /lib/x86_64-linux-gnu/libc.so.6</div><div class="line"><span class="meta">#</span>21 0x00007fdddd7f7f80 in ?? ()</div><div class="line"><span class="meta">#</span>22 0x0000000000000000 in ?? ()</div></pre></td></tr></table></figure></p>
<p>这是一协程上下文，同样是在等待qemu_mutex_lock (mutex=mutex@entry=0x7fe1f5223940 <qemu_global_mutex>)，上面已经分析了，qemu_global_mutex 是被线程migrate线程8417持有的，而migrate线程8417要等待的rfifolock_lock被线程8240持有，相当于，8417和8240相互持有锁而相互等待对方的锁解锁，但是8240是协程上下文，其协程栈内并没有地方持有rfifolock_lock，那么加锁rfifolock_lock的代码在哪儿呢？</qemu_global_mutex></p>
<p>我们在切换入协程的时候，保存了原有栈的指针到caller_sp：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">(gdb) ptype current</div><div class="line">type = struct Coroutine &#123;</div><div class="line">    CoroutineEntry *entry;</div><div class="line">    <span class="keyword">void</span> *entry_arg;</div><div class="line">    Coroutine *caller;</div><div class="line">    <span class="keyword">void</span> *caller_sp;</div><div class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></div><div class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">Coroutine</span> *<span class="title">sle_next</span>;</span></div><div class="line">    &#125; pool_next;</div><div class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></div><div class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">Coroutine</span> *<span class="title">tqh_first</span>;</span></div><div class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">Coroutine</span> **<span class="title">tqh_last</span>;</span></div><div class="line">    &#125; co_queue_wakeup;</div><div class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></div><div class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">Coroutine</span> *<span class="title">tqe_next</span>;</span></div><div class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">Coroutine</span> **<span class="title">tqe_prev</span>;</span></div><div class="line">    &#125; co_queue_next;</div><div class="line">&#125; *</div></pre></td></tr></table></figure></p>
<p>这个caller_sp是在进入协程前赋值的原有栈的栈变量：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">qemu_coroutine_enter</span><span class="params">(Coroutine *co, <span class="keyword">void</span> *opaque)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    Coroutine *self = qemu_coroutine_self();</div><div class="line">    CoroutineAction ret;</div><div class="line"></div><div class="line">    trace_qemu_coroutine_enter(self, co, opaque);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (co-&gt;caller) &#123;</div><div class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Co-routine re-entered recursively\n"</span>);</div><div class="line">        <span class="built_in">abort</span>();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    co-&gt;caller = self;</div><div class="line">    co-&gt;entry_arg = opaque;</div><div class="line">    co-&gt;caller_sp = &amp;self;</div><div class="line">    ret = qemu_coroutine_switch(self, co, COROUTINE_ENTER);</div><div class="line">...</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">(gdb) p *current</div><div class="line">$13 = &#123;entry = 0x7fe1f4b42400 &lt;bdrv_co_do_rw&gt;, entry_arg = 0x0, caller = 0x7fe1e6e375e0, caller_sp = 0x7fe1e6e36970, pool_next = &#123;sle_next = 0x7fe1f8e79930&#125;, co_queue_wakeup = &#123;</div><div class="line">    tqh_first = 0x0, tqh_last = 0x7fe1f89fdd48&#125;, co_queue_next = &#123;tqe_next = 0x0, tqe_prev = 0x0&#125;&#125;</div></pre></td></tr></table></figure>
<p>直接dump切换前的栈内容：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line">(gdb) x /<span class="number">100</span>a current-&gt;caller_sp </div><div class="line"><span class="number">0x7fe1e6e36970</span>:	<span class="number">0x7fe1e6e375e0</span>	<span class="number">0x47f6cf4982fdcb00</span></div><div class="line"><span class="number">0x7fe1e6e36980</span>:	<span class="number">0x3</span>	<span class="number">0x7fddc4031de0</span></div><div class="line"><span class="number">0x7fe1e6e36990</span>:	<span class="number">0x7fddc4031db0</span>	<span class="number">0x7fe1f4b3afe9</span> &lt;qemu_laio_completion_bh+<span class="number">201</span>&gt; </div><div class="line"><span class="comment">//static void qemu_laio_completion_bh(void *opaque) -&gt; static void qemu_laio_process_completion(struct qemu_laio_state *s, struct qemu_laiocb *laiocb)</span></div><div class="line"><span class="number">0x7fe1e6e369a0</span>:	<span class="number">0x7fe100000000</span>	<span class="number">0x47f6cf4982fdcb00</span></div><div class="line"><span class="number">0x7fe1e6e369b0</span>:	<span class="number">0x7fe1e308cfe0</span>	<span class="number">0x47f6cf4982fdcb00</span></div><div class="line"><span class="number">0x7fe1e6e369c0</span>:	<span class="number">0x0</span>	<span class="number">0x0</span></div><div class="line"><span class="number">0x7fe1e6e369d0</span>:	<span class="number">0x3</span>	<span class="number">0x47f6cf4982fdcb00</span></div><div class="line"><span class="number">0x7fe1e6e369e0</span>:	<span class="number">0x7fe1e308cfe0</span>	<span class="number">0x7fe1f6e0c710</span></div><div class="line"><span class="number">0x7fe1e6e369f0</span>:	<span class="number">0x7fe1f6e0cdf0</span>	<span class="number">0x1</span></div><div class="line"><span class="number">0x7fe1e6e36a00</span>:	<span class="number">0x0</span>	<span class="number">0x7fe1f6e0cf18</span></div><div class="line"><span class="number">0x7fe1e6e36a10</span>:	<span class="number">0x3</span>	<span class="number">0x7fe1f4ae881d</span> &lt;aio_bh_poll+<span class="number">125</span>&gt; </div><div class="line"><span class="comment">//int aio_bh_poll(AioContext *ctx)</span></div><div class="line"><span class="number">0x7fe1e6e36a20</span>:	<span class="number">0x3</span>	<span class="number">0x47f6cf4982fdcb00</span></div><div class="line"><span class="number">0x7fe1e6e36a30</span>:	<span class="number">0x0</span>	<span class="number">0x0</span></div><div class="line"><span class="number">0x7fe1e6e36a40</span>:	<span class="number">0x7fe1f6e0cdf0</span>	<span class="number">0x0</span></div><div class="line"><span class="number">0x7fe1e6e36a50</span>:	<span class="number">0x0</span>	<span class="number">0x7fe1f4afd45b</span> &lt;aio_dispatch+<span class="number">43</span>&gt; </div><div class="line"><span class="comment">//bool aio_dispatch(AioContext *ctx)</span></div><div class="line"><span class="number">0x7fe1e6e36a60</span>:	<span class="number">0x0</span>	<span class="number">0x47f6cf4982fdcb00</span></div><div class="line"><span class="number">0x7fe1e6e36a70</span>:	<span class="number">0x0</span>	<span class="number">0x7fe1f6e0cdf0</span></div><div class="line"><span class="number">0x7fe1e6e36a80</span>:	<span class="number">0x0</span>	<span class="number">0x0</span></div><div class="line"><span class="number">0x7fe1e6e36a90</span>:	<span class="number">0x0</span>	<span class="number">0x7fe1f4afd6e3</span> &lt;aio_poll+<span class="number">371</span>&gt; </div><div class="line"><span class="comment">//bool aio_poll(AioContext *ctx, bool blocking)</span></div><div class="line"><span class="number">0x7fe1e6e36aa0</span>:	<span class="number">0x7fe1f6e0ce50</span>	<span class="number">0x29</span></div><div class="line"><span class="number">0x7fe1e6e36ab0</span>:	<span class="number">0x0</span>	<span class="number">0x7fe1f4b8501d</span> &lt;qemu_thread_get_self+<span class="number">29</span>&gt;</div><div class="line"><span class="number">0x7fe1e6e36ac0</span>:	<span class="number">0x0</span>	<span class="number">0x47f6cf4982fdcb00</span></div><div class="line"><span class="number">0x7fe1e6e36ad0</span>:	<span class="number">0x7fe1f6e0ce50</span>	<span class="number">0x7fe1f4b96437</span> &lt;rfifolock_lock+<span class="number">103</span>&gt; </div><div class="line"><span class="number">0x7fe1e6e36ae0</span>:	<span class="number">0x0</span>	<span class="number">0x47f6cf4982fdcb00</span></div><div class="line"><span class="number">0x7fe1e6e36af0</span>:	<span class="number">0x7fe1f6e0c920</span>	<span class="number">0x7fe1f6e0c958</span></div><div class="line"><span class="number">0x7fe1e6e36b00</span>:	<span class="number">0x7ffdd3b789f0</span>	<span class="number">0x7fe1e6e379c0</span></div><div class="line"><span class="number">0x7fe1e6e36b10</span>:	<span class="number">0x7fe1f467d040</span> &lt;_rtld_global&gt;	<span class="number">0x7fe1f494b402</span> &lt;iothread_run+<span class="number">114</span>&gt; </div><div class="line"><span class="comment">// static void *iothread_run(void *opaque)</span></div><div class="line"><span class="number">0x7fe1e6e36b20</span>:	<span class="number">0x0</span>	<span class="number">0x47f6cf4982fdcb00</span></div><div class="line"><span class="number">0x7fe1e6e36b30</span>:	<span class="number">0x0</span>	<span class="number">0x0</span></div><div class="line"><span class="number">0x7fe1e6e36b40</span>:	<span class="number">0x0</span>	<span class="number">0x7fe1ed7d1b50</span> &lt;start_thread+<span class="number">208</span>&gt;</div></pre></td></tr></table></figure></p>
<p>如果细心一些，可以看出0x7fe1f6e0ce50地址就是上面线程migrate线程8417等待的RFifoLock *地址，记不得这个地址也没关系，对照源码分析下栈:<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> *<span class="title">iothread_run</span><span class="params">(<span class="keyword">void</span> *opaque)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    IOThread *iothread = opaque;</div><div class="line">    ...</div><div class="line">    <span class="keyword">while</span> (!iothread-&gt;stopping) &#123;</div><div class="line">        aio_context_acquire(iothread-&gt;ctx);</div><div class="line">        blocking = <span class="literal">true</span>;</div><div class="line">        <span class="keyword">while</span> (!iothread-&gt;stopping &amp;&amp; aio_poll(iothread-&gt;ctx, blocking)) &#123;</div><div class="line">            blocking = <span class="literal">false</span>;</div><div class="line">        &#125;</div><div class="line">        aio_context_release(iothread-&gt;ctx);</div><div class="line">    &#125;</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>在调用aio_poll之前，有aio_context_acquire(iothread-&gt;ctx)的调用，这个调用展开就是：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">aio_context_acquire</span><span class="params">(AioContext *ctx)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    rfifolock_lock(&amp;ctx-&gt;lock);</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">rfifolock_lock</span><span class="params">(RFifoLock *r)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    qemu_mutex_lock(&amp;r-&gt;lock);</div><div class="line"></div><div class="line">    <span class="comment">/* Take a ticket */</span></div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> ticket = r-&gt;tail++;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (r-&gt;nesting &gt; <span class="number">0</span> &amp;&amp; qemu_thread_is_self(&amp;r-&gt;owner_thread)) &#123;</div><div class="line">        r-&gt;tail--; <span class="comment">/* put ticket back, we're nesting */</span></div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="keyword">while</span> (ticket != r-&gt;head) &#123;</div><div class="line">            <span class="comment">/* Invoke optional contention callback */</span></div><div class="line">            <span class="keyword">if</span> (r-&gt;cb) &#123;</div><div class="line">                r-&gt;cb(r-&gt;cb_opaque);</div><div class="line">            &#125;</div><div class="line">            qemu_cond_wait(&amp;r-&gt;cond, &amp;r-&gt;lock);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    qemu_thread_get_self(&amp;r-&gt;owner_thread);</div><div class="line">    r-&gt;nesting++;</div><div class="line">    qemu_mutex_unlock(&amp;r-&gt;lock);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>细看iothread_run与aio_poll之间的栈变量残留：：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">0x7fe1e6e36aa0:	0x7fe1f6e0ce50	0x29</div><div class="line">0x7fe1e6e36ab0:	0x0	0x7fe1f4b8501d &lt;qemu_thread_get_self+29&gt;</div><div class="line">0x7fe1e6e36ac0:	0x0	0x47f6cf4982fdcb00</div><div class="line">0x7fe1e6e36ad0:	0x7fe1f6e0ce50	0x7fe1f4b96437 &lt;rfifolock_lock+103&gt; </div><div class="line">0x7fe1e6e36ae0:	0x0	0x47f6cf4982fdcb00</div><div class="line">0x7fe1e6e36af0:	0x7fe1f6e0c920	0x7fe1f6e0c958</div><div class="line">0x7fe1e6e36b00:	0x7ffdd3b789f0	0x7fe1e6e379c0</div></pre></td></tr></table></figure></p>
<p>其中qemu_thread_get_self和rfifolock_lock，都可以和源码重叠，表示，栈上曾经跑过rfifolock_lock操作。</p>
<p>现在的问题就是，这里lock的参数，是否就是线程migrate线程8417等待的RFifoLock？<br>如果你不记得地址0x7fe1f6e0ce50，也可以一个一个地址dump出来看，dump每个指针指向的结构，通过地址查找蛛丝马迹，例如0x7fe1f6e0ce50：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">(gdb) x /16g 0x7fe1f6e0ce50</div><div class="line">0x7fe1f6e0ce50:	0x0	0x100000000</div><div class="line">0x7fe1f6e0ce60:	0x0	0x0</div><div class="line">0x7fe1f6e0ce70:	0x0	0xb2710000b26f</div><div class="line">0x7fe1f6e0ce80:	0x5500000000	0x2b</div><div class="line">0x7fe1f6e0ce90:	0x2a	0x2a</div><div class="line">0x7fe1f6e0cea0:	0x7fe1f6e0ce50	0x2a00000002</div><div class="line">0x7fe1f6e0ceb0:	0x7fe1e6e37700(线程8240的地址)	0x2  </div><div class="line">0x7fe1f6e0cec0:	0x7fe1f4ae8c40 &lt;aio_rfifolock_cb&gt;	0x7fe1f6e0cdf0</div></pre></td></tr></table></figure></p>
<p>这里的突破点是aio_rfifolock_cb，全局搜索代码发现，只有一个地方会操作aio_rfifolock_cb地址：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">rfifolock_init(&amp;ctx-&gt;lock, aio_rfifolock_cb, ctx);</div><div class="line">void rfifolock_init(RFifoLock *r, void (*cb)(void *), void *opaque)</div><div class="line">&#123;</div><div class="line">    qemu_mutex_init(&amp;r-&gt;lock);</div><div class="line">    r-&gt;head = <span class="number">0</span>;</div><div class="line">    r-&gt;tail = <span class="number">0</span>;</div><div class="line">    qemu_cond_init(&amp;r-&gt;cond);</div><div class="line">    r-&gt;nesting = <span class="number">0</span>;</div><div class="line">    r-&gt;cb = cb;</div><div class="line">    r-&gt;cb_opaque = opaque;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>很明显，aio_rfifolock_cb是当成cb指针赋值给了RFifoLock结构，<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></div><div class="line">    QemuMutex lock;             <span class="comment">/* protects all fields */</span></div><div class="line"></div><div class="line">    <span class="comment">/* FIFO order */</span></div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> head;          <span class="comment">/* active ticket number */</span></div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> tail;          <span class="comment">/* waiting ticket number */</span></div><div class="line">    QemuCond cond;              <span class="comment">/* used to wait for our ticket number */</span></div><div class="line"></div><div class="line">    <span class="comment">/* Nesting */</span></div><div class="line">    QemuThread owner_thread;    <span class="comment">/* thread that currently has ownership */</span></div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> nesting;       <span class="comment">/* amount of nesting levels */</span></div><div class="line"></div><div class="line">    <span class="comment">/* Contention callback */</span></div><div class="line">    <span class="keyword">void</span> (*cb)(<span class="keyword">void</span> *);         <span class="comment">/* called when thread must wait, with -&gt;lock</span></div><div class="line"><span class="comment">                                 * held so it may not recursively lock/unlock</span></div><div class="line"><span class="comment">                                 */</span></div><div class="line">    <span class="keyword">void</span> *cb_opaque;</div><div class="line">&#125; RFifoLock;</div></pre></td></tr></table></figure></p>
<p>对照一下，上面一个值nesting=0x2，owner_thread里首地址等于0x7fe1e6e37700正好是线程8240的地址，推测这个0x7fe1f6e0ce50很有可能是RFifoLock指针：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">(gdb) p *(RFifoLock*)0x7fe1f6e0ce50</div><div class="line"><span class="meta">$</span>23 = &#123;lock = &#123;lock = &#123;__data = &#123;__lock = 0, __count = 0, __owner = 0, __nusers = 1, __kind = 0, __spins = 0, __list = &#123;__prev = 0x0, __next = 0x0&#125;&#125;, </div><div class="line">      __size = '\000' &lt;repeats 12 times&gt;, "\001", '\000' &lt;repeats 26 times&gt;, __align = 0&#125;&#125;, head = 45679, tail = 45681, cond = &#123;cond = &#123;__data = &#123;__lock = 0, __futex = 85, </div><div class="line">        __total_seq = 43, __wakeup_seq = 42, __woken_seq = 42, __mutex = 0x7fe1f6e0ce50, __nwaiters = 2, __broadcast_seq = 42&#125;, </div><div class="line">      __size = "\000\000\000\000U\000\000\000+\000\000\000\000\000\000\000*\000\000\000\000\000\000\000*\000\000\000\000\000\000\000P\316\340\366\341\177\000\000\002\000\000\000*\000\000", </div><div class="line">      __align = 365072220160&#125;&#125;, owner_thread = &#123;thread = 140608218035968&#125;, nesting = 2, cb = 0x7fe1f4ae8c40 &lt;aio_rfifolock_cb&gt;, cb_opaque = 0x7fe1f6e0cdf0&#125;</div></pre></td></tr></table></figure></p>
<p>这下总该眼熟了吧，我们上面分析过一次，通过owner_thread分析谁持有锁，两个内容一模一样，再看本来就是migrate线程8417等待的RFifoLock地址。<br>以上，证明 RFifoLock 被io线程8240持有，然后8240调度进入协程，而协程里需要等待被migrate线程8417持有的qemu_global_mutex锁。</p>
<h1 id="分析migrate线程源码"><a href="#分析migrate线程源码" class="headerlink" title="分析migrate线程源码"></a>分析migrate线程源码</h1><p>再回过头，我们结合源码分析一下migrate线程8417是如何持有qemu_global_mutex锁的：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">(gdb) bt</div><div class="line"><span class="meta">#</span>0  0x00007fe1ed7d62d4 in pthread_cond_wait@@GLIBC_2.3.2 () from /lib/x86_64-linux-gnu/libpthread.so.0</div><div class="line"><span class="meta">#</span>1  0x00007fe1f4b84959 in qemu_cond_wait (cond=cond@entry=0x7fe1f6e0ce80, mutex=mutex@entry=0x7fe1f6e0ce50) at util/qemu-thread-posix.c:132</div><div class="line"><span class="meta">#</span>2  0x00007fe1f4b9642a in rfifolock_lock (r=r@entry=0x7fe1f6e0ce50) at util/rfifolock.c:59</div><div class="line"><span class="meta">#</span>3  0x00007fe1f4ae8f91 in aio_context_acquire (ctx=ctx@entry=0x7fe1f6e0cdf0) at async.c:371</div><div class="line"><span class="meta">#</span>4  0x00007fe1f4b42fdb in bdrv_drain_all () at block/io.c:299</div><div class="line"><span class="meta">#</span>5  0x00007fe1f485dd15 in do_vm_stop (state=RUN_STATE_FINISH_MIGRATE) at /home/jenkins/workspace/Compile/HCI5.2_Compile/src/app/vtp-qemu-kvm/qemu-2.5.1/cpus.c:737</div><div class="line"><span class="meta">#</span>6  vm_stop (state=state@entry=RUN_STATE_FINISH_MIGRATE) at /home/jenkins/workspace/Compile/HCI5.2_Compile/src/app/vtp-qemu-kvm/qemu-2.5.1/cpus.c:1416</div><div class="line"><span class="meta">#</span>7  0x00007fe1f485ddfc in vm_stop_force_state (state=state@entry=RUN_STATE_FINISH_MIGRATE) at /home/jenkins/workspace/Compile/HCI5.2_Compile/src/app/vtp-qemu-kvm/qemu-2.5.1/cpus.c:1424</div><div class="line"><span class="meta">#</span>8  0x00007fe1f4a94d43 in migration_completion (start_time=&lt;synthetic pointer&gt;, old_vm_running=&lt;synthetic pointer&gt;, current_active_state=4, s=0x7fe1f51a6200 &lt;current_migration&gt;)</div><div class="line">    at migration/migration.c:1614</div><div class="line"><span class="meta">#</span>9  migration_thread (opaque=0x7fe1f51a6200 &lt;current_migration&gt;) at migration/migration.c:1754</div><div class="line"><span class="meta">#</span>10 0x00007fe1ed7d1b50 in start_thread () from /lib/x86_64-linux-gnu/libpthread.so.0</div><div class="line"><span class="meta">#</span>11 0x00007fe1ed51ba7d in clone () from /lib/x86_64-linux-gnu/libc.so.6</div><div class="line"><span class="meta">#</span>12 0x0000000000000000 in ?? ()</div><div class="line">(gdb) f 8</div><div class="line"><span class="meta">#</span>8  0x00007fe1f4a94d43 in migration_completion (start_time=&lt;synthetic pointer&gt;, old_vm_running=&lt;synthetic pointer&gt;, current_active_state=4, s=0x7fe1f51a6200 &lt;current_migration&gt;)</div><div class="line">    at migration/migration.c:1614</div><div class="line">1614	migration/migration.c: No such file or directory.</div><div class="line">(gdb) p s</div><div class="line"><span class="meta">$</span>1 = (MigrationState *) 0x7fe1f51a6200 &lt;current_migration&gt;</div><div class="line">(gdb) p *s</div><div class="line"><span class="meta">$</span>2 = &#123;bandwidth_limit = 8589934592, bytes_xfer = 0, xfer_limit = 0, thread = &#123;thread = 140590679303936&#125;, cleanup_bh = 0x7fe1f866a750, file = 0x7fe1fb5c2030, parameters = &#123;1, 8, 2, 20, 10&#125;, </div><div class="line">  state = 4, params = &#123;blk = false, shared = false&#125;, rp_state = &#123;from_dst_file = 0x0, rp_thread = &#123;thread = 0&#125;, error = false&#125;, mbps = 943.80247272727274, total_time = 351512593, </div><div class="line">  downtime = 0, expected_downtime = 59, dirty_pages_rate = 1713, dirty_bytes_rate = 7016448, enabled_capabilities = &#123;true, false, true, true, true, false, false&#125;, </div><div class="line">  xbzrle_cache_size = 1073741824, setup_time = 89, dirty_sync_count = 4, start_postcopy = false, migration_thread_running = true, src_page_req_mutex = &#123;lock = &#123;__data = &#123;__lock = 0, </div><div class="line">        __count = 0, __owner = 0, __nusers = 0, __kind = 0, __spins = 0, __list = &#123;__prev = 0x0, __next = 0x0&#125;&#125;, __size = '\000' &lt;repeats 39 times&gt;, __align = 0&#125;&#125;, src_page_requests = &#123;</div><div class="line">sqh_first = 0x0, sqh_last = 0x7fe1f51a62e8 &lt;current_migration+232&gt;&#125;, last_req_rb = 0x0&#125;</div></pre></td></tr></table></figure></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">./qapi-types.h:<span class="number">816</span>:    MIGRATION_STATUS_ACTIVE = <span class="number">4</span>,</div><div class="line"><span class="keyword">static</span> <span class="keyword">void</span> migration_completion(MigrationState *s, <span class="keyword">int</span> current_active_state,</div><div class="line">                                 <span class="keyword">bool</span> *old_vm_running,</div><div class="line">                                 <span class="keyword">int64_t</span> *start_time)</div><div class="line">&#123;</div><div class="line">    <span class="keyword">int</span> ret;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (s-&gt;state == MIGRATION_STATUS_ACTIVE) &#123;</div><div class="line">        qemu_mutex_lock_iothread(); <span class="comment">//这里持有锁</span></div><div class="line">        *start_time = qemu_clock_get_ms(QEMU_CLOCK_REALTIME);</div><div class="line">        qemu_system_wakeup_request(QEMU_WAKEUP_REASON_OTHER);</div><div class="line">        *old_vm_running = runstate_is_running();</div><div class="line">        ret = global_state_store();</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (!ret) &#123;</div><div class="line">            ret = vm_stop_force_state(RUN_STATE_FINISH_MIGRATE); <span class="comment">//代码在这里vm_stop_force_state</span></div><div class="line">            <span class="keyword">if</span> (ret &gt;= <span class="number">0</span>) &#123;</div><div class="line">                qemu_file_set_rate_limit(s-&gt;file, INT64_MAX);</div><div class="line">                qemu_savevm_state_complete_precopy(s-&gt;file, <span class="literal">false</span>);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        qemu_mutex_unlock_iothread();</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</div><div class="line">            <span class="keyword">goto</span> fail;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>s-&gt;state = 4，结合代码，可以看到，在进入vm_stop_force_state前，有qemu_mutex_lock_iothread调用，此函数用于加锁了qemu_global_mutex。</p>
<h1 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h1><p>从堆栈上都找到证据，从代码上找到理论支撑，那这个死锁就可以明确下来。<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">(gdb) info threads </div><div class="line">  Id   Target Id         Frame </div><div class="line">  22   Thread 0x7fddd17fa700 (LWP 8417) 0x00007fe1ed7d62d4 in pthread_cond_wait@@GLIBC_2.3.2 () from /lib/x86_64-linux-gnu/libpthread.so.0</div><div class="line">  21   Thread 0x7fddd1ffb700 (LWP 8409) 0x00007fe1ed7d62d4 in pthread_cond_wait@@GLIBC_2.3.2 () from /lib/x86_64-linux-gnu/libpthread.so.0</div><div class="line">  20   Thread 0x7fddd2ffd700 (LWP 8397) 0x00007fe1ed7d62d4 in pthread_cond_wait@@GLIBC_2.3.2 () from /lib/x86_64-linux-gnu/libpthread.so.0</div><div class="line">  19   Thread 0x7fddd27fc700 (LWP 8401) 0x00007fe1ed7d62d4 in pthread_cond_wait@@GLIBC_2.3.2 () from /lib/x86_64-linux-gnu/libpthread.so.0</div><div class="line">  18   Thread 0x7fddd37fe700 (LWP 8385) 0x00007fe1ed7d62d4 in pthread_cond_wait@@GLIBC_2.3.2 () from /lib/x86_64-linux-gnu/libpthread.so.0</div><div class="line">  17   Thread 0x7fddd8ffa700 (LWP 8378) 0x00007fe1ed7d62d4 in pthread_cond_wait@@GLIBC_2.3.2 () from /lib/x86_64-linux-gnu/libpthread.so.0</div><div class="line">  16   Thread 0x7fddd3fff700 (LWP 8383) 0x00007fe1ed7d62d4 in pthread_cond_wait@@GLIBC_2.3.2 () from /lib/x86_64-linux-gnu/libpthread.so.0</div><div class="line">  15   Thread 0x7fddda7fd700 (LWP 8360) 0x00007fe1ed7d62d4 in pthread_cond_wait@@GLIBC_2.3.2 () from /lib/x86_64-linux-gnu/libpthread.so.0</div><div class="line">  14   Thread 0x7fddd97fb700 (LWP 8373) 0x00007fe1ed7d62d4 in pthread_cond_wait@@GLIBC_2.3.2 () from /lib/x86_64-linux-gnu/libpthread.so.0</div><div class="line">  13   Thread 0x7fdddc3ff700 (LWP 8394) 0x00007fe1ed7d62d4 in pthread_cond_wait@@GLIBC_2.3.2 () from /lib/x86_64-linux-gnu/libpthread.so.0</div><div class="line">  12   Thread 0x7fdddbbfe700 (LWP 8395) 0x00007fe1ed510e33 in poll () from /lib/x86_64-linux-gnu/libc.so.6</div><div class="line">  11   Thread 0x7fddddffa700 (LWP 8324) 0x00007fe1ed7d62d4 in pthread_cond_wait@@GLIBC_2.3.2 () from /lib/x86_64-linux-gnu/libpthread.so.0</div><div class="line">  10   Thread 0x7fdddd7f9700 (LWP 8325) 0x00007fe1ed7d62d4 in pthread_cond_wait@@GLIBC_2.3.2 () from /lib/x86_64-linux-gnu/libpthread.so.0</div><div class="line">  9    Thread 0x7fddde7fb700 (LWP 8323) 0x00007fe1ed7d62d4 in pthread_cond_wait@@GLIBC_2.3.2 () from /lib/x86_64-linux-gnu/libpthread.so.0</div><div class="line">  8    Thread 0x7fdddeffc700 (LWP 8322) 0x00007fe1ed7d62d4 in pthread_cond_wait@@GLIBC_2.3.2 () from /lib/x86_64-linux-gnu/libpthread.so.0</div><div class="line">  7    Thread 0x7fdddf7fd700 (LWP 8321) 0x00007fe1ed7d62d4 in pthread_cond_wait@@GLIBC_2.3.2 () from /lib/x86_64-linux-gnu/libpthread.so.0</div><div class="line">  6    Thread 0x7fdddfffe700 (LWP 8320) 0x00007fe1ed7d62d4 in pthread_cond_wait@@GLIBC_2.3.2 () from /lib/x86_64-linux-gnu/libpthread.so.0</div><div class="line">  5    Thread 0x7fe1e5433700 (LWP 8318) 0x00007fe1ed7d62d4 in pthread_cond_wait@@GLIBC_2.3.2 () from /lib/x86_64-linux-gnu/libpthread.so.0</div><div class="line">  4    Thread 0x7fe1e4c32700 (LWP 8319) 0x00007fe1ed7d62d4 in pthread_cond_wait@@GLIBC_2.3.2 () from /lib/x86_64-linux-gnu/libpthread.so.0</div><div class="line">  3    Thread 0x7fe1e7638700 (LWP 8005) 0x00007fe1ed5182f9 in syscall () from /lib/x86_64-linux-gnu/libc.so.6</div><div class="line">  2    Thread 0x7fe1e6e37700 (LWP 8240) 0x00007fe1ed7d8cec in __lll_lock_wait () from /lib/x86_64-linux-gnu/libpthread.so.0</div><div class="line">* 1    Thread 0x7fe1f457caa0 (LWP 8003) 0x00007fe1ed7d8cec in __lll_lock_wait () from /lib/x86_64-linux-gnu/libpthread.so.0</div></pre></td></tr></table></figure></p>
<ul>
<li>线程22为migrate线程，持有qemu_global_mutex但是需要获取RFifoLock被线程2持有；</li>
<li>线程2为io线程切换后的协程栈，原io线程持有RFifoLock，但协程需要等待被线程22持有的qemu_global_mutex。</li>
</ul>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/BUG/" rel="tag"># BUG</a>
          
            <a href="/tags/Qemu/" rel="tag"># Qemu</a>
          
            <a href="/tags/GDB/" rel="tag"># GDB</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2016/07/26/simple-perl-unittest-lib/" rel="prev" title="PERL单元测试简易框架">
                PERL单元测试简易框架 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          
            <p class="site-author-name" itemprop="name">mnstory.net</p>
            <p class="site-description motion-element" itemprop="description"></p>
        </div>

        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
            
              <a href="/archives/">
            
                <span class="site-state-item-count">28</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">51</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#main线程8003"><span class="nav-number">1.</span> <span class="nav-text">main线程8003</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#migrate线程8417"><span class="nav-number">2.</span> <span class="nav-text">migrate线程8417</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#io线程8240"><span class="nav-number">3.</span> <span class="nav-text">io线程8240</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#分析migrate线程源码"><span class="nav-number">4.</span> <span class="nav-text">分析migrate线程源码</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#结论"><span class="nav-number">5.</span> <span class="nav-text">结论</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">mnstory.net</span>

  
</div>



        
<div class="busuanzi-count">
  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv">
      <i class="fa fa-user"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      
    </span>
  

  
    <span class="site-pv">
      <i class="fa fa-eye"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      
    </span>
  
</div>








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.2"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.2"></script>



  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.2"></script>


  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.2"></script>



  


  




	





  





  








  




  





  

  

  

  

  

  


  <!-- 背景动画 -->
  <script type="text/javascript" src="/js/src/particle.js"></script>

</body>
</html>
