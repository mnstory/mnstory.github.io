<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Shell,缺陷预防,Perl,Node.js,CodeReview,工具,代码检査," />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.2" />






<meta name="description" content="perlcritic是一款PERL的静态代码检测工具，官网为： http://www.perlcritic.org 源码下载： https://github.com/Perl-Critic/Perl-Critic 可以参考 http://search.cpan.org/dist/Perl-Critic/ 使用，可以使用CPAN安装：12perl -MCPAN -e shell&amp;gt; instal">
<meta name="keywords" content="Shell,缺陷预防,Perl,Node.js,CodeReview,工具,代码检査">
<meta property="og:type" content="article">
<meta property="og:title" content="代码上库前的自动review实现">
<meta property="og:url" content="http://mnstory.net/2016/09/12/auto-codereview-machine/index.html">
<meta property="og:site_name" content="码农故事">
<meta property="og:description" content="perlcritic是一款PERL的静态代码检测工具，官网为： http://www.perlcritic.org 源码下载： https://github.com/Perl-Critic/Perl-Critic 可以参考 http://search.cpan.org/dist/Perl-Critic/ 使用，可以使用CPAN安装：12perl -MCPAN -e shell&amp;gt; instal">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://mnstory.net/2016/09/12/auto-codereview-machine/1.own-check.png">
<meta property="og:image" content="http://mnstory.net/2016/09/12/auto-codereview-machine/2.all-check.png">
<meta property="og:image" content="http://mnstory.net/2016/09/12/auto-codereview-machine/3.rbjob-console.png">
<meta property="og:image" content="http://mnstory.net/2016/09/12/auto-codereview-machine/4.comments-list.png">
<meta property="og:image" content="http://mnstory.net/2016/09/12/auto-codereview-machine/5.comment-detail.png">
<meta property="og:image" content="http://mnstory.net/2016/09/12/auto-codereview-machine/6.comments-mail.png">
<meta property="og:image" content="http://mnstory.net/2016/09/12/auto-codereview-machine/7.submit-error.png">
<meta property="og:updated_time" content="2017-10-17T15:22:23.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="代码上库前的自动review实现">
<meta name="twitter:description" content="perlcritic是一款PERL的静态代码检测工具，官网为： http://www.perlcritic.org 源码下载： https://github.com/Perl-Critic/Perl-Critic 可以参考 http://search.cpan.org/dist/Perl-Critic/ 使用，可以使用CPAN安装：12perl -MCPAN -e shell&amp;gt; instal">
<meta name="twitter:image" content="http://mnstory.net/2016/09/12/auto-codereview-machine/1.own-check.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.2',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://mnstory.net/2016/09/12/auto-codereview-machine/"/>





  <title>代码上库前的自动review实现 | 码农故事</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">码农故事</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <h1 class="site-subtitle" itemprop="description"></h1>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://mnstory.net/2016/09/12/auto-codereview-machine/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="mnstory.net">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="码农故事">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">代码上库前的自动review实现</h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-09-12T23:00:00+08:00">
                2016-09-12
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          
            <span class="post-meta-divider">|</span>
            <span class="page-pv"><i class="fa fa-file-o"></i>
            <span class="busuanzi-value" id="busuanzi_value_page_pv" ></span>
            </span>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>perlcritic是一款PERL的静态代码检测工具，官网为： <a href="http://www.perlcritic.org" target="_blank" rel="external">http://www.perlcritic.org</a> 源码下载： <a href="https://github.com/Perl-Critic/Perl-Critic" target="_blank" rel="external">https://github.com/Perl-Critic/Perl-Critic</a> 可以参考 <a href="http://search.cpan.org/dist/Perl-Critic/" target="_blank" rel="external">http://search.cpan.org/dist/Perl-Critic/</a> 使用，可以使用CPAN安装：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">perl -MCPAN -e shell</div><div class="line"><span class="meta">&gt;</span> install Perl::Critic</div></pre></td></tr></table></figure></p>
<p>本日志自动扫描工具建立在Critic基础上，为我们的日志检测规则写了一插件，名为RequireLogStatment，安装文件覆盖 /usr/local/share/perl/5.14.2/Perl/Critic/Policy/CodeLayout/RequireLogStatment.pm 即可使用。<br><a id="more"></a></p>
<h1 id="检测规则"><a href="#检测规则" class="headerlink" title="检测规则"></a>检测规则</h1><p>针对部门使用大量PERL代码做日志规范，当前主要检查该打日志的地方未打日志的行为，该打日志的检查点为:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">EXITWORD：return, exit, _exit, die</div></pre></td></tr></table></figure></p>
<p>打日志的函数为：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">LOGWORD：ldie lemerg lalert lcrit lerror lwarn lnotice linfo ldebug dbg1 dbg2 dbg3 dbgv</div></pre></td></tr></table></figure></p>
<p>不是所有EXITWORD前都要打日志，且日志级别不一定是lerror，例如一个函数运行最后一条return语句作为合法出口不要求打日志，为了避免日志过多，建议大家按照“先处理错误，最后处理正确原则”书写代码，例如：<br><figure class="highlight perl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">sub</span> <span class="title">isUserAllowed</span> </span>&#123;</div><div class="line">    <span class="keyword">my</span> ($name, $age) = @_;</div><div class="line">    <span class="keyword">if</span>(!$name) &#123;</div><div class="line">        lerror(<span class="string">"Invalid param "</span>.($name?$name:<span class="string">'undef'</span>)); <span class="comment">#错误处理1</span></div><div class="line">        <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">    &#125; </div><div class="line">    <span class="keyword">if</span>($age &lt; <span class="number">18</span>) &#123;</div><div class="line">        lerror(<span class="string">"Adults Only"</span>); <span class="comment">#错误处理2</span></div><div class="line">        <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">#正确情况</span></div><div class="line">    <span class="keyword">print</span> $name;</div><div class="line">    <span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>如果某些语句真不需要日志，可以添加annotation，规则是在语句前一条注释处加：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@logcheck</span> no</div></pre></td></tr></table></figure></p>
<p>例如：<br><figure class="highlight perl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">foreach</span> <span class="keyword">my</span> $net (@$vm_nets) &#123;</div><div class="line">    <span class="comment">#@logcheck no</span></div><div class="line">    <span class="keyword">return</span> <span class="number">1</span> <span class="keyword">if</span> ($net-&gt;&#123;type&#125; eq <span class="string">'bvs'</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h1 id="日志检测插件与效果"><a href="#日志检测插件与效果" class="headerlink" title="日志检测插件与效果"></a>日志检测插件与效果</h1><p>perlcritic使用PERL编写，分析其原理，然后实现如下代码：<br><figure class="highlight perl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div><div class="line">302</div><div class="line">303</div><div class="line">304</div><div class="line">305</div><div class="line">306</div><div class="line">307</div><div class="line">308</div><div class="line">309</div><div class="line">310</div><div class="line">311</div><div class="line">312</div><div class="line">313</div><div class="line">314</div><div class="line">315</div><div class="line">316</div><div class="line">317</div><div class="line">318</div><div class="line">319</div><div class="line">320</div><div class="line">321</div><div class="line">322</div><div class="line">323</div><div class="line">324</div><div class="line">325</div><div class="line">326</div><div class="line">327</div><div class="line">328</div><div class="line">329</div><div class="line">330</div><div class="line">331</div><div class="line">332</div><div class="line">333</div><div class="line">334</div><div class="line">335</div><div class="line">336</div><div class="line">337</div><div class="line">338</div><div class="line">339</div><div class="line">340</div><div class="line">341</div><div class="line">342</div><div class="line">343</div><div class="line">344</div><div class="line">345</div><div class="line">346</div><div class="line">347</div><div class="line">348</div><div class="line">349</div><div class="line">350</div><div class="line">351</div><div class="line">352</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> Perl::Critic::Policy::CodeLayout::RequireLogStatment;</div><div class="line"> </div><div class="line"><span class="keyword">use</span> <span class="number">5.006001</span>;</div><div class="line"><span class="keyword">use</span> strict;</div><div class="line"><span class="keyword">use</span> warnings;</div><div class="line"><span class="keyword">use</span> Readonly;</div><div class="line"><span class="keyword">use</span> Data::Dumper;</div><div class="line"><span class="keyword">use</span> Carp;</div><div class="line"><span class="keyword">use</span> Perl::Critic::Utils <span class="string">qw&#123; :characters :severities &#125;</span>;</div><div class="line"><span class="keyword">use</span> base <span class="string">'Perl::Critic::Policy'</span>;</div><div class="line"> </div><div class="line"><span class="keyword">our</span> $VERSION = <span class="string">'1.0'</span>;</div><div class="line"> </div><div class="line"><span class="keyword">my</span> $transLocal = <span class="number">1</span>;</div><div class="line"><span class="keyword">my</span> $DESC=$transLocal?<span class="string">'日志规范检查：'</span>:<span class="string">'Log missing '</span>;</div><div class="line"><span class="keyword">my</span> $EXPL=<span class="number">29219</span>;</div><div class="line"> </div><div class="line"><span class="function"><span class="keyword">sub</span> <span class="title">supported_parameters</span> </span>&#123; <span class="keyword">return</span> ()                     &#125;</div><div class="line"><span class="function"><span class="keyword">sub</span> <span class="title">default_severity</span>     </span>&#123; <span class="keyword">return</span> $SEVERITY_HIGH       &#125;</div><div class="line"><span class="function"><span class="keyword">sub</span> <span class="title">default_themes</span>       </span>&#123; <span class="keyword">return</span> <span class="string">qw(core bugs pbp cosmetic)</span>  &#125;</div><div class="line"><span class="function"><span class="keyword">sub</span> <span class="title">applies_to</span>           </span>&#123; <span class="keyword">return</span> <span class="string">'PPI::Token::Word'</span> &#125;</div><div class="line"> </div><div class="line"><span class="comment"># base functions</span></div><div class="line"><span class="function"><span class="keyword">sub</span> <span class="title">ltrim</span> </span>&#123; <span class="keyword">my</span> $s = <span class="keyword">shift</span>; $s =~ <span class="regexp">s/^\s+//</span>;       <span class="keyword">return</span> $s &#125;;</div><div class="line"><span class="function"><span class="keyword">sub</span> <span class="title">rtrim</span> </span>&#123; <span class="keyword">my</span> $s = <span class="keyword">shift</span>; $s =~ <span class="regexp">s/\s+$//</span>;       <span class="keyword">return</span> $s &#125;;</div><div class="line"><span class="function"><span class="keyword">sub</span>  <span class="title">trim</span> </span>&#123; <span class="keyword">my</span> $s = <span class="keyword">shift</span>; $s =~ <span class="regexp">s/^\s+|\s+$//g</span>; <span class="keyword">return</span> $s &#125;;</div><div class="line"> </div><div class="line"><span class="comment"># check stat functions</span></div><div class="line"><span class="keyword">use</span> constant <span class="string">CheckRight  =&gt;</span> <span class="number">1</span>;</div><div class="line"><span class="keyword">use</span> constant <span class="string">CheckWrong  =&gt;</span> <span class="number">2</span>;</div><div class="line"><span class="keyword">use</span> constant <span class="string">CheckPass =&gt;</span> <span class="number">3</span>;</div><div class="line"> </div><div class="line"><span class="keyword">my</span> $checkRight = <span class="number">0</span>;</div><div class="line"><span class="keyword">my</span> $checkWrong = <span class="number">0</span>;</div><div class="line"><span class="keyword">my</span> $checkPass = <span class="number">0</span>;</div><div class="line"> </div><div class="line"><span class="function"><span class="keyword">sub</span> <span class="title">addCheckRecord</span> </span>&#123;</div><div class="line">    <span class="keyword">my</span> ($chktype, $elem) = @_;</div><div class="line">    <span class="keyword">if</span>($chktype == CheckRight) &#123;</div><div class="line">        ++$checkRight;</div><div class="line">        <span class="comment">#printf(ele2str($elem)."\n");</span></div><div class="line">    &#125; <span class="keyword">elsif</span>($chktype == CheckWrong) &#123;</div><div class="line">        ++$checkWrong;</div><div class="line">    &#125; <span class="keyword">elsif</span>($chktype == CheckPass) &#123;</div><div class="line">        ++$checkPass;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"> </div><div class="line"><span class="function"><span class="keyword">sub</span> <span class="title">volationEntry</span> </span>&#123;</div><div class="line">    <span class="keyword">my</span> ($self, $elem, $desc) = @_;    </div><div class="line">    addCheckRecord(CheckWrong, $elem);</div><div class="line">    <span class="keyword">return</span> $self-&gt;violation($DESC.$desc, $EXPL, $elem);</div><div class="line">&#125;</div><div class="line"> </div><div class="line"><span class="comment"># helper functions</span></div><div class="line"><span class="function"><span class="keyword">sub</span> <span class="title">existsIn</span> </span>&#123;</div><div class="line">    <span class="keyword">my</span> ($word, $words) = @_;</div><div class="line">    <span class="keyword">for</span> <span class="keyword">my</span> $i (@$words) &#123;</div><div class="line">        <span class="keyword">if</span>($word eq $i) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div><div class="line"> </div><div class="line"><span class="keyword">my</span> @exitWords = <span class="string">qw(return die exit _exit)</span>;</div><div class="line"><span class="function"><span class="keyword">sub</span> <span class="title">isExitWord</span> </span>&#123;</div><div class="line">    <span class="keyword">my</span> ($word) = @_;</div><div class="line">    <span class="keyword">return</span> existsIn($word, \@exitWords);</div><div class="line">&#125;</div><div class="line"> </div><div class="line"><span class="keyword">my</span> @logWords = <span class="string">qw(ldie lemerg lalert lcrit lerror lwarn lnotice linfo ldebug dbg1 dbg2 dbg3 dbgv)</span>;</div><div class="line"><span class="function"><span class="keyword">sub</span> <span class="title">isLogWord</span> </span>&#123;</div><div class="line">    <span class="keyword">my</span> ($word) = @_;</div><div class="line">    <span class="keyword">return</span> existsIn($word, \@logWords);</div><div class="line">&#125;</div><div class="line"> </div><div class="line"><span class="keyword">my</span> @conditionJoinWords = <span class="string">qw(|| &amp;&amp; or and)</span>;</div><div class="line"><span class="function"><span class="keyword">sub</span> <span class="title">isConditionJoinWord</span> </span>&#123;</div><div class="line">    <span class="keyword">my</span> ($word) = @_;</div><div class="line">    <span class="keyword">return</span> existsIn($word, \@conditionJoinWords);</div><div class="line">&#125;</div><div class="line"> </div><div class="line"><span class="keyword">my</span> @conditionWords = <span class="string">qw(unless if)</span>;</div><div class="line"><span class="function"><span class="keyword">sub</span> <span class="title">isConditionWord</span> </span>&#123;</div><div class="line">    <span class="keyword">my</span> ($word) = @_;</div><div class="line">    <span class="keyword">return</span> existsIn($word, \@conditionWords);</div><div class="line">&#125;</div><div class="line"> </div><div class="line"><span class="function"><span class="keyword">sub</span> <span class="title">ele2str</span> </span>&#123;</div><div class="line">    <span class="keyword">my</span> ($elem) = @_;</div><div class="line">    <span class="keyword">return</span> $elem-&gt;location()-&gt;[<span class="number">4</span>].<span class="string">":"</span>.$elem-&gt;location()-&gt;[<span class="number">0</span>].<span class="string">" "</span>.$elem-&gt;content().<span class="string">"\n"</span>;</div><div class="line">&#125;</div><div class="line"> </div><div class="line"><span class="function"><span class="keyword">sub</span> <span class="title">sfindNextType</span> </span>&#123;</div><div class="line">    <span class="keyword">my</span> ($nsib, $type) = @_;</div><div class="line">    <span class="keyword">while</span> ( $nsib &amp;&amp; ! $nsib-&gt;isa($type) ) &#123;</div><div class="line">        $nsib = $nsib-&gt;snext_sibling();</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> $nsib;</div><div class="line">&#125;</div><div class="line"> </div><div class="line"><span class="function"><span class="keyword">sub</span> <span class="title">sfindNextTypeAll</span> </span>&#123;</div><div class="line">    <span class="keyword">my</span> ($nsib, $type) = @_;</div><div class="line">    <span class="keyword">my</span> @res = ();</div><div class="line">    <span class="keyword">while</span> ($nsib) &#123;</div><div class="line">        <span class="keyword">if</span> ($nsib-&gt;isa($type)) &#123;</div><div class="line">            <span class="keyword">push</span> @res, $nsib;</div><div class="line">        &#125;</div><div class="line">        $nsib = $nsib-&gt;snext_sibling();</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> @res;</div><div class="line">&#125;</div><div class="line"> </div><div class="line"><span class="function"><span class="keyword">sub</span> <span class="title">findIfBlock</span> </span>&#123;</div><div class="line">    <span class="keyword">my</span> ($if) = @_;</div><div class="line"> </div><div class="line">    <span class="keyword">if</span> (!$if || !$if-&gt;isa(<span class="string">'PPI::Statement::Compound'</span>)) &#123;</div><div class="line">        <span class="keyword">printf</span>(ele2str($if).<span class="string">" is not if statement!\n"</span>);</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> sfindNextTypeAll($if-&gt;schild(<span class="number">0</span>), <span class="string">'PPI::Structure::Block'</span>);</div><div class="line">&#125;</div><div class="line"> </div><div class="line"><span class="function"><span class="keyword">sub</span> <span class="title">slast</span> </span>&#123;</div><div class="line">    <span class="keyword">my</span> $next_sibling = <span class="keyword">shift</span>;</div><div class="line">    <span class="keyword">my</span> $last_following_sibling = $next_sibling;</div><div class="line">    <span class="keyword">if</span> (!$next_sibling) &#123;</div><div class="line">        Carp::cluck(<span class="string">"null next sibling"</span>); </div><div class="line">        <span class="keyword">return</span> <span class="keyword">undef</span>;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">while</span> ($next_sibling = $next_sibling-&gt;snext_sibling()) &#123;</div><div class="line">        $last_following_sibling = $next_sibling;</div><div class="line">    &#125;</div><div class="line">    <span class="comment"># if the last is ;, use previous</span></div><div class="line">    <span class="keyword">if</span> ($last_following_sibling </div><div class="line">        &amp;&amp; $last_following_sibling-&gt;isa(<span class="string">'PPI::Token::Structure'</span>) </div><div class="line">        &amp;&amp; <span class="string">';'</span> eq $last_following_sibling-&gt;content()) &#123;</div><div class="line">        <span class="keyword">return</span> $last_following_sibling-&gt;sprevious_sibling();</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> $last_following_sibling;</div><div class="line">&#125;</div><div class="line"> </div><div class="line"><span class="function"><span class="keyword">sub</span> _<span class="title">commentExtra</span> </span>&#123;</div><div class="line">    <span class="keyword">my</span> ($comment) = @_;</div><div class="line">    <span class="keyword">if</span> (!$comment) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="string">""</span>;</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    <span class="keyword">my</span> $offset = <span class="keyword">index</span>($comment, <span class="string">'#'</span>);</div><div class="line">    <span class="keyword">if</span> (-<span class="number">1</span> == $offset) &#123;</div><div class="line">        <span class="keyword">printf</span>(<span class="string">"not a comment: "</span>.$comment.<span class="string">"\n"</span>);</div><div class="line">        <span class="keyword">return</span> <span class="string">""</span>;</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    $comment = <span class="keyword">substr</span>($comment, $offset+<span class="number">1</span>);</div><div class="line">    <span class="keyword">return</span> trim($comment);</div><div class="line">&#125;</div><div class="line"> </div><div class="line"><span class="function"><span class="keyword">sub</span> <span class="title">annotationParse</span> </span>&#123;</div><div class="line">    <span class="keyword">my</span> ($statement) = @_;</div><div class="line"> </div><div class="line">    <span class="keyword">if</span> (!$statement || <span class="number">0</span> != <span class="keyword">index</span>($statement, <span class="string">'@logcheck '</span>)) &#123;</div><div class="line">        <span class="keyword">return</span> ();</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">my</span> @annos = <span class="keyword">split</span>(<span class="regexp">/[\t ]+/</span>, $statement);</div><div class="line">    <span class="keyword">shift</span> @annos;</div><div class="line">    <span class="keyword">return</span> @annos;</div><div class="line">&#125;</div><div class="line"> </div><div class="line"><span class="function"><span class="keyword">sub</span> <span class="title">processStatement</span> </span>&#123;</div><div class="line">    <span class="keyword">my</span> ($self, $elem, $desc, $location) = @_;</div><div class="line">    <span class="keyword">my</span> $ftoken = $elem-&gt;schild(<span class="number">0</span>);</div><div class="line">    <span class="keyword">if</span> (!$ftoken) &#123;</div><div class="line">        <span class="keyword">printf</span>(Dumper($elem).<span class="string">" no first child!\n"</span>);</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (isLogWord($ftoken-&gt;content())) &#123;</div><div class="line">        <span class="keyword">return</span>; <span class="comment">#condition right</span></div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">if</span> ($ftoken-&gt;content() eq <span class="string">"if"</span>) &#123;</div><div class="line">        <span class="keyword">return</span> processIf($self, $elem, $desc, $location);</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    <span class="keyword">return</span> volationEntry($self, $location?$location:$ftoken, $desc?$desc:$transLocal?<span class="string">"PRE LOG MISSING 退出请打日志"</span>:<span class="string">"PRE LOG MISSING"</span>);</div><div class="line">&#125;</div><div class="line"> </div><div class="line"><span class="function"><span class="keyword">sub</span> <span class="title">processIf</span> </span>&#123;</div><div class="line">    <span class="keyword">my</span> ($self, $elem, $desc, $location) = @_;</div><div class="line"> </div><div class="line">    <span class="keyword">my</span> @ifblks = findIfBlock($elem);</div><div class="line"> </div><div class="line">    <span class="keyword">for</span>(<span class="keyword">my</span> $i = <span class="number">0</span>; $i &lt; @ifblks; $i++)&#123;</div><div class="line">        <span class="keyword">my</span> $ifblk = $ifblks[$i];</div><div class="line">        <span class="keyword">if</span>(!$ifblk) &#123;</div><div class="line">            <span class="keyword">printf</span>(<span class="string">"can't found ele's ifblk:"</span>.Dumper($elem).<span class="string">"\n"</span>);</div><div class="line">            <span class="keyword">next</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">my</span> $firstblock = $ifblk-&gt;schild(<span class="number">0</span>);</div><div class="line">        <span class="keyword">if</span>(!$firstblock) &#123;</div><div class="line">            <span class="comment">#Carp::cluck("null schild ".ele2str($ifblk)); </span></div><div class="line">            <span class="comment"># e.g: if($node ne 'cluster') &#123;&#125; </span></div><div class="line">            <span class="comment"># with empty block!</span></div><div class="line">            <span class="keyword">next</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">my</span> $last = slast($firstblock);</div><div class="line">        <span class="keyword">if</span> (!$last) &#123;</div><div class="line">            <span class="keyword">printf</span>(<span class="string">"can't found ifblk's last:"</span>.Dumper($ifblk).<span class="string">"\n"</span>);</div><div class="line">            <span class="keyword">next</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">my</span> $violate = process($self, $last, $desc, $location);</div><div class="line">        <span class="keyword">if</span> ($violate) &#123;</div><div class="line">            <span class="keyword">return</span> $violate;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    addCheckRecord(CheckRight, $elem);</div><div class="line">    <span class="keyword">return</span>;</div><div class="line">&#125;</div><div class="line"> </div><div class="line"><span class="function"><span class="keyword">sub</span> <span class="title">process</span> </span>&#123;</div><div class="line">    <span class="keyword">my</span> ($self, $elem, $desc, $location) = @_;</div><div class="line">    <span class="keyword">if</span> (!$elem) &#123;</div><div class="line">        <span class="keyword">printf</span>(<span class="string">"statement is null\n"</span>);</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> ($elem-&gt;isa(<span class="string">'PPI::Statement::Compound'</span>)) &#123;</div><div class="line">        <span class="keyword">return</span> processIf($self, $elem, $desc, $location);</div><div class="line">    &#125; <span class="keyword">elsif</span> ($elem-&gt;isa(<span class="string">'PPI::Statement'</span>)) &#123;</div><div class="line">        <span class="keyword">return</span> processStatement($self, $elem, $desc, $location);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="keyword">printf</span>(<span class="string">"unknown statement type: "</span>.Dumper($elem).<span class="string">"\n"</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span>;</div><div class="line">&#125;</div><div class="line"> </div><div class="line"><span class="function"><span class="keyword">sub</span> _<span class="title">isLastStatOfSub</span> </span>&#123;</div><div class="line">    <span class="keyword">my</span> ($stat) = @_;</div><div class="line">    </div><div class="line">    <span class="keyword">my</span> $sp = $stat-&gt;parent();</div><div class="line">    <span class="keyword">if</span>(!$sp) &#123;</div><div class="line">        <span class="comment">#printf("stat no parent: ".Dumper($stat)."\n");</span></div><div class="line">        <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    <span class="keyword">my</span> $findLast = slast($sp-&gt;schild(<span class="number">0</span>));</div><div class="line">    </div><div class="line">    <span class="keyword">if</span> ((refaddr $findLast) == (refaddr $stat)) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div><div class="line"> </div><div class="line"><span class="function"><span class="keyword">sub</span> <span class="title">isLastStatOfSub</span> </span>&#123;</div><div class="line">    <span class="keyword">my</span> ($stat) = @_;</div><div class="line"> </div><div class="line">    <span class="keyword">while</span> ($stat &amp;&amp; _isLastStatOfSub($stat)) &#123;</div><div class="line">        <span class="keyword">my</span> $sp  = $stat ? $stat-&gt;parent() : <span class="keyword">undef</span>;</div><div class="line">        <span class="keyword">my</span> $spp = $sp ? $sp-&gt;parent() : <span class="keyword">undef</span>;</div><div class="line">        <span class="keyword">if</span> ($spp &amp;&amp; $spp-&gt;isa(<span class="string">'PPI::Statement::Sub'</span>) &amp;&amp; $sp-&gt;isa(<span class="string">'PPI::Structure::Block'</span>)) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">        &#125;</div><div class="line">        $stat = $sp;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div><div class="line"> </div><div class="line"> </div><div class="line"><span class="function"><span class="keyword">sub</span> <span class="title">violates</span> </span>&#123;</div><div class="line">    <span class="keyword">my</span> ( $self, $elem, <span class="keyword">undef</span> ) = @_;</div><div class="line">    <span class="keyword">if</span>(!isExitWord($elem-&gt;content()))  &#123;</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    <span class="keyword">my</span> $statement = $elem-&gt;statement();</div><div class="line">    <span class="keyword">if</span> (!$statement) &#123;</div><div class="line">        <span class="keyword">printf</span>(Dumper($elem).<span class="string">" no statement!\n"</span>);</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    <span class="comment">#CASE sub except</span></div><div class="line">    <span class="keyword">if</span> (isLastStatOfSub($statement)) &#123;</div><div class="line">        addCheckRecord(CheckRight, $statement);</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    <span class="comment">#CASE annotation</span></div><div class="line">    <span class="keyword">my</span> $presib = $statement-&gt;previous_sibling();</div><div class="line">    <span class="keyword">while</span> ($presib &amp;&amp; $presib-&gt;isa(<span class="string">'PPI::Token::Whitespace'</span>)) &#123;</div><div class="line">        $presib = $presib-&gt;previous_sibling();</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span>($presib &amp;&amp; $presib-&gt;isa(<span class="string">'PPI::Token::Comment'</span>)) &#123;</div><div class="line">        <span class="keyword">my</span> @annos = annotationParse(_commentExtra($presib-&gt;content()));</div><div class="line">        <span class="keyword">if</span> (@annos &amp;&amp; (<span class="string">"no"</span> eq $annos[<span class="number">0</span>])) &#123;</div><div class="line">            addCheckRecord(CheckPass, $presib);</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    <span class="comment">#CASE or return</span></div><div class="line">    $presib = $elem-&gt;sprevious_sibling();</div><div class="line">    <span class="keyword">if</span> ($presib &amp;&amp; $presib-&gt;isa(<span class="string">'PPI::Token::Operator'</span>) &amp;&amp; isConditionJoinWord($presib-&gt;content())) &#123;</div><div class="line">        <span class="keyword">return</span> volationEntry($self, $elem, $transLocal?<span class="string">"OR RETURN 退出前请打日志"</span>:<span class="string">"OR RETURN need log"</span>);</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    <span class="comment">#CASE return if</span></div><div class="line">    <span class="keyword">my</span> $lastsib = slast($elem);</div><div class="line">    <span class="keyword">if</span>($lastsib &amp;&amp; $lastsib-&gt;isa(<span class="string">'PPI::Structure::Condition'</span>)) &#123;</div><div class="line">        <span class="keyword">my</span> $if = $lastsib-&gt;sprevious_sibling();</div><div class="line">        <span class="keyword">if</span> ($if &amp;&amp; isConditionWord($if-&gt;content())) &#123;</div><div class="line">            <span class="keyword">return</span> volationEntry($self, $elem, $transLocal?<span class="string">"RETURN IF 退出前请打日志"</span>:<span class="string">"RETURN IF need log"</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">printf</span>(<span class="string">"invalid condition found: "</span>.Dumper($lastsib).<span class="string">"\n"</span>);</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    <span class="comment">#CASE no pre-statement</span></div><div class="line">    <span class="keyword">my</span> $prestatement = $statement-&gt;sprevious_sibling();</div><div class="line">    <span class="keyword">if</span>(!$prestatement) &#123;</div><div class="line">        <span class="keyword">return</span> volationEntry($self, $elem, $transLocal?<span class="string">"NO PRE-STATEMENT 退出前请打日志"</span>:<span class="string">"NO PRE-STATEMENT"</span>);</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    <span class="comment">#CASE if-else return</span></div><div class="line">    <span class="keyword">if</span> ($prestatement-&gt;isa(<span class="string">'PPI::Statement::Compound'</span>)) &#123;</div><div class="line">        <span class="comment">#printf("case 1, ".ele2str($prestatement));</span></div><div class="line">        <span class="keyword">return</span> processIf($self, $prestatement, $transLocal?<span class="string">"IF-ELSE RETURN 退出前请打日志"</span>:<span class="string">"IF-ELSE RETURN need log"</span>, $elem);</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    <span class="comment">#CASE normal check    </span></div><div class="line">    <span class="keyword">if</span> ($prestatement-&gt;isa(<span class="string">'PPI::Statement'</span>)) &#123;</div><div class="line">        <span class="keyword">my</span> $ftoken = $prestatement-&gt;schild(<span class="number">0</span>);</div><div class="line">        <span class="keyword">if</span> ($ftoken) &#123;</div><div class="line">            <span class="keyword">if</span>(isLogWord($ftoken-&gt;content())) &#123;</div><div class="line">                <span class="comment">#pre statement is a logstat</span></div><div class="line">                addCheckRecord(CheckRight, $ftoken);</div><div class="line">                <span class="keyword">return</span>;</div><div class="line">            &#125; <span class="keyword">elsif</span>(isConditionWord($ftoken-&gt;content())) &#123;</div><div class="line">                <span class="keyword">return</span> processIf($self, $prestatement, $transLocal?<span class="string">"IF-ELSE RETURN 退出前请打日志"</span>:<span class="string">"IF-ELSE RETURN need log"</span>, $elem);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> volationEntry($self, $elem, $transLocal?<span class="string">"PRE LOG MISSING 退出前请打日志"</span>:<span class="string">"PRE LOG MISSING need log"</span>);</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    <span class="keyword">printf</span>(<span class="string">"unknown pre statement type: "</span>.Dumper($prestatement).<span class="string">"\n"</span>);</div><div class="line">    <span class="keyword">return</span>;</div><div class="line">&#125;</div><div class="line"> </div><div class="line">END &#123;</div><div class="line">    <span class="keyword">printf</span>(<span class="string">"LogCheck Right $checkRight Wrong $checkWrong Pass $checkPass\n"</span>);</div><div class="line">&#125;</div><div class="line"> </div><div class="line"><span class="number">1</span>;</div></pre></td></tr></table></figure></p>
<p>目前可检测如下语法unit.pm：<br><figure class="highlight perl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#[W] no pre-statement</span></div><div class="line"><span class="keyword">return</span> <span class="number">4</span>;</div><div class="line"> </div><div class="line"><span class="comment">#[P] annotation</span></div><div class="line"><span class="keyword">if</span> (-e <span class="string">"path/to/file"</span>) &#123;</div><div class="line">    i++;</div><div class="line">    <span class="comment">#@logcheck no</span></div><div class="line">    <span class="keyword">exit</span> (<span class="number">0</span>); <span class="comment">#PPI::Statement</span></div><div class="line">&#125;</div><div class="line"> </div><div class="line"><span class="comment">#[R] if return</span></div><div class="line"><span class="keyword">if</span> (-e <span class="string">"path/to/file"</span>) &#123;</div><div class="line">    i++;</div><div class="line">    ldebug(<span class="string">"file found!"</span>);</div><div class="line">    <span class="keyword">exit</span> (<span class="number">0</span>); <span class="comment">#PPI::Statement</span></div><div class="line">&#125;</div><div class="line"> </div><div class="line"><span class="comment">#[R] if if return</span></div><div class="line"><span class="keyword">if</span> (-e <span class="string">"path/to/file"</span>) &#123;</div><div class="line">    <span class="keyword">if</span> (true)&#123;</div><div class="line">        ldebug(<span class="string">"file found!"</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">exit</span> <span class="number">1</span>; <span class="comment">#PPI::Statement</span></div><div class="line">&#125;</div><div class="line"> </div><div class="line"><span class="comment">#[W] if-else return</span></div><div class="line"><span class="keyword">if</span> (-e <span class="string">"path/to/file"</span>) &#123;</div><div class="line">    <span class="keyword">if</span> ($i == <span class="number">1</span>)&#123;</div><div class="line">        lerror(<span class="string">"file found 1!"</span>);</div><div class="line">    &#125; <span class="keyword">elsif</span> ($i == <span class="number">2</span>)&#123;</div><div class="line">        ldebug(<span class="string">"file found 2!"</span>);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        i++;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">exit</span> <span class="number">1</span>; <span class="comment">#PPI::Statement</span></div><div class="line">&#125;</div><div class="line"> </div><div class="line"><span class="comment">#[R] if-else return</span></div><div class="line"><span class="keyword">if</span> (-e <span class="string">"path/to/file"</span>) &#123;</div><div class="line">    <span class="keyword">if</span> ($i == <span class="number">1</span>)&#123;</div><div class="line">        lerror(<span class="string">"file found 1!"</span>);</div><div class="line">    &#125; <span class="keyword">elsif</span> ($i == <span class="number">2</span>)&#123;</div><div class="line">        ldebug(<span class="string">"file found 2!"</span>);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        i++;</div><div class="line">        linfo(<span class="string">"file found 3!"</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">exit</span> <span class="number">1</span>; <span class="comment">#PPI::Statement</span></div><div class="line">&#125;</div><div class="line"> </div><div class="line"><span class="comment">#[W] if-else return</span></div><div class="line"><span class="keyword">if</span> (-e <span class="string">"path/to/file"</span>) &#123;</div><div class="line">    <span class="keyword">if</span> ($i == <span class="number">1</span>)&#123;</div><div class="line">        lerror(<span class="string">"file found 1!"</span>);</div><div class="line">    &#125; <span class="keyword">elsif</span> ($i == <span class="number">2</span>)&#123;</div><div class="line">        i++;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        ldebug(<span class="string">"file found 2!"</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">exit</span> <span class="number">1</span>; <span class="comment">#PPI::Statement</span></div><div class="line">&#125;</div><div class="line"> </div><div class="line"><span class="comment">#[W] if-else return</span></div><div class="line"><span class="keyword">if</span> (-e <span class="string">"path/to/file"</span>) &#123;</div><div class="line">    <span class="keyword">if</span> ($i == <span class="number">1</span>)&#123;</div><div class="line">        i++;</div><div class="line">    &#125; <span class="keyword">elsif</span> ($i == <span class="number">2</span>)&#123;</div><div class="line">        lerror(<span class="string">"file found 1!"</span>);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        ldebug(<span class="string">"file found 2!"</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">exit</span> <span class="number">1</span>; <span class="comment">#PPI::Statement</span></div><div class="line">&#125;</div><div class="line"> </div><div class="line"><span class="comment">#[W] pre log missing</span></div><div class="line"><span class="keyword">while</span> (true) &#123;</div><div class="line">    i++;</div><div class="line">    <span class="keyword">exit</span> <span class="number">2</span>;</div><div class="line">&#125;</div><div class="line"> </div><div class="line"><span class="comment">#[W] return if</span></div><div class="line"><span class="keyword">return</span> (-<span class="number">1</span>, <span class="string">"file not found"</span>) <span class="keyword">if</span>(! -e <span class="string">"path/to/file"</span>); <span class="comment">#statement=PPI::Structure::Condition,PPI::Token::Structure=';'</span></div><div class="line"> </div><div class="line"><span class="comment">#[W] return unless</span></div><div class="line"><span class="keyword">return</span> $vmlist <span class="keyword">unless</span> (-e $powerfile);</div><div class="line"> </div><div class="line"><span class="comment">#[W] or return</span></div><div class="line"><span class="keyword">open</span> STDOUT, <span class="string">'&gt;/dev/null'</span> <span class="keyword">or</span> <span class="keyword">die</span> <span class="string">"$msg $!\n"</span>;</div><div class="line"> </div><div class="line"><span class="comment">#[W] or return</span></div><div class="line">! -e <span class="string">"path/to/file"</span> || <span class="keyword">die</span> <span class="string">"file not exist!"</span>; <span class="comment">#psib=PPI::Token::Operator='||'</span></div><div class="line"> </div><div class="line"><span class="comment">#[W] sub except</span></div><div class="line"><span class="function"><span class="keyword">sub</span> <span class="title">foo</span> </span>&#123;</div><div class="line">    <span class="keyword">my</span> ($arg) = @_;</div><div class="line">    i++;</div><div class="line">    <span class="keyword">if</span> (i &gt; <span class="number">0</span>) &#123;</div><div class="line">        <span class="keyword">return</span> i;</div><div class="line">    &#125;</div><div class="line">    i--;</div><div class="line">&#125;</div><div class="line"> </div><div class="line"><span class="comment">#[R] sub except</span></div><div class="line"><span class="function"><span class="keyword">sub</span> <span class="title">foo</span> </span>&#123;</div><div class="line">    <span class="keyword">my</span> ($arg) = @_;</div><div class="line">    i++;</div><div class="line">    <span class="keyword">return</span> i;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>此工具可单独使用：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">perlcritic -s CodeLayout::RequireLogStatment ./unit.pm</div></pre></td></tr></table></figure></p>
<p><img src="/2016/09/12/auto-codereview-machine/1.own-check.png" alt="own-check"></p>
<p>也可配合其他检测选项使用：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">perlcritic -4 --verbose 8 ./QemuHugePages.pm</div></pre></td></tr></table></figure></p>
<p><img src="/2016/09/12/auto-codereview-machine/2.all-check.png" alt="all-check"></p>
<h1 id="根据reviewID扫描并提交reviewboard"><a href="#根据reviewID扫描并提交reviewboard" class="headerlink" title="根据reviewID扫描并提交reviewboard"></a>根据reviewID扫描并提交reviewboard</h1><p>上面命令实现后，想要完成自动化，需要实现根据reviewboard的reviewID自动获取代码进行检测，并将检测结果提交成comments形式给reviewboard，由于这部分使用大量Restful API请求，使用js处理request和JSON非常方便，但是node.js最大的问题是默认异步，导致代码并不是很优雅：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div><div class="line">302</div><div class="line">303</div><div class="line">304</div><div class="line">305</div><div class="line">306</div><div class="line">307</div><div class="line">308</div><div class="line">309</div><div class="line">310</div><div class="line">311</div><div class="line">312</div><div class="line">313</div><div class="line">314</div><div class="line">315</div><div class="line">316</div><div class="line">317</div><div class="line">318</div><div class="line">319</div><div class="line">320</div><div class="line">321</div><div class="line">322</div><div class="line">323</div><div class="line">324</div><div class="line">325</div><div class="line">326</div><div class="line">327</div><div class="line">328</div><div class="line">329</div><div class="line">330</div><div class="line">331</div><div class="line">332</div><div class="line">333</div><div class="line">334</div><div class="line">335</div><div class="line">336</div><div class="line">337</div><div class="line">338</div><div class="line">339</div><div class="line">340</div><div class="line">341</div><div class="line">342</div><div class="line">343</div><div class="line">344</div><div class="line">345</div><div class="line">346</div><div class="line">347</div><div class="line">348</div><div class="line">349</div><div class="line">350</div><div class="line">351</div><div class="line">352</div><div class="line">353</div><div class="line">354</div><div class="line">355</div><div class="line">356</div><div class="line">357</div><div class="line">358</div><div class="line">359</div><div class="line">360</div><div class="line">361</div><div class="line">362</div><div class="line">363</div><div class="line">364</div><div class="line">365</div><div class="line">366</div><div class="line">367</div><div class="line">368</div><div class="line">369</div><div class="line">370</div><div class="line">371</div><div class="line">372</div><div class="line">373</div><div class="line">374</div><div class="line">375</div><div class="line">376</div><div class="line">377</div><div class="line">378</div><div class="line">379</div><div class="line">380</div><div class="line">381</div><div class="line">382</div><div class="line">383</div><div class="line">384</div><div class="line">385</div><div class="line">386</div><div class="line">387</div><div class="line">388</div><div class="line">389</div><div class="line">390</div><div class="line">391</div><div class="line">392</div><div class="line">393</div><div class="line">394</div><div class="line">395</div><div class="line">396</div><div class="line">397</div><div class="line">398</div><div class="line">399</div><div class="line">400</div><div class="line">401</div><div class="line">402</div><div class="line">403</div><div class="line">404</div><div class="line">405</div><div class="line">406</div><div class="line">407</div><div class="line">408</div><div class="line">409</div><div class="line">410</div><div class="line">411</div><div class="line">412</div><div class="line">413</div><div class="line">414</div><div class="line">415</div><div class="line">416</div><div class="line">417</div><div class="line">418</div><div class="line">419</div><div class="line">420</div><div class="line">421</div><div class="line">422</div><div class="line">423</div><div class="line">424</div><div class="line">425</div><div class="line">426</div><div class="line">427</div><div class="line">428</div><div class="line">429</div><div class="line">430</div><div class="line">431</div><div class="line">432</div><div class="line">433</div><div class="line">434</div><div class="line">435</div><div class="line">436</div><div class="line">437</div><div class="line">438</div><div class="line">439</div><div class="line">440</div><div class="line">441</div><div class="line">442</div><div class="line">443</div><div class="line">444</div><div class="line">445</div><div class="line">446</div><div class="line">447</div><div class="line">448</div><div class="line">449</div><div class="line">450</div><div class="line">451</div><div class="line">452</div><div class="line">453</div><div class="line">454</div><div class="line">455</div><div class="line">456</div><div class="line">457</div><div class="line">458</div><div class="line">459</div><div class="line">460</div><div class="line">461</div><div class="line">462</div><div class="line">463</div><div class="line">464</div><div class="line">465</div><div class="line">466</div><div class="line">467</div><div class="line">468</div><div class="line">469</div><div class="line">470</div><div class="line">471</div><div class="line">472</div><div class="line">473</div><div class="line">474</div><div class="line">475</div><div class="line">476</div><div class="line">477</div><div class="line">478</div><div class="line">479</div><div class="line">480</div><div class="line">481</div><div class="line">482</div><div class="line">483</div><div class="line">484</div><div class="line">485</div><div class="line">486</div><div class="line">487</div><div class="line">488</div><div class="line">489</div><div class="line">490</div><div class="line">491</div><div class="line">492</div><div class="line">493</div><div class="line">494</div><div class="line">495</div><div class="line">496</div><div class="line">497</div><div class="line">498</div><div class="line">499</div><div class="line">500</div><div class="line">501</div><div class="line">502</div><div class="line">503</div><div class="line">504</div><div class="line">505</div><div class="line">506</div><div class="line">507</div><div class="line">508</div><div class="line">509</div><div class="line">510</div><div class="line">511</div><div class="line">512</div><div class="line">513</div><div class="line">514</div><div class="line">515</div><div class="line">516</div><div class="line">517</div><div class="line">518</div><div class="line">519</div><div class="line">520</div><div class="line">521</div><div class="line">522</div><div class="line">523</div><div class="line">524</div><div class="line">525</div><div class="line">526</div><div class="line">527</div><div class="line">528</div><div class="line">529</div><div class="line">530</div><div class="line">531</div><div class="line">532</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#!/bin/node</span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * syntex check and submit comments to reviewboard</span></div><div class="line"><span class="comment"> *     all api reference https://www.reviewboard.org/docs/manual/2.0/webapi/</span></div><div class="line"><span class="comment"> *     su -c "./rbjob -r 21371 retrive --check log --flog 2&gt;&amp;1" www-data</span></div><div class="line"><span class="comment"> *     su -c "./rbjob -r 21371 retrive --check all" www-data</span></div><div class="line"><span class="comment"> * @author mnstory.net</span></div><div class="line"><span class="comment"> * @version 20160910 - check syntex and post uniq comments</span></div><div class="line"><span class="comment"> */</span></div><div class="line"> </div><div class="line"><span class="comment">//public defines</span></div><div class="line"><span class="keyword">var</span> suspend = <span class="built_in">require</span>(<span class="string">'suspend'</span>),</div><div class="line">    resume = suspend.resume;</div><div class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>)</div><div class="line"><span class="keyword">var</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>)</div><div class="line"><span class="keyword">var</span> request = <span class="built_in">require</span>(<span class="string">'request'</span>)</div><div class="line"><span class="keyword">var</span> p = <span class="built_in">require</span>(<span class="string">'child_process'</span>)</div><div class="line"><span class="keyword">var</span> moment = <span class="built_in">require</span>(<span class="string">'moment'</span>)</div><div class="line"> </div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">mkdirsSync</span>(<span class="params">targets</span>) </span>&#123; </div><div class="line">    <span class="keyword">if</span> (fs.existsSync(targets)) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="literal">true</span></div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    <span class="keyword">var</span> joinTarget</div><div class="line">    targets.split(path.sep).forEach(<span class="function"><span class="keyword">function</span>(<span class="params">dirname</span>) </span>&#123;</div><div class="line">        <span class="keyword">if</span>(!joinTarget &amp;&amp; !dirname) &#123;</div><div class="line">            joinTarget=<span class="string">'/'</span></div><div class="line">            <span class="keyword">return</span> <span class="literal">true</span></div><div class="line">        &#125;</div><div class="line">        joinTarget = joinTarget ? path.join(joinTarget, dirname) : dirname</div><div class="line">        <span class="keyword">if</span> (!fs.existsSync(joinTarget)) &#123;</div><div class="line">            fs.mkdirSync(joinTarget)</div><div class="line">        &#125;</div><div class="line">    &#125;)</div><div class="line">    <span class="keyword">return</span> fs.existsSync(targets)</div><div class="line">&#125;</div><div class="line"> </div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">strArrBeginWith</span>(<span class="params">strArr, strMatch</span>) </span>&#123;</div><div class="line">    <span class="keyword">for</span> (i <span class="keyword">in</span> strArr) &#123;</div><div class="line">        <span class="keyword">if</span>(strArr[i].indexOf(strMatch) == <span class="number">0</span>) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="literal">true</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="literal">false</span></div><div class="line">&#125;</div><div class="line"> </div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">extractLastURLToken</span>(<span class="params">url</span>) </span>&#123;</div><div class="line">    <span class="keyword">if</span>(!url || url.length &lt;= <span class="number">2</span>) &#123;</div><div class="line">        l.error(<span class="string">'invalid url '</span> + (url?url:<span class="string">'&lt;null&gt;'</span>))</div><div class="line">        <span class="keyword">return</span> <span class="literal">null</span></div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    <span class="keyword">var</span> lastOffset = (<span class="string">'/'</span> == url[url.length - <span class="number">1</span>]) ? <span class="number">1</span> : <span class="number">0</span></div><div class="line">    <span class="keyword">var</span> offset = url.lastIndexOf(<span class="string">'/'</span>, url.length<span class="number">-1</span>-lastOffset)</div><div class="line">    <span class="keyword">if</span>(<span class="number">-1</span> == offset) &#123;</div><div class="line">        l.error(<span class="string">'url '</span> + url + <span class="string">' not expected format'</span>)</div><div class="line">        <span class="keyword">return</span> <span class="literal">null</span></div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> url.substring(offset + <span class="number">1</span>, url.length-lastOffset)</div><div class="line">&#125;</div><div class="line"> </div><div class="line">mkdirsSync(<span class="string">'/var/log/rb'</span>)</div><div class="line"><span class="keyword">var</span> log4js = <span class="built_in">require</span>(<span class="string">'log4js'</span>)</div><div class="line">log4js.configure(&#123;</div><div class="line">    appenders: [</div><div class="line">        &#123;</div><div class="line">            type: <span class="string">'console'</span>,</div><div class="line">            category: <span class="string">"consoleRBJob"</span></div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">            type: <span class="string">'dateFile'</span>,</div><div class="line">            filename: <span class="string">'/var/log/rb/job'</span>,</div><div class="line">            pattern: <span class="string">".yyyy-MM-dd.log"</span>,</div><div class="line">            maxLogSize: <span class="number">4096</span>,</div><div class="line">            alwaysIncludePattern: <span class="literal">true</span>,</div><div class="line">            backups: <span class="number">1</span>,</div><div class="line">            category: <span class="string">'RBJob'</span>,</div><div class="line">            layout: &#123;</div><div class="line">                type: <span class="string">'pattern'</span>,</div><div class="line">                pattern: <span class="string">"%d&#123;ABSOLUTE&#125; %-5p "</span> + process.pid +<span class="string">" %c %m"</span></div><div class="line">            &#125;</div><div class="line">        &#125;,</div><div class="line">    ],</div><div class="line">    replaceConsole: <span class="literal">false</span>,</div><div class="line">    levels: &#123;</div><div class="line">        RBJob: <span class="string">'trace'</span>,</div><div class="line">        consoleRBJob: <span class="string">'trace'</span></div><div class="line">    &#125;</div><div class="line">&#125;)</div><div class="line"> </div><div class="line"><span class="keyword">var</span> l = log4js.getLogger(<span class="string">'consoleRBJob'</span>)</div><div class="line"> </div><div class="line"><span class="comment">//module defines</span></div><div class="line"><span class="keyword">var</span> reviewURI</div><div class="line"><span class="keyword">var</span> reviewRequestOption</div><div class="line"><span class="keyword">var</span> outDir=<span class="string">'/tmp/rb/job'</span></div><div class="line"><span class="keyword">var</span> sessionDir=<span class="literal">null</span></div><div class="line"> </div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">optParse</span>(<span class="params">options</span>) </span>&#123;</div><div class="line">    <span class="keyword">if</span>(options.flog) &#123;</div><div class="line">        l = log4js.getLogger(<span class="string">'RBJob'</span>)</div><div class="line">    &#125;</div><div class="line">    p.execSync(<span class="string">'rm -rf '</span> + outDir)</div><div class="line">    </div><div class="line">    reviewURI=<span class="string">'http://'</span>+options.rserver+<span class="string">'/'</span></div><div class="line">    reviewRequestOption = &#123;</div><div class="line">        <span class="string">'auth'</span>: &#123;</div><div class="line">            <span class="string">'user'</span>: options.ruser,</div><div class="line">            <span class="string">'pass'</span>: options.rpass,</div><div class="line">            <span class="string">'sendImmediately'</span>: <span class="literal">false</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    l.debug(<span class="string">'reviewURI = '</span> + reviewURI)</div><div class="line">    l.debug(<span class="string">'reviewRequestOption = '</span> + <span class="built_in">JSON</span>.stringify(reviewRequestOption))</div><div class="line">    <span class="keyword">return</span> <span class="literal">true</span></div><div class="line">&#125;</div><div class="line"> </div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">commentsParse</span>(<span class="params">strComments</span>) </span>&#123;</div><div class="line">    <span class="keyword">if</span>(!strComments) &#123;</div><div class="line">        l.error(<span class="string">'strComments is empty when parse comments'</span>)</div><div class="line">        <span class="keyword">return</span> <span class="literal">null</span></div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    <span class="keyword">var</span> res = <span class="literal">null</span></div><div class="line">    <span class="keyword">var</span> comments = strComments.split(<span class="string">"\n"</span>)</div><div class="line">    <span class="keyword">var</span> regex = <span class="regexp">/at line ([0-9]+),/</span></div><div class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> idx = <span class="number">0</span>; idx &lt; comments.length; ++idx) &#123;</div><div class="line">        <span class="comment">//Log missing NO PRE-STATEMENT at line 99, column 9.  29219.  (Severity: 4)</span></div><div class="line">        <span class="keyword">var</span> matched = comments[idx].match(regex)</div><div class="line">        <span class="keyword">if</span> (!matched) &#123;</div><div class="line">            <span class="keyword">continue</span></div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span>(<span class="literal">null</span> == res) &#123;</div><div class="line">            res = &#123;&#125;</div><div class="line">        &#125;</div><div class="line">        res[matched[<span class="number">1</span>]] = comments[idx]</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> res;</div><div class="line">&#125;</div><div class="line"> </div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">commentsCommit</span>(<span class="params">reviewID, commentID</span>) </span>&#123;</div><div class="line">    <span class="keyword">var</span> url = reviewURI+<span class="string">'api/review-requests/'</span>+reviewID+<span class="string">'/reviews/'</span>+commentID+<span class="string">'/'</span></div><div class="line">    l.debug(<span class="string">'post comment commit: '</span> + url)</div><div class="line">    <span class="keyword">var</span> comment = &#123;&#125;</div><div class="line">    comment.api_format=<span class="string">'json'</span></div><div class="line">    comment.ship_it=<span class="literal">false</span></div><div class="line">    comment.public=<span class="number">1</span></div><div class="line"> </div><div class="line">    request.put(url, reviewRequestOption).form(comment).on(<span class="string">'data'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">d</span>) </span>&#123;</div><div class="line">        <span class="keyword">var</span> r = <span class="built_in">JSON</span>.parse(d.toString())</div><div class="line">        <span class="keyword">if</span> (!r || <span class="string">'ok'</span> != r.stat) &#123;</div><div class="line">            l.error(<span class="string">"fail to post comment commit "</span> + <span class="built_in">JSON</span>.stringify(comment) + <span class="string">" : "</span> + d.toString())</div><div class="line">            <span class="keyword">return</span></div><div class="line">        &#125;</div><div class="line">        l.debug(<span class="string">"success to post comment commit "</span> + <span class="built_in">JSON</span>.stringify(comment))</div><div class="line">    &#125;)</div><div class="line">&#125;</div><div class="line"> </div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">commentIDParse</span>(<span class="params">text</span>) </span>&#123;</div><div class="line">    <span class="keyword">var</span> r = <span class="built_in">JSON</span>.parse(text)</div><div class="line">    <span class="keyword">if</span> (!r || <span class="string">'ok'</span> != r.stat) &#123;</div><div class="line">        l.error(<span class="string">"invalid response when parse commentID: "</span> + text)</div><div class="line">        <span class="keyword">return</span> <span class="number">-1</span></div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> r.review.id</div><div class="line">&#125;</div><div class="line"> </div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">diffFilesParse</span>(<span class="params">url, r</span>) </span>&#123;</div><div class="line">    <span class="keyword">if</span>(<span class="literal">null</span> == r || <span class="number">0</span> == r.total_results) &#123;</div><div class="line">        l.error(<span class="string">'&lt;'</span>+url+<span class="string">'&gt; invalid total results: '</span> + (r?r.total_results:<span class="number">-1</span>))</div><div class="line">        <span class="keyword">return</span> <span class="literal">null</span></div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    <span class="keyword">var</span> files = []</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> idx <span class="keyword">in</span> r.files) &#123;</div><div class="line">        <span class="keyword">var</span> name = path.basename(r.files[idx].dest_file)</div><div class="line">        <span class="keyword">var</span> ext = path.extname(name)</div><div class="line">        <span class="keyword">if</span>(!ext || (ext != <span class="string">'.pm'</span> &amp;&amp; ext != <span class="string">'.pl'</span>)) &#123;</div><div class="line">            l.debug(<span class="string">'&lt;'</span>+url+<span class="string">'&gt; not check: '</span> + name)</div><div class="line">            <span class="keyword">continue</span></div><div class="line">        &#125;</div><div class="line">        <span class="keyword">var</span> fileID = r.files[idx].dest_file</div><div class="line"> </div><div class="line">        <span class="keyword">var</span> newInsert = <span class="literal">false</span></div><div class="line">        <span class="keyword">if</span>(<span class="number">0</span> != r.files[idx].extra_data.total_line_count</div><div class="line">            &amp;&amp; (<span class="number">0</span> == r.files[idx].extra_data.equal_count </div><div class="line">                || (r.files[idx].extra_data.equal_count / r.files[idx].extra_data.total_line_count &lt; <span class="number">0.2</span>))) &#123;</div><div class="line">            newInsert = <span class="literal">true</span></div><div class="line">        &#125;</div><div class="line">        <span class="comment">/*if('/src/app/vtp-common/StartOrder.pm' == fileID) &#123;</span></div><div class="line"><span class="comment">            l.debug("set start order to true")</span></div><div class="line"><span class="comment">            newInsert = true</span></div><div class="line"><span class="comment">        &#125;*/</span></div><div class="line">        files.push(&#123;<span class="string">'fileDiffID'</span>:r.files[idx].id, <span class="string">'name'</span>: name, <span class="string">'fileID'</span>: fileID, <span class="string">'newInsert'</span>: newInsert, <span class="string">'patchedFileURL'</span>: r.files[idx].links.patched_file.href&#125;)</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    <span class="keyword">return</span> <span class="number">0</span> == files.length ? <span class="literal">null</span> : files</div><div class="line">&#125;</div><div class="line"> </div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">responseBodyParse</span>(<span class="params">text</span>) </span>&#123;</div><div class="line">    <span class="keyword">var</span> r</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        r = <span class="built_in">JSON</span>.parse(text);</div><div class="line">    &#125; <span class="keyword">catch</span>(e) &#123;</div><div class="line">        <span class="comment">//not a json object, just common text</span></div><div class="line">        <span class="keyword">return</span> text</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    <span class="comment">//if codereview return a json, filter invalid stat</span></div><div class="line">    <span class="keyword">if</span>(r.stat &amp;&amp; <span class="string">'ok'</span> != r.stat) &#123;</div><div class="line">        l.error(<span class="string">'&lt;'</span>+url+<span class="string">'&gt; invalid response: '</span> + text)</div><div class="line">        <span class="keyword">return</span> <span class="literal">null</span></div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    <span class="keyword">return</span> r</div><div class="line">&#125;</div><div class="line"> </div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">responseParse</span>(<span class="params">url, error, response</span>) </span>&#123;</div><div class="line">    <span class="comment">//error occur</span></div><div class="line">    <span class="keyword">if</span>(error) &#123;</div><div class="line">        l.error(<span class="string">'&lt;'</span>+url+<span class="string">'&gt; error: '</span> + error)</div><div class="line">        <span class="keyword">return</span> <span class="literal">null</span></div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">//status code not right</span></div><div class="line">    <span class="keyword">if</span>(response.statusCode &lt; <span class="number">200</span> || response.statusCode &gt;= <span class="number">300</span>) &#123;</div><div class="line">        l.debug(<span class="string">'&lt;'</span>+url+<span class="string">'&gt; invalid status: '</span> + response.statusCode + <span class="string">' body: '</span> + response.body)</div><div class="line">        <span class="keyword">return</span> <span class="literal">null</span></div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    <span class="keyword">return</span> responseBodyParse(response.body)</div><div class="line">&#125;</div><div class="line"> </div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">diffStat</span>(<span class="params">reviewID, diffIdx, cb</span>) </span>&#123;</div><div class="line">    <span class="keyword">var</span> url = reviewURI+<span class="string">'api/review-requests/'</span>+reviewID+<span class="string">'/diffs/'</span>+diffIdx + <span class="string">'/'</span></div><div class="line">    request.get(&#123;<span class="attr">url</span>:url, <span class="attr">auth</span>:reviewRequestOption.auth&#125;, <span class="function"><span class="keyword">function</span>(<span class="params">error, response</span>)</span>&#123;</div><div class="line">        <span class="keyword">var</span> r = responseParse(url, error, response)</div><div class="line">        <span class="keyword">return</span> cb(<span class="number">0</span>, r ? &#123;<span class="string">'modifyTime'</span>: r.diff.timestamp, <span class="string">'filesURL'</span>: r.diff.links.files.href&#125; : <span class="literal">null</span>)</div><div class="line">    &#125;)</div><div class="line">&#125;</div><div class="line"> </div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">diffPatchedFiles</span>(<span class="params">url, cb</span>) </span>&#123;</div><div class="line">    request.get(&#123;<span class="attr">url</span>:url, <span class="attr">auth</span>:reviewRequestOption.auth&#125;, <span class="function"><span class="keyword">function</span>(<span class="params">error, response</span>)</span>&#123;</div><div class="line">        <span class="keyword">return</span> cb(<span class="number">0</span>, diffFilesParse(url, responseParse(url, error, response)))</div><div class="line">    &#125;)</div><div class="line">&#125;</div><div class="line"> </div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">syntexCheck</span>(<span class="params">path, check</span>) </span>&#123;</div><div class="line">    <span class="keyword">var</span> checkCmd = <span class="literal">null</span></div><div class="line">    <span class="keyword">if</span> (<span class="string">'log'</span> == check) &#123;</div><div class="line">        checkCmd = <span class="string">'perlcritic -s CodeLayout::RequireLogStatment '</span> + path</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">'l4'</span> == check) &#123;</div><div class="line">        checkCmd = <span class="string">'perlcritic -4 --verbose 8 '</span> + path</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">'all'</span> == check) &#123;</div><div class="line">        checkCmd = <span class="string">'perlcritic --verbose 8 '</span> + path</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        checkCmd = check + path</div><div class="line">    &#125;</div><div class="line">    l.debug(checkCmd)</div><div class="line"> </div><div class="line">    <span class="keyword">var</span> checkResp</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        checkResp = p.execSync(checkCmd).toString()</div><div class="line">    &#125; <span class="keyword">catch</span>(e) &#123;</div><div class="line">        checkResp = e.stdout.toString()</div><div class="line">    &#125;</div><div class="line">    fs.unlinkSync(path)</div><div class="line">    <span class="keyword">return</span> commentsParse(checkResp)</div><div class="line">&#125;</div><div class="line"> </div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">writeContent</span>(<span class="params">content, filePath</span>) </span>&#123;</div><div class="line">    mkdirsSync(path.dirname(filePath))</div><div class="line">    fs.writeFileSync(filePath, content)</div><div class="line">&#125;</div><div class="line"> </div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">commentPost</span>(<span class="params">url, fileDiffID, line, text, cb</span>) </span>&#123;</div><div class="line">    <span class="comment">// post file's ERROR check information to the server</span></div><div class="line">    <span class="comment">// @see https://www.reviewboard.org/docs/manual/dev/webapi/2.0/resources/review-diff-comment-list/</span></div><div class="line">    <span class="keyword">var</span> comment = &#123;&#125;</div><div class="line">    comment.api_format   = <span class="string">'json'</span></div><div class="line">    comment.num_lines    = <span class="number">1</span></div><div class="line">    comment.filediff_id  = fileDiffID</div><div class="line">    comment.issue_opened = <span class="literal">true</span></div><div class="line">    comment.text_type    = <span class="string">'plain'</span></div><div class="line">    comment.first_line   = line</div><div class="line">    comment.text         = text</div><div class="line">    request.post(&#123;<span class="attr">url</span>:url, <span class="attr">form</span>: comment, <span class="attr">auth</span>:reviewRequestOption.auth&#125;, <span class="function"><span class="keyword">function</span>(<span class="params">error, response</span>)</span>&#123;</div><div class="line">        <span class="keyword">var</span> r = responseParse(url, error, response)</div><div class="line">        <span class="keyword">if</span>(r) &#123;</div><div class="line">            l.info(<span class="string">'comment success: '</span> + text)</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            l.error(<span class="string">'comment failed: '</span> + text)</div><div class="line">        &#125;</div><div class="line">        cb(<span class="number">0</span>, r)</div><div class="line">    &#125;)</div><div class="line">&#125;</div><div class="line"> </div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">diffPatchedFileCheck</span>(<span class="params">diff, check, cb</span>) </span>&#123;</div><div class="line">    request.get(&#123;<span class="attr">url</span>:diff.patchedFileURL, <span class="attr">auth</span>:reviewRequestOption.auth&#125;, <span class="function"><span class="keyword">function</span>(<span class="params">error, response</span>)</span>&#123;</div><div class="line">        <span class="comment">//download file</span></div><div class="line">        <span class="keyword">var</span> fileContent = responseParse(diff.patchedFileURL, error, response)</div><div class="line">        <span class="keyword">if</span>(<span class="literal">null</span> == fileContent) &#123;</div><div class="line">            l.error(<span class="string">'&lt;'</span>+diff.patchedFileURL+<span class="string">'&gt; download file content failed'</span>)</div><div class="line">            <span class="keyword">return</span> cb(<span class="number">0</span>, <span class="literal">null</span>)</div><div class="line">        &#125;</div><div class="line"> </div><div class="line">        <span class="comment">//write download file to filesystem</span></div><div class="line">        <span class="keyword">var</span> patchedFileDir = outDir + <span class="string">'/'</span> + diff.fileDiffID</div><div class="line">        <span class="keyword">var</span> patchedFilePath = patchedFileDir + <span class="string">'/'</span> + diff.name</div><div class="line"> </div><div class="line">        writeContent(fileContent, patchedFilePath)</div><div class="line">        l.debug(<span class="string">'&lt;'</span>+diff.patchedFileURL+<span class="string">'&gt; download to "'</span> + patchedFilePath + <span class="string">'"'</span>)</div><div class="line">        </div><div class="line">        <span class="keyword">var</span> comments = syntexCheck(patchedFilePath, check)</div><div class="line">        <span class="comment">//clean download resource</span></div><div class="line">        fs.rmdirSync(patchedFileDir)</div><div class="line">        <span class="keyword">return</span> cb(<span class="number">0</span>, comments)</div><div class="line">    &#125;)</div><div class="line">&#125;</div><div class="line"> </div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">culminate</span>(<span class="params">lastStat</span>) </span>&#123;</div><div class="line">    <span class="keyword">var</span> desc = <span class="string">''</span></div><div class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> fileID <span class="keyword">in</span> lastStat) &#123;</div><div class="line">        <span class="keyword">if</span>(lastStat[fileID].IsNewInsert &amp;&amp; lastStat[fileID].ErrorCount &gt; <span class="number">0</span>) &#123;</div><div class="line">            <span class="built_in">console</span>.error(<span class="string">'@'</span> + fileID + <span class="string">' '</span> + lastStat[fileID].ErrorCount + <span class="string">' errors need check'</span>)</div><div class="line">            process.exitCode = <span class="number">2</span></div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="built_in">console</span>.log(<span class="string">'@'</span> + fileID + <span class="string">' '</span> + lastStat[fileID].ErrorCount + <span class="string">' errors'</span>)</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"> </div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">workLog</span>(<span class="params">type, s</span>) </span>&#123;</div><div class="line">    <span class="keyword">var</span> split = <span class="string">' '</span></div><div class="line">    <span class="keyword">var</span> record = <span class="literal">null</span></div><div class="line"> </div><div class="line">    <span class="keyword">if</span> (<span class="string">'diff'</span> == type) &#123;</div><div class="line">        <span class="keyword">if</span>(s.PostErrorCount &gt; <span class="number">0</span>) &#123;</div><div class="line">            record = s.CheckTime + split + s.DiffTime + split + s.ReviewID + split + s.DiffIndex + split + s.FileDiffID + split + (s.IsNewInsert?<span class="number">1</span>:<span class="number">0</span>) + split + s.ErrorCount + split + s.PostErrorCount + split + s.Name + <span class="string">'\n'</span></div><div class="line">        &#125;</div><div class="line">        <span class="comment">//l.debug('CheckTime DiffTime ReviewID DiffIndex FileDiffID IsNewInsert ErrorCount PostErrorCount Name')</span></div><div class="line">    &#125;</div><div class="line">    l.debug(<span class="built_in">JSON</span>.stringify(s))</div><div class="line">    <span class="keyword">if</span>(record &amp;&amp; sessionDir) &#123;</div><div class="line">        fs.appendFileSync(sessionDir+<span class="string">'/'</span>+type, record)</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"> </div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">onDeleteComments</span>(<span class="params">reviewID</span>) </span>&#123;</div><div class="line">    suspend(<span class="function"><span class="keyword">function</span>*(<span class="params"></span>) </span>&#123;</div><div class="line">        <span class="keyword">var</span> url = reviewURI+<span class="string">'api/review-requests/'</span>+reviewID+<span class="string">'/reviews/'</span></div><div class="line"> </div><div class="line">        <span class="keyword">var</span> postsResponse = <span class="keyword">yield</span> request.get(url+<span class="string">'?start=0&amp;max-results=500'</span>, reviewRequestOption, resume())</div><div class="line">        <span class="keyword">var</span> posts = responseBodyParse(postsResponse.body)</div><div class="line">        <span class="keyword">var</span> regex = <span class="regexp">/at line ([0-9]+),/</span></div><div class="line"> </div><div class="line">        l.debug(<span class="string">'review '</span> + reviewID + <span class="string">' already has '</span> + posts.total_results + <span class="string">' comment posts, need to iterator delete'</span>)</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> idxPost = <span class="number">0</span>; idxPost &lt; posts.reviews.length; ++idxPost) &#123;</div><div class="line">            <span class="keyword">var</span> urlc = posts.reviews[idxPost].links.diff_comments.href</div><div class="line">            <span class="keyword">var</span> commentsResponse = <span class="keyword">yield</span> request.get(urlc+<span class="string">'?start=0&amp;max-results=5000'</span>, reviewRequestOption, resume())</div><div class="line">            <span class="keyword">var</span> rc = responseBodyParse(commentsResponse.body)</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">var</span> idxComment = <span class="number">0</span>; idxComment &lt; rc.diff_comments.length; ++idxComment) &#123;</div><div class="line">                <span class="keyword">var</span> comment=rc.diff_comments[idxComment]</div><div class="line">                <span class="keyword">if</span>(comment.text.match(regex)) &#123;</div><div class="line">                    <span class="keyword">var</span> commentURL=comment.links.delete.href</div><div class="line">                    l.debug(<span class="string">'&lt;'</span> + commentURL + <span class="string">'&gt;'</span> + <span class="string">' delete '</span> + comment.text)</div><div class="line">                    request.delete(&#123;<span class="attr">url</span>:commentURL, <span class="attr">auth</span>:reviewRequestOption.auth&#125;, <span class="function"><span class="keyword">function</span>(<span class="params">error, response</span>)</span>&#123;</div><div class="line">                        l.debug(<span class="string">' delete '</span> + response.body + (error?(<span class="string">"failed: "</span> + error): <span class="string">""</span>))</div><div class="line">                    &#125;)</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;)()</div><div class="line">&#125;</div><div class="line"> </div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">commentsFill</span>(<span class="params">url, comments, cb</span>) </span>&#123;</div><div class="line">    request.get(&#123;<span class="attr">url</span>:url, <span class="attr">auth</span>:reviewRequestOption.auth&#125;, <span class="function"><span class="keyword">function</span>(<span class="params">error, response</span>)</span>&#123;</div><div class="line">        <span class="keyword">var</span> r = responseParse(url, error, response)</div><div class="line">        <span class="keyword">if</span>(<span class="literal">null</span> == r) &#123;</div><div class="line">            l.error(<span class="string">'&lt;'</span>+url+<span class="string">'&gt; comments parse failed'</span>)</div><div class="line">            <span class="keyword">return</span> cb(<span class="number">0</span>, <span class="literal">null</span>)</div><div class="line">        &#125;</div><div class="line">        l.debug(<span class="string">'&lt;'</span>+url+<span class="string">'&gt; '</span> + r.diff_comments.length + <span class="string">' comments'</span>)</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> idxComment = <span class="number">0</span>; idxComment &lt; r.diff_comments.length; ++idxComment) &#123;</div><div class="line">            <span class="keyword">var</span> fileDiffID = extractLastURLToken(r.diff_comments[idxComment].links.filediff.href)</div><div class="line">            <span class="keyword">if</span>(fileDiffID) &#123;</div><div class="line">                comments[fileDiffID + <span class="string">'.'</span> + r.diff_comments[idxComment].first_line] = r.diff_comments[idxComment].text</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> cb(<span class="number">0</span>, r.links.next?r.links.next.href:<span class="literal">null</span>)</div><div class="line">    &#125;)</div><div class="line">&#125;</div><div class="line"> </div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">onRetrive</span>(<span class="params">reviewID, check</span>) </span>&#123;</div><div class="line">    suspend(<span class="function"><span class="keyword">function</span>*(<span class="params"></span>) </span>&#123;</div><div class="line">        <span class="keyword">var</span> url = reviewURI+<span class="string">'api/review-requests/'</span>+reviewID+<span class="string">'/reviews/'</span></div><div class="line">        <span class="keyword">var</span> lastStat = &#123;&#125;</div><div class="line">        <span class="keyword">var</span> commentID = <span class="literal">null</span></div><div class="line">        <span class="keyword">var</span> comments = <span class="literal">null</span></div><div class="line"> </div><div class="line">        <span class="comment">// iterator all diffs</span></div><div class="line">        <span class="keyword">var</span> diffIdx = <span class="number">1</span></div><div class="line">        <span class="keyword">for</span> (; diffIdx &lt; <span class="number">20</span>; ++diffIdx) &#123;</div><div class="line">            <span class="keyword">var</span> stat = <span class="keyword">yield</span> diffStat(reviewID, diffIdx, resume())</div><div class="line">            <span class="keyword">if</span>(<span class="literal">null</span> == stat) &#123;</div><div class="line">                l.debug(<span class="string">'diff '</span> + reviewID + <span class="string">'/'</span> + diffIdx + <span class="string">' stat not ok, reach the end'</span>)</div><div class="line">                <span class="keyword">break</span></div><div class="line">            &#125;</div><div class="line"> </div><div class="line">            <span class="keyword">var</span> patchedFiles = <span class="keyword">yield</span> diffPatchedFiles(stat.filesURL, resume())</div><div class="line">            <span class="keyword">if</span>(<span class="literal">null</span> == patchedFiles) &#123;</div><div class="line">                l.debug(<span class="string">'&lt;'</span>+stat.filesURL+<span class="string">'&gt; no patched files should be check'</span>)</div><div class="line">                <span class="keyword">continue</span></div><div class="line">            &#125;</div><div class="line"> </div><div class="line">            <span class="keyword">for</span> (<span class="keyword">var</span> idx <span class="keyword">in</span> patchedFiles) &#123;</div><div class="line">                <span class="keyword">var</span> patched = patchedFiles[idx]</div><div class="line">                <span class="keyword">var</span> eCount = <span class="number">0</span></div><div class="line">                <span class="keyword">var</span> posteCount = <span class="number">0</span></div><div class="line"> </div><div class="line">                <span class="keyword">var</span> lines = <span class="keyword">yield</span> diffPatchedFileCheck(patched, check, resume())</div><div class="line">                <span class="keyword">for</span>(<span class="keyword">var</span> line <span class="keyword">in</span> lines) &#123;</div><div class="line">                    <span class="comment">//lazy find old comments</span></div><div class="line">                    <span class="keyword">if</span>(<span class="literal">null</span> == comments) &#123;</div><div class="line">                        comments = &#123;&#125;</div><div class="line">                        <span class="keyword">var</span> postsResponse = <span class="keyword">yield</span> request.get(url+<span class="string">'?start=0&amp;max-results=500'</span>, reviewRequestOption, resume())</div><div class="line">                        <span class="keyword">var</span> posts = responseBodyParse(postsResponse.body)</div><div class="line">                        l.debug(<span class="string">'review '</span> + reviewID + <span class="string">' already has '</span> + posts.total_results + <span class="string">' comment posts'</span>)</div><div class="line">                        <span class="keyword">for</span> (<span class="keyword">var</span> idxPost = <span class="number">0</span>; idxPost &lt; posts.reviews.length; ++idxPost) &#123;</div><div class="line">                            <span class="keyword">var</span> nextURL = posts.reviews[idxPost].links.diff_comments.href+<span class="string">'?start=0&amp;max-results=5000'</span></div><div class="line">                            <span class="keyword">while</span>(nextURL) &#123;</div><div class="line">                                nextURL = <span class="keyword">yield</span> commentsFill(nextURL, comments, resume())</div><div class="line">                            &#125;</div><div class="line">                        &#125;</div><div class="line">                        <span class="comment">//l.debug(JSON.stringify(comments))</span></div><div class="line">                    &#125;</div><div class="line">                    <span class="keyword">var</span> commentIdx = patched.fileDiffID+<span class="string">'.'</span>+line</div><div class="line">                    <span class="keyword">if</span>(comments[commentIdx]) &#123;</div><div class="line">                        l.debug(<span class="string">'already exists comments '</span> + commentIdx + <span class="string">': '</span> + comments[commentIdx] </div><div class="line">                            + ((lines[line] == comments[commentIdx])?<span class="string">''</span>:(<span class="string">' =&gt; '</span> + lines[line])))</div><div class="line">                    &#125; <span class="keyword">else</span> &#123;</div><div class="line">                        <span class="comment">//lazy request commentID</span></div><div class="line">                        <span class="keyword">if</span>(<span class="literal">null</span> == commentID) &#123;</div><div class="line">                            <span class="keyword">var</span> data = <span class="keyword">yield</span> request.post(url, reviewRequestOption, resume())</div><div class="line">                            commentID = commentIDParse(data.body)</div><div class="line">                        &#125;</div><div class="line">                        <span class="keyword">yield</span> commentPost(url+commentID+<span class="string">'/diff-comments/'</span>, patched.fileDiffID, line, lines[line], resume())</div><div class="line">                        ++posteCount</div><div class="line">                    &#125;</div><div class="line">                    ++eCount</div><div class="line">                &#125;</div><div class="line"> </div><div class="line">                lastStat[patched.fileID] = &#123;</div><div class="line">                    <span class="string">'ReviewID'</span>: reviewID,</div><div class="line">                    <span class="string">'DiffIndex'</span>: diffIdx,</div><div class="line">                    <span class="string">'FileDiffID'</span>: patched.fileDiffID,</div><div class="line">                    <span class="string">'IsNewInsert'</span>: ((lastStat[patched.fileID]?lastStat[patched.fileID].IsNewInsert:<span class="literal">false</span>) || patched.newInsert),</div><div class="line">                    <span class="string">'ErrorCount'</span>: eCount,</div><div class="line">                    <span class="string">'PostErrorCount'</span>: posteCount,</div><div class="line">                    <span class="string">'DiffTime'</span>: moment(stat.modifyTime).local().format(<span class="string">'YYYY-MM-DD HH:mm:ss'</span>),</div><div class="line">                    <span class="string">'CheckTime'</span>: moment().format(<span class="string">'YYYY-MM-DD HH:mm:ss'</span>),</div><div class="line">                    <span class="string">'Name'</span>: patched.fileID,</div><div class="line">                &#125;</div><div class="line"> </div><div class="line">                workLog(<span class="string">'diff'</span>, lastStat[patched.fileID])</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        <span class="keyword">if</span>(<span class="literal">null</span> != commentID) &#123;</div><div class="line">            commentsCommit(reviewID, commentID)</div><div class="line">        &#125;</div><div class="line"> </div><div class="line">        workLog(<span class="string">'review'</span>, lastStat)</div><div class="line">        culminate(lastStat)</div><div class="line">    &#125;)()</div><div class="line">&#125;</div><div class="line"> </div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">main</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="keyword">var</span> param = <span class="built_in">require</span>(<span class="string">'commander'</span>)</div><div class="line">    param</div><div class="line">        .version(<span class="string">'2016.08.06'</span>)</div><div class="line">        .description(<span class="string">'Review Board manage tool'</span>)</div><div class="line">        .option(<span class="string">'-s, --rserver &lt;addr&gt;'</span>, <span class="string">'Review Board server address, default is [127.0.0.1]'</span>, <span class="string">'127.0.0.1'</span>)</div><div class="line">        .option(<span class="string">'-u, --ruser &lt;username&gt;'</span>, <span class="string">'Review Board server login username, default is [root]'</span>, <span class="string">'root'</span>)</div><div class="line">        .option(<span class="string">'-p, --rpass &lt;password&gt;'</span>, <span class="string">'Review Board server login password, default is []'</span>, <span class="string">''</span>)</div><div class="line">        .option(<span class="string">'--flog'</span>, <span class="string">'log to file'</span>)</div><div class="line"> </div><div class="line">        .option(<span class="string">'-r, --reviewID &lt;id&gt;'</span>, <span class="string">'@retrive Review ID'</span>)</div><div class="line">        .option(<span class="string">'--check &lt;cmd&gt;'</span>, <span class="string">'@retrive check command, can be "log" "l4" "all" "\$userdef", default is [log]'</span>, <span class="string">'log'</span>)</div><div class="line">        .option(<span class="string">'--session [dir]'</span>, <span class="string">'@retrive session record dir, default no session and session dir is [/etc/rb]'</span>, <span class="string">'/etc/rb'</span>)</div><div class="line"> </div><div class="line">    param</div><div class="line">        .command(<span class="string">'retrive [env]'</span>)</div><div class="line">        .description(<span class="string">'Retrive all original/patched files special by reviewid'</span>)</div><div class="line">        </div><div class="line">        .action(<span class="function"><span class="keyword">function</span>(<span class="params">env, options</span>)</span>&#123;</div><div class="line">            <span class="keyword">if</span>(!optParse(options.parent)) &#123;</div><div class="line">                <span class="built_in">console</span>.log(<span class="string">"opt parse failed"</span>)</div><div class="line">                process.exit(<span class="number">1</span>)</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span>(!options.parent.reviewID) &#123;</div><div class="line">                <span class="built_in">console</span>.log(<span class="string">"reviewid is required"</span>)</div><div class="line">                process.exit(<span class="number">1</span>)</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span>(strArrBeginWith(options.parent.rawArgs, <span class="string">'--session'</span>)) &#123;</div><div class="line">                sessionDir = options.parent.session</div><div class="line">                mkdirsSync(sessionDir)</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">var</span> check=options.parent.check</div><div class="line">            onRetrive(<span class="built_in">parseInt</span>(options.parent.reviewID), check)</div><div class="line">        &#125;)</div><div class="line"> </div><div class="line">    param</div><div class="line">        .command(<span class="string">'delcomment [env]'</span>)</div><div class="line">        .description(<span class="string">'Delete all comments submited by this tool'</span>)</div><div class="line">        .action(<span class="function"><span class="keyword">function</span>(<span class="params">env, options</span>)</span>&#123;</div><div class="line">            <span class="keyword">if</span>(!optParse(options.parent)) &#123;</div><div class="line">                <span class="built_in">console</span>.log(<span class="string">"opt parse failed"</span>)</div><div class="line">                process.exit(<span class="number">1</span>)</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span>(!options.parent.reviewID) &#123;</div><div class="line">                <span class="built_in">console</span>.log(<span class="string">"reviewid is required"</span>)</div><div class="line">                process.exit(<span class="number">1</span>)</div><div class="line">            &#125;</div><div class="line"> </div><div class="line">            onDeleteComments(<span class="built_in">parseInt</span>(options.parent.reviewID))</div><div class="line">        &#125;)</div><div class="line">    param.parse(process.argv)</div><div class="line">&#125;</div><div class="line"> </div><div class="line">main()</div></pre></td></tr></table></figure></p>
<p>此rbjob工具支持如下参数：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span> ./rbjob --help</div><div class="line"></div><div class="line">  Usage: rbjob [options] [command]</div><div class="line"></div><div class="line">  Commands:</div><div class="line"></div><div class="line">    retrive [env]     Retrive all original/patched files special by reviewid</div><div class="line">    delcomment [env]  Delete all comments submited by this tool</div><div class="line"></div><div class="line">  Review Board manage tool</div><div class="line"></div><div class="line">  Options:</div><div class="line"></div><div class="line">    -h, --help              output usage information</div><div class="line">    -V, --version           output the version number</div><div class="line">    -s, --rserver &lt;addr&gt;    Review Board server address, default is [127.0.0.1]</div><div class="line">    -u, --ruser &lt;username&gt;  Review Board server login username, default is [root]</div><div class="line">    -p, --rpass &lt;password&gt;  Review Board server login password, default is []</div><div class="line">    --flog                  log to file</div><div class="line">    -r, --reviewID &lt;id&gt;     @retrive Review ID</div><div class="line">    --check &lt;cmd&gt;           @retrive check command, can be "log" "l4" "all" "$userdef", default is [log]</div><div class="line">    --session [dir]         @retrive session record dir, default no session and session dir is [/etc/rb]</div></pre></td></tr></table></figure></p>
<p>rbjob运行效果：<br><img src="/2016/09/12/auto-codereview-machine/3.rbjob-console.png" alt="rbjob-console"></p>
<p>剥去日志，输出类似：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">@/src/app/vtp-common/MutexVMs.pm 0 errors</div><div class="line">@/src/app/vtp-common/StartOrder.pm 1 errors</div><div class="line">@/src/app/vtp-qemu-server/VTP/QemuHugePages.pm 9 errors</div><div class="line">@/Test.pm 80 errors need check</div></pre></td></tr></table></figure></p>
<p>检测到错误会打印xx errors，如果是xx errors need check表示检测到错误且是一个新增文件或者改动超过80%的文件，之所以如此，是因为遗留代码不宜强制程序员修改，而新增代码强制要求符合规则比较容易推动。</p>
<p>上述具体的错误信息自动提交到reviewboard上，comments列表效果如：<br><img src="/2016/09/12/auto-codereview-machine/4.comments-list.png" alt="comments-list"></p>
<p>具体错误信息如：<br><img src="/2016/09/12/auto-codereview-machine/5.comment-detail.png" alt="comment-detail"></p>
<p>以上错误信息还会发送到内部邮件：<br><img src="/2016/09/12/auto-codereview-machine/6.comments-mail.png" alt="comments-mail"></p>
<h1 id="自动扫描"><a href="#自动扫描" class="headerlink" title="自动扫描"></a>自动扫描</h1><p>rbjob实现了根据reviewID自动下载代码，然后运行工具检测告警，然后将告警自动提交成review comments，但是需要人工来调用rbjob才能执行，如何做到自动在后台监控？<br>找了一下reviewboard没有提供最进改动review列表API，但是从页面上看有此功能，于是用curl定时将最近改动列表抓下来，然后自动调用rbjob，此脚本取名rbeye:<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span>!/bin/bash</div><div class="line"><span class="meta">#</span> monitor code submit and auto check</div><div class="line"><span class="meta">#</span>     su -c "./rbeye &gt;&gt;/var/log/rb/eye.$(date +%F).log 2&gt;&amp;1" www-data</div><div class="line"><span class="meta">#</span> @author mnstory.net</div><div class="line"><span class="meta">#</span> @version 20160910 - auto check by page list</div><div class="line"> </div><div class="line">if [ -f "$0" ]; then</div><div class="line">    SCRIPTDIR=$(dirname $(realpath $0 2&gt;/dev/null) 2&gt;/dev/null)</div><div class="line">fi</div><div class="line">if [ -z "$SCRIPTDIR" ]; then</div><div class="line">    SCRIPTDIR=.</div><div class="line">fi</div><div class="line"> </div><div class="line">rb_username="root"</div><div class="line">rb_password=""</div><div class="line">rb_baseurl="http://127.0.0.1"</div><div class="line">rb_tmpdir="/tmp/rb/"</div><div class="line"> </div><div class="line">ldebug()</div><div class="line">&#123;</div><div class="line">    echo -e $(date +"%F %T") "$$ $@" 1&gt;&amp;2</div><div class="line">&#125;</div><div class="line"> </div><div class="line">coolywork()</div><div class="line">&#123;</div><div class="line">    local timeafter=$1</div><div class="line">    local cookies="$&#123;rb_tmpdir&#125;cookies.txt"</div><div class="line">    local home="$&#123;rb_tmpdir&#125;home.txt"</div><div class="line">    local rid_records="$&#123;rb_tmpdir&#125;rid_records.txt"</div><div class="line">    local curlcmd="curl -v -c $cookies -b $cookies"</div><div class="line"> </div><div class="line">    mkdir -p "$rb_tmpdir" 2&gt;/dev/null</div><div class="line">    rm -f "$cookies" 2&gt;/dev/null</div><div class="line"> </div><div class="line">    $curlcmd $rb_baseurl/account/login/ &gt;/dev/null 2&gt;&amp;1</div><div class="line">    local csrf=$(cat $cookies | grep csrftoken | awk '&#123;print $7&#125;')    </div><div class="line">    $curlcmd -d "username=$&#123;rb_username&#125;&amp;password=$&#123;rb_password&#125;&amp;csrfmiddlewaretoken=$&#123;csrf&#125;" $rb_baseurl/account/login/ &gt;/dev/null 2&gt;&amp;1</div><div class="line">    $curlcmd -H 'Pragma:no-cache; Cache-Control:no-cache' $rb_baseurl/r/ 2&gt;/dev/null &gt; "$home"</div><div class="line">    cat "$home" | grep -oP '&lt;a href="/r/\d+/"&gt;.*&lt;/div&gt;|datetime=".*"' | awk -F/ '&#123;id=$3; getline T; t=substr(T,11,22); print id,t&#125;' &gt; "$rid_records"</div><div class="line"> </div><div class="line">    while read line; do</div><div class="line">        local rid=$&#123;line% *&#125;</div><div class="line">        local uptime=$&#123;line#* &#125;</div><div class="line">        local uptime_sec=$(date --date="$uptime" +%s)</div><div class="line"> </div><div class="line">        if [[ -n "$timeafter" &amp;&amp; $uptime_sec -lt $timeafter ]]; then</div><div class="line">            #ldebug "by pass $rid $uptime, $uptime_sec &lt; $timeafter"</div><div class="line">            continue</div><div class="line">        fi</div><div class="line">        local rbjobcmd="$SCRIPTDIR/rbjob --flog -r $rid retrive --session --check l4"</div><div class="line">        ldebug "$rbjobcmd (at $uptime, start)"</div><div class="line">        $rbjobcmd</div><div class="line">        lasterr=$?</div><div class="line">        ldebug "$rbjobcmd (exit $lasterr)"</div><div class="line">    done &lt; "$rid_records"</div><div class="line"> </div><div class="line">    return 0</div><div class="line">&#125;</div><div class="line"> </div><div class="line">main()</div><div class="line">&#123;</div><div class="line">    if [ "?" = "$1" ]; then</div><div class="line">        echo "$0 [timeafter]"</div><div class="line">        return 1</div><div class="line">    fi</div><div class="line"> </div><div class="line">    local timeafter=""</div><div class="line">    if [ -n "$1" ]; then</div><div class="line">        timeafter=$(date --date="$timeafter" +%s)</div><div class="line">    #else</div><div class="line">    #    timeafter=$(date +%s)</div><div class="line">    fi</div><div class="line">    </div><div class="line">    while : ; do </div><div class="line">        local timecheckpoint=$(date +%s)</div><div class="line">        coolywork $timeafter</div><div class="line">        sleep 15</div><div class="line">        timeafter=$timecheckpoint</div><div class="line">    done</div><div class="line"> </div><div class="line">    return 0</div><div class="line">&#125;</div><div class="line"></div><div class="line">main "$@"</div></pre></td></tr></table></figure></p>
<p>运行rbeye，由于rbjob我们还会在cgi里面调用，cgi owner是www-data，www-data读写文件权限受限较多，需要特别注意不同用户操作导致权限不够情况。SSH链接进程会在SSH CLIENT退出时候SIG HUB给子进程，需要考虑，例如：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">nohup command ...</div><div class="line">screen -dmS newscreen; screen -list; screen -r newscreen; command ...</div></pre></td></tr></table></figure></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">pkill rbeye; pkill rbjob; ps auxf | grep -P 'rbeye|rbjob'</div><div class="line">rm -rf /var/log/rb /tmp/rb; mkdir -p /var/log/rb /etc/rb /tmp/rb; chmod 777 /var/log/rb /etc/rb /tmp/rb; chown www-data -R /var/log/rb /etc/rb /tmp/rb</div><div class="line">nohup su -c "./rbeye &gt;&gt;/var/log/rb/eye.$(date +%F).log 2&gt;&amp;1" www-data &amp;</div><div class="line">tail -f ../log/review-debug.log /var/log/rb/*.log</div></pre></td></tr></table></figure>
<h1 id="SVN-PRE-COMMIT"><a href="#SVN-PRE-COMMIT" class="headerlink" title="SVN PRE-COMMIT"></a>SVN PRE-COMMIT</h1><p>为了在SVN上库流程卡主代码，需要对svn提交做HOOK，将svn pre-commit通过网络请求转发到自动检测代码，这段流程已经有，在已有的reviewboard HOOK脚本处添加检测调用：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> subprocess</div><div class="line"></div><div class="line">syntexcmd = <span class="string">"rbjob -r "</span>+str(rid)+<span class="string">" retrive --check log --flog 2&gt;&amp;1"</span></div><div class="line">checkResult = subprocess.Popen(syntexcmd, shell=<span class="keyword">True</span>, stdout=subprocess.PIPE).stdout.read()</div><div class="line"><span class="keyword">if</span> <span class="string">"errors need check"</span> <span class="keyword">in</span> checkResult:</div><div class="line">    <span class="keyword">raise</span> SvnError, <span class="string">"reviewid %s has syntex errors, %s"</span> % (rid, checkResult)</div><div class="line">debug(syntexcmd + <span class="string">" =&gt; "</span> + checkResult)</div></pre></td></tr></table></figure></p>
<p>这里检测是否有错是检测输出里面是否有”errors need check”，且检测标准和rbeye里面的有所不同，这里检测的是log，rbeye里面检测的是l4，如前面所述，只对判定为新增文件的PERL代码做强制要求，不符合规定就无法上库，所以，这里控制了报错，只要求新增代码做日志规范。阻止上库效果：<br><img src="/2016/09/12/auto-codereview-machine/7.submit-error.png" alt="submit-error"><br>此时，你需要打开reviewboard查看并处理相应的错误，然后重新提交改动后的代码到同一review,如果没有错误了，下次提交会顺利通过。</p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Shell/" rel="tag"># Shell</a>
          
            <a href="/tags/缺陷预防/" rel="tag"># 缺陷预防</a>
          
            <a href="/tags/Perl/" rel="tag"># Perl</a>
          
            <a href="/tags/Node-js/" rel="tag"># Node.js</a>
          
            <a href="/tags/CodeReview/" rel="tag"># CodeReview</a>
          
            <a href="/tags/工具/" rel="tag"># 工具</a>
          
            <a href="/tags/代码检査/" rel="tag"># 代码检査</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2016/07/26/simple-perl-unittest-lib/" rel="next" title="PERL单元测试简易框架">
                <i class="fa fa-chevron-left"></i> PERL单元测试简易框架
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2016/11/03/write-a-daemon-process/" rel="prev" title="写一个daemon进程">
                写一个daemon进程 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          
            <p class="site-author-name" itemprop="name">mnstory.net</p>
            <p class="site-description motion-element" itemprop="description"></p>
        </div>

        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
            
              <a href="/archives/">
            
                <span class="site-state-item-count">28</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">51</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#检测规则"><span class="nav-number">1.</span> <span class="nav-text">检测规则</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#日志检测插件与效果"><span class="nav-number">2.</span> <span class="nav-text">日志检测插件与效果</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#根据reviewID扫描并提交reviewboard"><span class="nav-number">3.</span> <span class="nav-text">根据reviewID扫描并提交reviewboard</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#自动扫描"><span class="nav-number">4.</span> <span class="nav-text">自动扫描</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#SVN-PRE-COMMIT"><span class="nav-number">5.</span> <span class="nav-text">SVN PRE-COMMIT</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">mnstory.net</span>

  
</div>



        
<div class="busuanzi-count">
  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv">
      <i class="fa fa-user"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      
    </span>
  

  
    <span class="site-pv">
      <i class="fa fa-eye"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      
    </span>
  
</div>








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.2"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.2"></script>



  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.2"></script>


  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.2"></script>



  


  




	





  





  








  




  





  

  

  

  

  

  


  <!-- 背景动画 -->
  <script type="text/javascript" src="/js/src/particle.js"></script>

</body>
</html>
