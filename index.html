<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.2" />






<meta name="description" content="A Programmer&apos;s Blog">
<meta property="og:type" content="website">
<meta property="og:title" content="码农故事">
<meta property="og:url" content="http://mnstory.net/index.html">
<meta property="og:site_name" content="码农故事">
<meta property="og:description" content="A Programmer&apos;s Blog">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="码农故事">
<meta name="twitter:description" content="A Programmer&apos;s Blog">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.2',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://mnstory.net/"/>





  <title>码农故事</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">码农故事</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <h1 class="site-subtitle" itemprop="description"></h1>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://mnstory.net/2018/12/20/mem-corrupt-for-file-replace/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="mnstory.net">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="码农故事">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/12/20/mem-corrupt-for-file-replace/" itemprop="url">文件替换导致进程内存损坏</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-12-20T21:00:00+08:00">
                2018-12-20
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>某客户的一台机器，无法访问文件上传端口（端口4430），但是可以访问webui端口（端口443），两者都是Apache提供的服务，只是运行时指定了不同的配置文件。</p>
<p>疑问1：为何443端口可以访问而4430端口无法访问？</p>
<p>其运行方式如：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">httpd -f 无法访问配置.conf</div></pre></td></tr></table></figure></p>
<h1 id="排除-网络原因"><a href="#排除-网络原因" class="headerlink" title="排除-网络原因"></a>排除-网络原因</h1><p>先在本机访问4430，连接上了便没了下文：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">~ $ wget --no-check-certificate https://127.0.0.1:4430/ </div><div class="line">--2018-12-19 16:36:04--  https://127.0.0.1:4430/</div><div class="line">Connecting to 127.0.0.1:4430... connected.</div></pre></td></tr></table></figure></p>
<p>由于本机也不正常，基本可排除网络方面导致的原因，例如防火墙等。</p>
<h1 id="定位-发生进程"><a href="#定位-发生进程" class="headerlink" title="定位-发生进程"></a>定位-发生进程</h1><p>查看4430关联的进程：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">~ $ netstat -nap | grep 4430          </div><div class="line">tcp6     129      0 :::4430                 :::*                    LISTEN      652/httpd</div></pre></td></tr></table></figure></p>
<p>关联进程652，其启动时间为2018-12-04 09:15:09，最开始出现SIGSEGV是在2018-12-10 11:50:24，当前时间为2018-12-20，说明进程运行了很多天了。</p>
<p>查看此apache进程的error日志，不停出现类似错误：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[Mon Dec 10 11:50:24 2018] [notice] child pid 24485 exit signal Segmentation fault (11)</div><div class="line">[Mon Dec 10 11:50:26 2018] [notice] child pid 24487 exit signal Segmentation fault (11)</div><div class="line">[Mon Dec 10 11:55:26 2018] [notice] child pid 29896 exit signal Segmentation fault (11)</div><div class="line">[Mon Dec 10 12:07:08 2018] [notice] child pid 36650 exit signal Segmentation fault (11)</div><div class="line">[Mon Dec 10 12:56:40 2018] [notice] child pid 6655 exit signal Segmentation fault (11)</div></pre></td></tr></table></figure></p>
<p>通过strace -FfTt关联，发现也是不停输出SIGSEGV。</p>
<p>没有coredump，所以通过gdb调试此进程，由于出core的是在子进程，需要“set follow-fork-mode child”，以便调试子进程。<br>发现没有glibc调试符号，安装：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">debuginfo-install glibc</div></pre></td></tr></table></figure></p>
<p>进入gdb：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div></pre></td><td class="code"><pre><div class="line">~ $ gdb -p 652</div><div class="line">(gdb) set follow-fork-mode child</div><div class="line">(gdb) c</div><div class="line">Continuing.</div><div class="line">[New process 5685]</div><div class="line">[Thread debugging using libthread_db enabled]</div><div class="line">Using host libthread_db library "/lib64/libthread_db.so.1".</div><div class="line"></div><div class="line">Program received signal SIGSEGV, Segmentation fault.</div><div class="line">[Switching to Thread 0x7f43a0379740 (LWP 5685)]</div><div class="line">(gdb) bt full n</div><div class="line"><span class="meta">#</span>0  strcmp () at ../sysdeps/x86_64/strcmp.S:135</div><div class="line">No locals.</div><div class="line"><span class="meta">#</span>1  0x00007f43a0171b13 in _dl_map_object (loader=0x7f43a037d4c8, name=name@entry=0x7fff36cbba80 "libnss_sss.so.2", type=type@entry=2, </div><div class="line">    trace_mode=trace_mode@entry=0, mode=mode@entry=-1879048191, nsid=0) at dl-load.c:2111</div><div class="line">        soname = &lt;optimized out&gt;</div><div class="line">        fd = &lt;optimized out&gt;</div><div class="line">        realname = 0x5 &lt;Address 0x5 out of bounds&gt;</div><div class="line">        l = 0x2715810</div><div class="line">        fb = &#123;len = 139928387339192, </div><div class="line">          buf = "H\263\313\066\377\177\000\000\340\370h\002\000\000\000\000\004\000\000\000\000\000\000\000\224%\027\240C\177\000\000\000\000\000\000\000\000\000\000\030\215\274\236C\177\000\000\t\000\000\000\000\000\000\000E\000\000\000\000\000\000\000\207\360\226|\000\000\000\000\313,\027\240C\177\000\000\000\000\000\000\000\000\000\000`\263\313\066\377\177\000\000\350\214\274\236C\177\000\000\350[\275\236C\177\000\000p\264\313\066\377\177\000\000`\264\313\066\377\177\000\000\a\000\000\000\000\000\000\000\000\232\017\236C\177\000\000\000\000\000\000\000\000\000\000\210\344d\002\000\000\000\000\310\324\067\240C\177\000\000]S\327\232C\177\000\000\b]\275\236C\177\000\000\360E\327\232C\177\000\000\000\000\000\000\001\000\000\000"...&#125;</div><div class="line">        found_other_class = 96</div><div class="line">        stack_end = 0x7f439de9dee6</div><div class="line"><span class="meta">#</span>2  0x00007f43a017c891 in dl_open_worker (a=a@entry=0x7fff36cbb848) at dl-open.c:228</div><div class="line">        args = 0x7fff36cbb848</div><div class="line">        file = 0x7fff36cbba80 "libnss_sss.so.2"</div><div class="line">        mode = -2147483647</div><div class="line">        call_map = &lt;optimized out&gt;</div><div class="line">        dst = &lt;optimized out&gt;</div><div class="line">        new = &lt;optimized out&gt;</div><div class="line">        r = &lt;optimized out&gt;</div><div class="line">        reloc_mode = &lt;optimized out&gt;</div><div class="line">        nmaps = &lt;optimized out&gt;</div><div class="line">        l = &lt;optimized out&gt;</div><div class="line">        maps = &lt;optimized out&gt;</div><div class="line">        relocation_in_progress = &lt;optimized out&gt;</div><div class="line">        any_tls = &lt;optimized out&gt;</div><div class="line">        first_static_tls = &lt;optimized out&gt;</div><div class="line"><span class="meta">#</span>3  0x00007f43a01782f4 in _dl_catch_error (objname=objname@entry=0x7fff36cbb838, errstring=errstring@entry=0x7fff36cbb840, </div><div class="line">    mallocedp=mallocedp@entry=0x7fff36cbb830, operate=operate@entry=0x7f43a017c770 &lt;dl_open_worker&gt;, args=args@entry=0x7fff36cbb848) at dl-error.c:177</div><div class="line">        errcode = &lt;optimized out&gt;</div><div class="line">        old = 0x7fff36cbb930</div><div class="line">        c = &#123;objname = 0x7f439ad75070 "", errstring = 0x0, malloced = true, env = &#123;&#123;__jmpbuf = &#123;-2, -962239387103018190, 2147483649, 140734112709248, </div><div class="line">                140734112710472, 4, -962239386769571022, -874721043931610318&#125;, __mask_was_saved = -1609093201, __saved_mask = &#123;__val = &#123;0, 0, 2, 0, 0, </div><div class="line">                  40169120, 140734112708640, 139928402693400, 9, 69, 0, 40170024, 140734112708640, 140734112708624, 2098210535, 140734112709232&#125;&#125;&#125;&#125;&#125;</div><div class="line">        catchp = 0x7f43a0379738</div><div class="line"><span class="meta">#</span>4  0x00007f43a017c21b in _dl_open (file=0x7fff36cbba80 "libnss_sss.so.2", mode=-2147483647, caller_dlopen=&lt;optimized out&gt;, nsid=-2, argc=4, </div><div class="line">    argv=0x7fff36cbbf48, env=0x7fff36cbbf70) at dl-open.c:656</div><div class="line">        args = &#123;file = 0x7fff36cbba80 "libnss_sss.so.2", mode = -2147483647, caller_dlopen = 0x7f439eccd259 &lt;__GI___nss_lookup_function+649&gt;, </div><div class="line">          caller_dl_open = 0x7f439ecf5962 &lt;do_dlopen+66&gt;, map = 0x0, nsid = 0, argc = 4, argv = 0x7fff36cbbf48, env = 0x7fff36cbbf70&#125;</div><div class="line">        objname = 0x7f43a0172ccb &lt;do_lookup_x+1803&gt; "H\205\300L\213L$\030L\213\\$(D\213D$0\017\205\217\372\377\377H\213T$\020\213\n\353\204I\213\003\276\377\377\377\377H9\360\017\204\353"</div><div class="line">        errstring = 0x7fff36cbb8a0 "\020\266\211\002"</div><div class="line">        malloced = 70</div><div class="line">        errcode = &lt;optimized out&gt;</div><div class="line"><span class="meta">#</span>5  0x00007f439ecf5962 in do_dlopen (ptr=ptr@entry=0x7fff36cbba50) at dl-libc.c:87</div><div class="line">        args = 0x7fff36cbba50</div><div class="line"><span class="meta">#</span>6  0x00007f43a01782f4 in _dl_catch_error (objname=0x7fff36cbba30, errstring=0x7fff36cbba40, mallocedp=0x7fff36cbba20, </div><div class="line">    operate=0x7f439ecf5920 &lt;do_dlopen&gt;, args=0x7fff36cbba50) at dl-error.c:177</div><div class="line">        errcode = &lt;optimized out&gt;</div><div class="line">        old = 0x0</div><div class="line">        c = &#123;objname = 0x20 &lt;Address 0x20 out of bounds&gt;, errstring = 0x0, malloced = 3, env = &#123;&#123;__jmpbuf = &#123;40167456, -962239387168029902, 42579472, </div><div class="line">                40167504, 140734112709264, 42579504, -962239387105115342, -874721043931610318&#125;, __mask_was_saved = 119, __saved_mask = &#123;__val = &#123;24, </div><div class="line">                  18446603339596842481, 139925739536386, 0, 139925739536432, 0, 140734112709136, 0, 472446402651, 0, 0, 532575944823, 140734112709135, </div><div class="line">                  0, 40167496, 139928403202444&#125;&#125;&#125;&#125;&#125;</div><div class="line">        catchp = 0x7f43a0379738</div><div class="line"><span class="meta">#</span>7  0x00007f439ecf5a22 in dlerror_run (args=0x7fff36cbba50, operate=0x7f439ecf5920 &lt;do_dlopen&gt;) at dl-libc.c:46</div><div class="line">        objname = 0x7fff36cbba80 "libnss_sss.so.2"</div><div class="line">        last_errstring = 0x0</div><div class="line">        malloced = false</div><div class="line">        result = &lt;optimized out&gt;</div><div class="line"><span class="meta">#</span>8  __GI___libc_dlopen_mode (name=name@entry=0x7fff36cbba80 "libnss_sss.so.2", mode=mode@entry=-2147483647) at dl-libc.c:163</div><div class="line">        args = &#123;name = 0x7fff36cbba80 "libnss_sss.so.2", mode = -2147483647, caller_dlopen = 0x7f439eccd259 &lt;__GI___nss_lookup_function+649&gt;, </div><div class="line">          map = 0x7f439ec4518c &lt;__GI___libc_malloc+92&gt;&#125;</div><div class="line"><span class="meta">#</span>9  0x00007f439eccd259 in nss_load_library (ni=0x264e820) at nsswitch.c:358</div><div class="line">        shlen = &lt;optimized out&gt;</div><div class="line">        saved_errno = 115</div><div class="line">        shlib_name = 0x7fff36cbba80 "libnss_sss.so.2"</div><div class="line">        ni = 0x264e820</div><div class="line"><span class="meta">#</span>10 __GI___nss_lookup_function (ni=ni@entry=0x264e820, fct_name=fct_name@entry=0x7f439ed4134d "initgroups_dyn") at nsswitch.c:455</div><div class="line">        known = 0x289b610</div><div class="line">        found = &lt;optimized out&gt;</div><div class="line">        result = &lt;optimized out&gt;</div><div class="line"><span class="meta">#</span>11 0x00007f439ec7f2ca in internal_getgrouplist (user=user@entry=0x262b188 "daemon", group=group@entry=2, size=size@entry=0x7fff36cbbb60, </div><div class="line">    groupsp=groupsp@entry=0x7fff36cbbb70, limit=65536) at initgroups.c:107</div><div class="line">        prev_start = 1</div><div class="line">        fct = &lt;optimized out&gt;</div><div class="line">        cnt = &lt;optimized out&gt;</div><div class="line">        status = &lt;optimized out&gt;</div><div class="line">        no_more = 0</div><div class="line">        start = 1</div><div class="line">        nip = 0x264e820</div><div class="line"><span class="meta">#</span>12 0x00007f439ec7f5da in initgroups (user=user@entry=0x262b188 "daemon", group=2) at initgroups.c:220</div><div class="line">        size = 64</div><div class="line">        groups = 0x289b480</div><div class="line">        ngroups = &lt;optimized out&gt;</div><div class="line">        result = &lt;optimized out&gt;</div><div class="line">        limit = &lt;optimized out&gt;</div><div class="line"><span class="meta">#</span>13 0x0000000000466211 in set_group_privs () at unixd.c:103</div><div class="line">        name = 0x262b188 "daemon"</div><div class="line"><span class="meta">#</span>14 unixd_setup_child () at unixd.c:117</div><div class="line">No locals.</div><div class="line"><span class="meta">#</span>15 0x0000000000464815 in child_main (child_num_arg=child_num_arg@entry=0) at prefork.c:514</div><div class="line">        ptrans = 0x2899498</div><div class="line">        allocator = 0x2897390</div><div class="line">        status = &lt;optimized out&gt;</div><div class="line">        i = &lt;optimized out&gt;</div><div class="line">        lr = &lt;optimized out&gt;</div><div class="line">        pollset = 0x7fff36cbbb00</div><div class="line">        sbh = 0x1</div><div class="line">        bucket_alloc = &lt;optimized out&gt;</div><div class="line">        last_poll_idx = 0</div><div class="line"><span class="meta">#</span>16 0x0000000000464ef4 in make_child (s=0x25ec158, slot=&lt;optimized out&gt;) at prefork.c:768</div><div class="line">        pid = 0</div><div class="line">        slot = 0</div><div class="line">        s = 0x25ec158</div><div class="line"><span class="meta">#</span>17 0x0000000000465dfa in perform_idle_server_maintenance (p=&lt;optimized out&gt;) at prefork.c:903</div><div class="line">        i = &lt;optimized out&gt;</div><div class="line">        idle_count = &lt;optimized out&gt;</div><div class="line">        ws = &lt;optimized out&gt;</div><div class="line">        free_length = &lt;optimized out&gt;</div><div class="line">        free_slots = &#123;0, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 0 &lt;repeats 16 times&gt;&#125;</div><div class="line">        last_non_dead = &lt;optimized out&gt;</div><div class="line">        total_non_dead = &lt;optimized out&gt;</div><div class="line"><span class="meta">#</span>18 ap_mpm_run (_pconf=_pconf@entry=0x25e5138, plog=&lt;optimized out&gt;, s=s@entry=0x25ec158) at prefork.c:1107</div><div class="line">        status = 11</div><div class="line">        pid = &#123;pid = -1, in = 0x7f439c4579c0 &lt;php_post_entries+32&gt;, out = 0x25ec158, err = 0x25e5138&#125;</div><div class="line">        child_slot = &lt;optimized out&gt;</div><div class="line">        exitwhy = APR_PROC_SIGNAL</div><div class="line">        processed_status = &lt;optimized out&gt;</div><div class="line">        index = &lt;optimized out&gt;</div><div class="line">        remaining_children_to_start = 0</div><div class="line">        rv = &lt;optimized out&gt;</div><div class="line"><span class="meta">#</span>19 0x0000000000425f3b in main (argc=4, argv=0x7fff36cbbf48) at main.c:753</div><div class="line">        c = 68 'D'</div><div class="line">        configtestonly = &lt;optimized out&gt;</div><div class="line">        confname = 0x7fff36cbcab2 "input.httpd.conf"</div><div class="line">        def_server_root = 0x46f348 "/environment/build/apache"</div><div class="line">        temp_error_log = &lt;optimized out&gt;</div><div class="line">        error = &lt;optimized out&gt;</div><div class="line">        process = 0x25e3218</div><div class="line">        server_conf = 0x25ec158</div><div class="line">        pglobal = &lt;optimized out&gt;</div><div class="line">        pconf = 0x25e5138</div><div class="line">        plog = 0x25f1198</div><div class="line">        ptemp = 0x25ef188</div><div class="line">        pcommands = 0x25e7148</div><div class="line">        opt = 0x25e7238</div><div class="line">        rv = &lt;optimized out&gt;</div><div class="line">        mod = &lt;optimized out&gt;</div><div class="line">        optarg = 0x7fff36cbcaf6 "FOREGROUND"</div><div class="line">        signal_server = &lt;optimized out&gt;</div></pre></td></tr></table></figure></p>
<p>进程死在initgroups里面，看一下这个代码：<br><a href="http://lcs.ios.ac.cn/~xuzb/canalyze/reports/httpd-2.4.4/inline_report/D1010-103-1.html" target="_blank" rel="external">http://lcs.ios.ac.cn/~xuzb/canalyze/reports/httpd-2.4.4/inline_report/D1010-103-1.html</a><br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">set_group_privs</span><span class="params">(<span class="keyword">void</span>)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">if</span> (!geteuid()) &#123;</div><div class="line">        <span class="keyword">const</span> <span class="keyword">char</span> *name;</div><div class="line"></div><div class="line">        <span class="comment">/* Get username if passed as a uid */</span></div><div class="line"></div><div class="line">        <span class="keyword">if</span> (ap_unixd_config.user_name[<span class="number">0</span>] == <span class="string">'#'</span>) &#123;</div><div class="line">            <span class="class"><span class="keyword">struct</span> <span class="title">passwd</span> *<span class="title">ent</span>;</span></div><div class="line">            <span class="keyword">uid_t</span> uid = atol(&amp;ap_unixd_config.user_name[<span class="number">1</span>]);</div><div class="line"></div><div class="line">            <span class="keyword">if</span> ((ent = getpwuid(uid)) == <span class="literal">NULL</span>) &#123;</div><div class="line">                ap_log_error(APLOG_MARK, APLOG_ALERT, errno, <span class="literal">NULL</span>, APLOGNO(<span class="number">02155</span>)</div><div class="line">                         <span class="string">"getpwuid: couldn't determine user name from uid %ld, "</span></div><div class="line">                         <span class="string">"you probably need to modify the User directive"</span>,</div><div class="line">                         (<span class="keyword">long</span>)uid);</div><div class="line">                <span class="keyword">return</span> <span class="number">-1</span>;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            name = ent-&gt;pw_name;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">else</span></div><div class="line">            name = ap_unixd_config.user_name;</div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">if</span> !defined(OS2)</span></div><div class="line">        <span class="comment">/*</span></div><div class="line"><span class="comment">         * Set the GID before initgroups(), since on some platforms</span></div><div class="line"><span class="comment">         * setgid() is known to zap the group list.</span></div><div class="line"><span class="comment">         */</span></div><div class="line">        <span class="keyword">if</span> (setgid(ap_unixd_config.group_id) == <span class="number">-1</span>) &#123;</div><div class="line">            ap_log_error(APLOG_MARK, APLOG_ALERT, errno, <span class="literal">NULL</span>, APLOGNO(<span class="number">02156</span>)</div><div class="line">                        <span class="string">"setgid: unable to set group id to Group %ld"</span>,</div><div class="line">                        (<span class="keyword">long</span>)ap_unixd_config.group_id);</div><div class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">//  in initgroups (user=user@entry=0x262b188 "daemon", group=2)</span></div><div class="line">        <span class="comment">//  user如果为NULL是可能导致异常的，但这里两个参数都是正确的。</span></div><div class="line">        <span class="keyword">if</span> (initgroups(name, ap_unixd_config.group_id) == <span class="number">-1</span>) &#123; </div><div class="line">            ap_log_error(APLOG_MARK, APLOG_ALERT, errno, <span class="literal">NULL</span>, APLOGNO(<span class="number">02157</span>)</div><div class="line">                        <span class="string">"initgroups: unable to set groups for User %s "</span></div><div class="line">                        <span class="string">"and Group %ld"</span>, name, (<span class="keyword">long</span>)ap_unixd_config.group_id);</div><div class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</div><div class="line">        &#125;</div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>载入的so文件libnss_sss.so.2我也和正常环境对比了，两者并没有什么差别。</p>
<p>上面的堆栈，只有一个地方又疑点：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">realname = 0x5 &lt;Address 0x5 out of bounds&gt;</div><div class="line">       l = 0x2715810</div><div class="line">       fb = &#123;len = 139928387339192,</div></pre></td></tr></table></figure></p>
<p>这里realname显然不是一个合法值，len看上去也不像，有点像踩内存。</p>
<p>第一反应是，作为apache进程，我们和他没有直接交集，应该不至于踩内存，网上也搜索不到死在initgroups里的样例。</p>
<p>疑问2：我们都是PHP或HTML代码，为何会导致Apache看上去有踩内存的现象？</p>
<h1 id="重现"><a href="#重现" class="headerlink" title="重现"></a>重现</h1><p>为了不破坏现场，我重现修改了一份conf文件，监听4433端口，再用相同命令启动，发现运行得很好。<br>并不能重现，所以原本的现场更不能破坏。</p>
<p>推理起来就有点不合逻辑了，进程启动了好几天，刚开始没事，中间某个时间点开始出故障，新启动的进程又没有这个问题？</p>
<h1 id="环境变量"><a href="#环境变量" class="headerlink" title="环境变量"></a>环境变量</h1><p>如果经常是人为启动的，可能会导致差异性，看了一下环境变量，并无多少差别：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">cat /proc/父进程和子进程/environ | tr &apos;\0&apos; &apos;\n&apos;</div></pre></td></tr></table></figure></p>
<h1 id="黑盒查验"><a href="#黑盒查验" class="headerlink" title="黑盒查验"></a>黑盒查验</h1><p>通过黑盒发现两个重要信息，其一，在2018-12-10这天，11:10分有用户登录过：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">root     root        14  1970     1  0.0  0.0 103796  3740  3740 ?        Ss     Nov 27 00:00:00 /usr/sbin/sshd -D</div><div class="line">root     root        15 17396  1970  0.0  0.0 148156  5688  5688 ?        Ss   11:10:38 00:00:00  \_ sshd: admin@pts/0</div><div class="line">root     root         5 17399 17396  0.0  0.0  11876  2036  2036 pts/0    Ss+  11:10:38 00:00:00      \_ -bash</div></pre></td></tr></table></figure></p>
<p>而第一次出现SIGSEGV的时间是在2018-12-10 11:50:24。</p>
<p>两者时间相隔很近，而且此用户登出的时间在12点以后。</p>
<p>一个关键结论：<strong>在此用户操作期间，出现了Apache SIGSEGV。</strong></p>
<p>我们再看另外一个443端口的黑盒日志，其加入了心跳监控机制，如果长时间不响应，会自动拉起，从黑盒日志看，443端口所在进程，在2018-12-10 12:02:16自动拉起过。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Mon Dec 10 12:02:16 CST 2018 Serivce httpd exit innormally restart by wget suspended ...</div></pre></td></tr></table></figure></p>
<p>这下可以解释：</p>
<blockquote>
<p>疑问1：为何443端口可以访问而4430端口无法访问？<br>因为443端口有监控机制，当天发现出问题后就重启了，之前我们也验证了，重新开进程是不会有错误现象的。</p>
</blockquote>
<p>这下的重点放到查此用户在登陆期间做了啥？</p>
<p>由于没有history，不是很方便，还好能问人，两个人一个替换了PHP，一个替换了一个非关联模块。</p>
<p>查看dmesg发现如下日志：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[1102467.408054] app1[3664]: segfault at 2e77520 ip 00007fd766df9ad0 sp 00007fff2a2bd7d8 error 4 in libfoo.so[7fd766df0000+17000]</div><div class="line">[1102469.849633] app2[10401]: segfault at 6a06 ip 0000000000006a06 sp 00007fff6cf59a70 error 14 in app2 (deleted)[400000+2e000]</div><div class="line">^Mon Dec 10 11:21:03 CST 2018</div></pre></td></tr></table></figure></p>
<p>时间上也比较吻合。</p>
<p>此日志说明推测，由于替换了libfoo.so，导致app1, app2进程挂掉。</p>
<p>由此找到关键点，是否因为替换了此文件，导致Apache进程异常？</p>
<h1 id="问题验证"><a href="#问题验证" class="headerlink" title="问题验证"></a>问题验证</h1><p>之前还查看过apache加载的mod，mod目录没有文件替换。<br>是我们自己开发的一个插件间接依赖的模块。</p>
<p>使用info sharedlibrary查看进程当前加载的动态库，发现的确有libfoo.so存在。<br>子进程内存布局是继承的父进程里老的libfoo.so的布局，而实际去取文件代码段的时候，就会映射成错误代码，导致代码或内存corrupt。</p>
<p>于是写了一段代码，查看都有哪些进程会出现载入动态库比进程启动时间更新：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span>!/bin/bash</div><div class="line">for pid in $(ps ax --no-headers -o pid); do </div><div class="line">    # 进程启动时间</div><div class="line">    startTime=$(date +"%s" --date="$(ps --no-headers -o lstart -p $pid)")</div><div class="line">    startTimePrint="$(date +"%F %T" --date=@$startTime)"</div><div class="line">    </div><div class="line">    # 获取进程加载的so，用gdb info sharedlibrary要准确一些</div><div class="line">    for i in $(lsof -p $pid | grep '\.so' | awk '&#123;print $NF&#125;' | sort -k 1); do </div><div class="line">        if [ -f "$i" ]; then </div><div class="line">            # 文件更改时间</div><div class="line">            fileTime=$(stat -c "%Y" $i)</div><div class="line">            if [ $fileTime -ge $startTime ]; then </div><div class="line">                fileTimePrint="$(date +"%F %T" --date=@$fileTime)"</div><div class="line">                cmdline="$(ps --no-headers -o args -p $pid)"</div><div class="line">                echo "Process $startTimePrint &lt; File $fileTimePrint $pid $i IN $cmdline"</div><div class="line">            fi</div><div class="line">        fi</div><div class="line">    done</div><div class="line">done</div></pre></td></tr></table></figure></p>
<p>执行后发现还有个进程也有此现象：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">Process 2018-12-04 09:15:09 &lt; File 2018-12-10 11:20:19 639 /usr/lib64/libfoo.so IN httpd -f sec_workorder/input.httpd.conf -DFOREGROUND</div><div class="line">Process 2018-12-04 09:15:09 &lt; File 2018-12-10 11:20:19 640 /usr/lib64/libfoo.so IN httpd -f seclib/input.httpd.conf -DFOREGROUND</div><div class="line">Process 2018-12-04 09:15:09 &lt; File 2018-12-10 11:20:19 652 /usr/lib64/libfoo.so IN httpd -f ngfw/input.httpd.conf -DFOREGROUND</div><div class="line">Process 2018-12-04 09:15:09 &lt; File 2018-12-10 11:20:19 791 /usr/lib64/libfoo.so IN httpd -f sec_workorder/input.httpd.conf -DFOREGROUND</div><div class="line">Process 2018-12-04 09:15:09 &lt; File 2018-12-10 11:20:19 792 /usr/lib64/libfoo.so IN httpd -f sec_workorder/input.httpd.conf -DFOREGROUND</div><div class="line">Process 2018-12-10 01:01:44 &lt; File 2018-12-10 11:20:19 38826 /usr/lib64/libfoo.so IN php -c php.ini index.php get_data</div></pre></td></tr></table></figure></p>
<p>用wget验证，现象相同：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">~ $ wget --no-check-certificate https://127.0.0.1:4488/ </div><div class="line">--2018-12-19 15:33:34--  https://127.0.0.1:4488/</div><div class="line">Connecting to 127.0.0.1:4488... connected.</div><div class="line">Unable to establish SSL connection.</div></pre></td></tr></table></figure></p>
<p>这下可以解释：</p>
<blockquote>
<p>疑问2：我们都是PHP或HTML代码，为何会导致Apache看上去有踩内存的现象？<br>因为libfoo.so最终间接加载进入了Apache进程，导致内存错乱，的确并非由PHP或HTML代码引起。</p>
</blockquote>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://mnstory.net/2018/12/14/make-self-signed-certificate/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="mnstory.net">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="码农故事">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/12/14/make-self-signed-certificate/" itemprop="url">自签名证书制作</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-12-14T21:00:00+08:00">
                2018-12-14
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>X509 是一种证书标准，定义了证书应该包含的内容，也是SSL使用的证书标准，可以参考<a href="https://tools.ietf.org/html/rfc5280" target="_blank" rel="external">rfc5280</a>。</p>
<h1 id="编码格式"><a href="#编码格式" class="headerlink" title="编码格式"></a>编码格式</h1><p>存储证书时主要有：</p>
<ol>
<li><p>pem(Privacy Enhanced Mail)文本编码<br> 以”—–BEGIN—–”开头，以”—–END—–” 结尾,内容是BASE64编码。<br> Apache和*NIX服务器偏向于使用此类编码格式。<br> 可通过如下方式查看：</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">openssl x509 -in your.pem -text -noout</div></pre></td></tr></table></figure>
</li>
<li><p>der(Distinguished Encoding Rules)二进制编<br> 二进制格式不可读，Java和Windows服务器偏向于使用这种编码格式。<br> 可通过如下方式查看：</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">openssl x509 -in your.der -inform der -text -noout</div></pre></td></tr></table></figure>
</li>
</ol>
<h1 id="文件扩展名"><a href="#文件扩展名" class="headerlink" title="文件扩展名"></a>文件扩展名</h1><p>上面是编码格式，本来就有pem和der的文件扩展名，但是，我们常常还能看到下面的扩展名（按文件功能来区分），其内可能是如上两种编码格式。</p>
<ol>
<li>key<br> key文件后缀一般用于存储私钥。<br> 私钥需要谨慎存储，以防泄漏，可以给私钥加密，并设置文件读取权限。<br> 可以用如下方式生成私钥： <figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="meta">$</span> openssl genrsa -out ca.key 2048</div><div class="line"></div><div class="line"><span class="meta">$</span> cat ca.key </div><div class="line">-----BEGIN RSA PRIVATE KEY-----</div><div class="line">MIIEpAIBAAKCAQEA2XAVPi2soM0Wtx50r38O2Vilznb38MJnwadsm1OwKpRWHj8I</div><div class="line">...</div><div class="line">vwiKSZ8Tca0PkfoTE4QQRxHxpoI6Guhrqgxp4nTLaDJ6fO8VzSXGJg==</div><div class="line">-----END RSA PRIVATE KEY-----</div></pre></td></tr></table></figure>
</li>
</ol>
<pre><code>私钥生成的时候，如果你想对私钥做加密存储，可以指定加密方法，如-des3，然后输入密码后私钥就被加密存储了，文件内容表现上，会多一些头部信息：
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="meta">$</span> openssl genrsa -des3 -out ca.key 2048</div><div class="line"></div><div class="line"><span class="meta">$</span> cat ca.key </div><div class="line">-----BEGIN RSA PRIVATE KEY-----</div><div class="line">Proc-Type: 4,ENCRYPTED</div><div class="line">DEK-Info: DES-EDE3-CBC,24E18B27E7DA3DBA</div><div class="line"></div><div class="line">FEMUvp7Rrjz2RmIqmRCb5Z3EIyqf4pkRM0hxuiu+ouvW08Qs/YATw2A9BXHq7vfX</div><div class="line">...</div><div class="line">8eZjXcPPpTTg8GRht4ScratQzgSx8XJ5ArxF5v3cl1323bYUAJVJnQ==</div><div class="line">-----END RSA PRIVATE KEY-----</div></pre></td></tr></table></figure>


可通过如下方式查看：
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">openssl rsa -in your.key -text -noout</div></pre></td></tr></table></figure>

或der格式：
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">openssl rsa -in your.key -inform der -text -noout</div></pre></td></tr></table></figure>
</code></pre><ol>
<li><p>csr(Cerificate Signing Request)<br> csr为签名请求文件，其核心内容为自己的公钥和一些附加信息（如域名匹配字串），一般来说，给证书签名的都是受信任机构，主要是浏览器和操作系统里面内置的那几家，而普通厂商或个人，若想让浏览器也信任你的网站，必须先到受信任的证书机构去申请，让其用他们的证书为咱们的证书做一次签名，这个请求过程，理论上就需要咱们提供csr文件。</p>
<p> 可通过如下方式查看：</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">openssl req -in your.csr -text -noout</div></pre></td></tr></table></figure>
<p> 若是der格式，同理加入-inform der即可。</p>
</li>
<li><p>crt(Certificate)<br> 被证书机构签名后的csr，就是crt文件，这是签署人用自己的秘钥给你签署的凭证。（windows下导入证书的时候，扩展名默认是csr，其实应该是crt）。</p>
</li>
<li><p>pfx/p12(predecessor of PKCS#12)<br> *nix服务器一般将crt和key分开存放，但Windows的IIS则将它们存在一个pfx文件中，这样的好处是移动方便，但是可能会泄漏私钥，没关系，pfx文件查看是需要输入“提取密码”的，和上面的key文件指定的存储密码类似。</p>
<p> pfx内部同样可能是der或pem格式，如何将pfx的der格式转换为pfx的pem格式？</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">openssl pkcs12 -in your.pfx -out your.pem -nodes</div></pre></td></tr></table></figure>
</li>
</ol>
<pre><code>如何生成pfx文件：
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">openssl pkcs12 -export -in 你的证书.crt -inkey 你的私钥.key -out your.pfx -certfile 权威机构的签名证书.crt</div></pre></td></tr></table></figure>
</code></pre><ol>
<li><p>jks(Java Key Storage)<br> 这是Java自己的一套，和OpenSSL关系不大，需要利用Java自带的keytool工具进行操作。</p>
</li>
<li><p>crl(Certificate Revocation List)<br> 证书吊销列表，不是用来存储证书或私钥的。</p>
</li>
</ol>
<h1 id="自签名证书生成"><a href="#自签名证书生成" class="headerlink" title="自签名证书生成"></a>自签名证书生成</h1><p>之前使用的SSL自签名证书，很简陋，怎么做也没法让浏览器真正信任网站，Chrome报错为NET::ERR_CERT_COMMON_NAME_INVALID：<br><img src="/2018/12/14/make-self-signed-certificate/err_cert_common_name_invalid.png" alt="err_cert_common_name_invalid"></p>
<p>研究了一下，生成自签名证书，需要附加“使用者备用名称”，将域名或IP加入证书，我将关键的配置抽象成模板，如下：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line">~/cert $ cat cfg/req-ssign-one.template </div><div class="line">[ req ]</div><div class="line">default_bits        = 2048</div><div class="line">default_keyfile     = private/ca.key</div><div class="line">distinguished_name  = req_distinguished_name</div><div class="line">req_extensions      = req_ext</div><div class="line">x509_extensions     = x509_ext</div><div class="line">string_mask         = utf8only</div><div class="line"></div><div class="line">[ req_distinguished_name ] </div><div class="line">countryName                 = Country Name (2 letter code)</div><div class="line">stateOrProvinceName         = State or Province Name (full name)</div><div class="line">localityName                = Locality Name (eg, city)</div><div class="line">organizationName            = Organization Name (eg, company)</div><div class="line">commonName                  = Common Name (e.g. server FQDN or YOUR name)</div><div class="line">emailAddress                = Email Address</div><div class="line"></div><div class="line"><span class="meta">#</span>%distinguish%</div><div class="line"></div><div class="line">[ x509_ext ]</div><div class="line">subjectKeyIdentifier   = hash</div><div class="line">authorityKeyIdentifier = keyid,issuer</div><div class="line"></div><div class="line">basicConstraints       = CA:FALSE</div><div class="line">keyUsage               = digitalSignature, keyEncipherment</div><div class="line">subjectAltName         = @alt_names</div><div class="line"></div><div class="line">[ req_ext ]</div><div class="line">subjectKeyIdentifier = hash</div><div class="line">basicConstraints     = CA:FALSE</div><div class="line">keyUsage             = digitalSignature, keyEncipherment</div><div class="line"></div><div class="line">subjectAltName          = @alt_names</div><div class="line"></div><div class="line">[ alt_names ]</div><div class="line"><span class="meta">#</span>%altnames%</div></pre></td></tr></table></figure></p>
<p>你只需要替换其中的“#%distinguish%”为自己需要的信息，例如：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">~/cert/ssign $ cat distinguish.userdef </div><div class="line">countryName_default         = CN</div><div class="line">stateOrProvinceName_default = Guangdong</div><div class="line">localityName_default        = ShenZhen</div><div class="line">organizationName_default    = X-Security</div><div class="line">commonName_default          = X-Security Platform</div><div class="line">emailAddress_default        = plat@x-security.com</div></pre></td></tr></table></figure></p>
<p>替换#%altnames%（使用者备用名称）为自定义域名或IP，例如：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">~/cert/ssign $ ssign/altnames.userdef </div><div class="line">DNS.1 = plat.x-security.com</div><div class="line">DNS.2 = plat1.x-security.com</div><div class="line">DNS.3 = google.plat</div><div class="line">IP.1  = 192.168.111.10</div><div class="line">IP.2  = 200.200.221.186</div></pre></td></tr></table></figure></p>
<p>配置写成这种方式是不行的，只能取最后一个：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">DNS = plat.x-security.com</div><div class="line">DNS = plat1.x-security.com</div></pre></td></tr></table></figure></p>
<p>如果同value的话，最后生成的证书也会出现多条同value的项，并不会在生成过程中uniq：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">DNS.1 = plat1.x-security.com</div><div class="line">DNS.2 = plat1.x-security.com</div></pre></td></tr></table></figure></p>
<p>几者结合起来，综合成一个配置文件（例如req.conf），便可以使用如下命令生成秘钥和证书：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">~/cert/ssign $ openssl req -config req.conf -new -sha256 -newkey rsa:2048 -nodes -keyout server.key -x509 -days 3650 -out server.crt</div></pre></td></tr></table></figure></p>
<p>将生成的私钥和证书替换到Apache配置下对应位置：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">~ $ cat httpd.conf</div><div class="line">SSLCertificateFile "你的路径/server.crt"</div><div class="line">SSLCertificateKeyFile "你的路径/server.key"</div></pre></td></tr></table></figure></p>
<p>重启Apache，浏览器ctrl+F5请求便能看到新版本证书。在Windows客户端，可指定伪域名，将证书里面的域名加入hosts文件：C:\Windows\System32\drivers\etc\hosts，例如添加：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">192.168.111.10  plat.x-security.com</div><div class="line">192.168.111.10  plat1.x-security.com</div><div class="line">200.200.221.186 google.plat</div></pre></td></tr></table></figure></p>
<p>此时打开Chrome浏览器，错误变为了NET::ERR_CERT_AUTHORITY_INVALID：<br><img src="/2018/12/14/make-self-signed-certificate/err_cert_authority_invalid.png" alt="err_cert_authority_invalid"></p>
<p>看得出，这报错是证书不受信任，而不再是域名匹配不上。</p>
<h1 id="Windows证书自签名导入"><a href="#Windows证书自签名导入" class="headerlink" title="Windows证书自签名导入"></a>Windows证书自签名导入</h1><p>解决上面的问题，只需要将证书导入Windows即可，以Chrome为例（Chrome和IE都是用的Windows自己的证书管理系统，而Firefox不是），步骤为：</p>
<ol>
<li><p>Chrome打开网站，点击“不安全”-&gt;”证书”<br> <img src="/2018/12/14/make-self-signed-certificate/addto1.png" alt="import setup1"></p>
</li>
<li><p>点击“详细信息”-&gt;”复制到文件”-&gt;”下一步”<br> <img src="/2018/12/14/make-self-signed-certificate/addto2.png" alt="import setup2"></p>
</li>
<li><p>点击”下一步”<br> <img src="/2018/12/14/make-self-signed-certificate/addto3.png" alt="import setup3"></p>
</li>
<li><p>点击”浏览”，选择输出路径，然后点击”下一步”<br> <img src="/2018/12/14/make-self-signed-certificate/addto4.png" alt="import setup4"></p>
</li>
<li><p>双击导出到桌面的证书文件，点击”安装证书”-&gt;”下一步”<br> <img src="/2018/12/14/make-self-signed-certificate/addto5.png" alt="import setup5"></p>
</li>
<li><p>选择”将所有的证书放入下列存储”-&gt;”浏览”选择存储位置为”受信任的根证书颁发机构”-&gt;”确定”-&gt;”下一步”<br> <img src="/2018/12/14/make-self-signed-certificate/addto6.png" alt="import setup6"></p>
</li>
<li><p>此时会弹出一个告警框，点击”是”<br> <img src="/2018/12/14/make-self-signed-certificate/addto7.png" alt="import setup7"></p>
</li>
</ol>
<p>经过如上几个步骤，证书便导入了系统，此时再次打开Chrome浏览器，之前的红色告警和阻止页面便会消失：</p>
<ol>
<li><p>受信任的域名<br> <img src="/2018/12/14/make-self-signed-certificate/valid-domain.png" alt="valid domain"></p>
</li>
<li><p>受信任的IP地址<br> <img src="/2018/12/14/make-self-signed-certificate/valid-ip.png" alt="valid ip"></p>
</li>
</ol>
<p>如果遇到NET::ERR_CERT_DATE_INVALID错误，可能是因为你签名的服务器时钟比较快，导致生效时间还没到。</p>
<p>##浏览器差异性</p>
<ol>
<li>Chrome和Firefox支持<strong>IP地址</strong>的证书认证，而IE（实测IE8）并不支持IP，只支持域名。</li>
<li><p>自签名的证书，虽然Chrome和IE是认的，但Firefox不认，Firfox会报错MOZILLA_PKIX_ERROR_SELF_SIGNED_CERT，且无法导入自签名证书到Firefox，会提示：这不是一个证书颁发机构证书，因此无法导入到证书颁发机构列表。效果仍然是被拒绝：<br> <img src="/2018/12/14/make-self-signed-certificate/firefox-self-sign.png" alt="firefox-self-sign"></p>
<p> 你可以添加例外，添加后效果如下：<br> <img src="/2018/12/14/make-self-signed-certificate/firefox-self-sign-show.png" alt="firefox-self-sign-show"></p>
</li>
</ol>
<h1 id="第三方认证证书生成"><a href="#第三方认证证书生成" class="headerlink" title="第三方认证证书生成"></a>第三方认证证书生成</h1><p>自己用自己的秘钥为自己的csr文件签名，叫做自签名。<br>而正常情况下，我们是将自己的csr文件发给第三方权威机构给我们签名，我们模拟一下，假设我们就算第三方权威机构，如何给别人颁发证书。</p>
<h2 id="角色权威机构"><a href="#角色权威机构" class="headerlink" title="角色权威机构"></a>角色权威机构</h2><ol>
<li><p>生成私钥</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">openssl genrsa -out private/ca.key 2048</div></pre></td></tr></table></figure>
</li>
<li><p>生成csr</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">openssl req -new -key private/ca.key -out ca.csr</div></pre></td></tr></table></figure>
<p> 上述命令需要一步一步输入提示信息，多次操作比较麻烦，我将输入配置成模板：</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">~/cert $ cat cfg/req.template </div><div class="line">[ req ]</div><div class="line">default_bits        = 2048</div><div class="line">default_keyfile     = private/ca.key</div><div class="line">distinguished_name  = req_distinguished_name</div><div class="line">string_mask         = utf8only</div><div class="line"></div><div class="line">[ req_distinguished_name ] </div><div class="line">countryName                 = Country Name (2 letter code)</div><div class="line">stateOrProvinceName         = State or Province Name (full name)</div><div class="line">localityName                = Locality Name (eg, city)</div><div class="line">organizationName            = Organization Name (eg, company)</div><div class="line">commonName                  = Common Name (e.g. server FQDN or YOUR name)</div><div class="line">emailAddress                = Email Address</div><div class="line"></div><div class="line"><span class="meta">#</span>%distinguish%</div></pre></td></tr></table></figure>
<p> 使用者只需要替换#%distinguish%为自己的信息，例如：</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">~/cert $ cat x-securityca/distinguish.userdef </div><div class="line">countryName_default         = CN</div><div class="line">stateOrProvinceName_default = Guangdong</div><div class="line">localityName_default        = ShenZhen</div><div class="line">organizationName_default    = x-security</div><div class="line">commonName_default          = x-security Certification Center</div><div class="line">emailAddress_default        = cert@x-security.com</div></pre></td></tr></table></figure>
<p> 几者结合起来，综合成一个配置文件（例如req.conf），便可以使用如下命令生成签名请求文件：</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">~/cert/x-securityca $ openssl req -new -key private/ca.key -out ca.csr -config req.conf</div></pre></td></tr></table></figure>
</li>
<li><p>生成crt<br> 由于是自签名，所以只需要用自己的私钥作为signkey，下面给的签名期限为20年：</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">~/cert/x-securityca $ openssl x509 -req -in ca.csr -out ca.crt -signkey private/ca.key -days 7305</div></pre></td></tr></table></figure>
</li>
</ol>
<p>如上，权威机构一方的私钥和证书生成完毕，但是要用来签名，还需要做一些环境配置：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">~/cert/x-securityca $ mkdir newcerts</div><div class="line">~/cert/x-securityca $ touch index.txt</div><div class="line">~/cert/x-securityca $ echo 01 &gt; serial</div></pre></td></tr></table></figure></p>
<p>两次为同名证书签名的时候，如果报错：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">failed to update database</div><div class="line">TXT_DB error number 2</div></pre></td></tr></table></figure></p>
<p>这表示unique_subject选项开启了(见index.txt.attr)，你可以在配置里面关闭或者直接：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">~/cert/x-securityca $ echo "unique_subject = no" &gt; index.txt.attr</div></pre></td></tr></table></figure></p>
<h2 id="角色第三方"><a href="#角色第三方" class="headerlink" title="角色第三方"></a>角色第三方</h2><p>权威机构一方已经ready，随时可以帮助第三方机构提供签名服务。现在我们模拟第三方机构请求签名过程。<br>其中：</p>
<pre><code>1. 生成私钥。
2. 生成csr。
</code></pre><p>两步骤和“角色权威机构”的做法完全一致，只需要调整 distinguish.userdef 里面的自定义内容。</p>
<p>差别在于第3步，我们还是通过配置模板的方式来实现：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line">~/cert $ cat cfg/osign.template </div><div class="line">[ ca ]</div><div class="line">default_ca      = CA_default        # The default ca section</div><div class="line"></div><div class="line">[ CA_default ]</div><div class="line">dir             = %secretRoot%      # Where everything is kept 修改ca目录</div><div class="line">certs           = $dir/certs        # Where the issued certs are kept</div><div class="line">crl_dir         = $dir/crl          # Where the issued crl are kept</div><div class="line">database        = $dir/index.txt    # database index file.</div><div class="line">unique_subject  = no                # 一般我们会多次尝试创建相同subject名称的证书，所以关掉unique_subject功能，默认是yes(开启)</div><div class="line"></div><div class="line">new_certs_dir   = $dir/newcerts     # default place for new certs.</div><div class="line"></div><div class="line">certificate     = $dir/ca.crt       # The CA certificate 修改crt路径</div><div class="line">serial          = $dir/serial       # The current serial number</div><div class="line">crlnumber       = $dir/crlnumber    # the current crl number</div><div class="line">                                    # must be commented out to leave a V1 CRL</div><div class="line">crl             = $dir/crl.pem      # The current CRL</div><div class="line">private_key     = $dir/private/ca.key       # The private key 修改key路径</div><div class="line"></div><div class="line">x509_extensions = v3_req            # The extensions to add to the cert</div><div class="line"></div><div class="line">name_opt    = ca_default            # Subject Name options</div><div class="line">cert_opt    = ca_default            # Certificate field options</div><div class="line"></div><div class="line">default_days    = 3650              # how long to certify for 修改默认天数</div><div class="line">default_crl_days= 30                # how long before next CRL</div><div class="line">default_md      = default           # use public key default MD</div><div class="line">preserve        = no                # keep passed DN ordering</div><div class="line"></div><div class="line">policy          = policy_match</div><div class="line"></div><div class="line">[ policy_match ]</div><div class="line">countryName             = match</div><div class="line">stateOrProvinceName     = match</div><div class="line">organizationName        = match</div><div class="line">organizationalUnitName  = optional</div><div class="line">commonName              = supplied</div><div class="line">emailAddress            = optional</div><div class="line"></div><div class="line">[ v3_req ]</div><div class="line"><span class="meta">#</span> Extensions to add to a certificate request</div><div class="line">basicConstraints        = CA:FALSE</div><div class="line">keyUsage                = nonRepudiation, digitalSignature, keyEncipherment</div><div class="line">subjectAltName          = @alt_names</div><div class="line"></div><div class="line">[ alt_names ]</div><div class="line"><span class="meta">#</span>%altnames%</div></pre></td></tr></table></figure></p>
<p>对于上述模板，你需要修改两个地方，其一，将 %secretRoot% 替换为刚才权威机构生成证书和相关辅助文件的所在目录（上例为~/cert/x-securityca）；其二，将#%altnames%替换为altnames.userdef文件里面的自定义内容：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">~/cert/user1 $ cat altnames.userdef </div><div class="line">DNS.1   = plat.x-security.com</div><div class="line">DNS.2   = plat1.x-security.com</div><div class="line">DNS.3   = google.plat</div><div class="line">IP.1    = 192.168.111.10</div><div class="line">IP.2    = 200.200.221.186</div></pre></td></tr></table></figure></p>
<p>执行权威机构的签名：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">~/cert/user1 $ openssl ca -in ca.csr -out ca.crt -config req.conf</div><div class="line">Using configuration from req.conf</div><div class="line">Check that the request matches the signature</div><div class="line">Signature ok</div><div class="line">Certificate Details:</div><div class="line">        Serial Number: 4 (0x4)</div><div class="line">        Validity</div><div class="line">            Not Before: Dec 14 10:08:26 2018 GMT</div><div class="line">            Not After : Dec 11 10:08:26 2028 GMT</div><div class="line">        Subject:</div><div class="line">            countryName               = CN</div><div class="line">            stateOrProvinceName       = Guangdong</div><div class="line">            organizationName          = x-security</div><div class="line">            commonName                = x-security Security intelligence Platform</div><div class="line">            emailAddress              = plat@x-security.com</div><div class="line">        X509v3 extensions:</div><div class="line">            X509v3 Basic Constraints: </div><div class="line">                CA:FALSE</div><div class="line">            X509v3 Key Usage: </div><div class="line">                Digital Signature, Non Repudiation, Key Encipherment</div><div class="line">            X509v3 Subject Alternative Name: </div><div class="line">                DNS:plat.x-security.com, DNS:plat1.x-security.com, DNS:google.plat, IP Address:192.168.111.10, IP Address:200.200.221.186</div><div class="line">Certificate is to be certified until Dec 11 10:08:26 2028 GMT (3650 days)</div><div class="line">Sign the certificate? [y/n]:y</div><div class="line"></div><div class="line">1 out of 1 certificate requests certified, commit? [y/n]y</div><div class="line">Write out database with 1 new entries</div><div class="line">Data Base Updated</div></pre></td></tr></table></figure></p>
<h1 id="第三方认证证书导入"><a href="#第三方认证证书导入" class="headerlink" title="第三方认证证书导入"></a>第三方认证证书导入</h1><p>与自签名证书导入有一定差异的是，这里操作系统导入的证书必须是“权威机构”的证书，而不是被签名的第三方证书。<br>表现出来就是，我们需要分发上述步骤中的~/cert/x-securityca/ca.crt到浏览器端，双击ca.crt导入，其导入方法和“Windows证书自签名导入”一节的第5步以后完全一致，略述。</p>
<h2 id="第三方认证证书导入Firefox"><a href="#第三方认证证书导入Firefox" class="headerlink" title="第三方认证证书导入Firefox"></a>第三方认证证书导入Firefox</h2><p>Firefox并不是使用的Windows的证书管理，所以，导入了Windows的信任证书，对Firefox并不生效，仍然报错SEC_ERROR_UNKNOWN_ISSUER，需要单独导入：</p>
<ol>
<li>输入 about:preferences#privacy</li>
<li>点击“隐私与安全”-&gt;找到“证书”一节-&gt;点击“查看证书”</li>
<li>点击“证书颁发机构”-&gt;点击“导入”-&gt;勾选两个checkbox-&gt;点击“确定”-&gt;点击“确定”  </li>
</ol>
<p>附操作图：<br><img src="/2018/12/14/make-self-signed-certificate/ffimport.png" alt="firefox import"></p>
<p>导入后，Firefox效果如：<br><img src="/2018/12/14/make-self-signed-certificate/firefox-other-sign-show.png" alt="firefox other sign show"></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://mnstory.net/2018/12/09/chrony-ntp-date-sync/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="mnstory.net">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="码农故事">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/12/09/chrony-ntp-date-sync/" itemprop="url">Chrony时间同步</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-12-09T21:00:00+08:00">
                2018-12-09
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>目前Centos使用<a href="https://chrony.tuxfamily.org/manual.html" target="_blank" rel="external">Chrony</a>来提供NTP服务。</p>
<h1 id="将Chrony当成客户端"><a href="#将Chrony当成客户端" class="headerlink" title="将Chrony当成客户端"></a>将Chrony当成客户端</h1><p>我们可以将Chrony当成客户端来使用，此时，你需要将你想要同步的NTP server加入配置（例如myserver为NTP server）：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">server ~ $ cat /etc/chrony.conf </div><div class="line">server myserver iburst</div></pre></td></tr></table></figure></p>
<p>然后重启：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">server ~ $ systemctl restart chronyd</div></pre></td></tr></table></figure></p>
<h2 id="查看和服务器的连通状态"><a href="#查看和服务器的连通状态" class="headerlink" title="查看和服务器的连通状态"></a>查看和服务器的连通状态</h2><p>下面MS是^*，^（脱字符号） 是服务器的意思，*（星号）代表当前处于同步状态，?（问号）表示连接断开。例如，我将服务器时钟调快一个小时，在客户端会显示yyyy为 -36000s。<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">server ~ $ chronyc sources -v</div><div class="line">210 Number of sources = 1</div><div class="line"></div><div class="line">  .-- Source mode  '^' = server, '=' = peer, '#' = local clock.</div><div class="line"> / .- Source state '*' = current synced, '+' = combined , '-' = not combined,</div><div class="line">| /   '?' = unreachable, 'x' = time may be in error, '~' = time too variable.</div><div class="line">||                                                 .- xxxx [ yyyy ] +/- zzzz</div><div class="line">||                                                /   xxxx = adjusted offset,</div><div class="line">||         Log2(Polling interval) -.             |    yyyy = measured offset,</div><div class="line">||                                  \            |    zzzz = estimated error.</div><div class="line">||                                   |           |                         </div><div class="line">MS Name/IP address         Stratum Poll Reach LastRx Last sample</div><div class="line">===============================================================================</div><div class="line">^* myserver                 3   6   377    39   -1274s[ -3600s] +/-   29ms</div></pre></td></tr></table></figure></p>
<p>如果服务器手动date修改了walltime，客户端效果有点诡异，感觉每次makestep都会跳来跳去的，时间不会跟随服务器变更(没有深究，可能理解有误)，而会变为互联网的正常时间（客户端不联网）：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">server ~ $ date</div><div class="line">Wed Dec  5 11:59:44 CST 2018</div><div class="line">server ~ $ chronyc -a makestep</div><div class="line">200 OK</div><div class="line">200 OK</div><div class="line">server ~ $ date</div><div class="line">Wed Dec  5 11:22:34 CST 2018</div><div class="line">server ~ $ chronyc -a makestep</div><div class="line">200 OK</div><div class="line">200 OK</div><div class="line">server ~ $ date</div><div class="line">Wed Dec  5 12:01:21 CST 2018</div></pre></td></tr></table></figure></p>
<p>如果是客户端自己的时间被date修改了，可以通过chronyc -a makestep来同步。<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">server ~ $ date -s "-2hour"</div><div class="line">Wed Dec  5 10:04:38 CST 2018</div><div class="line">server ~ $ date</div><div class="line">Wed Dec  5 10:04:53 CST 2018</div><div class="line">server ~ $ chronyc -a makestep</div><div class="line">200 OK</div><div class="line">200 OK</div><div class="line">server ~ $ date</div><div class="line">Wed Dec  5 12:05:00 CST 2018</div></pre></td></tr></table></figure></p>
<p>而使用waitsync不会跳跃同步：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">server ~ $ chronyc -a waitsync</div><div class="line">200 OK</div><div class="line">try: 1, refid: myserver, correction: 0.000000009, skew: 13.208</div></pre></td></tr></table></figure></p>
<h1 id="将Chrony当成服务端"><a href="#将Chrony当成服务端" class="headerlink" title="将Chrony当成服务端"></a>将Chrony当成服务端</h1><p>现在我们将其当成服务器来配置，主要修改以下几个地方：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">server ~ $ cat /etc/chrony.conf </div><div class="line"><span class="meta">#</span> 对于安全要求比较高的，这里可以限制谁能访问本机提供的NTP服务。</div><div class="line">allow 客户端IP</div><div class="line"></div><div class="line"><span class="meta">#</span> 修改监听地址</div><div class="line">bindcmdaddress 0.0.0.0</div><div class="line"></div><div class="line"><span class="meta">#</span> Serve time even if not synchronized to any NTP server.</div><div class="line"><span class="meta">#</span> 这个地方很重要，如果服务器本身也不能同步时间，那么就用本地时间替代，层级为10</div><div class="line">local stratum 10</div></pre></td></tr></table></figure></p>
<p>此程序会监听两个端口：</p>
<ol>
<li>端口 323/udp 为默认的管理端口，可以通过cmdport $newPort 来修改。</li>
<li>端口 123/udp 为标准的NTP监听端口，如果要对外提供ntp server功能，必须开启防火墙和监听地址为外部可访问地址，可以通过port $newPort 来修改。</li>
</ol>
<p>想要别人访问自己的ntp端口，必须防火墙放通，通过如下命令可永久放通：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">firewall-cmd --zone=public --add-port=123/udp --permanent</div><div class="line">firewall-cmd --reload</div></pre></td></tr></table></figure></p>
<p>如果误添加了端口，可以通过类似命令来删除（不存在的时候删除会报错）：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">firewall-cmd --zone=public --remove-port=323/tcp</div></pre></td></tr></table></figure></p>
<p>看看原本服务器和客户端的时间差，如下相差约11秒：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">server ~ $ echo  -e "local: $(date +"%F %T")\nremote:$(sshpass -p 密码 ssh -p 端口 admin@客户端IP date +\"%F %T\")\n"</div><div class="line">local: 2018-12-10 14:40:02</div><div class="line">remote:2018-12-10 14:40:13</div></pre></td></tr></table></figure></p>
<p>客户端执行同步命令：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">client ~ $ ntpdate -v -d 服务端IP</div><div class="line">10 Dec 14:40:03 ntpdate[5190]: ntpdate 4.2.4p8@1.1612-o Wed Aug 25 13:54:52 UTC 2010 (1)</div><div class="line">Looking for host 10.250.250.251 and service ntp</div><div class="line">host found : 10.250.250.251</div><div class="line">transmit(10.250.250.251)</div><div class="line">receive(10.250.250.251)</div><div class="line">transmit(10.250.250.251)</div><div class="line">receive(10.250.250.251)</div><div class="line">transmit(10.250.250.251)</div><div class="line">receive(10.250.250.251)</div><div class="line">transmit(10.250.250.251)</div><div class="line">receive(10.250.250.251)</div><div class="line">transmit(10.250.250.251)</div><div class="line">server 10.250.250.251, port 123</div><div class="line">stratum 10, precision -19, leap 00, trust 000</div><div class="line">refid [10.250.250.251], delay 0.02565, dispersion 0.00000</div><div class="line">transmitted 4, in filter 4</div><div class="line">reference time:    dfb888b8.70b9338e  Mon, Dec 10 2018 14:39:52.440</div><div class="line">originate timestamp: dfb888b9.70b98204  Mon, Dec 10 2018 14:39:53.440</div><div class="line">transmit timestamp:  dfb888c3.e10d573c  Mon, Dec 10 2018 14:40:03.879</div><div class="line">filter delay:  0.02570  0.02565  0.02570  0.02568 </div><div class="line">         0.00000  0.00000  0.00000  0.00000 </div><div class="line">filter offset: -10.4388 -10.4388 -10.4388 -10.4388</div><div class="line">         0.000000 0.000000 0.000000 0.000000</div><div class="line">delay 0.02565, dispersion 0.00000</div><div class="line">offset -10.438836</div><div class="line"></div><div class="line">10 Dec 14:40:03 ntpdate[5190]: step time server 10.250.250.251 offset -10.438836 sec</div></pre></td></tr></table></figure></p>
<p>这表示执行成功，如果遇到如下错误：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">...</div><div class="line">10.250.250.251: Server dropped: strata too high</div><div class="line">...</div><div class="line">stratum 16, precision -19, leap 11, trust 000</div><div class="line">...</div><div class="line">10 Dec 14:31:43 ntpdate[31119]: no server suitable for synchronization found</div></pre></td></tr></table></figure></p>
<p>是因为服务端自身也没有同步好自己的时钟，且没有运行本地时间作为时钟源，Chrony服务端记得开启：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">local stratum 10</div></pre></td></tr></table></figure></p>
<p>再次确认，时钟是否同步成功：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">server ~ $ echo  -e "local: $(date +"%F %T")\nremote:$(sshpass -p 密码 ssh -p 端口 admin@客户端IP date +\"%F %T\")\n"</div><div class="line">local: 2018-12-10 14:40:30</div><div class="line">remote:2018-12-10 14:40:30</div></pre></td></tr></table></figure></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://mnstory.net/2018/12/05/session-block-php-parallel-execution/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="mnstory.net">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="码农故事">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/12/05/session-block-php-parallel-execution/" itemprop="url">PHP Session阻塞验证</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-12-05T21:00:00+08:00">
                2018-12-05
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>在<a href="http://php.net/manual/zh/function.session-start.php" target="_blank" rel="external">function.session-start</a>看到，session_start后，会一直持有锁，建议使用session_write_close/session_commit释放锁，对此表示有点意外，因为这个session_start函数名字取得作实不咋地，怎么看也不想是一段加锁函数，于是写一段代码来验证：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line">print_r(date(<span class="string">'h:i:s'</span>).<span class="string">" enter&lt;br&gt;"</span>);</div><div class="line"></div><div class="line">session_start();</div><div class="line"></div><div class="line">print_r(date(<span class="string">'h:i:s'</span>).<span class="string">" start in session sleep&lt;br&gt;"</span>);</div><div class="line">$_SESSION[<span class="string">'a'</span>] = date(<span class="string">'h:i:s'</span>);</div><div class="line">sleep(<span class="number">10</span>);</div><div class="line">print_r(date(<span class="string">'h:i:s'</span>).<span class="string">" end in session sleep&lt;br&gt;"</span>);</div><div class="line"></div><div class="line"><span class="comment">// $_SESSION can still be read, but writing will not update the session.</span></div><div class="line"><span class="comment">// the lock is removed and other scripts can now read the session</span></div><div class="line">session_write_close(); <span class="comment">//别名session_commit</span></div><div class="line"></div><div class="line">print_r(date(<span class="string">'h:i:s'</span>).<span class="string">" start after session write sleep&lt;br&gt;"</span>);</div><div class="line">sleep(<span class="number">10</span>);</div><div class="line">print_r(date(<span class="string">'h:i:s'</span>).<span class="string">" end after session write sleep&lt;br&gt;"</span>);</div><div class="line"><span class="meta">?&gt;</span></div></pre></td></tr></table></figure></p>
<p>Chrome上同时（1秒左右的延迟）打开四个页面。</p>
<p>第一个页面（有0s的Stalled时间，TTFB是20s，总共是20.02s）：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">01:06:31 enter</div><div class="line">01:06:31 start in session sleep</div><div class="line">01:06:41 end in session sleep</div><div class="line">01:06:41 start after session write sleep</div><div class="line">01:06:51 end after session write sleep</div></pre></td></tr></table></figure></p>
<p>第二个页面（有19.34s的Stalled时间，TTFB是29.99s，总共是49.35s）：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">01:06:51 enter</div><div class="line">01:07:01 start in session sleep</div><div class="line">01:07:11 end in session sleep</div><div class="line">01:07:11 start after session write sleep</div><div class="line">01:07:21 end after session write sleep</div></pre></td></tr></table></figure></p>
<p>第三个页面（有18.53s的Stalled时间，TTFB是20s，总共是38.54s）：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">01:06:51 enter</div><div class="line">01:06:51 start in session sleep</div><div class="line">01:07:01 end in session sleep</div><div class="line">01:07:01 start after session write sleep</div><div class="line">01:07:11 end after session write sleep</div></pre></td></tr></table></figure></p>
<p>第四个页面（有16.75s的Stalled时间，TTFB是39.99s，总共是56.77s）：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">01:06:51 enter</div><div class="line">01:07:11 start in session sleep</div><div class="line">01:07:21 end in session sleep</div><div class="line">01:07:21 start after session write sleep</div><div class="line">01:07:31 end after session write sleep</div></pre></td></tr></table></figure></p>
<p>Chrome会在同域的第一个请求返回后，再并发开始其他的请求（有最大并发值）。所以，后面三个页面，虽然我点开时间有秒级的差别，实际开始时间都是第一个页面返回后的时间。当后面三个页面同时进入后端APACHE后（后端没有排队），可以看到enter时间是一致的。<br>差别就在于“start in session sleep”。</p>
<ol>
<li>第三个页面顺利进入后优先抢到锁，在01:07:01释放后。</li>
<li>第二个页面抢到锁，sesion_start返回，直到 01:07:11才释放锁。</li>
<li>第四个页面终于获得锁，直到01:07:21才释放锁。</li>
</ol>
<p>如上验证，session_start之后，如果不session_write_close，的确会<strong>Block其他进程调用session_start</strong>。</p>
<blockquote>
<p>将上述session_start修改为session_start([‘read_and_close’  =&gt; true]) 后，现象依旧。</p>
</blockquote>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://mnstory.net/2018/11/27/chrome-crash-for-gCurrOpUniqueID-overflow/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="mnstory.net">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="码农故事">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/11/27/chrome-crash-for-gCurrOpUniqueID-overflow/" itemprop="url">gCurrOpUniqueID溢出导致Chrome进程崩溃</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-11-27T21:00:00+08:00">
                2018-11-27
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>有一个大屏展示页面，利用Canvas做了大量的2D图像绘制，在某客户处发现，当大屏持续开启一个周左右，Chrome会崩溃，崩溃UI类似：</p>
<p>我们从客户的Chrome://crashes里面获取到了崩溃的dump文件（位于：C:\Users\你的用户名\AppData\Local\Google\Chrome\User Data\Crashpad\reports）（注：下面的截图是我们自己的截图，不是客户的）。</p>
<p>原因分析<br>由于网络原因，之前一直没有下载到对应的Chrome符号，昨晚第二次分析，发现符号可以下载了，于是使用Windbg，加入symbols路径：<br>SRV<em>C:\Symbols</em><a href="http://msdl.microsoft.com/download/symbols;SRV*C:\Symbols*https://chromium-browser-symsrv.commondatastorage.googleapis.com" target="_blank" rel="external">http://msdl.microsoft.com/download/symbols;SRV*C:\Symbols*https://chromium-browser-symsrv.commondatastorage.googleapis.com</a></p>
<ol>
<li>先看下analyze结果<br>Executable search path is:<br>Windows 7 Version 17134 (1) MP (4 procs) Free x64<br>Product: WinNt<br>Machine Name:<br>Debug session time: Sat Nov 24 20:32:02.000 2018 (UTC + 8:00) //周六晚上崩溃的<br>System Uptime: not available<br>Process Uptime: 2 days 11:52:48.000<br>0:000&gt; !analyze -v</li>
</ol>
<hr>
<ul>
<li>*</li>
<li>Exception Analysis                                   *</li>
<li>*</li>
</ul>
<hr>
<p>Failed calling InternetOpenUrl, GLE=12002</p>
<p>FAULTING_IP:<br>chrome_child!base::win::<code>anonymous namespace&#39;::ForceCrashOnSigAbort+0 [C:\b\c\b\win64_clang\src\base\win\win_util.cc @ 87]
00007ff9</code>48b9cd80 c704250000000037130000 mov dword ptr [0],1337h   // 这是一段强制Abort代码，访问空指针。</p>
<p>EXCEPTION_RECORD:  ffffffffffffffff – (.exr 0xffffffffffffffff)<br>ExceptionAddress: 00007ff948b9cd80 (chrome_child!base::win::`anonymous namespace’::ForceCrashOnSigAbort)<br>   ExceptionCode: c0000005 (Access violation)<br>  ExceptionFlags: 00000000<br>NumberParameters: 2<br>   Parameter[0]: 0000000000000001<br>   Parameter[1]: 0000000000000000<br>Attempt to write to address 0000000000000000</p>
<p>DEFAULT_BUCKET_ID:  NULL_POINTER_WRITE</p>
<p>PROCESS_NAME:  chrome.exe</p>
<p>ERROR_CODE: (NTSTATUS) 0xc0000005 - 0x%08lx</p>
<p>EXCEPTION_CODE: (NTSTATUS) 0xc0000005 - 0x%08lx</p>
<p>EXCEPTION_PARAMETER1:  0000000000000001</p>
<p>EXCEPTION_PARAMETER2:  0000000000000000</p>
<p>WRITE_ADDRESS:  0000000000000000 </p>
<p>FOLLOWUP_IP:<br>chrome_child!base::win::<code>anonymous namespace&#39;::ForceCrashOnSigAbort+0 [C:\b\c\b\win64_clang\src\base\win\win_util.cc @ 87]
00007ff9</code>48b9cd80 c704250000000037130000 mov dword ptr [0],1337h</p>
<p>NTGLOBALFLAG:  0</p>
<p>FAULTING_THREAD:  00000000000016cc</p>
<p>PRIMARY_PROBLEM_CLASS:  NULL_POINTER_WRITE</p>
<p>BUGCHECK_STR:  APPLICATION_FAULT_NULL_POINTER_WRITE</p>
<p>LAST_CONTROL_TRANSFER:  from 00007ff94b10f6e7 to 00007ff948b9cd80</p>
<p>STACK_TEXT:<br>000000bc<code>c85fca78 00007ff9</code>4b10f6e7 : 00007ff9<code>4bf74c98 00007ff9</code>4b10f857 000000bc<code>c85fcaf8 00000000</code>00000201 : chrome_child!base::win::<code>anonymous namespace&#39;::ForceCrashOnSigAbort [C:\b\c\b\win64_clang\src\base\win\win_util.cc @ 87]
000000bc</code>c85fca80 00007ff9<code>4b0fe654 : 00000000</code>00000101 0000027a<code>00000000 00000000</code>00000000 0000027a<code>c7be07c8 : chrome_child!raise+0x22b [minkernel\crts\ucrt\src\appcrt\misc\signal.cpp @ 547]
000000bc</code>c85fcaf0 00007ff9<code>48d2c5c5 : 0000027a</code>c7be07c8 0000027a<code>c91d4af8 00000000</code>00000000 000000bc<code>c85fcc60 : chrome_child!abort+0x18 [minkernel\crts\ucrt\src\appcrt\startup\abort.cpp @ 71]
000000bc</code>c85fcb20 00007ff9<code>47995d44 : 43978309</code>00000000 00000000<code>00000000 00000000</code>00000000 00000000<code>00000000 : chrome_child!sk_abort_no_print+0x15 [C:\b\c\b\win64_clang\src\skia\ext\SkMemory_new_handler.cpp @ 41]
000000bc</code>c85fcb50 00007ff9<code>4a111464 : 0000027a</code>b3f31650 00007ff9<code>48f5e14f 00007ff9</code>4b432658 00007ff9<code>4b432658 : chrome_child!GrOpFlushState::draw+0x1b4 [C:\b\c\b\win64_clang\src\third_party\skia\src\gpu\GrOpFlushState.cpp @ 120] // 这里是abort调用之前的代码。
000000bc</code>c85fcbe0 00007ff9<code>47990cf7 : 0000027a</code>be6fdca8 0000027a<code>be6fdca8 00000000</code>00000005 000000bc<code>c85fd540 : chrome_child!</code>anonymous namespace’::AAConvexPathOp::onPrepareDraws+0x2754 [C:\b\c\b\win64_clang\src\third_party\skia\src\gpu\ops\GrAAConvexPathRenderer.cpp @ 943]<br>000000bc<code>c85fd110 00007ff9</code>47990b41 : 0000027a<code>c9406730 000000bc</code>c85fd4b0 000000bc<code>c85fd304 000000bc</code>c85fd4b0 : chrome_child!GrRenderTargetOpList::onPrepare+0x197 [C:\b\c\b\win64_clang\src\third_party\skia\src\gpu\GrRenderTargetOpList.cpp @ 105]<br>000000bc<code>c85fd1b0 00007ff9</code>47990830 : 0000027a<code>bac81dd0 0000027a</code>bac81e18 00000000<code>000000ff 00000000</code>00000006 : chrome_child!GrOpList::prepare+0x61 [C:\b\c\b\win64_clang\src\third_party\skia\src\gpu\GrOpList.cpp @ 88]<br>000000bc<code>c85fd210 00007ff9</code>4798f4cf : 00000000<code>00000000 00000000</code>00000000 00000000<code>00000000 00005c10</code>68089d0f : chrome_child!GrDrawingManager::executeOpLists+0xb0 [C:\b\c\b\win64_clang\src\third_party\skia\src\gpu\GrDrawingManager.cpp @ 315]<br>000000bc<code>c85fd280 00007ff9</code>47bda0d7 : 00007ff9<code>4b299e07 00005c10</code>6808981f 00007ff9<code>4b299e07 00007ff9</code>4b299dfe : chrome_child!GrDrawingManager::internalFlush+0x75f [C:\b\c\b\win64_clang\src\third_party\skia\src\gpu\GrDrawingManager.cpp @ 232]<br>000000bc<code>c85fd7a0 00007ff9</code>48d896b4 : 000000bc<code>c85fd830 0000027a</code>8127fd18 0000027a<code>c8b5fef0 00007ff9</code>4b3a2d30 : chrome_child!GrContext::flush+0x27 [C:\b\c\b\win64_clang\src\third_party\skia\src\gpu\GrContext.cpp @ 366]<br>000000bc<code>c85fd7d0 00007ff9</code>4798be1b : 0000027a<code>b40b0000 00007ff9</code>917b2b55 0000027a<code>31000031 0000027a</code>00000002 : chrome_child!cc::SkiaPaintCanvas::FlushAfterDrawIfNeeded+0x74 [C:\b\c\b\win64_clang\src\cc\paint\skia_paint_canvas.cc @ 376]<br>000000bc<code>c85fd8b0 00007ff9</code>48d8a3bd : 0000027a<code>c84e89e0 00007ff9</code>475d2bb5 000000bc<code>c85fdce8 00007ff9</code>4b0c343b : chrome_child!cc::PaintOpBuffer::Playback+0x20b [C:\b\c\b\win64_clang\src\cc\paint\paint_op_buffer.cc @ 2333]<br>000000bc<code>c85fdb20 00007ff9</code>48d8a2c1 : 00000000<code>00000000 00000000</code>00000000 00005c10<code>6808958f 00005c10</code>680894ef : chrome_child!cc::SkiaPaintCanvas::drawPicture+0xcd [C:\b\c\b\win64_clang\src\cc\paint\skia_paint_canvas.cc @ 364]<br>000000bc<code>c85fdbe0 00007ff9</code>4a298fd8 : 00007ff9<code>4b299e07 00007ff9</code>4b299dfe 00000000<code>00000000 00000000</code>00000000 : chrome_child!cc::SkiaPaintCanvas::drawPicture+0x41 [C:\b\c\b\win64_clang\src\cc\paint\skia_paint_canvas.cc @ 321]<br>000000bc<code>c85fdc30 00007ff9</code>4a299e67 : 00000000<code>00000000 00005c10</code>680893ff 00005c10<code>6808938f 00000000</code>00000000 : chrome_child!blink::Canvas2DLayerBridge::FlushRecording+0xb4 [C:\b\c\b\win64_clang\src\third_party\blink\renderer\platform\graphics\canvas_2d_layer_bridge.cc @ 517]<br>000000bc<code>c85fdd20 00007ff9</code>492e5695 : 0000027a<code>b671c8f0 00007ff9</code>47493fcc 00000000<code>00000000 00000000</code>00000000 : chrome_child!blink::Canvas2DLayerBridge::PrepareTransferableResource+0x5d [C:\b\c\b\win64_clang\src\third_party\blink\renderer\platform\graphics\canvas_2d_layer_bridge.cc @ 615]<br>000000bc<code>c85fdd80 00007ff9</code>477d1c6a : 00000000<code>00000000 00000000</code>00000000 00000003<code>c85fde00 00000000</code>00000000 : chrome_child!cc::TextureLayer::Update+0x65 [C:\b\c\b\win64_clang\src\cc\layers\texture_layer.cc @ 179]<br>000000bc<code>c85fde80 00007ff9</code>477d0f71 : 0000027a<code>c8cfd300 00005c10</code>6808aedf 00000000<code>00000002 000000bc</code>c85fe520 : chrome_child!cc::LayerTreeHost::DoUpdateLayers+0xc2a [C:\b\c\b\win64_clang\src\cc\trees\layer_tree_host.cc @ 820]<br>000000bc<code>c85fe2a0 00007ff9</code>477c44a3 : 0000027a<code>b3ef1358 0000027a</code>b3ef1700 0000027a<code>c7ac6f48 0000027a</code>c7ac6ec0 : chrome_child!cc::LayerTreeHost::UpdateLayers+0x41 [C:\b\c\b\win64_clang\src\cc\trees\layer_tree_host.cc @ 647]<br>000000bc<code>c85fe320 00007ff9</code>477c4076 : 00000000<code>00000002 0000027a</code>b3ee1c60 000000bc<code>c85fe7c0 00007ff9</code>473b86e8 : chrome_child!cc::ProxyMain::BeginMainFrame+0x403 [C:\b\c\b\win64_clang\src\cc\trees\proxy_main.cc @ 270]<br>000000bc<code>c85fe4f0 00007ff9</code>473b851c : 0000027a<code>b3ef1708 00007ff9</code>4b87ee9a 00000000<code>00000001 0000027a</code>b3ef1700 : chrome_child!base::internal::Invoker<base::internal::bindstate<void (cc::proxymain::*)(std::unique_ptr<cc::beginmainframeandcommitstate,std::default_delete<cc::beginmainframeandcommitstate=""> &gt;),base::WeakPtr<cc::proxymain>,base::internal::PassedWrapper<std::unique_ptr<cc::beginmainframeandcommitstate,std::default_delete<cc::beginmainframeandcommitstate> &gt; &gt; &gt;,void ()&gt;::RunOnce+0xa6 [C:\b\c\b\win64_clang\src\base\bind_internal.h @ 662]<br>000000bc<code>c85fe560 00007ff9</code>47414996 : 00000000<code>00000000 0000027a</code>b3ee1bc0 000000bc<code>c85fe7c8 00007ff9</code>47419275 : chrome_child!base::debug::TaskAnnotator::RunTask+0x12c [C:\b\c\b\win64_clang\src\base\debug\task_annotator.cc @ 101]<br>000000bc<code>c85fe680 00007ff9</code>473b851c : 00000000<code>00000000 00005c10</code>6808a83f 00000000<code>00000000 00000000</code>00000000 : chrome_child!base::sequence_manager::internal::ThreadControllerImpl::DoWork+0x1b6 [C:\b\c\b\win64_clang\src\base\task\sequence_manager\thread_controller_impl.cc @ 179]<br>000000bc<code>c85fe8c0 00007ff9</code>473b7d7f : 00005c10<code>6808a69f 00000000</code>b3ee1a01 000000bc<code>c85ff101 000000bc</code>c85feaa8 : chrome_child!base::debug::TaskAnnotator::RunTask+0x12c [C:\b\c\b\win64_clang\src\base\debug\task_annotator.cc @ 101]<br>000000bc<code>c85fe9e0 00007ff9</code>473b1215 : 000000bc<code>c85fecb0 00007ff9</code>473b0436 0000027a<code>b3ee1b20 00007ff9</code>47414e02 : chrome_child!base::MessageLoop::RunTask+0xdf [C:\b\c\b\win64_clang\src\base\message_loop\message_loop.cc @ 436]<br>000000bc<code>c85feb20 00007ff9</code>473b1069 : 000000bc<code>c85feef0 00007ff9</code>47393d74 000000bc<code>c85fee68 00007ff9</code>4bdde830 : chrome_child!base::MessageLoop::DoWork+0x185 [C:\b\c\b\win64_clang\src\base\message_loop\message_loop.cc @ 517]<br>000000bc<code>c85fed50 00007ff9</code>473b05f1 : 00000000<code>00000000 00000000</code>b71d5e01 00007ff9<code>4bd77780 000000bc</code>c85fee68 : chrome_child!base::MessagePumpDefault::Run+0x99 [C:\b\c\b\win64_clang\src\base\message_loop\message_pump_default.cc @ 37]<br>000000bc<code>c85fedb0 00007ff9</code>473939cc : 0000027a<code>b40b0340 000000bc</code>c85fee98 00000000<code>00000000 000000bc</code>c85feeb0 : chrome_child!base::RunLoop::Run+0x31 [C:\b\c\b\win64_clang\src\base\run_loop.cc @ 108]<br>000000bc<code>c85fede0 00007ff9</code>4738d2e3 : 000000bc<code>c85ff080 00007ff9</code>4b0c343b 000000bc<code>c85ff080 00000000</code>00000003 : chrome_child!content::RendererMain+0x3d6 [C:\b\c\b\win64_clang\src\content\renderer\renderer_main.cc @ 200]<br>000000bc<code>c85fefa0 00007ff9</code>47364968 : 00000000<code>00000000 00000000</code>00000027 00000000<code>00000000 00000000</code>00000000 : chrome_child!content::ContentMainRunnerImpl::Run+0x171 [C:\b\c\b\win64_clang\src\content\app\content_main_runner_impl.cc @ 898]<br>000000bc<code>c85ff140 00007ff9</code>47364568 : 000000bc<code>c85ff6a8 00007ff9</code>47361d5b 00000000<code>000001f6 00007ff9</code>4736111b : chrome_child!service_manager::Main+0x333 [C:\b\c\b\win64_clang\src\services\service_manager\embedder\main.cc @ 472]<br>000000bc<code>c85ff4b0 00007ff9</code>473619f8 : 000000bc<code>c85ff560 00007ff6</code>b70a0000 000000bc<code>c85ff680 00000000</code>00000000 : chrome_child!content::ContentMain+0x41 [C:\b\c\b\win64_clang\src\content\app\content_main.cc @ 19]<br>000000bc<code>c85ff540 00007ff6</code>b70a376c : 0000027a<code>b3b88a60 00007ff9</code>473618e0 000000bc<code>c85ff6a8 0000027a</code>b3b88a50 : chrome_child!ChromeMain+0x118 [C:\b\c\b\win64_clang\src\chrome\app\chrome_main.cc @ 0]<br>000000bc<code>c85ff620 00007ff6</code>b70a1697 : 00000000<code>00000018 ffffffff</code>fffffffe 0000027a<code>b3b8030c 00000000</code>0000001a : chrome!MainDllLoader::Launch+0x28c [C:\b\c\b\win64_clang\src\chrome\app\main_dll_loader_win.cc @ 205]<br>000000bc<code>c85ff710 00000000</code>00000000 : 00007ff6<code>e2000000 00000000</code>00000000 72657265<code>646e6572 0000027a</code>b3b83400 : chrome!std::operator&lt;&lt;<std::char_traits<char> &gt;+0x47 [C:\b\c\b\win64_clang\src\third_party\depot_tools\win_toolchain\vs_files\3bc0ec615cf20ee342f3bc29bc991b5ad66d8d2c\VC\Tools\MSVC\14.14.26428\include\ostream @ 787]</std::char_traits<char></std::unique_ptr<cc::beginmainframeandcommitstate,std::default_delete<cc::beginmainframeandcommitstate></cc::proxymain></base::internal::bindstate<void></p>
<p>STACK_COMMAND:  ~0s; .ecxr ; kb</p>
<p>SYMBOL_STACK_INDEX:  0</p>
<p>SYMBOL_NAME:  chrome!base::win::`anonymous namespace’::ForceCrashOnSigAbort+0</p>
<p>FOLLOWUP_NAME:  MachineOwner</p>
<p>MODULE_NAME: chrome_child</p>
<p>IMAGE_NAME:  chrome_child.dll</p>
<p>DEBUG_FLR_IMAGE_TIMESTAMP:  5becfd50</p>
<p>FAILURE_BUCKET_ID:  NULL_POINTER_WRITE_c0000005_chrome_child.dll!base::win::_anonymous<em>namespace</em>::ForceCrashOnSigAbort</p>
<p>BUCKET_ID:  X64_APPLICATION_FAULT_NULL_POINTER_WRITE_chrome!base::win::_anonymous<em>namespace</em>::ForceCrashOnSigAbort+0</p>
<p>WATSON_STAGEONE_URL:  <a href="http://watson.microsoft.com/StageOne/chrome_exe/70_0_3538_110/5becfd50/chrome_child_dll/70_0_3538_110/5becfd50/c0000005/0183cd80.htm?Retriage=1" target="_blank" rel="external">http://watson.microsoft.com/StageOne/chrome_exe/70_0_3538_110/5becfd50/chrome_child_dll/70_0_3538_110/5becfd50/c0000005/0183cd80.htm?Retriage=1</a></p>
<h2 id="Followup-MachineOwner"><a href="#Followup-MachineOwner" class="headerlink" title="Followup: MachineOwner"></a>Followup: MachineOwner</h2><p>0:000&gt; lmvm chrome_child<br>start             end                 module name<br>00007ff9<code>47360000 00007ff9</code>4c253000   chrome_child C (private pdb symbols)  c:\symbols\chrome_child.dll.pdb\61754B485B7E8429FE4BA7DC749B3ECC1\chrome_child.dll.pdb<br>    Loaded symbol image file: chrome_child.dll<br>    Mapped memory image file: c:\symbols\chrome_child.dll\5BECFD504ef3000\chrome_child.dll<br>    Image path: D:\Google\Chrome\Application\70.0.3538.110\chrome_child.dll<br>    Image name: chrome_child.dll<br>    Timestamp:        Thu Nov 15 13:00:00 2018 (5BECFD50)<br>    CheckSum:         00000000<br>    ImageSize:        04EF3000<br>    File version:     70.0.3538.110<br>    Product version:  70.0.3538.110<br>    File flags:       0 (Mask 0)<br>    File OS:          0 Unknown Base<br>    File type:        1.0 App<br>    File date:        00000000.00000000<br>    Translations:     0409.04b0<br>    CompanyName:      Google Inc.<br>    ProductName:      Google Chrome<br>    InternalName:     chrome_dll<br>    OriginalFilename: chrome.dll<br>    ProductVersion:   70.0.3538.110 //这是客户的Chrome版本<br>    FileVersion:      70.0.3538.110<br>    FileDescription:  Google Chrome<br>LegalCopyright:   Copyright 2017 Google Inc. All rights reserved.</p>
<p>0:000&gt; ~*kv</p>
<p>.  0  Id: 1704.16cc Suspend: 0 Teb: 000000bc<code>c83e2000 Unfrozen
Child-SP          RetAddr           : Args to Child                                                           : Call Site
000000bc</code>c85fb7e8 00007ff9<code>8de25e9a : 000000bc</code>c85fb8a8 00000000<code>00000000 00000000</code>00000000 00000000<code>00000000 : ntdll!ZwDelayExecution+0x14
000000bc</code>c85fb7f0 00007ff9<code>7d5d2e15 : 000000bc</code>c85fb998 00001b18<code>00000000 00000000</code>c00000bb 00000000<code>00000000 : KERNELBASE!SleepEx+0x9a
000000bc</code>c85fb890 00007ff9<code>8decbcf0 : 00000000</code>00000000 000000bc<code>c85ffb60 00000000</code>00000000 00007ff9<code>917b5c52 : chrome_elf!crashpad::</code>anonymous namespace’::UnhandledExceptionHandler+0xdd [C:\b\c\b\win64_clang\src\third_party\crashpad\crashpad\client\crashpad_client_win.cc @ 174]<br>000000bc<code>c85fb9e0 00007ff9</code>91842757 : 00007ff6<code>b71ceb60 00007ff9</code>918dc15c 00000000<code>00000000 00000000</code>00000000 : KERNELBASE!UnhandledExceptionFilter+0x190<br>000000bc<code>c85fbaf0 00007ff9</code>9182ab46 : 000000bc<code>c85fbb89 0000027a</code>b40b0150 00000000<code>00000000 000000bc</code>c85fc7b0 : ntdll!RtlUserThreadStart$filt$0+0x38<br>000000bc<code>c85fbb20 00007ff9</code>9183ed3d : 00000000<code>00000000 000000bc</code>c85fbcc0 000000bc<code>c85fc2c0 000000bc</code>c85fbcc0 : ntdll!_C_specific_handler+0x96<br>000000bc<code>c85fbb90 00007ff9</code>917a6c86 : 000000bc<code>c85fbcc0 000000bc</code>c85fc2c0 00007ff9<code>8ee7ab10 00000000</code>00000000 : ntdll!RtlpExecuteHandlerForException+0xd<br>000000bc<code>c85fbbc0 00007ff9</code>9183dc6e : 00000000<code>000000d0 435fd7c3</code>447a34e2 00000000<code>00000016 00000000</code>000000d0 : ntdll!RtlDispatchException+0x3c6<br>000000bc<code>c85fc2c0 00007ff9</code>48b9cd80 : 00007ff9<code>4b10f6e7 00007ff9</code>4bf74c98 00007ff9<code>4b10f857 000000bc</code>c85fcaf8 : ntdll!KiUserExceptionDispatcher+0x2e (TrapFrame @ 000000bc<code>c85fc6e8)
000000bc</code>c85fca78 00007ff9<code>4b10f6e7 : 00007ff9</code>4bf74c98 00007ff9<code>4b10f857 000000bc</code>c85fcaf8 00000000<code>00000201 : chrome_child!base::win::</code>anonymous namespace’::ForceCrashOnSigAbort [C:\b\c\b\win64_clang\src\base\win\win_util.cc @ 87]<br>000000bc<code>c85fca80 00007ff9</code>4b0fe654 : 00000000<code>00000101 0000027a</code>00000000 00000000<code>00000000 0000027a</code>c7be07c8 : chrome_child!raise+0x22b [minkernel\crts\ucrt\src\appcrt\misc\signal.cpp @ 547]<br>000000bc<code>c85fcaf0 00007ff9</code>48d2c5c5 : 0000027a<code>c7be07c8 0000027a</code>c91d4af8 00000000<code>00000000 000000bc</code>c85fcc60 : chrome_child!abort+0x18 [minkernel\crts\ucrt\src\appcrt\startup\abort.cpp @ 71]<br>000000bc<code>c85fcb20 00007ff9</code>47995d44 : 43978309<code>00000000 00000000</code>00000000 00000000<code>00000000 00000000</code>00000000 : chrome_child!sk_abort_no_print+0x15 [C:\b\c\b\win64_clang\src\skia\ext\SkMemory_new_handler.cpp @ 41]<br>000000bc<code>c85fcb50 00007ff9</code>4a111464 : 0000027a<code>b3f31650 00007ff9</code>48f5e14f 00007ff9<code>4b432658 00007ff9</code>4b432658 : chrome_child!GrOpFlushState::draw+0x1b4 [C:\b\c\b\win64_clang\src\third_party\skia\src\gpu\GrOpFlushState.cpp @ 120]<br>000000bc<code>c85fcbe0 00007ff9</code>47990cf7 : 0000027a<code>be6fdca8 0000027a</code>be6fdca8 00000000<code>00000005 000000bc</code>c85fd540 : chrome_child!<code>anonymous namespace&#39;::AAConvexPathOp::onPrepareDraws+0x2754 [C:\b\c\b\win64_clang\src\third_party\skia\src\gpu\ops\GrAAConvexPathRenderer.cpp @ 943]
000000bc</code>c85fd110 00007ff9<code>47990b41 : 0000027a</code>c9406730 000000bc<code>c85fd4b0 000000bc</code>c85fd304 000000bc<code>c85fd4b0 : chrome_child!GrRenderTargetOpList::onPrepare+0x197 [C:\b\c\b\win64_clang\src\third_party\skia\src\gpu\GrRenderTargetOpList.cpp @ 105]
000000bc</code>c85fd1b0 00007ff9<code>47990830 : 0000027a</code>bac81dd0 0000027a<code>bac81e18 00000000</code>000000ff 00000000<code>00000006 : chrome_child!GrOpList::prepare+0x61 [C:\b\c\b\win64_clang\src\third_party\skia\src\gpu\GrOpList.cpp @ 88]
000000bc</code>c85fd210 00007ff9<code>4798f4cf : 00000000</code>00000000 00000000<code>00000000 00000000</code>00000000 00005c10<code>68089d0f : chrome_child!GrDrawingManager::executeOpLists+0xb0 [C:\b\c\b\win64_clang\src\third_party\skia\src\gpu\GrDrawingManager.cpp @ 315]
000000bc</code>c85fd280 00007ff9<code>47bda0d7 : 00007ff9</code>4b299e07 00005c10<code>6808981f 00007ff9</code>4b299e07 00007ff9<code>4b299dfe : chrome_child!GrDrawingManager::internalFlush+0x75f [C:\b\c\b\win64_clang\src\third_party\skia\src\gpu\GrDrawingManager.cpp @ 232]
000000bc</code>c85fd7a0 00007ff9<code>48d896b4 : 000000bc</code>c85fd830 0000027a<code>8127fd18 0000027a</code>c8b5fef0 00007ff9`4b3a2d30 : chrome_child!GrContext::flush+0x27 [C:\b\c\b\win64_clang\src\third_party\skia\src\gpu\GrContext.cpp @ 366]</p>
<p>   1  Id: 1704.215c Suspend: 0 Teb: 000000bc`c83e4000 Unfrozen</p>
<ol>
<li>分析汇编代码<br>因为源代码行号对应不上，我们看一下汇编代码：<br>0:000&gt; u chrome_child!GrOpFlushState::draw+0x1b4<br>chrome_child!GrOpFlushState::draw+0x1b4 [C:\b\c\b\win64_clang\src\third_party\skia\src\gpu\GrOpFlushState.cpp @ 120]:<br>00007ff9<code>47995d44 897d1c          mov     dword ptr [rbp+1Ch],edi
00007ff9</code>47995d47 897b2c          mov     dword ptr [rbx+2Ch],edi<br>00007ff9<code>47995d4a 48837c244000    cmp     qword ptr [rsp+40h],0
00007ff9</code>47995d50 7507            jne     chrome_child!GrOpFlushState::draw+0x1c9 (00007ff9`47995d59)</li>
</ol>
<p>往前一点：<br>0:000&gt; u chrome_child!GrOpFlushState::draw+0x164 L20<br>chrome_child!GrOpFlushState::draw+0x164 [C:\b\c\b\win64_clang\src\third_party\skia\src\gpu\GrOpFlushState.cpp @ 120]:<br>00007ff9<code>47995cf4 1c85            sbb     al,85h
00007ff9</code>47995cf6 ff754e          push    qword ptr [rbp+4Eh]<br>00007ff9<code>47995cf9 bf01000000      mov     edi,1
00007ff9</code>47995cfe f00fc13d02675204 lock xadd dword ptr [chrome_child!gCurrOpUniqueID (00007ff9<code>4bebc408)],edi
00007ff9</code>47995d06 83c701          add     edi,1<br>00007ff9<code>47995d09 7539            jne     chrome_child!GrOpFlushState::draw+0x1b4 (00007ff9</code>47995d44)<br>00007ff9<code>47995d0b 488d057e2bad03  lea     rax,[chrome_child!</code>string’ (00007ff9<code>4b468890)]
00007ff9</code>47995d12 4889442430      mov     qword ptr [rsp+30h],rax<br>00007ff9<code>47995d17 488d0dc22bad03  lea     rcx,[chrome_child!</code>string’ (00007ff9<code>4b4688e0)]
00007ff9</code>47995d1e 48894c2420      mov     qword ptr [rsp+20h],rcx<br>00007ff9<code>47995d23 c744242817010000 mov     dword ptr [rsp+28h],117h
00007ff9</code>47995d2b 4c8d0d7fa97b03  lea     r9,[chrome_child!<code>string&#39; (00007ff9</code>4b1506b1)]<br>00007ff9<code>47995d32 ba17010000      mov     edx,117h
00007ff9</code>47995d37 4531c0          xor     r8d,r8d<br>00007ff9<code>47995d3a e8016a3901      call    chrome_child!SkDebugf_FileLine (00007ff9</code>48d2c740)<br>00007ff9<code>47995d3f e86c683901      call    chrome_child!sk_abort_no_print (00007ff9</code>48d2c5b0) //堆栈位置<br>00007ff9<code>47995d44 897d1c          mov     dword ptr [rbp+1Ch],edi
00007ff9</code>47995d47 897b2c          mov     dword ptr [rbx+2Ch],edi<br>00007ff9<code>47995d4a 48837c244000    cmp     qword ptr [rsp+40h],0
00007ff9</code>47995d50 7507            jne     chrome_child!GrOpFlushState::draw+0x1c9 (00007ff9<code>47995d59)
00007ff9</code>47995d52 4d89a618010000  mov     qword ptr [r14+118h],r12</p>
<p>打印一下几个关键的string<br>0:000&gt; da 00007ff9<code>4b1506b1
00007ff9</code>4b1506b1  “%s(%d): fatal error: “%s”.”<br>0:000&gt; da 00007ff9<code>4b4688e0
00007ff9</code>4b4688e0  “../../third_party/skia/src/gpu/o”<br>00007ff9<code>4b468900  &quot;ps/GrOp.h&quot;
0:000&gt; da 00007ff9</code>4b468890<br>00007ff9<code>4b468890  &quot;This should never wrap as it sho&quot;
00007ff9</code>4b4688b0  “uld only be called once for each”<br>00007ff9`4b4688d0  “ GrOp subclass.”</p>
<ol>
<li>定位源码<br>通过这些string和汇编，我们定位到源码调用栈为：<br><a href="https://chromium.googlesource.com/skia/+/master/src/gpu/GrOpFlushState.cpp" target="_blank" rel="external">https://chromium.googlesource.com/skia/+/master/src/gpu/GrOpFlushState.cpp</a><br>void GrOpFlushState::draw(sk_sp<const grgeometryprocessor=""> gp, const GrPipeline* pipeline,<pre><code>const GrPipeline::FixedDynamicState* fixedDynamicState,
const GrPipeline::DynamicStateArrays* dynamicStateArrays,
const GrMesh meshes[], int meshCnt) {
</code></pre>SkASSERT(fOpArgs);<br>SkASSERT(fOpArgs-&gt;fOp);<br>bool firstDraw = fDraws.begin() == fDraws.end();<br>auto&amp; draw = fDraws.append(&amp;fArena);<br>GrDeferredUploadToken token = fTokenTracker-&gt;issueDrawToken();<br>if (fixedDynamicState &amp;&amp; fixedDynamicState-&gt;fPrimitiveProcessorTextures) {<br>  for (int i = 0; i &lt; gp-&gt;numTextureSamplers(); ++i) {<pre><code>fixedDynamicState-&gt;fPrimitiveProcessorTextures[i]-&gt;addPendingRead();
</code></pre>  }<br>}<br>if (dynamicStateArrays &amp;&amp; dynamicStateArrays-&gt;fPrimitiveProcessorTextures) {<br>  int n = gp-&gt;numTextureSamplers() * meshCnt;<br>  for (int i = 0; i &lt; n; ++i) {<pre><code>dynamicStateArrays-&gt;fPrimitiveProcessorTextures[i]-&gt;addPendingRead();
</code></pre>  }<br>}<br>draw.fGeometryProcessor = std::move(gp);<br>draw.fPipeline = pipeline;<br>draw.fFixedDynamicState = fixedDynamicState;<br>draw.fDynamicStateArrays = dynamicStateArrays;<br>draw.fMeshes = meshes;<br>draw.fMeshCnt = meshCnt;<br>draw.fOpID = fOpArgs-&gt;fOp-&gt;uniqueID();<br>if (firstDraw) {<br>  fBaseDrawToken = token;<br>}<br>}</const></li>
</ol>
<p><a href="https://chromium.googlesource.com/skia/+/master/src/gpu/ops/GrOp.h" target="_blank" rel="external">https://chromium.googlesource.com/skia/+/master/src/gpu/ops/GrOp.h</a><br>// We lazily initialize the uniqueID because currently the only user is GrAuditTrail<br>uint32_t uniqueID() const {<br>    if (kIllegalOpID == fUniqueID) {<br>        fUniqueID = GenOpID();<br>    }<br>    return fUniqueID;<br>}</p>
<p><a href="https://chromium.googlesource.com/skia/+/master/src/gpu/ops/GrOp.h" target="_blank" rel="external">https://chromium.googlesource.com/skia/+/master/src/gpu/ops/GrOp.h</a><br>static uint32_t GenOpID() { return GenID(&amp;gCurrOpUniqueID); }</p>
<p><a href="https://chromium.googlesource.com/skia/+/master/src/gpu/ops/GrOp.h" target="_blank" rel="external">https://chromium.googlesource.com/skia/+/master/src/gpu/ops/GrOp.h</a><br>static uint32_t GenID(int32_t* idCounter) {<br>    // The atomic inc returns the old value not the incremented value. So we add<br>    // 1 to the returned value.<br>    uint32_t id = static_cast<uint32_t>(sk_atomic_inc(idCounter)) + 1;<br>    if (!id) {<br>        SK_ABORT(“This should never wrap as it should only be called once for each GrOp “<br>               “subclass.”);<br>    }<br>    return id;<br>}</uint32_t></p>
<p><a href="https://github.com/google/skia/blob/81abc43e6f0b1a789e1bf116820c8ede68d778ab/include/core/SkPostConfig.h" target="_blank" rel="external">https://github.com/google/skia/blob/81abc43e6f0b1a789e1bf116820c8ede68d778ab/include/core/SkPostConfig.h</a> </p>
<p>#if !defined(SkNO_RETURN_HINT)</p>
<h1 id="if-SK-HAS-COMPILER-FEATURE-attribute-analyzer-noreturn"><a href="#if-SK-HAS-COMPILER-FEATURE-attribute-analyzer-noreturn" class="headerlink" title="if SK_HAS_COMPILER_FEATURE(attribute_analyzer_noreturn)"></a>if SK_HAS_COMPILER_FEATURE(attribute_analyzer_noreturn)</h1><pre><code>static inline void SkNO_RETURN_HINT() __attribute__((analyzer_noreturn));
static inline void SkNO_RETURN_HINT() {}
</code></pre><h1 id="else"><a href="#else" class="headerlink" title="else"></a>else</h1><h1 id="define-SkNO-RETURN-HINT-do-while-false"><a href="#define-SkNO-RETURN-HINT-do-while-false" class="headerlink" title="define SkNO_RETURN_HINT() do {} while (false)"></a>define SkNO_RETURN_HINT() do {} while (false)</h1><h1 id="endif"><a href="#endif" class="headerlink" title="endif"></a>endif</h1><p>#endif</p>
<p>#if defined(SK_BUILD_FOR_GOOGLE3)<br>    void SkDebugfForDumpStackTrace(const char<em> data, void</em> unused);<br>    void DumpStackTrace(int skip_count, void w(const char<em>, void</em>), void* arg);</p>
<h1 id="define-SK-DUMP-GOOGLE3-STACK-DumpStackTrace-0-SkDebugfForDumpStackTrace-nullptr"><a href="#define-SK-DUMP-GOOGLE3-STACK-DumpStackTrace-0-SkDebugfForDumpStackTrace-nullptr" class="headerlink" title="define SK_DUMP_GOOGLE3_STACK() DumpStackTrace(0, SkDebugfForDumpStackTrace, nullptr)"></a>define SK_DUMP_GOOGLE3_STACK() DumpStackTrace(0, SkDebugfForDumpStackTrace, nullptr)</h1><p>#else</p>
<h1 id="define-SK-DUMP-GOOGLE3-STACK"><a href="#define-SK-DUMP-GOOGLE3-STACK" class="headerlink" title="define SK_DUMP_GOOGLE3_STACK()"></a>define SK_DUMP_GOOGLE3_STACK()</h1><p>#endif</p>
<p>#ifdef SK_BUILD_FOR_WIN<br>// permits visual studio to follow error back to source</p>
<p>#define SK_DUMP_LINE_FORMAT(message) \<br>    SkDebugf(“%s(%d): fatal error: \”%s\”\n”, <strong>FILE</strong>, <strong>LINE</strong>, message)</p>
<p>#else</p>
<p>#define SK_DUMP_LINE_FORMAT(message) \<br>    SkDebugf(“%s:%d: fatal error: \”%s\”\n”, <strong>FILE</strong>, <strong>LINE</strong>, message)</p>
<p>#endif</p>
<p>#ifndef SK_ABORT</p>
<h1 id="define-SK-ABORT-message"><a href="#define-SK-ABORT-message" class="headerlink" title="define SK_ABORT(message) \"></a>define SK_ABORT(message) \</h1><pre><code>do { \
   SkNO_RETURN_HINT(); \
   SK_DUMP_LINE_FORMAT(message); \
   SK_DUMP_GOOGLE3_STACK(); \
   sk_abort_no_print(); \
} while (false)
</code></pre><p>#endif</p>
<p>这个宏展开后，就是<br>SkDebugf(“%s(%d): fatal error: \”%s\”\n”, <strong>FILE</strong>, <strong>LINE</strong>, message)<br>sk_abort_no_print();<br>和汇编能对应上。</p>
<ol>
<li>分析Crash原因</li>
</ol>
<p>看看idCounter的初始值：<br>enum {<br>    kIllegalOpID = 0,<br>};<br>int32_t GrOp::gCurrOpUniqueID = GrOp::kIllegalOpID;<br>初始为0。</p>
<p>现在分析为何会abrt：<br>if (!id) {<br>        SK_ABORT(“This should never wrap as it should only be called once for each GrOp “<br>               “subclass.”);<br>    }<br>要abrt，id必须为0，表示：<br>uint32_t id = static_cast<uint32_t>(sk_atomic_inc(idCounter)) + 1;</uint32_t></p>
<p>sk_atomic_inc(idCounter)返回的值必须是(uint32_t)0xFFFFFFFF</p>
<p>排除sk_atomic_inc的BUG：<br><a href="https://chromium.googlesource.com/chromium/chromium/+/master/skia/ext/SkThread_chrome.cc" target="_blank" rel="external">https://chromium.googlesource.com/chromium/chromium/+/master/skia/ext/SkThread_chrome.cc</a><br>int32_t sk_atomic_inc(int32_t* addr) {<br>  // sk_atomic_inc is expected to return the old value,<br>  // Barrier_AtomicIncrement returns the new value.<br>  return base::subtle::NoBarrier_AtomicIncrement(addr, 1) - 1;<br>}</p>
<p><a href="https://github.com/adobe/chromium/blob/cfe5bf0b51b1f6b9fe239c2a3c2f2364da9967d7/third_party/tcmalloc/chromium/src/base/atomicops-internals-x86.h" target="_blank" rel="external">https://github.com/adobe/chromium/blob/cfe5bf0b51b1f6b9fe239c2a3c2f2364da9967d7/third_party/tcmalloc/chromium/src/base/atomicops-internals-x86.h</a><br>inline Atomic64 NoBarrier_AtomicIncrement(volatile Atomic64<em> ptr,<br>                                          Atomic64 increment) {<br>  Atomic64 temp = increment;<br>  <strong>asm</strong> <strong>volatile</strong>(“lock; xaddq %0,%1”<br>                       : “+r” (temp), “+m” (</em>ptr)<br>                       : : “memory”);<br>  // temp now contains the previous value of *ptr<br>  return temp + increment;<br>}</p>
<p>对应汇编：<br>00007ff9<code>47995cfe f00fc13d02675204 lock xadd dword ptr [chrome_child!gCurrOpUniqueID (00007ff9</code>4bebc408)],edi<br>00007ff9`47995d06 83c701          add     edi,1</p>
<p>ak_atomic_inc比较就是一个xadd操作，没有问题。</p>
<p>那要让外部溢出，这个add操作应该返回 0xFFFFFFFF，4294967295为42亿次调用，便会warp。</p>
<p>验证问题<br>既然怀疑是此处有问题，那么我们修改内存验证来重现一下，首先，需要找一台带有显卡的物理机（之前在虚拟机里面测试，由于虚拟机没有显卡，不会跑到此GPU渲染逻辑），然后保证符号一定能加载上，直接修改内存地址：<br>0:018&gt; ed 00000000<code>570cb120 0xFFFFFFF0
0:018&gt; dd gCurrOpUniqueID
00000000</code>570cb120  fffffff0 00000002 8000021f 00000000</p>
<p>如上，将gCurrOpUniqueID值修改为0xFFFFFFF0，再运行，马上就Crash：<br>0:018&gt; g<br>(211c.c68): Access violation - code c0000005 (first chance)   马上就Crash了<br>First chance exceptions are reported before any exception handling.<br>This exception may be expected and handled.<br>chrome_child!base::win::`anonymous namespace’::ForceCrashOnSigAbort:<br>544f9fb0 c7050000000037130000 mov dword ptr ds:[0],1337h ds:002b:00000000=????????</p>
<p>此验证说明，前面的堆栈分析和实际是相符合的。</p>
<p>现在，我们测试一下，到底多久会溢出，通过秒表跑了30秒，获取前后gCurrOpUniqueID的值：<br>0:018&gt; dd gCurrOpUniqueID<br>00000000<code>570cb120  0003bb6f 00000002 8000021f 00000000
0:018&gt; g
(211c.918): Break instruction exception - code 80000003 (first chance)
ntdll!DbgBreakPoint:
00000000</code>77a0b1f0 cc              int     3<br>0:018&gt; dd gCurrOpUniqueID<br>00000000`570cb120  0003f7ff 00000002 8000021f 00000000</p>
<p>计算一下，30秒增长53021，一天53021<em>2</em>60*24增长 152700480，需要28天左右才会rewind。考虑到调试时候速度慢一些，假设慢4倍，那正好一周左右会溢出。</p>
<p>溢出后新产生的Core dump，会出现多个版本，其中一个是和客户的Core dump完全能对应上的，另一个和之前我们自己重现出来的堆栈破坏Core dump也能对应上，此堆栈如下：<br>FAULTING_IP:<br>chrome_child!base::win::IsDeviceUsedAsATablet+a0 [C:\b\c\b\win_clang\src\base\win\win_util.cc @ 516]<br>544f9fb0 c7050000000037130000 mov dword ptr ds:[0],1337h</p>
<p>EXCEPTION_RECORD:  ffffffff – (.exr 0xffffffffffffffff)<br>ExceptionAddress: 544f9fb0 (chrome_child!base::win::IsDeviceUsedAsATablet+0x000000a0)<br>   ExceptionCode: c0000005 (Access violation)<br>  ExceptionFlags: 00000000<br>NumberParameters: 2<br>   Parameter[0]: 00000001<br>   Parameter[1]: 00000000<br>Attempt to write to address 00000000</p>
<p>PROCESS_NAME:  chrome.exe</p>
<p>ERROR_CODE: (NTSTATUS) 0xc0000005 - 0x%08lx</p>
<p>EXCEPTION_CODE: (NTSTATUS) 0xc0000005 - 0x%08lx</p>
<p>EXCEPTION_PARAMETER1:  00000001</p>
<p>EXCEPTION_PARAMETER2:  00000000</p>
<p>WRITE_ADDRESS:  00000000 </p>
<p>FOLLOWUP_IP:<br>chrome_child!base::win::IsDeviceUsedAsATablet+a0 [C:\b\c\b\win_clang\src\base\win\win_util.cc @ 516]<br>544f9fb0 c7050000000037130000 mov dword ptr ds:[0],1337h</p>
<p>MOD_LIST: <analysis></analysis></p>
<p>CHKIMG_EXTENSION: !chkimg -lo 50 -d !chrome_child<br>    5309526a - chrome_child!base::trace_event::MemoryDumpProviderInfo::MemoryDumpProviderInfo+5a<br>    [ 12:02 ]<br>    530952cd-530952ce  2 bytes - chrome_child!base::internal::LockImpl::Lock+4d (+0x63)<br>    [ c6 3a:46 3b ]<br>    53095331 - chrome_child!base::debug::ScopedLockAcquireActivity::ScopedLockAcquireActivity+41 (+0x64)<br>    [ 62:e2 ]<br>    53095383-53095384  2 bytes - chrome_child!base::debug::GlobalActivityTracker::ScopedThreadActivity::ScopedThreadActivity+43 (+0x52)<br>    [ d9 d4:69 d5 ]<br>    544f9f30-544f9f61  50 bytes - chrome_child!base::win::IsDeviceUsedAsATablet+20 (+0x1464bad)<br>    [ 85 f6 0f 84 33 03 00 00:8a 45 ec 89 f1 88 44 24 ]<br>    544f9f63-544f9f8f  45 bytes - chrome_child!base::win::IsDeviceUsedAsATablet+53 (+0x33)<br>    [ 04 03 00 00 c7 04 24 5f:e8 af ee 02 02 83 c4 08 ]<br>    544f9f91-544f9fec  92 bytes - chrome_child!base::win::IsDeviceUsedAsATablet+81 (+0x2e)<br>    [ 00 00 85 f6 0f 84 d0 02:31 db 8b 4d f0 31 e9 e8 ]<br>    544f9fee-544f9ffb  14 bytes - chrome_child!base::win::IsDeviceUsedAsATablet+de (+0x5d)<br>    [ f9 1f 0f 83 de 01 00 00:e1 00 00 00 8a 45 d8 89 ]<br>    544f9ffe-544fa014  23 bytes - chrome_child!base::win::IsDeviceUsedAsATablet+ee (+0x10)<br>    [ 04 c7 44 24 0c 1f 00 00:08 91 0d 6e 56 c7 04 24 ]<br>    544fa016-544fa030  27 bytes - chrome_child!base::win::IsDeviceUsedAsATablet+106 (+0x18)<br>    [ e8 53 a9 ba fe 83 ec 10:00 c7 04 24 5f 00 00 00 ]<br>    544fa032-544fa056  37 bytes - chrome_child!base::win::IsDeviceUsedAsATablet+122 (+0x1c)<br>    [ 00 00 c7 44 24 04 91 0d:ff 15 28 6e fa 56 83 ec ]<br>    544fa058-544fa0a0  73 bytes - chrome_child!base::win::IsDeviceUsedAsATablet+148 (+0x26)<br>    [ 72 02 8b 0e c7 44 01 0c:0f 83 9f 00 00 00 8a 45 ]<br>    544fa0a2-544fa0f1  80 bytes - chrome_child!base::win::IsDeviceUsedAsATablet+192 (+0x4a)<br>    [ ec 08 85 c0 74 20 8d 4d:de 01 00 00 8a 45 dc 89 ]<br>    544fa0f3-544fa12f  61 bytes - chrome_child!base::win::IsDeviceUsedAsATablet+1e3 (+0x51)<br>    [ 85 c0 0f 84 83 00 00 00:02 c6 47 36 00 e9 1e 02 ]<br>508 errors : !chrome_child (5309526a-544fa12f)</p>
<p>FAULTING_THREAD:  000031c4</p>
<p>BUGCHECK_STR:  APPLICATION_FAULT_MEMORY_CORRUPTION_NULL_POINTER_WRITE_LARGE</p>
<p>PRIMARY_PROBLEM_CLASS:  MEMORY_CORRUPTION_LARGE</p>
<p>DEFAULT_BUCKET_ID:  MEMORY_CORRUPTION_LARGE</p>
<p>LAST_CONTROL_TRANSFER:  from 5655b868 to 544f9fb0</p>
<p>STACK_TEXT:<br>0036d52c 5655b868 00000016 5465f605 0036d564 chrome_child!base::win::IsDeviceUsedAsATablet+0xa0 [C:\b\c\b\win_clang\src\base\win\win_util.cc @ 516]<br>0036d53c 53607be6 00000000 00000000 05a30998 chrome_child!_get_fmode+0x2b [minkernel\crts\ucrt\src\appcrt\lowio\setmode.cpp @ 121]<br>0036d564 53607a31 00000000 0986006c 00000000 chrome_child!GrOpFlushState::draw+0x166 [C:\b\c\b\win_clang\src\third_party\skia\src\gpu\GrOpFlushState.cpp @ 120]<br>0036d66c 5334fa98 0036e7b0 00008000 ac34bc51 chrome_child!GrMeshDrawOp::Target::draw+0x11 [C:\b\c\b\win_clang\src\third_party\skia\src\gpu\ops\GrMeshDrawOp.h @ 93]<br>0036e530 530911da 05a30998 0997b560 00000000 chrome_child!sk_malloc_flags+0x68 [C:\b\c\b\win_clang\src\skia\ext\SkMemory_new_handler.cpp @ 117]<br>0036e534 05a30998 0997b560 00000000 00000000 chrome_child!base::allocator::WinHeapFree+0x1a [C:\b\c\b\win_clang\src\base\allocator\winheap_stubs_win.cc @ 43]<br>WARNING: Frame IP not in any known module. Following frames may be wrong.<br>0036e538 0997b560 00000000 00000000 00000000 0x5a30998<br>0036e53c 00000000 00000000 00000000 00000000 0x997b560</p>
<p>STACK_COMMAND:  ~0s; .ecxr ; kb</p>
<p>SYMBOL_NAME:  memory_corruption!chrome_child</p>
<p>FOLLOWUP_NAME:  MachineOwner</p>
<p>MODULE_NAME: memory_corruption</p>
<p>IMAGE_NAME:  memory_corruption</p>
<p>DEBUG_FLR_IMAGE_TIMESTAMP:  0</p>
<p>FAILURE_BUCKET_ID:  MEMORY_CORRUPTION_LARGE_c0000005_memory_corruption!chrome_child</p>
<p>BUCKET_ID:  APPLICATION_FAULT_MEMORY_CORRUPTION_NULL_POINTER_WRITE_LARGE_memory_corruption!chrome_child</p>
<p>WATSON_STAGEONE_URL:  <a href="http://watson.microsoft.com/StageOne/chrome_exe/70_0_3538_102/5be3c2d0/chrome_child_dll/70_0_3538_102/5be3c2d0/c0000005/01469fb0.htm?Retriage=1" target="_blank" rel="external">http://watson.microsoft.com/StageOne/chrome_exe/70_0_3538_102/5be3c2d0/chrome_child_dll/70_0_3538_102/5be3c2d0/c0000005/01469fb0.htm?Retriage=1</a></p>
<h2 id="Followup-MachineOwner-1"><a href="#Followup-MachineOwner-1" class="headerlink" title="Followup: MachineOwner"></a>Followup: MachineOwner</h2><p>此堆栈破坏版本，没法跟到根因，导致之前一次分析自己的Core dump时，误以为是踩内存导致，其实应该是Crash handler没有dump好内存。</p>
<p>还有一种堆栈，是GPU Watch dog超时（15秒），这个Crash的是GPU进程，之前的是render进程：</p>
<p>Executable search path is:<br>Windows 7 Version 7601 (23391) MP (2 procs) Free x64<br>Product: WinNt<br>Machine Name:<br>Debug session time: Sat Nov 10 12:11:41.000 2018 (GMT+8) //这个时间，应该是客户的老机器<br>System Uptime: not available<br>Process Uptime: 0 days 13:31:03.000<br>……………………………………………………….<br>……………………<br>Loading unloaded module list</p>
<p>0:001&gt; !analyze -v<br>Failed calling InternetOpenUrl, GLE=12002</p>
<p>FAULTING_IP:<br>chrome_child!gpu::GpuWatchdogThread::DeliberatelyTerminateToRecoverFromHang+1c1 [C:\b\c\b\win64_clang\src\gpu\ipc\service\gpu_watchdog_thread.cc @ 505]<br>000007fe`ebec081f c704250000000037130000 mov dword ptr [0],1337h</p>
<p>EXCEPTION_RECORD:  ffffffffffffffff – (.exr 0xffffffffffffffff)<br>ExceptionAddress: 000007feebec081f (chrome_child!gpu::GpuWatchdogThread::DeliberatelyTerminateToRecoverFromHang+0x00000000000001c1)<br>   ExceptionCode: c0000005 (Access violation)<br>  ExceptionFlags: 00000000<br>NumberParameters: 2<br>   Parameter[0]: 0000000000000001<br>   Parameter[1]: 0000000000000000<br>Attempt to write to address 0000000000000000</p>
<p>DEFAULT_BUCKET_ID:  NULL_POINTER_WRITE</p>
<p>PROCESS_NAME:  chrome.exe</p>
<p>ERROR_CODE: (NTSTATUS) 0xc0000005 - 0x%08lx</p>
<p>EXCEPTION_CODE: (NTSTATUS) 0xc0000005 - 0x%08lx</p>
<p>EXCEPTION_PARAMETER1:  0000000000000001</p>
<p>EXCEPTION_PARAMETER2:  0000000000000000</p>
<p>WRITE_ADDRESS:  0000000000000000 </p>
<p>FOLLOWUP_IP:<br>chrome_child!gpu::GpuWatchdogThread::DeliberatelyTerminateToRecoverFromHang+1c1 [C:\b\c\b\win64_clang\src\gpu\ipc\service\gpu_watchdog_thread.cc @ 505]<br>000007fe`ebec081f c704250000000037130000 mov dword ptr [0],1337h</p>
<p>MOD_LIST: <analysis></analysis></p>
<p>NTGLOBALFLAG:  0</p>
<p>FAULTING_THREAD:  000000000000135c</p>
<p>PRIMARY_PROBLEM_CLASS:  NULL_POINTER_WRITE</p>
<p>BUGCHECK_STR:  APPLICATION_FAULT_NULL_POINTER_WRITE</p>
<p>LAST_CONTROL_TRANSFER:  from 000007feebec0489 to 000007feebec081f</p>
<p>STACK_TEXT:<br>00000000<code>0349f440 000007fe</code>ebec0489 : 00000000<code>00000001 00000000</code>00000000 0000deed<code>2785490f 000000d9</code>e819a530 : chrome_child!gpu::GpuWatchdogThread::DeliberatelyTerminateToRecoverFromHang+0x1c1 [C:\b\c\b\win64_clang\src\gpu\ipc\service\gpu_watchdog_thread.cc @ 505]<br>00000000<code>0349f520 000007fe</code>ea16d2cc : 00000000<code>00000000 00000000</code>7751dba8 00000000<code>00000000 000007fe</code>00000002 : chrome_child!gpu::GpuWatchdogThread::OnCheckTimeout+0x61 [C:\b\c\b\win64_clang\src\gpu\ipc\service\gpu_watchdog_thread.cc @ 368]<br>00000000<code>0349f5d0 000007fe</code>ea16cb37 : 00000000<code>00000000 00000000</code>028674d0 00000000<code>00000001 00000000</code>0349f758 : chrome_child!base::debug::TaskAnnotator::RunTask+0x12c [C:\b\c\b\win64_clang\src\base\debug\task_annotator.cc @ 101]<br>00000000<code>0349f6f0 000007fe</code>ea1682bd : 00000000<code>00000048 00000000</code>00000001 00000000<code>00000000 000007fe</code>ee92d8d0 : chrome_child!base::MessageLoop::RunTask+0x247 [C:\b\c\b\win64_clang\src\base\message_loop\message_loop.cc @ 423]<br>00000000<code>0349f850 000007fe</code>ea1678bc : 00000000<code>00000000 000007fe</code>ea14bb94 00000000<code>0349fa70 000007fe</code>ee92d6d8 : chrome_child!base::MessageLoop::DoDelayedWork+0x18d [C:\b\c\b\win64_clang\src\base\message_loop\message_loop.cc @ 521]<br>00000000<code>0349f9c0 000007fe</code>ea167621 : 00000000<code>02867250 00000000</code>00000000 00000000<code>02867260 00000000</code>02867250 : chrome_child!base::MessagePumpDefault::Run+0x4c [C:\b\c\b\win64_clang\src\base\message_loop\message_pump_default.cc @ 42]<br>00000000<code>0349fa20 000007fe</code>ea163f90 : 00000000<code>00000000 00000000</code>00000000 000007fe<code>ea13d4e2 00000000</code>00000000 : chrome_child!base::RunLoop::Run+0x31 [C:\b\c\b\win64_clang\src\base\run_loop.cc @ 108]<br>00000000<code>0349fa50 000007fe</code>eb8670b4 : 00000000<code>00000000 00000000</code>00000000 00000000<code>00000000 00000000</code>00000000 : chrome_child!base::Thread::ThreadMain+0x180 [C:\b\c\b\win64_clang\src\base\threading\thread.cc @ 340]<br>00000000<code>0349fae0 00000000</code>773c59bd : 00000000<code>00000000 00000000</code>00000000 00000000<code>00000000 00000000</code>00000000 : chrome_child!base::<code>anonymous namespace&#39;::ThreadFunc+0xf4 [C:\b\c\b\win64_clang\src\base\threading\platform_thread_win.cc @ 94]
00000000</code>0349fb60 00000000<code>774fa2e1 : 00000000</code>00000000 00000000<code>00000000 00000000</code>00000000 00000000<code>00000000 : kernel32!BaseThreadInitThunk+0xd
00000000</code>0349fb90 00000000<code>00000000 : 00000000</code>00000000 00000000<code>00000000 00000000</code>00000000 00000000`00000000 : ntdll!RtlUserThreadStart+0x1d</p>
<p>STACK_COMMAND:  ~1s; .ecxr ; kb</p>
<p>SYMBOL_STACK_INDEX:  0</p>
<p>SYMBOL_NAME:  chrome_child!gpu::GpuWatchdogThread::DeliberatelyTerminateToRecoverFromHang+1c1</p>
<p>FOLLOWUP_NAME:  MachineOwner</p>
<p>MODULE_NAME: chrome_child</p>
<p>IMAGE_NAME:  chrome_child.dll</p>
<p>DEBUG_FLR_IMAGE_TIMESTAMP:  5b96fc9f</p>
<p>FAILURE_BUCKET_ID:  NULL_POINTER_WRITE_c0000005_chrome_child.dll!gpu::GpuWatchdogThread::DeliberatelyTerminateToRecoverFromHang</p>
<p>BUCKET_ID:  X64_APPLICATION_FAULT_NULL_POINTER_WRITE_chrome_child!gpu::GpuWatchdogThread::DeliberatelyTerminateToRecoverFromHang+1c1</p>
<p>WATSON_STAGEONE_URL:  <a href="http://watson.microsoft.com/StageOne/chrome_exe/69_0_3497_92/5b96fd04/chrome_child_dll/69_0_3497_92/5b96fc9f/c0000005/01da081f.htm?Retriage=1" target="_blank" rel="external">http://watson.microsoft.com/StageOne/chrome_exe/69_0_3497_92/5b96fd04/chrome_child_dll/69_0_3497_92/5b96fc9f/c0000005/01da081f.htm?Retriage=1</a></p>
<p>Followup: MachineOwner</p>
<p>此进程是GPU渲染进程：<br>0:001&gt; !peb<br>PEB at 000007fffffdf000<br>CommandLine ‘“C:\Users\Administrator\AppData\Local\Google\Chrome\Application\chrome.exe” –type=gpu-process –field-trial-handle=1028,15351644294314642440,598078252489282679,131072 –gpu-preferences=KAAAAAAAAACAAwBAAQAAAAAAAAAAAGAAAAAAAAAAAAAIAAAAAAAAACgAAAAEAAAAIAAAAAAAAAAoAAAAAAAAADAAAAAAAAAAOAAAAAAAAAAQAAAAAAAAAAAAAAAKAAAAEAAAAAAAAAAAAAAACwAAABAAAAAAAAAAAQAAAAoAAAAQAAAAAAAAAAEAAAALAAAA –service-request-channel-token=2922249399616643618 –mojo-platform-channel-handle=2076 –ignored=” –type=renderer “ /prefetch:2’</p>
<p>搜索到类似BUG <a href="https://bugs.chromium.org/p/chromium/issues/detail?id=597700" target="_blank" rel="external">https://bugs.chromium.org/p/chromium/issues/detail?id=597700</a> 看讨论说升级intel驱动可解决。</p>
<p>下断点：<br>bp chrome_child!gpu::GpuWatchdogThread::OnCheckTimeout<br>bp chrome_child!gpu::GpuWatchdogThread::OnCheck</p>
<p>0:001:x86&gt; bl<br> 0 e x86 10a48680     0001 (0001)  0:<strong><strong> chrome_child!gpu::GpuWatchdogThread::OnCheckTimeout<br> 2 e x86 10a4817c     0001 (0001)  0:</strong></strong> chrome_child!gpu::GpuWatchdogThread::OnCheck<br>0:001:x86&gt; g<br>Breakpoint 2 hit<br>chrome_child!gpu::GpuWatchdogThread::OnCheck:  //在GPU硬件加速开启的情况下定时15秒会断下来，不开启的时候，断不下来。<br>10a4817c 55              push    ebp<br>0:001:x86&gt; kv<br>ChildEBP RetAddr  Args to Child<br>038af968 10338e22 00000000 10a4817c 00000000 chrome_child!gpu::GpuWatchdogThread::OnCheck (CONV: thiscall) [C:\b\c\b\win_clang\src\gpu\ipc\service\gpu_watchdog_thread.cc @ 292]<br>038af984 0f07c562 04e51808 02440000 00000000 chrome_child!base::internal::Invoker<base::internal::bindstate<void (blink::scheduler::mainthreadschedulerimpl::*)(bool)="" __attribute__((thiscall)),base::weakptr<blink::scheduler::mainthreadschedulerimpl="">,bool&gt;,void ()&gt;::RunOnce+0x44 (CONV: cdecl) [C:\b\c\b\win_clang\src\base\bind_internal.h @ 662]<br>038af9f0 0f07bbd3 1267f4c0 038afa98 038afa80 chrome_child!base::debug::TaskAnnotator::RunTask+0xe2 (CONV: thiscall) [C:\b\c\b\win_clang\src\base\debug\task_annotator.cc @ 101]<br>038afa70 0f07baf3 038afa98 0f074740 f687dac3 chrome_child!base::MessageLoop::RunTask+0xb3 (CONV: thiscall) [C:\b\c\b\win_clang\src\base\message_loop\message_loop.cc @ 436]<br>038afa90 0f0752a4 00000000 12848700 128486ac chrome_child!base::MessageLoop::DeferOrRunPendingTask+0x53 (CONV: thiscall) [C:\b\c\b\win_clang\src\base\message_loop\message_loop.cc @ 445]<br>038afb58 0f074b0a 02465a70 02465a70 02465a68 chrome_child!base::MessageLoop::DoDelayedWork+0x134 (CONV: thiscall) [C:\b\c\b\win_clang\src\base\message_loop\message_loop.cc @ 558]<br>038afb78 0f074aaf 0247b6c8 038afbb8 038afb98 chrome_child!base::MessagePumpDefault::Run+0x3a (CONV: thiscall) [C:\b\c\b\win_clang\src\base\message_loop\message_pump_default.cc @ 42]<br>038afb88 0f0748fe 00000001 0247b5e0 038afba0 chrome_child!base::MessageLoop::Run+0x1f (CONV: thiscall) [C:\b\c\b\win_clang\src\base\message_loop\message_loop.cc @ 386]<br>038afb98 0f0748cb 038afbe0 0f073105 038afbb8 chrome_child!base::RunLoop::Run+0x2e (CONV: thiscall) [C:\b\c\b\win_clang\src\base\run_loop.cc @ 108]<br>038afba0 0f073105 038afbb8 0247b6c8 00000000 chrome_child!base::Thread::Run+0xb (CONV: thiscall) [C:\b\c\b\win_clang\src\base\threading\thread.cc @ 263]<br>038afbe0 1047f865 0247b5e0 000001c8 000001c8 chrome_child!base::Thread::ThreadMain+0x165 (CONV: thiscall) [C:\b\c\b\win_clang\src\base\threading\thread.cc @ 360]<br>038afc04 7721343d 0246d408 038afc50 77b99832 chrome_child!base::`anonymous namespace’::ThreadFunc+0x95 (CONV: stdcall) [C:\b\c\b\win_clang\src\base\threading\platform_thread_win.cc @ 103]<br>038afc10 77b99832 0246d408 a7488ffb 00000000 KERNEL32!BaseThreadInitThunk+0xe (FPO: [Non-Fpo])<br>038afc50 77b99805 1047f7d0 0246d408 ffffffff ntdll_77b60000!__RtlUserThreadStart+0x70 (FPO: [Non-Fpo])<br>038afc68 00000000 1047f7d0 0246d408 00000000 ntdll_77b60000!_RtlUserThreadStart+0x1b (FPO: [Non-Fpo])</base::internal::bindstate<void></p>
<p>还有一种是内存耗光的，但是比较早了：<br>Windows 7 Version 7601 (23391) MP (2 procs) Free x64<br>Product: WinNt<br>Machine Name:<br>Debug session time: Sun Nov 18 06:58:52.000 2018 (UTC + 8:00)<br>System Uptime: not available<br>Process Uptime: 4 days 13:20:33.000<br>版本还是69.0.3497.92<br>0:009&gt; !analyze -v<br><em>*</em> WARNING: Unable to verify checksum for KERNELBASE.dll</p>
<hr>
<ul>
<li>*</li>
<li>Exception Analysis                                   *</li>
<li>*</li>
</ul>
<hr>
<p><strong><em> WARNING: Unable to verify checksum for chrome_child.dll
</em></strong> WARNING: Unable to verify checksum for kernel32.dll<br><strong><em> WARNING: Unable to verify checksum for USER32.dll
</em></strong> WARNING: Unable to verify checksum for ole32.dll<br><strong><em> WARNING: Unable to verify checksum for chrome_elf.dll<br>Unable to load image C:\Program Files (x86)\360\360Safe\safemon\safemon64.dll, Win32 error 0n2
</em></strong> WARNING: Unable to verify timestamp for safemon64.dll<br><em>*</em> ERROR: Module load completed but symbols could not be loaded for safemon64.dll<br>Failed calling InternetOpenUrl, GLE=12002</p>
<p>FAULTING_IP:<br>KERNELBASE!RaiseException+39<br>000007fe`fd12a06d 4881c4c8000000  add     rsp,0C8h</p>
<p>EXCEPTION_RECORD:  ffffffffffffffff – (.exr 0xffffffffffffffff)<br>ExceptionAddress: 000007fefd12a06d (KERNELBASE!RaiseException+0x0000000000000039)<br>   ExceptionCode: e0000008<br>  ExceptionFlags: 00000001<br>NumberParameters: 1<br>   Parameter[0]: 0000000045c5c040</p>
<p>DEFAULT_BUCKET_ID:  APPLICATION_FAULT</p>
<p>PROCESS_NAME:  chrome.exe</p>
<p>ERROR_CODE: (NTSTATUS) 0xe0000008 - <unable to="" get="" error="" code="" text=""></unable></p>
<p>EXCEPTION_CODE: (NTSTATUS) 0xe0000008 - <unable to="" get="" error="" code="" text=""></unable></p>
<p>EXCEPTION_PARAMETER1:  0000000045c5c040</p>
<p>MOD_LIST: <analysis></analysis></p>
<p>NTGLOBALFLAG:  0</p>
<p>FAULTING_THREAD:  0000000000001798</p>
<p>PRIMARY_PROBLEM_CLASS:  APPLICATION_FAULT</p>
<p>BUGCHECK_STR:  APPLICATION_FAULT_APPLICATION_FAULT</p>
<p>LAST_CONTROL_TRANSFER:  from 000007feeb854284 to 000007fefd12a06d</p>
<p>STACK_TEXT:<br>00000000<code>04aae590 000007fe</code>eb854284 : 000007fe<code>eb854260 00000000</code>00000000 00000000<code>00000000 00000000</code>012a8ed0 : KERNELBASE!RaiseException+0x39<br>00000000<code>04aae660 000007fe</code>ebc26767 : 00000000<code>00000000 00000000</code>00000000 000007fe<code>edf9ff98 00000000</code>45c5c040 : chrome_child!base::<code>anonymous namespace&#39;::OnNoMemory+0x24 [C:\b\c\b\win64_clang\src\base\process\memory_win.cc @ 55]
00000000</code>04aae690 000007fe<code>ea121136 : 00000000</code>00000003 00000000<code>007f957c 00000000</code>775e03c8 000007fe<code>ea49b5ad : chrome_child!base::allocator::WinCallNewHandler+0x17 [C:\b\c\b\win64_clang\src\base\allocator\winheap_stubs_win.cc @ 90]
00000000</code>04aae6c0 000007fe<code>ea181b98 : 00000000</code>01302f50 00000000<code>04934395 00000000</code>00000000 000007fe<code>ea125d27 : chrome_child!malloc+0x46 [C:\b\c\b\win64_clang\src\base\allocator\allocator_shim_override_ucrt_symbols_win.h @ 53]
00000000</code>04aae700 000007fe<code>ea181a1f : 00000000</code>01302e50 00000000<code>01302e40 00000000</code>04aae880 00000000<code>04aae930 : chrome_child!base::circular_deque&lt;base::sequence_manager::internal::TaskQueueImpl::Task&gt;::ExpandCapacityIfNecessary+0x88 [C:\b\c\b\win64_clang\src\base\containers\circular_deque.h @ 960]
00000000</code>04aae780 000007fe<code>ea1818c2 : 000007fe</code>edf9ff98 00000000<code>00000048 00000000</code>3a4ab518 000007fe<code>ea12111b : chrome_child!base::sequence_manager::internal::TaskQueueImpl::PushOntoImmediateIncomingQueueLocked+0x6f [C:\b\c\b\win64_clang\src\base\task\sequence_manager\task_queue_impl.cc @ 311]
00000000</code>04aae800 000007fe<code>ea17753c : 00000000</code>04aaebb8 000007fe<code>ea125d83 00000000</code>0373c740 000007fe<code>ea499461 : chrome_child!base::sequence_manager::internal::TaskQueueImpl::PostImmediateTaskImpl+0xd2 [C:\b\c\b\win64_clang\src\base\task\sequence_manager\task_queue_impl.cc @ 209]
00000000</code>04aae9f0 000007fe<code>ea177458 : 00000000</code>012bb5c0 00000000<code>00000000 00000000</code>00000000 00000000<code>04aaeb18 : chrome_child!base::sequence_manager::internal::TaskQueueImpl::PostDelayedTask+0x6c [C:\b\c\b\win64_clang\src\base\task\sequence_manager\task_queue_impl.cc @ 192]
00000000</code>04aaeab0 000007fe<code>ea177316 : 00000000</code>012bb740 000007fe<code>ea5ad0a9 00000000</code>00000001 0000123a<code>865fd636 : chrome_child!base::sequence_manager::TaskQueue::PostTaskWithMetadata+0xa8 [C:\b\c\b\win64_clang\src\base\task\sequence_manager\task_queue.cc @ 116]
00000000</code>04aaeb80 000007fe<code>ea16c7bf : 00000000</code>00000038 00000000<code>01309580 00000000</code>1b9d9da0 000007fe<code>edc8150b : chrome_child!blink::scheduler::TaskQueueWithTaskType::PostDelayedTask+0x7e [C:\b\c\b\win64_clang\src\third_party\blink\renderer\platform\scheduler\child\task_queue_with_task_type.cc @ 37]
00000000</code>04aaec50 000007fe<code>ea5ace8a : 00000000</code>00000002 000007fe<code>ea5acd78 00000000</code>04aaedc0 000007fe<code>ea138c80 : chrome_child!base::TaskRunner::PostTask+0x3f [C:\b\c\b\win64_clang\src\base\task_runner.cc @ 44]
00000000</code>04aaeca0 000007fe<code>ea477f1d : 00000000</code>00000000 00000000<code>04aaeea0 000007fe</code>edd5bc30 00000000<code>00000000 : chrome_child!cc::ProxyImpl::DidReceiveCompositorFrameAckOnImplThread+0xea [C:\b\c\b\win64_clang\src\cc\trees\proxy_impl.cc @ 297]
00000000</code>04aaeda0 000007fe<code>ea1cf431 : 00000000</code>00000000 00000000<code>04aaedc0 00000000</code>04aaedc0 00000000<code>00000000 : chrome_child!viz::mojom::CompositorFrameSinkClientStubDispatch::Accept+0x31b [C:\b\c\b\win64_clang\src\out\Release_x64\gen\services\viz\public\interfaces\compositing\compositor_frame_sink.mojom.cc @ 1387]
00000000</code>04aaee80 000007fe<code>ea1cef77 : 00000000</code>04aaeffc 000007fe<code>ea1ce782 000007fe</code>ea49ddc2 000007fe<code>ee8c7af0 : chrome_child!mojo::internal::MultiplexRouter::ProcessIncomingMessage+0x17b [C:\b\c\b\win64_clang\src\mojo\public\cpp\bindings\lib\multiplex_router.cc @ 868]
00000000</code>04aaef50 000007fe<code>ea1ce306 : 00000000</code>04aaf1a8 000007fe<code>ea1be884 0def32d8</code>00020007 00000000<code>012bb350 : chrome_child!mojo::internal::MultiplexRouter::Accept+0xc7 [C:\b\c\b\win64_clang\src\mojo\public\cpp\bindings\lib\multiplex_router.cc @ 594]
00000000</code>04aaf110 000007fe<code>ea1ce181 : 00000000</code>04aaf2f0 00000000<code>066304d0 00000000</code>04aaf340 000007fe<code>ea9eb007 : chrome_child!mojo::Connector::ReadSingleMessage+0xfe [C:\b\c\b\win64_clang\src\mojo\public\cpp\bindings\lib\connector.cc @ 456]
00000000</code>04aaf2b0 000007fe<code>ea1ce05f : 00000000</code>00000000 00000000<code>04ad8f88 00000000</code>04aaf600 000007fe<code>ea1cdf85 : chrome_child!mojo::Connector::ReadAllAvailableMessages+0x63 [C:\b\c\b\win64_clang\src\mojo\public\cpp\bindings\lib\connector.cc @ 486]
00000000</code>04aaf320 000007fe<code>ea16d2cc : 00000000</code>00000000 00000000<code>00000000 00000000</code>00000000 00000000<code>0382b9f8 : chrome_child!mojo::SimpleWatcher::OnHandleReady+0xab [C:\b\c\b\win64_clang\src\mojo\public\cpp\system\simple_watcher.cc @ 274]
00000000</code>04aaf390 000007fe<code>ea1bc986 : 00000000</code>04aaf618 00000000<code>04aaf680 00000000</code>04ad8f18 000007fe<code>ea165781 : chrome_child!base::debug::TaskAnnotator::RunTask+0x12c [C:\b\c\b\win64_clang\src\base\debug\task_annotator.cc @ 101]
00000000</code>04aaf4b0 000007fe<code>ea16d2cc : 00000000</code>3a4ab2f0 00000000<code>00000001 000007fe</code>ea1bce04 00000000<code>03825a18 : chrome_child!base::sequence_manager::internal::ThreadControllerImpl::DoWork+0x1b6 [C:\b\c\b\win64_clang\src\base\task\sequence_manager\thread_controller_impl.cc @ 170]
00000000</code>04aaf6f0 000007fe<code>ea16cb37 : 00000000</code>3a4ab2f0 efefefef<code>efefefef 000007fe</code>ea1bce04 000007fe<code>ea1bce04 : chrome_child!base::debug::TaskAnnotator::RunTask+0x12c [C:\b\c\b\win64_clang\src\base\debug\task_annotator.cc @ 101]
00000000</code>04aaf810 000007fe<code>ea167ac8 : 000007fe</code>edf9ca2c 000007fe<code>edf9c935 0000123a</code>865fc596 0000123a<code>865fc5f6 : chrome_child!base::MessageLoop::RunTask+0x247 [C:\b\c\b\win64_clang\src\base\message_loop\message_loop.cc @ 423]
00000000</code>04aaf970 000007fe<code>ea167909 : 00000000</code>00000000 000007fe<code>ea14bb94 00000000</code>04aafc10 000007fe<code>ee92d6d8 : chrome_child!base::MessageLoop::DoWork+0x198 [C:\b\c\b\win64_clang\src\base\message_loop\message_loop.cc @ 480]
00000000</code>04aafb60 000007fe<code>ea167621 : 00000000</code>00000000 00000000<code>00000000 00000000</code>037df9f0 00000000<code>037df9e0 : chrome_child!base::MessagePumpDefault::Run+0x99 [C:\b\c\b\win64_clang\src\base\message_loop\message_pump_default.cc @ 37]
00000000</code>04aafbc0 000007fe<code>ea163f90 : 00000000</code>00000000 00000000<code>00000000 000007fe</code>ea13d4e2 00000000<code>00000000 : chrome_child!base::RunLoop::Run+0x31 [C:\b\c\b\win64_clang\src\base\run_loop.cc @ 108]
00000000</code>04aafbf0 000007fe<code>eb8670b4 : 00000000</code>00000000 00000000<code>00000000 00000000</code>00000000 00000000<code>00000000 : chrome_child!base::Thread::ThreadMain+0x180 [C:\b\c\b\win64_clang\src\base\threading\thread.cc @ 340]
00000000</code>04aafc80 00000000<code>773c59bd : 00000000</code>00000000 00000000<code>00000000 00000000</code>00000000 00000000<code>00000000 : chrome_child!base::</code>anonymous namespace’::ThreadFunc+0xf4 [C:\b\c\b\win64_clang\src\base\threading\platform_thread_win.cc @ 94]<br>00000000<code>04aafd00 00000000</code>774fa2e1 : 00000000<code>00000000 00000000</code>00000000 00000000<code>00000000 00000000</code>00000000 : kernel32!BaseThreadInitThunk+0xd<br>00000000<code>04aafd30 00000000</code>00000000 : 00000000<code>00000000 00000000</code>00000000 00000000<code>00000000 00000000</code>00000000 : ntdll!RtlUserThreadStart+0x1d</p>
<p>STACK_COMMAND:  ~9s; .ecxr ; kb</p>
<p>FOLLOWUP_IP:<br>chrome_child!base::<code>anonymous namespace&#39;::OnNoMemory+24 [C:\b\c\b\win64_clang\src\base\process\memory_win.cc @ 55]
000007fe</code>eb854284 b9080000e0      mov     ecx,0E0000008h</p>
<p>SYMBOL_STACK_INDEX:  1</p>
<p>SYMBOL_NAME:  chrome_child!base::`anonymous namespace’::OnNoMemory+24</p>
<p>FOLLOWUP_NAME:  MachineOwner</p>
<p>MODULE_NAME: chrome_child</p>
<p>IMAGE_NAME:  chrome_child.dll</p>
<p>DEBUG_FLR_IMAGE_TIMESTAMP:  5b96fc9f</p>
<p>FAILURE_BUCKET_ID:  APPLICATION_FAULT_e0000008_chrome_child.dll!base::_anonymous<em>namespace</em>::OnNoMemory</p>
<p>BUCKET_ID:  X64_APPLICATION_FAULT_APPLICATION_FAULT_chrome_child!base::_anonymous<em>namespace</em>::OnNoMemory+24</p>
<p>WATSON_STAGEONE_URL:  <a href="http://watson.microsoft.com/StageOne/chrome_exe/69_0_3497_92/5b96fd04/KERNELBASE_dll/6_1_7601_23391/56e9ab2a/e0000008/0001a06d.htm?Retriage=1" target="_blank" rel="external">http://watson.microsoft.com/StageOne/chrome_exe/69_0_3497_92/5b96fd04/KERNELBASE_dll/6_1_7601_23391/56e9ab2a/e0000008/0001a06d.htm?Retriage=1</a></p>
<h2 id="Followup-MachineOwner-2"><a href="#Followup-MachineOwner-2" class="headerlink" title="Followup: MachineOwner"></a>Followup: MachineOwner</h2><p>简化重现<br>因为这是一个标准的2d draw调用，不需要用我们的代码，同事专门写了一段2d Canvas绘制代码，便可验证此问题（需要运行好几天），另外，测试的时候，我还发现，把Chrome浏览器最小化或不是激活Tab，都会停止绘图，需要重现得保证Chrome一直显示：</p>
<html lang="en"><br><head><br>    <meta charset="UTF-8"><br>    <title>2d draw</title><br>    <script type="text/javascript"><br>        function draw () {<br>            var c=document.getElementById(“myCanvas”);<br>            var ctx=c.getContext(“2d”);<br>            ctx.beginPath();<br>            ctx.arc(100,75,50,0,2*Math.PI);<br>            ctx.stroke();<br>        }<br>        window.onload = function () {<br>            var time = +new Date();<br>            var test = document.getElementById(‘test’);<br>            var func;<br>            window.requestAnimationFrame(func = function () {<br>                var newTime = +new Date();<br>                test.innerHTML = newTime - time;<br>                time = +new Date();<br>                for(var i = 0; i &lt; 100000; i++)<br>                    draw();<br>                window.requestAnimationFrame(func);<br>            });<br>        }<br>    </script><br></head><br><body><br>    <div id="test"></div><br>    <canvas id="myCanvas" width="500" height="500"></canvas><br></body><br></html>

<p>解决方法<br>目前看，最好的方法是更换为非Chrome浏览器，此问题已经反馈给Chrome官方。<br><a href="https://bugs.chromium.org/p/skia/issues/detail?id=8575&amp;can=1&amp;q=gCurrOpUniqueID&amp;colspec=ID%20Type%20Status%20Priority%20M%20Area%20Owner%20Summary" target="_blank" rel="external">https://bugs.chromium.org/p/skia/issues/detail?id=8575&amp;can=1&amp;q=gCurrOpUniqueID&amp;colspec=ID%20Type%20Status%20Priority%20M%20Area%20Owner%20Summary</a></p>
<p>当天晚上，Chrome就修复了此问题，预计后面的新版本就不会有此问题：</p>
<p>2018/11/29</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://mnstory.net/2018/11/01/cookies-git/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="mnstory.net">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="码农故事">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/11/01/cookies-git/" itemprop="url">Cookies之Git命令</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-10-27T21:00:00+08:00">
                2018-10-27
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h1><h2 id="gitlib秘钥配置"><a href="#gitlib秘钥配置" class="headerlink" title="gitlib秘钥配置"></a>gitlib秘钥配置</h2><p>需要自己生成一个秘钥<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ssh-keygen -t rsa -C "youremail@example.com"</div></pre></td></tr></table></figure></p>
<p>然后将公钥（默认在~/.ssh/id_rsa.pub）放到网站的个人配置页面，里面有SSH keys添加子页：</p>
<h2 id="基本配置"><a href="#基本配置" class="headerlink" title="基本配置"></a>基本配置</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">git config --global user.name "你的名字"</div><div class="line">git config --global user.email "你的邮箱"</div><div class="line"><span class="meta">#</span> windows下载代码编码格式，不会进行转换，提交不转换（默认安装会转换成windows）</div><div class="line">git config --global core.autocrlf false</div><div class="line"><span class="meta">#</span> 拒绝提交包含混合换行符的文件</div><div class="line">git config --global core.safecrlf true</div><div class="line"><span class="meta">#</span> 文件名大小写敏感，有人又不需要大小写敏感，因为windows是大小写不敏感的</div><div class="line">git config --global core.ignorecase true</div><div class="line"><span class="meta">#</span> 避免git gui中的中文乱码</div><div class="line">git config --global gui.encoding utf-8</div><div class="line"><span class="meta">#</span> 避免git status显示的中文文件名乱码</div><div class="line">git config --global core.quotepath off</div><div class="line"><span class="meta">#</span> 彩色显示</div><div class="line">git config --global color.ui true</div><div class="line"><span class="meta">#</span> windows支持长路径，要不然代码路径太长会报错</div><div class="line">git config --global core.longpaths true</div><div class="line"><span class="meta">#</span> windows默认下载git代码，没有显示链接link属性问题</div><div class="line">git config --global core.symlinks true</div><div class="line"><span class="meta">#</span> 为查看历史配置一个别名</div><div class="line">git config --global alias.lg "log --color --graph --pretty=format:'%Cred%h%Creset -%C(yellow)%d%Creset %s %Cgreen(%cr) %C(bold blue)&lt;%an&gt;%Creset' --abbrev-commit"</div></pre></td></tr></table></figure>
<p>别名效果示例：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">$</span> git lg</div><div class="line">* 1d14eae - (HEAD, origin/master, master) specification v1 (23 minutes ago) &lt;你的名字&gt;</div><div class="line">* 9f7c372 - add README (2 hours ago) &lt;你的名字&gt;</div><div class="line">*</div></pre></td></tr></table></figure></p>
<h2 id="回车换行的修改"><a href="#回车换行的修改" class="headerlink" title="回车换行的修改"></a>回车换行的修改</h2><p>git add 提示会对回车换行做修改<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="meta">$</span> git add .gitattributes</div><div class="line">warning: LF will be replaced by CRLF in .gitattributes.</div><div class="line">The file will have its original line endings in your working directory.</div></pre></td></tr></table></figure></p>
<p>回车换行有两个配置，一个是AutoCRLF：</p>
<ol>
<li><p>提交时转换为LF，检出时转换为CRLF</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">git config --global core.autocrlf true</div></pre></td></tr></table></figure>
</li>
<li><p>提交时转换为LF，检出时不转换</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">git config --global core.autocrlf input</div></pre></td></tr></table></figure>
</li>
<li><p>提交检出均不转换</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">git config --global core.autocrlf false</div></pre></td></tr></table></figure>
</li>
</ol>
<p>二是SafeCRLF：</p>
<ol>
<li>拒绝提交包含混合换行符的文件 <figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">git config --global core.safecrlf true</div></pre></td></tr></table></figure>
</li>
</ol>
<ol>
<li><p>允许提交包含混合换行符的文件</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">git config --global core.safecrlf false</div></pre></td></tr></table></figure>
</li>
<li><p>提交包含混合换行符的文件时给出警告</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">git config --global core.safecrlf warn</div></pre></td></tr></table></figure>
</li>
</ol>
<h1 id="入门命令"><a href="#入门命令" class="headerlink" title="入门命令"></a>入门命令</h1><h2 id="创建仓库"><a href="#创建仓库" class="headerlink" title="创建仓库"></a>创建仓库</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="meta">$</span> git init</div><div class="line"><span class="meta">$</span> ls -a</div><div class="line">./  ../  .git/</div></pre></td></tr></table></figure>
<h2 id="提交一个文件"><a href="#提交一个文件" class="headerlink" title="提交一个文件"></a>提交一个文件</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="meta">$</span> echo i have a dream &gt; readme.txt</div><div class="line"><span class="meta">$</span> git add readme.txt #添加</div><div class="line"><span class="meta">$</span> git status #查看状态</div><div class="line"><span class="meta">#</span> On branch master</div><div class="line"><span class="meta">#</span></div><div class="line"><span class="meta">#</span> Initial commit</div><div class="line"><span class="meta">#</span></div><div class="line"><span class="meta">#</span> Changes to be committed:</div><div class="line"><span class="meta">#</span>   (use "git rm --cached &lt;file&gt;..." to unstage)</div><div class="line"><span class="meta">#</span></div><div class="line"><span class="meta">#</span>	new file:   readme.txt</div><div class="line"><span class="meta">#</span></div><div class="line"></div><div class="line"><span class="meta">$</span> git commit -m "first blood" #提交文件</div><div class="line">[master (root-commit) 9d88046] first blood</div><div class="line"> 1 files changed, 1 insertions(+), 0 deletions(-)</div><div class="line"> create mode 100644 readme.txt</div><div class="line"></div><div class="line"><span class="meta">$</span> git status #再次查看状态</div><div class="line"><span class="meta">#</span> On branch master</div><div class="line">nothing to commit (working directory clean)</div></pre></td></tr></table></figure>
<h2 id="修改文件后提交"><a href="#修改文件后提交" class="headerlink" title="修改文件后提交"></a>修改文件后提交</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="meta">$</span> echo "second line" &gt;&gt; readme.txt </div><div class="line"><span class="meta">$</span> git status</div><div class="line"><span class="meta">#</span> On branch master</div><div class="line"><span class="meta">#</span> Changed but not updated:</div><div class="line"><span class="meta">#</span>   (use "git add &lt;file&gt;..." to update what will be committed)</div><div class="line"><span class="meta">#</span>   (use "git checkout -- &lt;file&gt;..." to discard changes in working directory)</div><div class="line"><span class="meta">#</span></div><div class="line"><span class="meta">#</span>	modified:   readme.txt</div><div class="line"><span class="meta">#</span></div><div class="line">no changes added to commit (use "git add" and/or "git commit -a")</div></pre></td></tr></table></figure>
<p>查看有什么不一样：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="meta">$</span> git diff readme.txt </div><div class="line">diff --git a/readme.txt b/readme.txt</div><div class="line">index a23bf50..896de85 100644</div><div class="line">--- a/readme.txt</div><div class="line">+++ b/readme.txt</div><div class="line">@@ -1 +1,2 @@</div><div class="line"> i have a dream</div><div class="line">+second line</div></pre></td></tr></table></figure></p>
<p>再次提交改动：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="meta">$</span> git commit -m "second blood" -a</div><div class="line">[master 615b81b] second blood</div><div class="line"> 1 files changed, 1 insertions(+), 0 deletions(-)</div><div class="line"> </div><div class="line"><span class="meta">$</span> git status</div><div class="line"><span class="meta">#</span> On branch master</div><div class="line">nothing to commit (working directory clean)</div></pre></td></tr></table></figure></p>
<h2 id="查看修改记录"><a href="#查看修改记录" class="headerlink" title="查看修改记录"></a>查看修改记录</h2><p>常规查看：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">$ git log</div><div class="line">commit 615b81b6814eb5441cb304db5c4f11052ce7c654</div><div class="line">Author: 你的名字 &lt;你的邮箱&gt;</div><div class="line">Date:   Tue Mar 20 00:59:39 2018 +0800</div><div class="line"></div><div class="line">    second blood</div><div class="line"></div><div class="line">commit 9d8804680b7b2d9dfe95db84012bd21546271c68</div><div class="line">Author: 你的名字 &lt;你的邮箱&gt;</div><div class="line">Date:   Tue Mar 20 00:56:10 2018 +0800</div><div class="line"></div><div class="line">    first blood</div></pre></td></tr></table></figure></p>
<p>单行模式查看：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"># git log --pretty=oneline</div><div class="line">615b81b6814eb5441cb304db5c4f11052ce7c654 second blood</div><div class="line">9d8804680b7b2d9dfe95db84012bd21546271c68 first blood</div></pre></td></tr></table></figure></p>
<h1 id="分支"><a href="#分支" class="headerlink" title="分支"></a>分支</h1><h2 id="提交到一个新分支"><a href="#提交到一个新分支" class="headerlink" title="提交到一个新分支"></a>提交到一个新分支</h2><p>当前分支情况，只有master：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">$</span> git branch</div><div class="line">* master</div></pre></td></tr></table></figure></p>
<p>想要提交commit到newBranch1分支（如果这个分支之前不存在，会自动创建），可以：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="meta">$</span> git push origin master:newBranch1</div><div class="line"> ...</div><div class="line"> * [new branch]          master -&gt; newBranch1</div></pre></td></tr></table></figure></p>
<h2 id="删除分支"><a href="#删除分支" class="headerlink" title="删除分支"></a>删除分支</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="meta">$</span> git branch</div><div class="line">  newBranch1</div><div class="line">* master</div><div class="line"></div><div class="line"><span class="meta">$</span> git branch -d newBranch1</div><div class="line">Deleted branch newBranch1 (was 1d14eae).</div><div class="line"></div><div class="line"><span class="meta">$</span> git branch</div><div class="line">* master</div></pre></td></tr></table></figure>
<h2 id="从分支克隆"><a href="#从分支克隆" class="headerlink" title="从分支克隆"></a>从分支克隆</h2><p>加入-b参数，可以克隆某个分支的数据：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">git clone -b newBranch1 git@你的服务器:路径/版本.git</div></pre></td></tr></table></figure></p>
<p>在这样一个只有分支newBranch1的本地仓库中，你的所有操作都默认在此分支：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="meta">$</span> git status</div><div class="line">On branch newBranch1</div><div class="line">Your branch is up to date with 'origin/newBranch1'.</div></pre></td></tr></table></figure></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="meta">$</span> git commit -m "优化性能"</div><div class="line">[newBranch1 ec0177719] 优化性能</div><div class="line"> 7 files changed, 403 insertions(+), 37 deletions(-)</div></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">$</span> git push</div><div class="line">...</div><div class="line">To git@你的服务器:路径/版本.git</div><div class="line">   b71ecced5..ec0177719  newBranch1 -&gt; newBranch1</div></pre></td></tr></table></figure>
<h2 id="切换到分支再提交"><a href="#切换到分支再提交" class="headerlink" title="切换到分支再提交"></a>切换到分支再提交</h2><p>切换分支到newBranch1（如果这个分支之前不存在，会自动创建）：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">$</span> git checkout -b newBranch1</div></pre></td></tr></table></figure></p>
<p>默认是在master上创建分支，可以这里指定从其他地方创建，例如 orign/newBranch1 。</p>
<p>这个checkout -b操作，也可以展开为创建/切换两个步骤：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="meta">$</span> git branch newBranch1 # 创建分支</div><div class="line"></div><div class="line"><span class="meta">$</span> git branch # 查看当前默认分支情况</div><div class="line">* master</div><div class="line">  newBranch1</div><div class="line"></div><div class="line"><span class="meta">$</span> git checkout newBranch1 # 切换分支</div><div class="line">  已经位于 'newBranch1'</div><div class="line"></div><div class="line"><span class="meta">$</span> git branch</div><div class="line">  master</div><div class="line">* newBranch1</div></pre></td></tr></table></figure></p>
<p>当然，切换分支前，拉取master的最新改动是一个好习惯，上面的步骤可以改进为：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">git checkout master     #切换到master分支</div><div class="line">git pull origin master  #更新master代码</div><div class="line">git checkout -b newBranch1 master  #从master新建，并切换到新分支</div></pre></td></tr></table></figure></p>
<p>对于已存在分区，多人更改的时候，你可以拉取分支newBranch1下最新改动：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">git pull origin newBranch1</div></pre></td></tr></table></figure></p>
<p>现在你可以正常add, commit了。<br>最后将commit推送到分支newBranch1<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">git push origin newBranch1</div></pre></td></tr></table></figure></p>
<p>可以随时切换会到其他分支，例如，切换回master分支：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">$</span> git checkout master</div><div class="line">Switched to branch 'master'</div></pre></td></tr></table></figure></p>
<h1 id="回滚"><a href="#回滚" class="headerlink" title="回滚"></a>回滚</h1><h2 id="放弃本地更改，强制更新"><a href="#放弃本地更改，强制更新" class="headerlink" title="放弃本地更改，强制更新"></a>放弃本地更改，强制更新</h2><p>先获取远程内容，这时候没有合并：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">git fetch --all</div></pre></td></tr></table></figure></p>
<p>再把HEAD指向刚刚获取的最新内容：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">git reset --hard origin/master</div></pre></td></tr></table></figure></p>
<h2 id="回到历史某版本"><a href="#回到历史某版本" class="headerlink" title="回到历史某版本"></a>回到历史某版本</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="meta">$</span> git reset --hard 9d88</div><div class="line">HEAD is now at 9d88046 first blood</div><div class="line"></div><div class="line"><span class="meta">$</span> cat readme.txt </div><div class="line">i have a dream</div><div class="line"></div><div class="line"><span class="meta">$</span> git log</div><div class="line">commit 9d8804680b7b2d9dfe95db84012bd21546271c68</div><div class="line">Author: 你的名字 &lt;你的邮箱&gt;</div><div class="line">Date:   Tue Mar 20 00:56:10 2018 +0800</div><div class="line"></div><div class="line">    first blood</div></pre></td></tr></table></figure>
<h2 id="撤销回滚到历史版本，回到最新版本"><a href="#撤销回滚到历史版本，回到最新版本" class="headerlink" title="撤销回滚到历史版本，回到最新版本"></a>撤销回滚到历史版本，回到最新版本</h2><p>需要记得之前最新版本的commit ID：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="meta">$</span> git reset --hard 615b</div><div class="line">HEAD is now at 615b81b second blood</div><div class="line"></div><div class="line"><span class="meta">$</span> cat readme.txt </div><div class="line">i have a dream</div><div class="line">second line</div><div class="line"></div><div class="line"><span class="meta">$</span> git log</div><div class="line">commit 615b81b6814eb5441cb304db5c4f11052ce7c654</div><div class="line">Author: 你的名字 &lt;你的邮箱&gt;</div><div class="line">Date:   Tue Mar 20 00:59:39 2018 +0800</div><div class="line"></div><div class="line">    second blood</div><div class="line"></div><div class="line">commit 9d8804680b7b2d9dfe95db84012bd21546271c68</div><div class="line">Author: 你的名字 &lt;你的邮箱&gt;</div><div class="line">Date:   Tue Mar 20 00:56:10 2018 +0800</div><div class="line"></div><div class="line">    first blood</div></pre></td></tr></table></figure></p>
<h2 id="撤销工作区的修改"><a href="#撤销工作区的修改" class="headerlink" title="撤销工作区的修改"></a>撤销工作区的修改</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="meta">$</span> echo third &gt;&gt; readme.txt </div><div class="line"><span class="meta">$</span> cat readme.txt </div><div class="line">i have a dream</div><div class="line">second line</div><div class="line">third</div><div class="line"></div><div class="line"><span class="meta">$</span> git checkout -- readme.txt</div><div class="line">或者</div><div class="line"><span class="meta">$</span> git reset --hard HEAD</div><div class="line"></div><div class="line"><span class="meta">$</span> cat readme.txt </div><div class="line">i have a dream</div><div class="line">second line</div></pre></td></tr></table></figure>
<h2 id="撤销暂存区修改"><a href="#撤销暂存区修改" class="headerlink" title="撤销暂存区修改"></a>撤销暂存区修改</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="meta">$</span> echo third &gt;&gt; readme.txt </div><div class="line"><span class="meta">$</span> git add readme.txt </div><div class="line"><span class="meta">$</span> git status</div><div class="line"><span class="meta">#</span> On branch master</div><div class="line"><span class="meta">#</span> Changes to be committed:</div><div class="line"><span class="meta">#</span>   (use "git reset HEAD &lt;file&gt;..." to unstage)</div><div class="line"><span class="meta">#</span></div><div class="line"><span class="meta">#</span>	modified:   readme.txt</div><div class="line"><span class="meta">#</span></div></pre></td></tr></table></figure>
<p>上面已经放入暂存区了，下面撤销：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="meta">$</span> git reset HEAD readme.txt #先撤销暂存区修改</div><div class="line">Unstaged changes after reset:</div><div class="line">M	readme.txt</div><div class="line"></div><div class="line"><span class="meta">$</span> git status</div><div class="line"><span class="meta">#</span> On branch master</div><div class="line"><span class="meta">#</span> Changed but not updated:</div><div class="line"><span class="meta">#</span>   (use "git add &lt;file&gt;..." to update what will be committed)</div><div class="line"><span class="meta">#</span>   (use "git checkout -- &lt;file&gt;..." to discard changes in working directory)</div><div class="line"><span class="meta">#</span></div><div class="line"><span class="meta">#</span>	modified:   readme.txt</div><div class="line"><span class="meta">#</span></div><div class="line">no changes added to commit (use "git add" and/or "git commit -a")</div><div class="line"></div><div class="line"><span class="meta">$</span> git checkout -- readme.txt #再撤销工作区修改</div><div class="line"></div><div class="line"><span class="meta">$</span> git status</div><div class="line"><span class="meta">#</span> On branch master</div><div class="line">nothing to commit (working directory clean)</div></pre></td></tr></table></figure></p>
<h2 id="撤销Commit"><a href="#撤销Commit" class="headerlink" title="撤销Commit"></a>撤销Commit</h2><p>比如我现在commit了，但是并没有push：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="meta">$</span> git rm readme.txt </div><div class="line">rm 'readme.txt'</div><div class="line"></div><div class="line"><span class="meta">$</span> git status</div><div class="line"><span class="meta">#</span> On branch master</div><div class="line"><span class="meta">#</span> Changes to be committed:</div><div class="line"><span class="meta">#</span>   (use "git reset HEAD &lt;file&gt;..." to unstage)</div><div class="line"><span class="meta">#</span></div><div class="line"><span class="meta">#</span>	deleted:    readme.txt</div><div class="line"></div><div class="line"><span class="meta">$</span> git commit -m "delete all"</div><div class="line">[master b88b45e] delete all</div><div class="line"> 1 files changed, 0 insertions(+), 2 deletions(-)</div><div class="line"> delete mode 100644 readme.txt</div><div class="line"></div><div class="line"><span class="meta">$</span> git log</div><div class="line">commit b88b45e4cd4fa3750199d43b1f156f1175384e7f</div><div class="line">Author: 你的名字 &lt;你的邮箱&gt;</div><div class="line">Date:   Tue Mar 20 01:19:19 2018 +0800</div><div class="line"></div><div class="line">    delete all</div><div class="line"></div><div class="line">commit 615b81b6814eb5441cb304db5c4f11052ce7c654</div><div class="line">Author: 你的名字 &lt;你的邮箱&gt;</div><div class="line">Date:   Tue Mar 20 00:59:39 2018 +0800</div><div class="line"></div><div class="line">    second blood</div><div class="line"></div><div class="line">commit 9d8804680b7b2d9dfe95db84012bd21546271c68</div><div class="line">Author: 你的名字 &lt;你的邮箱&gt;</div><div class="line">Date:   Tue Mar 20 00:56:10 2018 +0800</div><div class="line"></div><div class="line">    first blood</div></pre></td></tr></table></figure></p>
<p>找要撤销步骤的commit ID，上述为 b88b45e4cd4fa3750199d43b1f156f1175384e7f<br>一种撤销是，只撤销commit命令，不对修改的代码进行撤销：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">git reset b88b45e4cd4fa3750199d43b1f156f1175384e7f</div></pre></td></tr></table></figure></p>
<p>另一种撤销是，既撤销commit，还要将代码撤销（代码恢复到commit前的对应版本）：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">git reset --hard b88b45e4cd4fa3750199d43b1f156f1175384e7f</div></pre></td></tr></table></figure></p>
<p>对于已经commit的，需要git reset，如果只是放入了暂存区，就不需要git reset，后面还可以加入：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">git checkout 改动文件</div></pre></td></tr></table></figure></p>
<p>这样确保“改动文件”在工作区的内容为最新。</p>
<h2 id="删除文件"><a href="#删除文件" class="headerlink" title="删除文件"></a>删除文件</h2><p>工作区、暂存区、分支上同时删除<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">git rm 路径</div></pre></td></tr></table></figure></p>
<p>暂存区、分支上删除，但工作区保留（其实就是不希望某文件被版本控制，和.gitignore一个作用，对于已经在分支上的.gitignore无效）<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">git rm --cached 路径</div></pre></td></tr></table></figure></p>
<p>如果递归删除结合reset，可以清除本地的所有改动：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">git rm --cached -r . </div><div class="line">git reset --hard</div></pre></td></tr></table></figure></p>
<h1 id="合并"><a href="#合并" class="headerlink" title="合并"></a>合并</h1><h2 id="合并newBranch1到当前分支"><a href="#合并newBranch1到当前分支" class="headerlink" title="合并newBranch1到当前分支"></a>合并newBranch1到当前分支</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="meta">$</span> git merge newBranch1</div><div class="line">Updating 9f7c372..1d14eae</div><div class="line">Fast-forward</div><div class="line"> ...readme.xlsx" |  Bin 0 -&gt; 16048 bytes</div><div class="line"> 6 files changed, 0 insertions(+), 0 deletions(-)</div><div class="line"> create mode 100644 "readme.xlsx"</div></pre></td></tr></table></figure>
<h2 id="使用mergetool处理冲突"><a href="#使用mergetool处理冲突" class="headerlink" title="使用mergetool处理冲突"></a>使用mergetool处理冲突</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="meta">$</span> git merge</div><div class="line">Auto-merging .gitattributes</div><div class="line">CONFLICT (content): Merge conflict in .gitattributes</div><div class="line">Automatic merge failed; fix conflicts and then commit the result.</div><div class="line"></div><div class="line"><span class="meta">$</span> git status</div><div class="line"></div><div class="line">Unmerged paths:</div><div class="line">  (use "git add &lt;file&gt;..." to mark resolution)</div><div class="line"></div><div class="line">        both modified:   .gitattributes</div></pre></td></tr></table></figure>
<p>用mergetool来人工处理冲突:<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="meta">$</span> git mergetool --tool-help</div><div class="line">'git mergetool --tool=&lt;tool&gt;' may be set to one of the following:</div><div class="line">                tortoisemerge</div><div class="line">                vimdiff</div><div class="line">                vimdiff2</div><div class="line">                vimdiff3</div><div class="line"></div><div class="line"><span class="meta">$</span> git mergetool --tool=tortoisemerge</div></pre></td></tr></table></figure></p>
<p>或者<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="meta">$</span> git mergetool</div><div class="line">'git mergetool' will now attempt to use one of the following tools:</div><div class="line">opendiff kdiff3 tkdiff xxdiff meld tortoisemerge gvimdiff diffuse diffmerge ecmerge p4merge araxis bc codecompare emerge vimdiff</div><div class="line">refs/remotes/origin/master is not a valid attribute name: .gitattributes:36</div><div class="line">Merging:</div><div class="line">.gitattributes</div><div class="line"></div><div class="line">Normal merge conflict for '.gitattributes':</div><div class="line">  &#123;local&#125;: modified file</div><div class="line">  &#123;remote&#125;: modified file</div><div class="line">Hit return to start merge resolution tool (tortoisemerge):</div></pre></td></tr></table></figure></p>
<h2 id="手动处理二进制冲突"><a href="#手动处理二进制冲突" class="headerlink" title="手动处理二进制冲突"></a>手动处理二进制冲突</h2><p>两种选择，要么保留欲合并分支的修改：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">git checkout --theirs filename</div></pre></td></tr></table></figure></p>
<p>要么保留自己的修改：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">git checkout --ours filename</div></pre></td></tr></table></figure></p>
<p>然后提交更改：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">git add filename</div><div class="line">git commit</div></pre></td></tr></table></figure></p>
<h2 id="放弃本地修改"><a href="#放弃本地修改" class="headerlink" title="放弃本地修改"></a>放弃本地修改</h2><p>单文件放弃：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">git checkout [oldversion可选] -- 文件地址</div></pre></td></tr></table></figure></p>
<p>整体放弃<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">git reset --hard</div><div class="line">git pull</div></pre></td></tr></table></figure></p>
<h2 id="完全以自己的内容为准（危险）"><a href="#完全以自己的内容为准（危险）" class="headerlink" title="完全以自己的内容为准（危险）"></a>完全以自己的内容为准（危险）</h2><p>比如，你pull的时候，发现有冲突：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">$</span> git pull</div><div class="line">warning: Cannot merge binary files: /lib64/libutils.so (HEAD vs. 9ac05b78ec9555ef16ab50efe1f31e69617d2be8)</div><div class="line">Auto-merging /lib64/libutils.so</div><div class="line">CONFLICT (content): Merge conflict in /lib64/libutils.so</div><div class="line">Automatic merge failed; fix conflicts and then commit the result.</div></pre></td></tr></table></figure></p>
<p>你如果<strong>只想</strong>保留本地修改，忽略远端修改，可以<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">$</span> git merge -s ours origin/master</div><div class="line">Merge made by the 'ours' strategy.</div></pre></td></tr></table></figure></p>
<blockquote>
<p><strong>注意</strong><br>这动作非常<strong>危险</strong>，如果你push了你的提交，会导致别人的修改被丢弃。</p>
</blockquote>
<p>##保留本地修改<br>$ git fetch origin</p>
<p>危险，会导致你没有PULL的别人提交的部分在库上也被丢弃。<br>$ git merge -s ours origin/master<br>Merge made by the ‘ours’ strategy.</p>
<p>如果你不小心提交了，导致别人的提交丢失，可以参考<a href="#rebase-example">rebase示例</a></p>
<h2 id="放弃合并"><a href="#放弃合并" class="headerlink" title="放弃合并"></a>放弃合并</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">$</span> git merge --abort</div><div class="line"><span class="meta">$</span> git reset --merge</div></pre></td></tr></table></figure>
<h2 id="跨版本合并"><a href="#跨版本合并" class="headerlink" title="跨版本合并"></a>跨版本合并</h2><p>例如合并3.0.9代码到3.0.10。</p>
<ol>
<li>工作目录目前在3.0.10，把3.0.10下的所有文件都commit，并push。</li>
<li><p>添加3.0.9为远程分支并取回内容</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">git remote add 3.0.9 git@你的服务器:路径/3.0.9.git</div><div class="line">git fetch 3.0.9</div></pre></td></tr></table></figure>
</li>
<li><p>checkout 3.0.9的master分支到本地，给分支取名 3.0.9-master</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">git checkout -b 3.0.9-master 3.0.9/master</div></pre></td></tr></table></figure>
</li>
<li><p>切换到3.0.10的master分支</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">git checkout master</div></pre></td></tr></table></figure>
</li>
<li><p>将 3.0.9-master 合入到3.0.10的当前工作目录</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">git merge 3.0.9-master --allow-unrelated-histories</div></pre></td></tr></table></figure>
</li>
<li><p>期间会有合并失败的，需要先解决冲突。</p>
</li>
<li><p>提交代码</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">$</span> git commit -m "merge sip3.0.9"</div><div class="line">[master cfe833e6f] merge sip3.0.9</div></pre></td></tr></table></figure>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">$</span> git push -u origin master</div></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="从其他版本的某个分支挑选代码合入当前版本"><a href="#从其他版本的某个分支挑选代码合入当前版本" class="headerlink" title="从其他版本的某个分支挑选代码合入当前版本"></a>从其他版本的某个分支挑选代码合入当前版本</h2><ol>
<li><p>在预合入的分支下，添加远程分支，将其他版本的某个分支加入进来。</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">(master)$</span> git remote add -m 其他版本的分支名字 本地名字 git@你的服务器:路径/其他版本.git</div></pre></td></tr></table></figure>
</li>
<li><p>更新代码。</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">(master)$</span> git fetch 本地名字</div></pre></td></tr></table></figure>
</li>
<li><p>把远程分支中要合并的commit Id挑选过来</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">(master)$</span> git cherry-pick e93ca048978f480c0258df2f2d7f0af67cb4f23e</div></pre></td></tr></table></figure>
<p> 或者用名称也可以：</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="meta">(master)$</span> git cherry-pick 本地名字/其他版本的分支名字</div><div class="line">...</div><div class="line">9 files changed（改动了9个文件）, 125 insertions(+)（有125行新增代码）, 7 deletions(-)（有7行删除代码）</div></pre></td></tr></table></figure>
</li>
<li><p>提交代码，这里我提交到一个新分支</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">(master)$</span> git checkout -b newBranch1</div><div class="line">Switched to a new branch 'newBranch1'</div><div class="line"></div><div class="line"><span class="meta">(newBranch1)$</span> git push origin newBranch1</div></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="rebase示例"><a href="#rebase示例" class="headerlink" title="rebase示例"></a><span id="rebase-example">rebase示例</span></h2><p>merge和rebase都是用于合并代码，差异在于历史记录看起来不一样。<br>我之前使用 git merge -s ours origin/master 把自己的内容强制merge并push到了master分支，导致我修改期间别人的提交丢失，现在，我准备将别人丢失的部分，重新加入到master分支里面。我这里使用rebase操作，把历史也处理一下。</p>
<ol>
<li><p>先把我最新在master上的提叫checkout下来，名称叫mylast，这个版本丢失了其他人的提交的。</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">(master)$</span> git checkout 6ac5d94fdae15a17108cbdc1700656f1d8b3ad70 -b mylast</div><div class="line">Switched to a new branch 'mylast'</div></pre></td></tr></table></figure>
</li>
<li><p>把别人的最后一次正确提交checkout下来，取名叫skipPoint</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">(mylast)$</span> git checkout 9ac05b78ec9555ef16ab50efe1f31e69617d2be8 -b skipPoint</div><div class="line">Switched to a new branch 'skipPoint'</div><div class="line"></div><div class="line"><span class="meta">(skipPoint)$</span> git checkout mylast</div><div class="line">Switched to branch 'mylast'</div></pre></td></tr></table></figure>
</li>
<li><p>rebase操作，把mylast上的提交取消掉，并将其保存为patch，然后mylast会更新为skipPoint，然后再把mylast原本的path应用到更新后的mylast上。</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="meta">(mylast)$</span> git rebase skipPoint</div><div class="line">First, rewinding head to replay your work on top of it</div><div class="line">...</div><div class="line">Resolve all conflicts manually, mark them as resolved with</div><div class="line">"git add/rm &lt;conflicted_files&gt;", then run "git rebase --continue".</div><div class="line">You can instead skip this commit: run "git rebase --skip".</div><div class="line">To abort and get back to the state before "git rebase", run "git rebase --abort".</div></pre></td></tr></table></figure>
</li>
<li><p>rebase过程中会有冲突，我们需要处理冲突。<br> 例如：</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">(mylast|REBASE 1/1)$ git rm /lib64/libutils.so</div><div class="line">rm '/lib64/libutils.so'</div><div class="line"></div><div class="line">(mylast|REBASE 1/1)$ git add /lib64/libutils.so</div><div class="line">add '/lib64/libutils.so'</div></pre></td></tr></table></figure>
</li>
<li><p>所有冲突处理完，可以继续rebase。</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">(mylast|REBASE 1/1)$ git rebase --continue</div></pre></td></tr></table></figure>
</li>
<li><p>对于一些遗漏的commit，佟麟阁cherry-pick合入。</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">(mylast|REBASE 1/1)$ git cherry-pick 92578fc27d978ca092f8773e2a866f79c2e554c3</div></pre></td></tr></table></figure>
</li>
<li><p>提交</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">(mylast|CHERRY-PICKING)$ git commit -m "confit"</div></pre></td></tr></table></figure>
</li>
<li><p>替换master为mylast分支<br> 删除原本的master分支</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta"> (mylast)$</span> git branch -D master </div><div class="line">Deleted branch master (was 1dea1c102).</div></pre></td></tr></table></figure>
<p> 或者，把原本的master重命名：</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">(mylast)$</span> git branch -m master</div></pre></td></tr></table></figure>
</li>
<li><p>推送覆盖到master<br> gitlib禁止了覆盖master，需要在 “设置”/“版本库”/“保护分支”下临时去掉保护。</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">(master|CHERRY-PICKING)$ git push -f --set-upstream origin master</div><div class="line">Counting objects: 202, done.</div><div class="line">To git@你的服务器:路径/版本.git</div><div class="line"> + 1dea1c102...2c7ecba76 master -&gt; master (forced update)</div><div class="line">Branch 'master' set up to track remote branch 'master' from 'origin'.</div></pre></td></tr></table></figure>
</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://mnstory.net/2018/06/01/handle-leak-cause-logic-error/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="mnstory.net">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="码农故事">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/06/01/handle-leak-cause-logic-error/" itemprop="url">句柄泄漏引发的逻辑错误</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-06-01T21:00:00+08:00">
                2018-06-01
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <h1 id="现象"><a href="#现象" class="headerlink" title="现象"></a>现象</h1><p>后端现象是，某个配置文件 “changedir/某配置文件.json” 不定期会被删除。但是不知道是什么进程删除的。</p>
<h1 id="inotify和audit监控"><a href="#inotify和audit监控" class="headerlink" title="inotify和audit监控"></a>inotify和audit监控</h1><p>使用inotify监控，的确看到有删除动作，但是同样没法看到是什么进程删除了。<br>于是改用 audit 监控，监控出来，如下信息：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">~ # ausearch -f changedir/某配置文件.json | tail</div><div class="line"><span class="meta">time-&gt;</span>Thu May 31 18:00:50 2018</div><div class="line">type=PATH msg=audit(1527760850.765:209600): item=1 name="changedir/某配置文件.json" inode=2722142 dev=08:02 mode=0100644 ouid=0 ogid=0 rdev=00:00 objtype=DELETE</div><div class="line">type=PATH msg=audit(1527760850.765:209600): item=0 name="changedir/" inode=2720150 dev=08:02 mode=040755 ouid=2 ogid=2 rdev=00:00 objtype=PARENT</div><div class="line">type=CWD msg=audit(1527760850.765:209600):  cwd="数据根目录"</div><div class="line">type=SYSCALL msg=audit(1527760850.765:209600): arch=c000003e syscall=87 success=yes exit=0 a0=7ffa4402a460 a1=1 a2=7ffa59a22f88 a3=fffffff0 items=2 ppid=10311 pid=23637 auid=0 uid=0 gid=0 euid=0 suid=0 fsuid=0 egid=0 sgid=0 fsgid=0 tty=(none) ses=1 comm="python" exe="/usr/bin/python2.7" key=(null)</div></pre></td></tr></table></figure></p>
<p>可以看到，进程号pid=23637，进程名为python，删除了文件。但是，我们执行：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ps auxf | grep 23637</div></pre></td></tr></table></figure></p>
<p>并没有发现进程。<br></p>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2018/06/01/handle-leak-cause-logic-error/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://mnstory.net/2018/01/31/who-kill-me-audit/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="mnstory.net">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="码农故事">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/01/31/who-kill-me-audit/" itemprop="url">谁KILL了进程定位工具之auditd</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-01-31T21:00:00+08:00">
                2018-01-31
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <p>测试部让查一个BUG，某台虚拟机的fantom启动不来。</p>
<p>我准备调试一下：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">~ # python -mpdb /home/fantom/share/Python-2.7/lib/supervisor/supervisord.py -c /home/fantom/apps/super/default/conf/fantom/supervisord.conf</div><div class="line"><span class="meta">&gt;</span> /home/fantom/share/Python-2.7/lib/supervisor/supervisord.py(31)&lt;module&gt;()</div><div class="line"><span class="meta">-&gt;</span> """</div><div class="line">(Pdb) Killed</div></pre></td></tr></table></figure></p>
<p>发现刚启动就被KILL了。</p>
<p>是谁这么暗箭伤人？操作系统给了我们杀死其他进程的能力，但自己被杀时，却连仇家都找不到。大概是怕冤冤相报何时了。</p>
<h1 id="auditd"><a href="#auditd" class="headerlink" title="auditd"></a>auditd</h1><p>想要找到是谁干的，Linux下有一个比较厉害审计工具，auditd，他可以审计很多系统调用，包括kill。</p>
<p>看下如何配置：<br></p>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2018/01/31/who-kill-me-audit/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://mnstory.net/2017/12/29/elasticsearch-aggregations/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="mnstory.net">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="码农故事">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/12/29/elasticsearch-aggregations/" itemprop="url">Elasticsearch 聚合</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-12-29T21:00:00+08:00">
                2017-12-29
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <p>Elasticsearch是可以自动判断字段的类型的，这个步骤本可以不要，但是，我发现在5.3版本测试的时候，如果不设置fielddata=true，后面的汇聚会报：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Fielddata is disabled on text fields by default. Set fielddata=true</div></pre></td></tr></table></figure></p>
<p>于是，为color、make两个文本字段设置fielddata=true选项，这个步骤要在插入数据前，类似于提前创建表：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">PUT</div><div class="line">cars</div><div class="line">&#123;</div><div class="line">  &quot;mappings&quot;: &#123;</div><div class="line">    &quot;transations&quot;: &#123;</div><div class="line">      &quot;properties&quot;: &#123;</div><div class="line">        &quot;color&quot;: &#123;</div><div class="line">          &quot;type&quot;: &quot;text&quot;,</div><div class="line">          &quot;fielddata&quot;: true</div><div class="line">        &#125;,</div><div class="line">        &quot;make&quot;: &#123;</div><div class="line">          &quot;type&quot;: &quot;text&quot;,</div><div class="line">          &quot;fielddata&quot; : true,</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2017/12/29/elasticsearch-aggregations/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://mnstory.net/2017/11/14/qemu-balloon-damage-file-cache/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="mnstory.net">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="码农故事">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/11/14/qemu-balloon-damage-file-cache/" itemprop="url">内存气泡导致文件损坏错误分析</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-11-14T21:00:00+08:00">
                2017-11-14
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <p>今天测试发现，升级新包后，原来可以插入Elasticsearch的数据，插入不了了，具体错误，我缩减到了一行代码，如下，可重现：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">python -c &quot;from pandas.formats.format import detect_console_encoding&quot;</div></pre></td></tr></table></figure></p>
<p>输出错误：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">  File &quot;/home/fantom/share/Python-2.7/lib/site-packages/pandas/__init__.py&quot;, line 37, in &lt;module&gt;</div><div class="line">    import pandas.core.config_init</div><div class="line">  File &quot;/home/fantom/share/Python-2.7/lib/site-packages/pandas/core/config_init.py&quot;, line 18, in &lt;module&gt;</div><div class="line">    from pandas.formats.format import detect_console_encoding</div><div class="line">  File &quot;/home/fantom/share/Python-2.7/lib/site-packages/pandas/formats/format.py&quot;, line 13, in &lt;module&gt;</div><div class="line">    from pandas.types.missing import isnull, notnull</div><div class="line">  File &quot;/home/fantom/share/Python-2.7/lib/site-packages/pandas/types/missing.py&quot;, line 12, in &lt;module&gt;</div><div class="line">    from .common import (is_string_dtype, is_datetimelike,</div><div class="line">  File &quot;/home/fantom/share/Python-2.7/lib/site-packages/pandas/types/common.py&quot;, line 8, in &lt;module&gt;</div><div class="line">    from pandas import lib, algos</div><div class="line">  File &quot;pandas/algos.pyx&quot;, line 1, in init pandas.algos (pandas/algos.c:155772)</div><div class="line">SystemError: Negative size passed to PyString_FromStringAndSize</div></pre></td></tr></table></figure></p>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2017/11/14/qemu-balloon-damage-file-cache/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/6/">6</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          
            <p class="site-author-name" itemprop="name">mnstory.net</p>
            <p class="site-description motion-element" itemprop="description"></p>
        </div>

        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
            
              <a href="/archives/">
            
                <span class="site-state-item-count">58</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">68</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">mnstory.net</span>

  
</div>



        
<div class="busuanzi-count">
  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv">
      <i class="fa fa-user"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      
    </span>
  

  
    <span class="site-pv">
      <i class="fa fa-eye"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      
    </span>
  
</div>








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.2"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.2"></script>



  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.2"></script>


  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.2"></script>



  


  




	





  





  








  




  





  

  

  

  

  

  


  <!-- 背景动画 -->
  <script type="text/javascript" src="/js/src/particle.js"></script>

</body>
</html>
