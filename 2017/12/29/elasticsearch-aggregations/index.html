<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="ElasticSearch," />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.2" />






<meta name="description" content="Elasticsearch是可以自动判断字段的类型的，这个步骤本可以不要，但是，我发现在5.3版本测试的时候，如果不设置fielddata=true，后面的汇聚会报：1Fielddata is disabled on text fields by default. Set fielddata=true 于是，为color、make两个文本字段设置fielddata=true选项，这个步骤要在插入数">
<meta name="keywords" content="ElasticSearch">
<meta property="og:type" content="article">
<meta property="og:title" content="Elasticsearch 聚合">
<meta property="og:url" content="http://mnstory.net/2017/12/29/elasticsearch-aggregations/index.html">
<meta property="og:site_name" content="码农故事">
<meta property="og:description" content="Elasticsearch是可以自动判断字段的类型的，这个步骤本可以不要，但是，我发现在5.3版本测试的时候，如果不设置fielddata=true，后面的汇聚会报：1Fielddata is disabled on text fields by default. Set fielddata=true 于是，为color、make两个文本字段设置fielddata=true选项，这个步骤要在插入数">
<meta property="og:locale" content="zh-Hans">
<meta property="og:updated_time" content="2018-06-01T06:49:12.248Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Elasticsearch 聚合">
<meta name="twitter:description" content="Elasticsearch是可以自动判断字段的类型的，这个步骤本可以不要，但是，我发现在5.3版本测试的时候，如果不设置fielddata=true，后面的汇聚会报：1Fielddata is disabled on text fields by default. Set fielddata=true 于是，为color、make两个文本字段设置fielddata=true选项，这个步骤要在插入数">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.2',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://mnstory.net/2017/12/29/elasticsearch-aggregations/"/>





  <title>Elasticsearch 聚合 | 码农故事</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">码农故事</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <h1 class="site-subtitle" itemprop="description"></h1>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://mnstory.net/2017/12/29/elasticsearch-aggregations/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="mnstory.net">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="码农故事">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">Elasticsearch 聚合</h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-12-29T13:00:00+00:00">
                2017-12-29
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          
            <span class="post-meta-divider">|</span>
            <span class="page-pv"><i class="fa fa-file-o"></i>
            <span class="busuanzi-value" id="busuanzi_value_page_pv" ></span>
            </span>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>Elasticsearch是可以自动判断字段的类型的，这个步骤本可以不要，但是，我发现在5.3版本测试的时候，如果不设置fielddata=true，后面的汇聚会报：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Fielddata is disabled on text fields by default. Set fielddata=true</div></pre></td></tr></table></figure></p>
<p>于是，为color、make两个文本字段设置fielddata=true选项，这个步骤要在插入数据前，类似于提前创建表：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">PUT</div><div class="line">cars</div><div class="line">&#123;</div><div class="line">  &quot;mappings&quot;: &#123;</div><div class="line">    &quot;transations&quot;: &#123;</div><div class="line">      &quot;properties&quot;: &#123;</div><div class="line">        &quot;color&quot;: &#123;</div><div class="line">          &quot;type&quot;: &quot;text&quot;,</div><div class="line">          &quot;fielddata&quot;: true</div><div class="line">        &#125;,</div><div class="line">        &quot;make&quot;: &#123;</div><div class="line">          &quot;type&quot;: &quot;text&quot;,</div><div class="line">          &quot;fielddata&quot; : true,</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<a id="more"></a>
<p>批量插入数据：</p>
<blockquote>
<p>注意：<br>最后一条数据后面有一个换行符，不然最后一条数据插入不进去。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">POST</div><div class="line">cars/transactions/_bulk</div><div class="line">&#123; &quot;index&quot;: &#123;&#125;&#125;</div><div class="line">&#123; &quot;price&quot; : 10000, &quot;color&quot; : &quot;red&quot;, &quot;make&quot; : &quot;honda&quot;, &quot;sold&quot; : &quot;2014-10-28&quot; &#125;</div><div class="line">&#123; &quot;index&quot;: &#123;&#125;&#125;</div><div class="line">&#123; &quot;price&quot; : 20000, &quot;color&quot; : &quot;red&quot;, &quot;make&quot; : &quot;honda&quot;, &quot;sold&quot; : &quot;2014-11-05&quot; &#125;</div><div class="line">&#123; &quot;index&quot;: &#123;&#125;&#125;</div><div class="line">&#123; &quot;price&quot; : 30000, &quot;color&quot; : &quot;green&quot;, &quot;make&quot; : &quot;ford&quot;, &quot;sold&quot; : &quot;2014-05-18&quot; &#125;</div><div class="line">&#123; &quot;index&quot;: &#123;&#125;&#125;</div><div class="line">&#123; &quot;price&quot; : 15000, &quot;color&quot; : &quot;blue&quot;, &quot;make&quot; : &quot;toyota&quot;, &quot;sold&quot; : &quot;2014-07-02&quot; &#125;</div><div class="line">&#123; &quot;index&quot;: &#123;&#125;&#125;</div><div class="line">&#123; &quot;price&quot; : 12000, &quot;color&quot; : &quot;green&quot;, &quot;make&quot; : &quot;toyota&quot;, &quot;sold&quot; : &quot;2014-08-19&quot; &#125;</div><div class="line">&#123; &quot;index&quot;: &#123;&#125;&#125;</div><div class="line">&#123; &quot;price&quot; : 20000, &quot;color&quot; : &quot;red&quot;, &quot;make&quot; : &quot;honda&quot;, &quot;sold&quot; : &quot;2014-11-05&quot; &#125;</div><div class="line">&#123; &quot;index&quot;: &#123;&#125;&#125;</div><div class="line">&#123; &quot;price&quot; : 80000, &quot;color&quot; : &quot;red&quot;, &quot;make&quot; : &quot;bmw&quot;, &quot;sold&quot; : &quot;2014-01-01&quot; &#125;</div><div class="line">&#123; &quot;index&quot;: &#123;&#125;&#125;</div><div class="line">&#123; &quot;price&quot; : 25000, &quot;color&quot; : &quot;blue&quot;, &quot;make&quot; : &quot;ford&quot;, &quot;sold&quot; : &quot;2014-02-12&quot; &#125;</div></pre></td></tr></table></figure></p>
</blockquote>
<p>scope. By default, aggregations operate in the same scope as the query. Put another way, aggregations are calculated on the set of documents that match your query.</p>
<p>汇聚前，需要数据源，数据源来自本级的查询过滤结果，本级的查询也需要数据源，其数据源来自嵌套上级的输出。<br>如果没有本级查询过滤时，表示原封不动保留嵌套上级的输出。<br>如果有本级查询过滤，不论aggs语句是写在查询过滤前还是后，都会先执行查询过滤语句，然后再执行aggs。</p>
<h1 id="汇聚不同色系的汽车，看一下销量情况"><a href="#汇聚不同色系的汽车，看一下销量情况" class="headerlink" title="汇聚不同色系的汽车，看一下销量情况"></a>汇聚不同色系的汽车，看一下销量情况</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">GET</div><div class="line">cars/_search</div><div class="line">&#123;</div><div class="line">  &quot;size&quot;: 0, //这里没有Query语句，表示所有cars数据都需要，同时size设置为0，表示我们不想输出查询的结果。</div><div class="line">  &quot;aggs&quot;: &#123;</div><div class="line">    &quot;popular_colors&quot;: &#123;</div><div class="line">      &quot;terms&quot;: &#123;</div><div class="line">        &quot;field&quot;: &quot;color&quot; //我们以color字段的不同value做桶，不同value分装到不同的桶中。</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>返回结果：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  &quot;took&quot;: 11,</div><div class="line">  &quot;timed_out&quot;: false,</div><div class="line">  &quot;_shards&quot;: &#123;</div><div class="line">    &quot;total&quot;: 5,</div><div class="line">    &quot;successful&quot;: 5,</div><div class="line">    &quot;failed&quot;: 0</div><div class="line">  &#125;,</div><div class="line">  &quot;hits&quot;: &#123;</div><div class="line">    &quot;total&quot;: 7,</div><div class="line">    &quot;max_score&quot;: 0,</div><div class="line">    &quot;hits&quot;: [</div><div class="line"></div><div class="line">    ]</div><div class="line">  &#125;,</div><div class="line">  &quot;aggregations&quot;: &#123;</div><div class="line">    &quot;popular_colors&quot;: &#123;</div><div class="line">      &quot;doc_count_error_upper_bound&quot;: 0,</div><div class="line">      &quot;sum_other_doc_count&quot;: 0,</div><div class="line">      &quot;buckets&quot;: [</div><div class="line">        &#123;</div><div class="line">          &quot;key&quot;: &quot;red&quot;,</div><div class="line">          &quot;doc_count&quot;: 4</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">          &quot;key&quot;: &quot;blue&quot;,</div><div class="line">          &quot;doc_count&quot;: 2</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">          &quot;key&quot;: &quot;green&quot;,</div><div class="line">          &quot;doc_count&quot;: 2</div><div class="line">        &#125;</div><div class="line">      ]</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h1 id="汇聚不同色系的汽车，查看该色系的均价"><a href="#汇聚不同色系的汽车，查看该色系的均价" class="headerlink" title="汇聚不同色系的汽车，查看该色系的均价"></a>汇聚不同色系的汽车，查看该色系的均价</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">GET</div><div class="line">cars/_search</div><div class="line">&#123;</div><div class="line">  &quot;size&quot;: 0,</div><div class="line">  &quot;aggs&quot;: &#123;</div><div class="line">    &quot;popular_colors&quot;: &#123;</div><div class="line">      &quot;terms&quot;: &#123;</div><div class="line">        &quot;field&quot;: &quot;color&quot;</div><div class="line">      &#125;,</div><div class="line">      //popular_colors按色系分桶后，得到的数据，便是aggs的源数据，在这里，不论terms.field=color写在aggs前还是后，效果都一样。</div><div class="line">      &quot;aggs&quot;: &#123;</div><div class="line">        &quot;popular_colors_avg_price&quot;: &#123;</div><div class="line">          &quot;avg&quot;: &#123;</div><div class="line">            &quot;field&quot;: &quot;price&quot;</div><div class="line">          &#125;</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>返回结果：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  &quot;took&quot;: 4,</div><div class="line">  &quot;timed_out&quot;: false,</div><div class="line">  &quot;_shards&quot;: &#123;</div><div class="line">    &quot;total&quot;: 5,</div><div class="line">    &quot;successful&quot;: 5,</div><div class="line">    &quot;failed&quot;: 0</div><div class="line">  &#125;,</div><div class="line">  &quot;hits&quot;: &#123;</div><div class="line">    &quot;total&quot;: 7,</div><div class="line">    &quot;max_score&quot;: 0,</div><div class="line">    &quot;hits&quot;: [</div><div class="line"></div><div class="line">    ]</div><div class="line">  &#125;,</div><div class="line">  &quot;aggregations&quot;: &#123;</div><div class="line">    &quot;popular_colors&quot;: &#123;</div><div class="line">      &quot;doc_count_error_upper_bound&quot;: 0,</div><div class="line">      &quot;sum_other_doc_count&quot;: 0,</div><div class="line">      &quot;buckets&quot;: [</div><div class="line">        &#123;</div><div class="line">          &quot;key&quot;: &quot;red&quot;,</div><div class="line">          &quot;doc_count&quot;: 4,</div><div class="line">          &quot;popular_colors_avg_price&quot;: &#123;</div><div class="line">            &quot;value&quot;: 32500</div><div class="line">          &#125;</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">          &quot;key&quot;: &quot;blue&quot;,</div><div class="line">          &quot;doc_count&quot;: 2,</div><div class="line">          &quot;popular_colors_avg_price&quot;: &#123;</div><div class="line">            &quot;value&quot;: 20000</div><div class="line">          &#125;</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">          &quot;key&quot;: &quot;green&quot;,</div><div class="line">          &quot;doc_count&quot;: 2,</div><div class="line">          &quot;popular_colors_avg_price&quot;: &#123;</div><div class="line">            &quot;value&quot;: 21000</div><div class="line">          &#125;</div><div class="line">        &#125;</div><div class="line">      ]</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h1 id="汇聚嵌套"><a href="#汇聚嵌套" class="headerlink" title="汇聚嵌套"></a>汇聚嵌套</h1><h2 id="汇聚不同色系的汽车，查看该色系的均价，并查看该色系下制造商的分布情况"><a href="#汇聚不同色系的汽车，查看该色系的均价，并查看该色系下制造商的分布情况" class="headerlink" title="汇聚不同色系的汽车，查看该色系的均价，并查看该色系下制造商的分布情况"></a>汇聚不同色系的汽车，查看该色系的均价，并查看该色系下制造商的分布情况</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">GET</div><div class="line">cars/_search</div><div class="line">&#123;</div><div class="line">  &quot;size&quot;: 0,</div><div class="line">  &quot;aggs&quot;: &#123;</div><div class="line">    &quot;popular_colors&quot;: &#123;</div><div class="line">      &quot;terms&quot;: &#123;</div><div class="line">        &quot;field&quot;: &quot;color&quot;</div><div class="line">      &#125;,</div><div class="line">      &quot;aggs&quot;: &#123;</div><div class="line">        &quot;popular_colors_avg_price&quot;: &#123;</div><div class="line">          &quot;avg&quot;: &#123;</div><div class="line">            &quot;field&quot;: &quot;price&quot;</div><div class="line">          &#125;</div><div class="line">        &#125;,</div><div class="line">        // 这里的数据源，是上级桶的数据，也就是popular_colors分桶后的数据。所以，这里，其实是在一个色系内部做制造商划分。</div><div class="line">        &quot;who_maked&quot;: &#123;</div><div class="line">          &quot;terms&quot;: &#123;</div><div class="line">            &quot;field&quot;: &quot;make&quot;</div><div class="line">          &#125;</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>返回结果：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  &quot;took&quot;: 1,</div><div class="line">  &quot;timed_out&quot;: false,</div><div class="line">  &quot;_shards&quot;: &#123;</div><div class="line">    &quot;total&quot;: 5,</div><div class="line">    &quot;successful&quot;: 5,</div><div class="line">    &quot;failed&quot;: 0</div><div class="line">  &#125;,</div><div class="line">  &quot;hits&quot;: &#123;</div><div class="line">    &quot;total&quot;: 8,</div><div class="line">    &quot;max_score&quot;: 0,</div><div class="line">    &quot;hits&quot;: [</div><div class="line"></div><div class="line">    ]</div><div class="line">  &#125;,</div><div class="line">  &quot;aggregations&quot;: &#123;</div><div class="line">    &quot;popular_colors&quot;: &#123;</div><div class="line">      &quot;doc_count_error_upper_bound&quot;: 0,</div><div class="line">      &quot;sum_other_doc_count&quot;: 0,</div><div class="line">      &quot;buckets&quot;: [</div><div class="line">        &#123;</div><div class="line">          &quot;key&quot;: &quot;red&quot;,</div><div class="line">          &quot;doc_count&quot;: 4,</div><div class="line">          &quot;who_maked&quot;: &#123;</div><div class="line">            &quot;doc_count_error_upper_bound&quot;: 0,</div><div class="line">            &quot;sum_other_doc_count&quot;: 0,</div><div class="line">            &quot;buckets&quot;: [</div><div class="line">              &#123;</div><div class="line">                &quot;key&quot;: &quot;honda&quot;,</div><div class="line">                &quot;doc_count&quot;: 3</div><div class="line">              &#125;,</div><div class="line">              &#123;</div><div class="line">                &quot;key&quot;: &quot;bmw&quot;,</div><div class="line">                &quot;doc_count&quot;: 1</div><div class="line">              &#125;</div><div class="line">            ]</div><div class="line">          &#125;,</div><div class="line">          &quot;popular_colors_avg_price&quot;: &#123;</div><div class="line">            &quot;value&quot;: 32500</div><div class="line">          &#125;</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">          &quot;key&quot;: &quot;blue&quot;,</div><div class="line">          &quot;doc_count&quot;: 2,</div><div class="line">          &quot;who_maked&quot;: &#123;</div><div class="line">            &quot;doc_count_error_upper_bound&quot;: 0,</div><div class="line">            &quot;sum_other_doc_count&quot;: 0,</div><div class="line">            &quot;buckets&quot;: [</div><div class="line">              &#123;</div><div class="line">                &quot;key&quot;: &quot;ford&quot;,</div><div class="line">                &quot;doc_count&quot;: 1</div><div class="line">              &#125;,</div><div class="line">              &#123;</div><div class="line">                &quot;key&quot;: &quot;toyota&quot;,</div><div class="line">                &quot;doc_count&quot;: 1</div><div class="line">              &#125;</div><div class="line">            ]</div><div class="line">          &#125;,</div><div class="line">          &quot;popular_colors_avg_price&quot;: &#123;</div><div class="line">            &quot;value&quot;: 20000</div><div class="line">          &#125;</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">          &quot;key&quot;: &quot;green&quot;,</div><div class="line">          &quot;doc_count&quot;: 2,</div><div class="line">          &quot;who_maked&quot;: &#123;</div><div class="line">            &quot;doc_count_error_upper_bound&quot;: 0,</div><div class="line">            &quot;sum_other_doc_count&quot;: 0,</div><div class="line">            &quot;buckets&quot;: [</div><div class="line">              &#123;</div><div class="line">                &quot;key&quot;: &quot;ford&quot;,</div><div class="line">                &quot;doc_count&quot;: 1</div><div class="line">              &#125;,</div><div class="line">              &#123;</div><div class="line">                &quot;key&quot;: &quot;toyota&quot;,</div><div class="line">                &quot;doc_count&quot;: 1</div><div class="line">              &#125;</div><div class="line">            ]</div><div class="line">          &#125;,</div><div class="line">          &quot;popular_colors_avg_price&quot;: &#123;</div><div class="line">            &quot;value&quot;: 21000</div><div class="line">          &#125;</div><div class="line">        &#125;</div><div class="line">      ]</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h1 id="相同数据源多次汇聚"><a href="#相同数据源多次汇聚" class="headerlink" title="相同数据源多次汇聚"></a>相同数据源多次汇聚</h1><h2 id="汇聚不同颜色的汽车，并看一下不同颜色汽车的均价；同时针对所有汽车，查看其制造商的分布情况"><a href="#汇聚不同颜色的汽车，并看一下不同颜色汽车的均价；同时针对所有汽车，查看其制造商的分布情况" class="headerlink" title="汇聚不同颜色的汽车，并看一下不同颜色汽车的均价；同时针对所有汽车，查看其制造商的分布情况"></a>汇聚不同颜色的汽车，并看一下不同颜色汽车的均价；同时针对所有汽车，查看其制造商的分布情况</h2><p>和上面的嵌套汇聚不同，我们不做嵌套，只是将两次汇聚语句放到一次查询后进行。<br>如果我们将who_maked放到和popular_colors同一级，那么他们的源数据都是其parent aggs层的数据(下面的语句没有查询，默认就是所有)：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  &quot;size&quot;: 0,</div><div class="line">  &quot;aggs&quot;: &#123;</div><div class="line">    &quot;popular_colors&quot;: &#123;</div><div class="line">      &quot;terms&quot;: &#123;</div><div class="line">        &quot;field&quot;: &quot;color&quot;</div><div class="line">      &#125;,</div><div class="line">      &quot;aggs&quot;: &#123;</div><div class="line">        &quot;popular_colors_avg_price&quot;: &#123;</div><div class="line">          &quot;avg&quot;: &#123;</div><div class="line">            &quot;field&quot;: &quot;price&quot;</div><div class="line">          &#125;</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;,</div><div class="line">    &quot;who_maked&quot;: &#123;</div><div class="line">      &quot;terms&quot;: &#123;</div><div class="line">        &quot;field&quot;: &quot;make&quot;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>返回结果，who_maked和popular_colors在同一级，who_maked表示，针对所有的汽车，制造商的分布状况：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  &quot;took&quot;: 1,</div><div class="line">  &quot;timed_out&quot;: false,</div><div class="line">  &quot;_shards&quot;: &#123;</div><div class="line">    &quot;total&quot;: 5,</div><div class="line">    &quot;successful&quot;: 5,</div><div class="line">    &quot;failed&quot;: 0</div><div class="line">  &#125;,</div><div class="line">  &quot;hits&quot;: &#123;</div><div class="line">    &quot;total&quot;: 8,</div><div class="line">    &quot;max_score&quot;: 0,</div><div class="line">    &quot;hits&quot;: [</div><div class="line"></div><div class="line">    ]</div><div class="line">  &#125;,</div><div class="line">  &quot;aggregations&quot;: &#123;</div><div class="line">    &quot;popular_colors&quot;: &#123;</div><div class="line">      &quot;doc_count_error_upper_bound&quot;: 0,</div><div class="line">      &quot;sum_other_doc_count&quot;: 0,</div><div class="line">      &quot;buckets&quot;: [</div><div class="line">        &#123;</div><div class="line">          &quot;key&quot;: &quot;red&quot;,</div><div class="line">          &quot;doc_count&quot;: 4,</div><div class="line">          &quot;popular_colors_avg_price&quot;: &#123;</div><div class="line">            &quot;value&quot;: 32500</div><div class="line">          &#125;</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">          &quot;key&quot;: &quot;blue&quot;,</div><div class="line">          &quot;doc_count&quot;: 2,</div><div class="line">          &quot;popular_colors_avg_price&quot;: &#123;</div><div class="line">            &quot;value&quot;: 20000</div><div class="line">          &#125;</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">          &quot;key&quot;: &quot;green&quot;,</div><div class="line">          &quot;doc_count&quot;: 2,</div><div class="line">          &quot;popular_colors_avg_price&quot;: &#123;</div><div class="line">            &quot;value&quot;: 21000</div><div class="line">          &#125;</div><div class="line">        &#125;</div><div class="line">      ]</div><div class="line">    &#125;,</div><div class="line">    &quot;who_maked&quot;: &#123;</div><div class="line">      &quot;doc_count_error_upper_bound&quot;: 0,</div><div class="line">      &quot;sum_other_doc_count&quot;: 0,</div><div class="line">      &quot;buckets&quot;: [</div><div class="line">        &#123;</div><div class="line">          &quot;key&quot;: &quot;honda&quot;,</div><div class="line">          &quot;doc_count&quot;: 3</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">          &quot;key&quot;: &quot;ford&quot;,</div><div class="line">          &quot;doc_count&quot;: 2</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">          &quot;key&quot;: &quot;toyota&quot;,</div><div class="line">          &quot;doc_count&quot;: 2</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">          &quot;key&quot;: &quot;bmw&quot;,</div><div class="line">          &quot;doc_count&quot;: 1</div><div class="line">        &#125;</div><div class="line">      ]</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>有了上面的认识，假设我们想要获取某色系的最高价和最低价，那可以将：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">&quot;min_price&quot; : &#123; &quot;min&quot;: &#123; &quot;field&quot;: &quot;price&quot;&#125; &#125;, </div><div class="line">&quot;max_price&quot; : &#123; &quot;max&quot;: &#123; &quot;field&quot;: &quot;price&quot;&#125; &#125;</div></pre></td></tr></table></figure></p>
<p>加入同popular_colors_avg_price平级的地方。</p>
<p>如果我们是想获取某色系里某制造商的最高价和最低价，应该将<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&quot;aggs&quot; : &#123; </div><div class="line">    &quot;min_price&quot; : &#123; &quot;min&quot;: &#123; &quot;field&quot;: &quot;price&quot;&#125; &#125;, </div><div class="line">    &quot;max_price&quot; : &#123; &quot;max&quot;: &#123; &quot;field&quot;: &quot;price&quot;&#125; &#125; </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>加到who_maked内部(因为who_maked没有aggs，所以要包围在aggs内部)，不论是在terms前或者后，都是一个效果。</p>
<h1 id="直方图统计"><a href="#直方图统计" class="headerlink" title="直方图统计"></a>直方图统计</h1><p>histogram 这个桶，可以将field按照interval大小分段。</p>
<h2 id="以2万为一个段，统计不同价格区间，汽车的销量"><a href="#以2万为一个段，统计不同价格区间，汽车的销量" class="headerlink" title="以2万为一个段，统计不同价格区间，汽车的销量"></a>以2万为一个段，统计不同价格区间，汽车的销量</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">GET</div><div class="line">cars/transactions/_search</div><div class="line">&#123;</div><div class="line">  &quot;size&quot;: 0,</div><div class="line">  &quot;aggs&quot;: &#123;</div><div class="line">    &quot;price&quot;: &#123;</div><div class="line">      &quot;histogram&quot;: &#123;</div><div class="line">        &quot;field&quot;: &quot;price&quot;,</div><div class="line">        &quot;interval&quot;: 20000</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>返回结果：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  &quot;took&quot;: 1,</div><div class="line">  &quot;timed_out&quot;: false,</div><div class="line">  &quot;_shards&quot;: &#123;</div><div class="line">    &quot;total&quot;: 5,</div><div class="line">    &quot;successful&quot;: 5,</div><div class="line">    &quot;failed&quot;: 0</div><div class="line">  &#125;,</div><div class="line">  &quot;hits&quot;: &#123;</div><div class="line">    &quot;total&quot;: 8,</div><div class="line">    &quot;max_score&quot;: 0,</div><div class="line">    &quot;hits&quot;: [</div><div class="line"></div><div class="line">    ]</div><div class="line">  &#125;,</div><div class="line">  &quot;aggregations&quot;: &#123;</div><div class="line">    &quot;price&quot;: &#123;</div><div class="line">      &quot;buckets&quot;: [</div><div class="line">        &#123;</div><div class="line">          &quot;key&quot;: 0,</div><div class="line">          &quot;doc_count&quot;: 3</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">          &quot;key&quot;: 20000,</div><div class="line">          &quot;doc_count&quot;: 4</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">          &quot;key&quot;: 40000,</div><div class="line">          &quot;doc_count&quot;: 0</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">          &quot;key&quot;: 60000,</div><div class="line">          &quot;doc_count&quot;: 0</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">          &quot;key&quot;: 80000,</div><div class="line">          &quot;doc_count&quot;: 1</div><div class="line">        &#125;</div><div class="line">      ]</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="以2万为一个段，统计不同价格区间，汽车的销量，并且将价格详细分布展示出来"><a href="#以2万为一个段，统计不同价格区间，汽车的销量，并且将价格详细分布展示出来" class="headerlink" title="以2万为一个段，统计不同价格区间，汽车的销量，并且将价格详细分布展示出来"></a>以2万为一个段，统计不同价格区间，汽车的销量，并且将价格详细分布展示出来</h2><p>和前面的聚合比较，这里需要显示价格分布细节，其实就是在上面的 histogram 标签后面，添加子聚合：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">&quot;aggs&quot;: &#123;</div><div class="line">  &quot;price_items&quot;: &#123;</div><div class="line">    &quot;terms&quot;: &#123;</div><div class="line">      &quot;field&quot;: &quot;price&quot;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>返回的每一个bucket里面，会多了子buckets(price_items项)：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  &quot;key&quot;: 0,</div><div class="line">  &quot;doc_count&quot;: 3,</div><div class="line">  &quot;price_items&quot;: &#123;</div><div class="line">    &quot;doc_count_error_upper_bound&quot;: 0,</div><div class="line">    &quot;sum_other_doc_count&quot;: 0,</div><div class="line">    &quot;buckets&quot;: [</div><div class="line">      &#123;</div><div class="line">        &quot;key&quot;: 10000,</div><div class="line">        &quot;doc_count&quot;: 1</div><div class="line">      &#125;,</div><div class="line">      &#123;</div><div class="line">        &quot;key&quot;: 12000,</div><div class="line">        &quot;doc_count&quot;: 1</div><div class="line">      &#125;,</div><div class="line">      &#123;</div><div class="line">        &quot;key&quot;: 15000,</div><div class="line">        &quot;doc_count&quot;: 1</div><div class="line">      &#125;</div><div class="line">    ]</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="和kibana结合"><a href="#和kibana结合" class="headerlink" title="和kibana结合"></a>和kibana结合</h2><p>假设我们以2万为价格区间，统计不同制造商的销售情况，查询语句应该是：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">GET</div><div class="line">cars/transactions/_search</div><div class="line">&#123;</div><div class="line">  &quot;size&quot;: 0,</div><div class="line">  &quot;aggs&quot;: &#123;</div><div class="line">    &quot;price&quot;: &#123;</div><div class="line">      &quot;histogram&quot;: &#123;</div><div class="line">        &quot;field&quot;: &quot;price&quot;,</div><div class="line">        &quot;interval&quot;: 20000</div><div class="line">      &#125;,</div><div class="line">      &quot;aggs&quot;: &#123;</div><div class="line">        &quot;make_detail&quot;: &#123;</div><div class="line">          &quot;terms&quot;: &#123;</div><div class="line">            &quot;field&quot;: &quot;make&quot;</div><div class="line">          &#125;</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>返回结果：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  &quot;took&quot;: 1,</div><div class="line">  &quot;timed_out&quot;: false,</div><div class="line">  &quot;_shards&quot;: &#123;</div><div class="line">    &quot;total&quot;: 5,</div><div class="line">    &quot;successful&quot;: 5,</div><div class="line">    &quot;failed&quot;: 0</div><div class="line">  &#125;,</div><div class="line">  &quot;hits&quot;: &#123;</div><div class="line">    &quot;total&quot;: 8,</div><div class="line">    &quot;max_score&quot;: 0,</div><div class="line">    &quot;hits&quot;: [</div><div class="line"></div><div class="line">    ]</div><div class="line">  &#125;,</div><div class="line">  &quot;aggregations&quot;: &#123;</div><div class="line">    &quot;price&quot;: &#123;</div><div class="line">      &quot;buckets&quot;: [</div><div class="line">        &#123;</div><div class="line">          &quot;key&quot;: 0,</div><div class="line">          &quot;doc_count&quot;: 3,</div><div class="line">          &quot;make_detail&quot;: &#123;</div><div class="line">            &quot;doc_count_error_upper_bound&quot;: 0,</div><div class="line">            &quot;sum_other_doc_count&quot;: 0,</div><div class="line">            &quot;buckets&quot;: [</div><div class="line">              &#123;</div><div class="line">                &quot;key&quot;: &quot;toyota&quot;,</div><div class="line">                &quot;doc_count&quot;: 2</div><div class="line">              &#125;,</div><div class="line">              &#123;</div><div class="line">                &quot;key&quot;: &quot;honda&quot;,</div><div class="line">                &quot;doc_count&quot;: 1</div><div class="line">              &#125;</div><div class="line">            ]</div><div class="line">          &#125;</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">          &quot;key&quot;: 20000,</div><div class="line">          &quot;doc_count&quot;: 4,</div><div class="line">          &quot;make_detail&quot;: &#123;</div><div class="line">            &quot;doc_count_error_upper_bound&quot;: 0,</div><div class="line">            &quot;sum_other_doc_count&quot;: 0,</div><div class="line">            &quot;buckets&quot;: [</div><div class="line">              &#123;</div><div class="line">                &quot;key&quot;: &quot;ford&quot;,</div><div class="line">                &quot;doc_count&quot;: 2</div><div class="line">              &#125;,</div><div class="line">              &#123;</div><div class="line">                &quot;key&quot;: &quot;honda&quot;,</div><div class="line">                &quot;doc_count&quot;: 2</div><div class="line">              &#125;</div><div class="line">            ]</div><div class="line">          &#125;</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">          &quot;key&quot;: 40000,</div><div class="line">          &quot;doc_count&quot;: 0,</div><div class="line">          &quot;make_detail&quot;: &#123;</div><div class="line">            &quot;doc_count_error_upper_bound&quot;: 0,</div><div class="line">            &quot;sum_other_doc_count&quot;: 0,</div><div class="line">            &quot;buckets&quot;: [</div><div class="line"></div><div class="line">            ]</div><div class="line">          &#125;</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">          &quot;key&quot;: 60000,</div><div class="line">          &quot;doc_count&quot;: 0,</div><div class="line">          &quot;make_detail&quot;: &#123;</div><div class="line">            &quot;doc_count_error_upper_bound&quot;: 0,</div><div class="line">            &quot;sum_other_doc_count&quot;: 0,</div><div class="line">            &quot;buckets&quot;: [</div><div class="line"></div><div class="line">            ]</div><div class="line">          &#125;</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">          &quot;key&quot;: 80000,</div><div class="line">          &quot;doc_count&quot;: 1,</div><div class="line">          &quot;make_detail&quot;: &#123;</div><div class="line">            &quot;doc_count_error_upper_bound&quot;: 0,</div><div class="line">            &quot;sum_other_doc_count&quot;: 0,</div><div class="line">            &quot;buckets&quot;: [</div><div class="line">              &#123;</div><div class="line">                &quot;key&quot;: &quot;bmw&quot;,</div><div class="line">                &quot;doc_count&quot;: 1</div><div class="line">              &#125;</div><div class="line">            ]</div><div class="line">          &#125;</div><div class="line">        &#125;</div><div class="line">      ]</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>我们之前讲过 <a href="https://www.mnstory.net/2017/09/27/install-elasticsearch-and-plugins/" target="_blank" rel="external">kibana的安装</a>，现在，我们利用kibana的绘图功能，将上面的查询，对应绘制出来。</p>
<p>我们从浏览器打开kibana，配置好数据源</p>
<h1 id="date-histogram"><a href="#date-histogram" class="headerlink" title="date histogram"></a>date histogram</h1><p>date_histogram聚合方法，需要设置是以哪个field当成时间字段，统计间隙interval是多久，输出时间的字符串格式为format：<br>请求<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">GET</div><div class="line">cars/transactions/_search</div><div class="line">&#123;</div><div class="line">   &quot;size&quot; : 0,</div><div class="line">   &quot;aggs&quot;: &#123;</div><div class="line">      &quot;sales&quot;: &#123;</div><div class="line">         &quot;date_histogram&quot;: &#123;</div><div class="line">            &quot;field&quot;: &quot;sold&quot;,</div><div class="line">            &quot;interval&quot;: &quot;month&quot;, </div><div class="line">            &quot;format&quot;: &quot;yyyy-MM-dd&quot; </div><div class="line">         &#125;</div><div class="line">      &#125;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>返回结果为：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  &quot;took&quot;: 1,</div><div class="line">  &quot;timed_out&quot;: false,</div><div class="line">  &quot;_shards&quot;: &#123;</div><div class="line">    &quot;total&quot;: 5,</div><div class="line">    &quot;successful&quot;: 5,</div><div class="line">    &quot;failed&quot;: 0</div><div class="line">  &#125;,</div><div class="line">  &quot;hits&quot;: &#123;</div><div class="line">    &quot;total&quot;: 8,</div><div class="line">    &quot;max_score&quot;: 0,</div><div class="line">    &quot;hits&quot;: [</div><div class="line"></div><div class="line">    ]</div><div class="line">  &#125;,</div><div class="line">  &quot;aggregations&quot;: &#123;</div><div class="line">    &quot;sales&quot;: &#123;</div><div class="line">      &quot;buckets&quot;: [</div><div class="line">        &#123;</div><div class="line">          &quot;key_as_string&quot;: &quot;2014-01-01&quot;,</div><div class="line">          &quot;key&quot;: 1388534400000,</div><div class="line">          &quot;doc_count&quot;: 1</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">          &quot;key_as_string&quot;: &quot;2014-02-01&quot;,</div><div class="line">          &quot;key&quot;: 1391212800000,</div><div class="line">          &quot;doc_count&quot;: 1</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">          &quot;key_as_string&quot;: &quot;2014-03-01&quot;,</div><div class="line">          &quot;key&quot;: 1393632000000,</div><div class="line">          &quot;doc_count&quot;: 0</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">          &quot;key_as_string&quot;: &quot;2014-04-01&quot;,</div><div class="line">          &quot;key&quot;: 1396310400000,</div><div class="line">          &quot;doc_count&quot;: 0</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">          &quot;key_as_string&quot;: &quot;2014-05-01&quot;,</div><div class="line">          &quot;key&quot;: 1398902400000,</div><div class="line">          &quot;doc_count&quot;: 1</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">          &quot;key_as_string&quot;: &quot;2014-06-01&quot;,</div><div class="line">          &quot;key&quot;: 1401580800000,</div><div class="line">          &quot;doc_count&quot;: 0</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">          &quot;key_as_string&quot;: &quot;2014-07-01&quot;,</div><div class="line">          &quot;key&quot;: 1404172800000,</div><div class="line">          &quot;doc_count&quot;: 1</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">          &quot;key_as_string&quot;: &quot;2014-08-01&quot;,</div><div class="line">          &quot;key&quot;: 1406851200000,</div><div class="line">          &quot;doc_count&quot;: 1</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">          &quot;key_as_string&quot;: &quot;2014-09-01&quot;,</div><div class="line">          &quot;key&quot;: 1409529600000,</div><div class="line">          &quot;doc_count&quot;: 0</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">          &quot;key_as_string&quot;: &quot;2014-10-01&quot;,</div><div class="line">          &quot;key&quot;: 1412121600000,</div><div class="line">          &quot;doc_count&quot;: 1</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">          &quot;key_as_string&quot;: &quot;2014-11-01&quot;,</div><div class="line">          &quot;key&quot;: 1414800000000,</div><div class="line">          &quot;doc_count&quot;: 2</div><div class="line">        &#125;</div><div class="line">      ]</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h1 id="query-filter"><a href="#query-filter" class="headerlink" title="query filter"></a>query filter</h1><h2 id="只查看ford汽车的色系销售情况"><a href="#只查看ford汽车的色系销售情况" class="headerlink" title="只查看ford汽车的色系销售情况"></a>只查看ford汽车的色系销售情况</h2><p>上面的查询聚合了所有制造商的色系销量，如今我们只想查看ford的，可以通过查询语句，先查询出ford的汽车，然后再跑上面一样的汇聚：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">GET</div><div class="line">cars/transactions/_search</div><div class="line">&#123;</div><div class="line">  &quot;query&quot;: &#123; //这个部分，是新增的查询语句</div><div class="line">    &quot;match&quot;: &#123;</div><div class="line">      &quot;make&quot;: &quot;ford&quot;</div><div class="line">    &#125;</div><div class="line">  &#125;,</div><div class="line">  &quot;size&quot;: 0,</div><div class="line">  &quot;aggs&quot;: &#123;</div><div class="line">    &quot;popular_colors&quot;: &#123;</div><div class="line">      &quot;terms&quot;: &#123;</div><div class="line">        &quot;field&quot;: &quot;color&quot;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>返回结果：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  &quot;took&quot;: 1,</div><div class="line">  &quot;timed_out&quot;: false,</div><div class="line">  &quot;_shards&quot;: &#123;</div><div class="line">    &quot;total&quot;: 5,</div><div class="line">    &quot;successful&quot;: 5,</div><div class="line">    &quot;failed&quot;: 0</div><div class="line">  &#125;,</div><div class="line">  &quot;hits&quot;: &#123;</div><div class="line">    &quot;total&quot;: 2,</div><div class="line">    &quot;max_score&quot;: 0,</div><div class="line">    &quot;hits&quot;: [</div><div class="line"></div><div class="line">    ]</div><div class="line">  &#125;,</div><div class="line">  &quot;aggregations&quot;: &#123;</div><div class="line">    &quot;popular_colors&quot;: &#123;</div><div class="line">      &quot;doc_count_error_upper_bound&quot;: 0,</div><div class="line">      &quot;sum_other_doc_count&quot;: 0,</div><div class="line">      &quot;buckets&quot;: [</div><div class="line">        &#123;</div><div class="line">          &quot;key&quot;: &quot;blue&quot;,</div><div class="line">          &quot;doc_count&quot;: 1</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">          &quot;key&quot;: &quot;green&quot;,</div><div class="line">          &quot;doc_count&quot;: 1</div><div class="line">        &#125;</div><div class="line">      ]</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h1 id="全局桶"><a href="#全局桶" class="headerlink" title="全局桶"></a>全局桶</h1><p>一般来说，我们聚合的范围都是查询过滤的结果范围，但是，我们可能也会突然需要在当前上下文聚合全局的数据。例如，我们需要对比，ford汽车的均价和所有制造商汽车的均价。<br>这个时候，你就需要指定全局桶范围，全局桶不受当前查询范围影响，它包含所有数据。</p>
<h2 id="ford汽车的均价和所有制造商汽车的均价"><a href="#ford汽车的均价和所有制造商汽车的均价" class="headerlink" title="ford汽车的均价和所有制造商汽车的均价"></a>ford汽车的均价和所有制造商汽车的均价</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">GET</div><div class="line">cars/transactions/_search</div><div class="line">&#123;</div><div class="line">  &quot;size&quot;: 0,</div><div class="line">  &quot;query&quot;: &#123;</div><div class="line">    &quot;match&quot;: &#123;</div><div class="line">      &quot;make&quot;: &quot;ford&quot;</div><div class="line">    &#125;</div><div class="line">  &#125;,</div><div class="line">  &quot;aggs&quot;: &#123;</div><div class="line">    &quot;福特均价&quot;: &#123;</div><div class="line">      &quot;avg&quot;: &#123;</div><div class="line">        &quot;field&quot;: &quot;price&quot;</div><div class="line">      &#125;</div><div class="line">    &#125;,</div><div class="line">    &quot;全局桶&quot;: &#123;</div><div class="line">      &quot;global&quot;: &#123;&#125;,</div><div class="line">      &quot;aggs&quot;: &#123;</div><div class="line">        &quot;全部均价&quot;: &#123;</div><div class="line">          &quot;avg&quot;: &#123;</div><div class="line">            &quot;field&quot;: &quot;price&quot;</div><div class="line">          &#125;</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>返回结果：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  &quot;took&quot;: 2,</div><div class="line">  &quot;timed_out&quot;: false,</div><div class="line">  &quot;_shards&quot;: &#123;</div><div class="line">    &quot;total&quot;: 5,</div><div class="line">    &quot;successful&quot;: 5,</div><div class="line">    &quot;failed&quot;: 0</div><div class="line">  &#125;,</div><div class="line">  &quot;hits&quot;: &#123;</div><div class="line">    &quot;total&quot;: 2,</div><div class="line">    &quot;max_score&quot;: 0,</div><div class="line">    &quot;hits&quot;: [</div><div class="line"></div><div class="line">    ]</div><div class="line">  &#125;,</div><div class="line">  &quot;aggregations&quot;: &#123;</div><div class="line">    &quot;福特均价&quot;: &#123;</div><div class="line">      &quot;value&quot;: 27500</div><div class="line">    &#125;,</div><div class="line">    &quot;全局桶&quot;: &#123;</div><div class="line">      &quot;doc_count&quot;: 8,</div><div class="line">      &quot;全部均价&quot;: &#123;</div><div class="line">        &quot;value&quot;: 26500</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="match-和-non-scoring-query-filter"><a href="#match-和-non-scoring-query-filter" class="headerlink" title="match 和 non-scoring query(filter)"></a>match 和 non-scoring query(filter)</h2><p>使用 constant_score 可以在查询的时候，不计算score，match是会计算score的，上面的语句，我们改写为 constant_score 方式为：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  &quot;size&quot;: 0,</div><div class="line">  &quot;query&quot;: &#123;</div><div class="line">    //这里从match修改为constant_score filter</div><div class="line">    &quot;constant_score&quot;: &#123;</div><div class="line">      &quot;filter&quot;: &#123;</div><div class="line">        &quot;term&quot;: &#123;</div><div class="line">          &quot;make&quot;: &quot;ford&quot;</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;,</div><div class="line">  //下面是一样的</div><div class="line">  &quot;aggs&quot;: &#123;</div><div class="line">    &quot;福特均价&quot;: &#123;</div><div class="line">      &quot;avg&quot;: &#123;</div><div class="line">        &quot;field&quot;: &quot;price&quot;</div><div class="line">      &#125;</div><div class="line">    &#125;,</div><div class="line">    &quot;全局桶&quot;: &#123;</div><div class="line">      &quot;global&quot;: &#123;&#125;,</div><div class="line">      &quot;aggs&quot;: &#123;</div><div class="line">        &quot;全部均价&quot;: &#123;</div><div class="line">          &quot;avg&quot;: &#123;</div><div class="line">            &quot;field&quot;: &quot;price&quot;</div><div class="line">          &#125;</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="桶前过滤"><a href="#桶前过滤" class="headerlink" title="桶前过滤"></a>桶前过滤</h2><p>在aggs内部，装入桶前，可以先过滤，filter需要的数据来分桶。当然，如果我们只做一次aggs，这个filter也可以加在查询的时候。<br>例如，我们先查询了所有honda的汽车销售情况，在aggs阶段，我们只想对2014-11-01 - 2014-11-15之间的数据做半月销售统计，就可以在aggs内加入时间过滤，这种方式的优点是，影响的作用域就是自己和子孙，不会影响兄弟。如下，我们做了”honda半月售价情况”统计后，我们还想做”honda所有时间段售价情况”统计，aggs内部filter，便派上了用场。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  &quot;size&quot;: 0,</div><div class="line">  &quot;query&quot;: &#123;</div><div class="line">    &quot;match&quot;: &#123;</div><div class="line">      &quot;make&quot;: &quot;honda&quot; //没有这条查询，原本数据是8条，查询后，数据是3条</div><div class="line">    &#125;</div><div class="line">  &#125;,</div><div class="line">  &quot;aggs&quot;: &#123;</div><div class="line">    //这里数据是3条</div><div class="line">    &quot;honda半月售价情况&quot;: &#123;</div><div class="line">      &quot;filter&quot;: &#123; </div><div class="line">        &quot;range&quot;: &#123;</div><div class="line">          &quot;sold&quot;: &#123;</div><div class="line">            &quot;from&quot;: &quot;2014-11-01&quot;,</div><div class="line">            &quot;to&quot;: &quot;2014-11-15&quot;</div><div class="line">          &#125;</div><div class="line">          //按照时间过滤后，变成了2条数据</div><div class="line">        &#125;</div><div class="line">      &#125;,</div><div class="line">      //这里数据是2条</div><div class="line">      &quot;aggs&quot;: &#123;</div><div class="line">        &quot;honda半月售价分布&quot;: &#123;</div><div class="line">          &quot;terms&quot;: &#123;</div><div class="line">            &quot;field&quot;: &quot;price&quot;</div><div class="line">          &#125;</div><div class="line">        &#125;,</div><div class="line">        &quot;honda半月销售额&quot;: &#123;</div><div class="line">          &quot;sum&quot;: &#123;</div><div class="line">            &quot;field&quot;: &quot;price&quot;</div><div class="line">          &#125;</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;,</div><div class="line">    //&quot;honda半月售价情况&quot;内部做的filter不会影响到平级的&quot;honda所有时间段售价情况&quot; filter，所以，这里数据还是3条</div><div class="line">    &quot;honda所有时间段售价情况&quot;: &#123;</div><div class="line">      &quot;terms&quot;: &#123;</div><div class="line">        &quot;field&quot;: &quot;price&quot;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>返回结果：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  &quot;took&quot;: 2,</div><div class="line">  &quot;timed_out&quot;: false,</div><div class="line">  &quot;_shards&quot;: &#123;</div><div class="line">    &quot;total&quot;: 5,</div><div class="line">    &quot;successful&quot;: 5,</div><div class="line">    &quot;failed&quot;: 0</div><div class="line">  &#125;,</div><div class="line">  &quot;hits&quot;: &#123;</div><div class="line">    &quot;total&quot;: 3,</div><div class="line">    &quot;max_score&quot;: 0,</div><div class="line">    &quot;hits&quot;: [</div><div class="line"></div><div class="line">    ]</div><div class="line">  &#125;,</div><div class="line">  &quot;aggregations&quot;: &#123;</div><div class="line">    &quot;honda所有时间段售价情况&quot;: &#123;</div><div class="line">      &quot;doc_count_error_upper_bound&quot;: 0,</div><div class="line">      &quot;sum_other_doc_count&quot;: 0,</div><div class="line">      &quot;buckets&quot;: [</div><div class="line">        &#123;</div><div class="line">          &quot;key&quot;: 20000,</div><div class="line">          &quot;doc_count&quot;: 2</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">          &quot;key&quot;: 10000,</div><div class="line">          &quot;doc_count&quot;: 1</div><div class="line">        &#125;</div><div class="line">      ]</div><div class="line">    &#125;,</div><div class="line">    &quot;honda半月售价情况&quot;: &#123;</div><div class="line">      &quot;doc_count&quot;: 2,</div><div class="line">      &quot;honda半月售价分布&quot;: &#123;</div><div class="line">        &quot;doc_count_error_upper_bound&quot;: 0,</div><div class="line">        &quot;sum_other_doc_count&quot;: 0,</div><div class="line">        &quot;buckets&quot;: [</div><div class="line">          &#123;</div><div class="line">            &quot;key&quot;: 20000,</div><div class="line">            &quot;doc_count&quot;: 2</div><div class="line">          &#125;</div><div class="line">        ]</div><div class="line">      &#125;,</div><div class="line">      &quot;honda半月销售额&quot;: &#123;</div><div class="line">        &quot;value&quot;: 40000</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h1 id="post-filter"><a href="#post-filter" class="headerlink" title="post filter"></a>post filter</h1><p>post_filter过滤器，作用于输出query结果给用户之前，顺序是：<br>query -&gt; aggs -&gt; post_filter<br>所以，post_filter不会影响aggs结果，但是会影响hits返回结果。</p>
<p>例如 我想要ford汽车的色系销量情况并且同时返回ford汽车的绿色汽车详情:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  &quot;size&quot;: 10,</div><div class="line">  &quot;query&quot;: &#123;</div><div class="line">    &quot;match&quot;: &#123;</div><div class="line">      &quot;make&quot;: &quot;ford&quot;</div><div class="line">    &#125;</div><div class="line">  &#125;,</div><div class="line">  &quot;post_filter&quot;: &#123; //有了这个post_filter，返回的hits内容里，原本应该是2条结果，现在过滤后只有1条</div><div class="line">    &quot;term&quot;: &#123;</div><div class="line">      &quot;color&quot;: &quot;green&quot;</div><div class="line">    &#125;</div><div class="line">  &#125;,</div><div class="line">  &quot;aggs&quot;: &#123; // aggs不受影响，这里仍然显示所有色系的聚合结果</div><div class="line">    &quot;all_colors&quot;: &#123;</div><div class="line">      &quot;terms&quot;: &#123;</div><div class="line">        &quot;field&quot;: &quot;color&quot;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  &quot;took&quot;: 2,</div><div class="line">  &quot;timed_out&quot;: false,</div><div class="line">  &quot;_shards&quot;: &#123;</div><div class="line">    &quot;total&quot;: 5,</div><div class="line">    &quot;successful&quot;: 5,</div><div class="line">    &quot;failed&quot;: 0</div><div class="line">  &#125;,</div><div class="line">  &quot;hits&quot;: &#123;</div><div class="line">    &quot;total&quot;: 1,</div><div class="line">    &quot;max_score&quot;: 1.2039728,</div><div class="line">    &quot;hits&quot;: [</div><div class="line">      &#123;</div><div class="line">        &quot;_index&quot;: &quot;cars&quot;,</div><div class="line">        &quot;_type&quot;: &quot;transactions&quot;,</div><div class="line">        &quot;_id&quot;: &quot;AV7PgBdUSAU1E8xKCaY2&quot;,</div><div class="line">        &quot;_score&quot;: 1.2039728,</div><div class="line">        &quot;_source&quot;: &#123;</div><div class="line">          &quot;price&quot;: 30000,</div><div class="line">          &quot;color&quot;: &quot;green&quot;,</div><div class="line">          &quot;make&quot;: &quot;ford&quot;,</div><div class="line">          &quot;sold&quot;: &quot;2014-05-18&quot;</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    ]</div><div class="line">  &#125;,</div><div class="line">  &quot;aggregations&quot;: &#123;</div><div class="line">    &quot;all_colors&quot;: &#123;</div><div class="line">      &quot;doc_count_error_upper_bound&quot;: 0,</div><div class="line">      &quot;sum_other_doc_count&quot;: 0,</div><div class="line">      &quot;buckets&quot;: [</div><div class="line">        &#123;</div><div class="line">          &quot;key&quot;: &quot;blue&quot;,</div><div class="line">          &quot;doc_count&quot;: 1</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">          &quot;key&quot;: &quot;green&quot;,</div><div class="line">          &quot;doc_count&quot;: 1</div><div class="line">        &#125;</div><div class="line">      ]</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>如果单纯为了过滤，不应该用post_filter，因为他作用的阶段是在查询输出给用户前，很多filter cache都没有，效益不高。</p>
</blockquote>
<h1 id="汇聚的排序"><a href="#汇聚的排序" class="headerlink" title="汇聚的排序"></a>汇聚的排序</h1><p>我们可以在aggs里面，使用order来指定不同的排序方法，默认情况下，elasticsearch汇聚在不同的桶后，输出的时候，是按照doc_count降序输出，类似于：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  &quot;size&quot;: 0,</div><div class="line">  &quot;aggs&quot;: &#123;</div><div class="line">    &quot;colors&quot;: &#123;</div><div class="line">      &quot;terms&quot;: &#123;</div><div class="line">        &quot;field&quot;: &quot;color&quot;,</div><div class="line">        //这部分，加了和没加，效果是一样</div><div class="line">        &quot;order&quot;: &#123;</div><div class="line">          &quot;_count&quot;: &quot;desc&quot; //如果我们想要升序，修改desc为asc</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>order可以在terms, histogram, date_histogram内部使用，但order内部的这些排序方法，使用条件不同：</p>
<ol>
<li>_count<br> 按照文档数排序，可在 terms, histogram, date_histogram 内使用。示例如上。</li>
<li><p>_term<br> 按照字母顺序排序.可在 terms 内使用。例如：</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  &quot;size&quot;: 0,</div><div class="line">  &quot;aggs&quot;: &#123;</div><div class="line">    &quot;colors&quot;: &#123;</div><div class="line">      &quot;terms&quot;: &#123;</div><div class="line">        &quot;field&quot;: &quot;color&quot;,</div><div class="line">        &quot;order&quot;: &#123; //color字段的值以字母顺序降序排列</div><div class="line">          &quot;_term&quot;: &quot;asc&quot;</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>_key<br> 对桶的key按照数字排序，可以在histogram, date_histogram内使用。例如：</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  &quot;size&quot;: 0,</div><div class="line">  &quot;aggs&quot;: &#123;</div><div class="line">    &quot;sales&quot;: &#123;</div><div class="line">      &quot;date_histogram&quot;: &#123;</div><div class="line">        &quot;field&quot;: &quot;sold&quot;,</div><div class="line">        &quot;interval&quot;: &quot;month&quot;,</div><div class="line">        &quot;format&quot;: &quot;yyyy-MM-dd&quot;,</div><div class="line">        &quot;order&quot; : &#123; //默认是按照date key升序，我们可以指定为降序</div><div class="line">            &quot;_key&quot;: &quot;desc&quot;</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="按汇聚结果排序"><a href="#按汇聚结果排序" class="headerlink" title="按汇聚结果排序"></a>按汇聚结果排序</h2><p>假如我们聚合了不通色系的平均售价，然后想要按照售价从第到高输出，那么，就需要指定聚合结果排序，例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  &quot;size&quot;: 0,</div><div class="line">  &quot;aggs&quot;: &#123;</div><div class="line">    &quot;colors&quot;: &#123;</div><div class="line">      &quot;terms&quot;: &#123;</div><div class="line">        &quot;field&quot;: &quot;color&quot;,</div><div class="line">        &quot;order&quot;: &#123; //如果没有这个order，默认是按照不同色系的数量排序，即doc_count字段</div><div class="line">          &quot;avg_price&quot;: &quot;asc&quot;</div><div class="line">        &#125;</div><div class="line">      &#125;,</div><div class="line">      &quot;aggs&quot;: &#123;</div><div class="line">        &quot;avg_price&quot;: &#123;</div><div class="line">          &quot;avg&quot;: &#123;</div><div class="line">            &quot;field&quot;: &quot;price&quot;</div><div class="line">          &#125;</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>返回结果：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  &quot;took&quot;: 5,</div><div class="line">  &quot;timed_out&quot;: false,</div><div class="line">  &quot;_shards&quot;: &#123;</div><div class="line">    &quot;total&quot;: 5,</div><div class="line">    &quot;successful&quot;: 5,</div><div class="line">    &quot;failed&quot;: 0</div><div class="line">  &#125;,</div><div class="line">  &quot;hits&quot;: &#123;</div><div class="line">    &quot;total&quot;: 8,</div><div class="line">    &quot;max_score&quot;: 0,</div><div class="line">    &quot;hits&quot;: [</div><div class="line"></div><div class="line">    ]</div><div class="line">  &#125;,</div><div class="line">  &quot;aggregations&quot;: &#123;</div><div class="line">    &quot;colors&quot;: &#123;</div><div class="line">      &quot;doc_count_error_upper_bound&quot;: 0,</div><div class="line">      &quot;sum_other_doc_count&quot;: 0,</div><div class="line">      &quot;buckets&quot;: [</div><div class="line">        &#123;</div><div class="line">          &quot;key&quot;: &quot;blue&quot;,</div><div class="line">          &quot;doc_count&quot;: 2,</div><div class="line">          &quot;avg_price&quot;: &#123;</div><div class="line">            &quot;value&quot;: 20000</div><div class="line">          &#125;</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">          &quot;key&quot;: &quot;green&quot;,</div><div class="line">          &quot;doc_count&quot;: 2,</div><div class="line">          &quot;avg_price&quot;: &#123;</div><div class="line">            &quot;value&quot;: 21000</div><div class="line">          &#125;</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">          &quot;key&quot;: &quot;red&quot;,</div><div class="line">          &quot;doc_count&quot;: 4,</div><div class="line">          &quot;avg_price&quot;: &#123;</div><div class="line">            &quot;value&quot;: 32500</div><div class="line">          &#125;</div><div class="line">        &#125;</div><div class="line">      ]</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>问题来了，如果aggs有嵌套，我们如何按照内层计算结果排序？<br>order支持这种格式：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">my_bucket&gt;another_bucket&gt;metric</div></pre></td></tr></table></figure></p>
<p>你可以将所有bucket用尖括号分隔开，即可。例如，我们针对红绿色系的汽车，按照价格2万为一个区间划分，默认情况下，是按照价格从低到高的区间排序输出，我们如果想修改为按照方差(variance)来排序输出，可以这样写：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  &quot;size&quot;: 0,</div><div class="line">  &quot;aggs&quot;: &#123;</div><div class="line">    &quot;colors&quot;: &#123;</div><div class="line">      &quot;histogram&quot;: &#123;</div><div class="line">        &quot;field&quot;: &quot;price&quot;,</div><div class="line">        &quot;interval&quot;: 20000,</div><div class="line">        &quot;order&quot;: &#123; //修改为按照方差排序</div><div class="line">          &quot;红绿色系的汽车&gt;统计结果.variance&quot;: &quot;asc&quot;</div><div class="line">        &#125;</div><div class="line">      &#125;,</div><div class="line">      &quot;aggs&quot;: &#123;</div><div class="line">        &quot;红绿色系的汽车&quot;: &#123;</div><div class="line">          &quot;filter&quot;: &#123;</div><div class="line">            &quot;terms&quot;: &#123;</div><div class="line">              &quot;color&quot;: [</div><div class="line">                &quot;red&quot;,</div><div class="line">                &quot;green&quot;</div><div class="line">              ]</div><div class="line">            &#125;</div><div class="line">          &#125;,</div><div class="line">          &quot;aggs&quot;: &#123;</div><div class="line">            &quot;统计结果&quot;: &#123;</div><div class="line">              &quot;extended_stats&quot;: &#123;</div><div class="line">                &quot;field&quot;: &quot;price&quot;</div><div class="line">              &#125;</div><div class="line">            &#125;</div><div class="line">          &#125;</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>返回结果：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  ...</div><div class="line">  &quot;aggregations&quot;: &#123;</div><div class="line">    &quot;colors&quot;: &#123;</div><div class="line">      &quot;buckets&quot;: [</div><div class="line">        &#123;</div><div class="line">          &quot;key&quot;: 80000,</div><div class="line">          &quot;doc_count&quot;: 1,</div><div class="line">          &quot;红绿色系的汽车&quot;: &#123;</div><div class="line">            &quot;doc_count&quot;: 1,</div><div class="line">            &quot;统计结果&quot;: &#123;</div><div class="line">              &quot;count&quot;: 1,</div><div class="line">              &quot;min&quot;: 80000,</div><div class="line">              &quot;max&quot;: 80000,</div><div class="line">              &quot;avg&quot;: 80000,</div><div class="line">              &quot;sum&quot;: 80000,</div><div class="line">              &quot;sum_of_squares&quot;: 6400000000,</div><div class="line">              &quot;variance&quot;: 0,</div><div class="line">              &quot;std_deviation&quot;: 0,</div><div class="line">              &quot;std_deviation_bounds&quot;: &#123;</div><div class="line">                &quot;upper&quot;: 80000,</div><div class="line">                &quot;lower&quot;: 80000</div><div class="line">              &#125;</div><div class="line">            &#125;</div><div class="line">          &#125;</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">          &quot;key&quot;: 0,</div><div class="line">          &quot;doc_count&quot;: 3,</div><div class="line">          &quot;红绿色系的汽车&quot;: &#123;</div><div class="line">            &quot;doc_count&quot;: 2,</div><div class="line">            &quot;统计结果&quot;: &#123;</div><div class="line">              &quot;count&quot;: 2,</div><div class="line">              &quot;min&quot;: 10000,</div><div class="line">              &quot;max&quot;: 12000,</div><div class="line">              &quot;avg&quot;: 11000,</div><div class="line">              &quot;sum&quot;: 22000,</div><div class="line">              &quot;sum_of_squares&quot;: 244000000,</div><div class="line">              &quot;variance&quot;: 1000000,</div><div class="line">              &quot;std_deviation&quot;: 1000,</div><div class="line">              &quot;std_deviation_bounds&quot;: &#123;</div><div class="line">                &quot;upper&quot;: 13000,</div><div class="line">                &quot;lower&quot;: 9000</div><div class="line">              &#125;</div><div class="line">            &#125;</div><div class="line">          &#125;</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">          &quot;key&quot;: 20000,</div><div class="line">          &quot;doc_count&quot;: 4,</div><div class="line">          &quot;红绿色系的汽车&quot;: &#123;</div><div class="line">            &quot;doc_count&quot;: 3,</div><div class="line">            &quot;统计结果&quot;: &#123;</div><div class="line">              &quot;count&quot;: 3,</div><div class="line">              &quot;min&quot;: 20000,</div><div class="line">              &quot;max&quot;: 30000,</div><div class="line">              &quot;avg&quot;: 23333.333333333332,</div><div class="line">              &quot;sum&quot;: 70000,</div><div class="line">              &quot;sum_of_squares&quot;: 1700000000,</div><div class="line">              &quot;variance&quot;: 22222222.22222225,</div><div class="line">              &quot;std_deviation&quot;: 4714.04520791032,</div><div class="line">              &quot;std_deviation_bounds&quot;: &#123;</div><div class="line">                &quot;upper&quot;: 32761.42374915397,</div><div class="line">                &quot;lower&quot;: 13905.242917512693</div><div class="line">              &#125;</div><div class="line">            &#125;</div><div class="line">          &#125;</div><div class="line">        &#125;,</div><div class="line">        ...</div><div class="line">      ]</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h1 id="cardinality"><a href="#cardinality" class="headerlink" title="cardinality"></a>cardinality</h1><p>cardinality这个词不好翻译，大体的意思是 distinct count，类似于将数值放入一个set里面，最终计算set的count。<br>cardinality一个field，表示统计这个filed的值的distinct count，例如：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  &quot;size&quot;: 0,</div><div class="line">  &quot;aggs&quot;: &#123;</div><div class="line">    &quot;销售的汽车都有几种颜色&quot;: &#123;</div><div class="line">      &quot;cardinality&quot;: &#123; //如果你想知道，具体每一种颜色，他的销售量，这里应该修改为 terms </div><div class="line">        &quot;field&quot;: &quot;color&quot;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>结果会告诉你，一共有3种：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  ...</div><div class="line">  &quot;aggregations&quot;: &#123;</div><div class="line">    &quot;销售的汽车都有几种颜色&quot;: &#123;</div><div class="line">      &quot;value&quot;: 3</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>大数据的三角裤，只能取其二：<br>You get to choose two from this triangle:</p>
<p>Exact + real time<br>Your data fits in the RAM of a single machine. The world is your oyster; use any algorithm you want. Results will be 100% accurate and relatively fast.<br>Big data + exact<br>A classic Hadoop installation. Can handle petabytes of data and give you exact answers—but it may take a week to give you that answer.<br>Big data + real time<br>Approximate algorithms that give you accurate, but not exact, results.</p>
<p>这个地方用了 HyperLogLog++ (HLL) algorithm，是一种近似算法，并不是绝对exact。可以通过在cardinality内加入precision_threshold来权衡内存消耗与准确性，消耗内存为 precision_threshold * 8 bytes，最大取值 4000。</p>
<h1 id="percentile"><a href="#percentile" class="headerlink" title="percentile"></a>percentile</h1><p>按百等分等级排列，也是选用的一个近似算法 TDigest，据说你也可以用”compression”来类似precision_threshold设置精度，但是我在5.3版本没有试验成功，这种近似算法，越靠近两头两尾的越准确。符合找茬的需求(找茬一般都找和主流偏离太远的)<br>例如，查找网站访问时延。</p>
<p>先创建一个新的索引 website，你可能会遇到Fielddata不能应用到zone错误，请参考cars表的创建，为zone字段添加”fielddata” : true属性：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">POST</div><div class="line">website/logs/_bulk</div><div class="line">&#123; &quot;index&quot;: &#123;&#125;&#125;</div><div class="line">&#123; &quot;latency&quot; : 100, &quot;zone&quot; : &quot;US&quot;, &quot;timestamp&quot; : &quot;2014-10-28&quot; &#125;</div><div class="line">&#123; &quot;index&quot;: &#123;&#125;&#125;</div><div class="line">&#123; &quot;latency&quot; : 80, &quot;zone&quot; : &quot;US&quot;, &quot;timestamp&quot; : &quot;2014-10-29&quot; &#125;</div><div class="line">&#123; &quot;index&quot;: &#123;&#125;&#125;</div><div class="line">&#123; &quot;latency&quot; : 99, &quot;zone&quot; : &quot;US&quot;, &quot;timestamp&quot; : &quot;2014-10-29&quot; &#125;</div><div class="line">&#123; &quot;index&quot;: &#123;&#125;&#125;</div><div class="line">&#123; &quot;latency&quot; : 102, &quot;zone&quot; : &quot;US&quot;, &quot;timestamp&quot; : &quot;2014-10-28&quot; &#125;</div><div class="line">&#123; &quot;index&quot;: &#123;&#125;&#125;</div><div class="line">&#123; &quot;latency&quot; : 75, &quot;zone&quot; : &quot;US&quot;, &quot;timestamp&quot; : &quot;2014-10-28&quot; &#125;</div><div class="line">&#123; &quot;index&quot;: &#123;&#125;&#125;</div><div class="line">&#123; &quot;latency&quot; : 82, &quot;zone&quot; : &quot;US&quot;, &quot;timestamp&quot; : &quot;2014-10-29&quot; &#125;</div><div class="line">&#123; &quot;index&quot;: &#123;&#125;&#125;</div><div class="line">&#123; &quot;latency&quot; : 100, &quot;zone&quot; : &quot;EU&quot;, &quot;timestamp&quot; : &quot;2014-10-28&quot; &#125;</div><div class="line">&#123; &quot;index&quot;: &#123;&#125;&#125;</div><div class="line">&#123; &quot;latency&quot; : 280, &quot;zone&quot; : &quot;EU&quot;, &quot;timestamp&quot; : &quot;2014-10-29&quot; &#125;</div><div class="line">&#123; &quot;index&quot;: &#123;&#125;&#125;</div><div class="line">&#123; &quot;latency&quot; : 155, &quot;zone&quot; : &quot;EU&quot;, &quot;timestamp&quot; : &quot;2014-10-29&quot; &#125;</div><div class="line">&#123; &quot;index&quot;: &#123;&#125;&#125;</div><div class="line">&#123; &quot;latency&quot; : 623, &quot;zone&quot; : &quot;EU&quot;, &quot;timestamp&quot; : &quot;2014-10-28&quot; &#125;</div><div class="line">&#123; &quot;index&quot;: &#123;&#125;&#125;</div><div class="line">&#123; &quot;latency&quot; : 380, &quot;zone&quot; : &quot;EU&quot;, &quot;timestamp&quot; : &quot;2014-10-28&quot; &#125;</div><div class="line">&#123; &quot;index&quot;: &#123;&#125;&#125;</div><div class="line">&#123; &quot;latency&quot; : 319, &quot;zone&quot; : &quot;EU&quot;, &quot;timestamp&quot; : &quot;2014-10-29&quot; &#125;</div></pre></td></tr></table></figure></p>
<p>记得上面的POST内容，最后一行得有回车换行符。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">GET</div><div class="line">website/logs/_search</div><div class="line">&#123;</div><div class="line">  &quot;size&quot;: 0,</div><div class="line">  &quot;aggs&quot;: &#123;</div><div class="line">    &quot;加载时间分布&quot;: &#123;</div><div class="line">      &quot;percentiles&quot;: &#123;</div><div class="line">        &quot;field&quot;: &quot;latency&quot;</div><div class="line">      &#125;</div><div class="line">    &#125;,</div><div class="line">    &quot;平均加载时间分布&quot;: &#123;</div><div class="line">      &quot;avg&quot;: &#123;</div><div class="line">        &quot;field&quot;: &quot;latency&quot;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>返回结果：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  &quot;took&quot;: 11,</div><div class="line">  &quot;timed_out&quot;: false,</div><div class="line">  &quot;_shards&quot;: &#123;</div><div class="line">    &quot;total&quot;: 5,</div><div class="line">    &quot;successful&quot;: 5,</div><div class="line">    &quot;failed&quot;: 0</div><div class="line">  &#125;,</div><div class="line">  &quot;hits&quot;: &#123;</div><div class="line">    &quot;total&quot;: 12,</div><div class="line">    &quot;max_score&quot;: 0,</div><div class="line">    &quot;hits&quot;: [</div><div class="line"></div><div class="line">    ]</div><div class="line">  &#125;,</div><div class="line">  &quot;aggregations&quot;: &#123;</div><div class="line">    &quot;加载时间分布&quot;: &#123;</div><div class="line">      &quot;values&quot;: &#123;</div><div class="line">        &quot;1.0&quot;: 75.55,</div><div class="line">        &quot;5.0&quot;: 77.75,</div><div class="line">        &quot;25.0&quot;: 94.75,</div><div class="line">        &quot;50.0&quot;: 101,</div><div class="line">        &quot;75.0&quot;: 289.75,</div><div class="line">        &quot;95.0&quot;: 489.34999999999985,</div><div class="line">        &quot;99.0&quot;: 596.2700000000002</div><div class="line">      &#125;</div><div class="line">    &#125;,</div><div class="line">    &quot;平均加载时间分布&quot;: &#123;</div><div class="line">      &quot;value&quot;: 199.58333333333334</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>默认情况下，是显示[1, 5, 25, 50, 75, 95, 99]刻度百分比，如果想调整刻度，可以在percentiles内部加入自定义刻度，例如：”percents” : [50, 95.0, 99.0]</p>
<h2 id="percentile-ranks"><a href="#percentile-ranks" class="headerlink" title="percentile_ranks"></a>percentile_ranks</h2><p>我们再来看看 percentile_ranks，和上面的percentile展示效果是相反的，percentile是想通过输入百分比刻度，得到落入区间的值，而percentile_ranks是输入值，得到落入0到这个值范围的百分比。</p>
<p>例如，我们只对欧洲区的数据，做延时归类，看下，延时为0-90， 0-101， 0-210， 0-800所占百分比：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line">GET</div><div class="line">website/logs/_search</div><div class="line">&#123;</div><div class="line">  &quot;size&quot;: 10,</div><div class="line">  &quot;query&quot;: &#123;</div><div class="line">    &quot;constant_score&quot;: &#123;</div><div class="line">      &quot;filter&quot;: &#123;</div><div class="line">        &quot;term&quot;: &#123;</div><div class="line">          &quot;zone&quot;: &quot;eu&quot;</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;,</div><div class="line">  &quot;_source&quot;: [ //返回给用户的时候，只显示latency字段，这个_source也可以用于汇聚，比如top_hits的时候指定字段。</div><div class="line">    &quot;latency&quot;</div><div class="line">  ],</div><div class="line">  &quot;sort&quot;: [ //返回给用户的数据，按照latency的值做一下升序排列</div><div class="line">    &#123;</div><div class="line">      &quot;latency&quot;: &#123;</div><div class="line">        &quot;order&quot;: &quot;asc&quot;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  ],</div><div class="line">  &quot;aggs&quot;: &#123;</div><div class="line">    &quot;zones&quot;: &#123;</div><div class="line">      &quot;percentile_ranks&quot;: &#123;</div><div class="line">        &quot;field&quot;: &quot;latency&quot;,</div><div class="line">        &quot;values&quot;: [</div><div class="line">          90,</div><div class="line">          101,</div><div class="line">          210,</div><div class="line">          800</div><div class="line">        ]</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  ...</div><div class="line">  &quot;hits&quot;: &#123;</div><div class="line">    &quot;total&quot;: 6,</div><div class="line">    &quot;max_score&quot;: 1,</div><div class="line">    &quot;hits&quot;: [</div><div class="line">      &#123;</div><div class="line">        ...</div><div class="line">        &quot;latency&quot;: 100</div><div class="line">      &#125;,</div><div class="line">      &#123;</div><div class="line">        ...</div><div class="line">        &quot;latency&quot;: 155</div><div class="line">      &#125;,</div><div class="line">      &#123;</div><div class="line">        ...</div><div class="line">        &quot;latency&quot;: 280</div><div class="line">      &#125;,</div><div class="line">      &#123;</div><div class="line">        ...</div><div class="line">        &quot;latency&quot;: 319</div><div class="line">      &#125;,</div><div class="line">      &#123;</div><div class="line">        ...</div><div class="line">        &quot;latency&quot;: 380</div><div class="line">      &#125;,</div><div class="line">      &#123;</div><div class="line">        ...</div><div class="line">        &quot;latency&quot;: 623</div><div class="line">      &#125;</div><div class="line">    ]</div><div class="line">  &#125;,</div><div class="line">  &quot;aggregations&quot;: &#123;</div><div class="line">    &quot;zones&quot;: &#123;</div><div class="line">      &quot;values&quot;: &#123;</div><div class="line">        &quot;90.0&quot;: 5.303030303030303,   //latency小于90的，其实是0%，但是这个显示的是5%，请对比上面的原始数据</div><div class="line">        &quot;101.0&quot;: 8.636363636363637,  //latency小于101的，其实是1/6=8%</div><div class="line">        &quot;210.0&quot;: 31.944444444444443, //latency小于210的，其实是2/6=33%</div><div class="line">        &quot;800.0&quot;: 100                 //latency小于210的，是6/6=100%，只有这个是准确的。</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="数据关系"><a href="#数据关系" class="headerlink" title="数据关系"></a>数据关系</h1><p>{ “tag”: [ “search”, “nosql” ]}<br>这样的一个值为array的情况，不能用下标去索引，例如tag[0]，因为存储到elasticsearch的array是unorder的，可能并不是你存储的时候的顺序。</p>
<h2 id="多级对象"><a href="#多级对象" class="headerlink" title="多级对象"></a>多级对象</h2><p>例如，这样一个多级对象：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    &quot;tweet&quot;:            &quot;Elasticsearch is very flexible&quot;,</div><div class="line">    &quot;user&quot;: &#123;</div><div class="line">        &quot;id&quot;:           &quot;@johnsmith&quot;,</div><div class="line">        &quot;gender&quot;:       &quot;male&quot;,</div><div class="line">        &quot;age&quot;:          26,</div><div class="line">        &quot;name&quot;: &#123;</div><div class="line">            &quot;full&quot;:     &quot;John Smith&quot;,</div><div class="line">            &quot;first&quot;:    &quot;John&quot;,</div><div class="line">            &quot;last&quot;:     &quot;Smith&quot;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>其Mapping结构为：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  &quot;gb&quot;: &#123;</div><div class="line">    &quot;tweet&quot;: &#123; </div><div class="line">      &quot;properties&quot;: &#123;</div><div class="line">        &quot;tweet&quot;:            &#123; &quot;type&quot;: &quot;string&quot; &#125;,</div><div class="line">        &quot;user&quot;: &#123; </div><div class="line">          &quot;type&quot;:             &quot;object&quot;,</div><div class="line">          &quot;properties&quot;: &#123;</div><div class="line">            &quot;id&quot;:           &#123; &quot;type&quot;: &quot;string&quot; &#125;,</div><div class="line">            &quot;gender&quot;:       &#123; &quot;type&quot;: &quot;string&quot; &#125;,</div><div class="line">            &quot;age&quot;:          &#123; &quot;type&quot;: &quot;long&quot;   &#125;,</div><div class="line">            &quot;name&quot;:   &#123; </div><div class="line">              &quot;type&quot;:         &quot;object&quot;,</div><div class="line">              &quot;properties&quot;: &#123;</div><div class="line">                &quot;full&quot;:     &#123; &quot;type&quot;: &quot;string&quot; &#125;,</div><div class="line">                &quot;first&quot;:    &#123; &quot;type&quot;: &quot;string&quot; &#125;,</div><div class="line">                &quot;last&quot;:     &#123; &quot;type&quot;: &quot;string&quot; &#125;</div><div class="line">              &#125;</div><div class="line">            &#125;</div><div class="line">          &#125;</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>可以看出，user和name两个key自动映射为了object。</p>
<p>Lucene没有嵌套结构一说，它会将所有对象数据存储到一个平面，变成：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    &quot;tweet&quot;:            [elasticsearch, flexible, very],</div><div class="line">    &quot;user.id&quot;:          [@johnsmith],</div><div class="line">    &quot;user.gender&quot;:      [male],</div><div class="line">    &quot;user.age&quot;:         [26],</div><div class="line">    &quot;user.name.full&quot;:   [john, smith],</div><div class="line">    &quot;user.name.first&quot;:  [john],</div><div class="line">    &quot;user.name.last&quot;:   [smith]</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>所以，你可以通过user.name.full这种方式，去获取多级对象的值。</p>
<h2 id="对象数组"><a href="#对象数组" class="headerlink" title="对象数组"></a>对象数组</h2><p>咱们的数组里面包含的是对象，例如：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">PUT</div><div class="line">my_index/blogpost/1</div><div class="line">&#123;</div><div class="line">  &quot;title&quot;: &quot;Nest eggs&quot;,</div><div class="line">  &quot;body&quot;: &quot;Making your money work...&quot;,</div><div class="line">  &quot;tags&quot;: [</div><div class="line">    &quot;cash&quot;,</div><div class="line">    &quot;shares&quot;</div><div class="line">  ],</div><div class="line">  &quot;comments&quot;: [</div><div class="line">    &#123;</div><div class="line">      &quot;name&quot;: &quot;John Smith&quot;,</div><div class="line">      &quot;comment&quot;: &quot;Great article&quot;,</div><div class="line">      &quot;age&quot;: 28,</div><div class="line">      &quot;stars&quot;: 4,</div><div class="line">      &quot;date&quot;: &quot;2014-09-01&quot;</div><div class="line">    &#125;,</div><div class="line">    &#123;</div><div class="line">      &quot;name&quot;: &quot;Alice White&quot;,</div><div class="line">      &quot;comment&quot;: &quot;More like this please&quot;,</div><div class="line">      &quot;age&quot;: 31,</div><div class="line">      &quot;stars&quot;: 5,</div><div class="line">      &quot;date&quot;: &quot;2014-10-22&quot;</div><div class="line">    &#125;</div><div class="line">  ]</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>现在，默认的dynamic mapping会将comments当成一个对象：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div></pre></td><td class="code"><pre><div class="line">&quot;mappings&quot;: &#123;</div><div class="line">  &quot;blogpost&quot;: &#123;</div><div class="line">    &quot;properties&quot;: &#123;</div><div class="line">      &quot;body&quot;: &#123;</div><div class="line">        &quot;type&quot;: &quot;text&quot;,</div><div class="line">        &quot;fields&quot;: &#123;</div><div class="line">          &quot;keyword&quot;: &#123;</div><div class="line">            &quot;type&quot;: &quot;keyword&quot;,</div><div class="line">            &quot;ignore_above&quot;: 256</div><div class="line">          &#125;</div><div class="line">        &#125;</div><div class="line">      &#125;,</div><div class="line">      &quot;comments&quot;: &#123;</div><div class="line">        &quot;properties&quot;: &#123;</div><div class="line">          &quot;age&quot;: &#123;</div><div class="line">            &quot;type&quot;: &quot;long&quot;</div><div class="line">          &#125;,</div><div class="line">          &quot;comment&quot;: &#123;</div><div class="line">            &quot;type&quot;: &quot;text&quot;,</div><div class="line">            &quot;fields&quot;: &#123;</div><div class="line">              &quot;keyword&quot;: &#123;</div><div class="line">                &quot;type&quot;: &quot;keyword&quot;,</div><div class="line">                &quot;ignore_above&quot;: 256</div><div class="line">              &#125;</div><div class="line">            &#125;</div><div class="line">          &#125;,</div><div class="line">          ...</div><div class="line">        &#125;</div><div class="line">      &#125;,</div><div class="line">      &quot;tags&quot;: &#123;</div><div class="line">        &quot;type&quot;: &quot;text&quot;,</div><div class="line">        &quot;fields&quot;: &#123;</div><div class="line">          &quot;keyword&quot;: &#123;</div><div class="line">            &quot;type&quot;: &quot;keyword&quot;,</div><div class="line">            &quot;ignore_above&quot;: 256</div><div class="line">          &#125;</div><div class="line">        &#125;</div><div class="line">      &#125;,</div><div class="line">      &quot;title&quot;: &#123;</div><div class="line">        &quot;type&quot;: &quot;text&quot;,</div><div class="line">        &quot;fields&quot;: &#123;</div><div class="line">          &quot;keyword&quot;: &#123;</div><div class="line">            &quot;type&quot;: &quot;keyword&quot;,</div><div class="line">            &quot;ignore_above&quot;: 256</div><div class="line">          &#125;</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>相同对象名的值，会合并成数组，存储到Lucene内部，应该是这样的：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  &quot;title&quot;:            [ eggs, nest ],</div><div class="line">  &quot;body&quot;:             [ making, money, work, your ],</div><div class="line">  &quot;tags&quot;:             [ cash, shares ],</div><div class="line">  &quot;comments.name&quot;:    [ alice, john, smith, white ],</div><div class="line">  &quot;comments.comment&quot;: [ article, great, like, more, please, this ],</div><div class="line">  &quot;comments.age&quot;:     [ 28, 31 ],</div><div class="line">  &quot;comments.stars&quot;:   [ 4, 5 ],</div><div class="line">  &quot;comments.date&quot;:    [ 2014-09-01, 2014-10-22 ]</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>如果我们想搜索，comments里面名字包含Alice，并且年龄为28岁的blog：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  &quot;query&quot;: &#123;</div><div class="line">    &quot;bool&quot;: &#123;</div><div class="line">      &quot;must&quot;: [</div><div class="line">        &#123; &quot;match&quot;: &#123; &quot;comments.name&quot;: &quot;Alice&quot; &#125;&#125;,</div><div class="line">        &#123; &quot;match&quot;: &#123; &quot;comments.age&quot;:  28      &#125;&#125; </div><div class="line">      ]</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>从原始数据看，这种搜索是不应该返回结果的，因为Alice的年龄是31，而不是28，但是Lucene将其结构扁平化之后，这个搜索会返回此条记录。</p>
<p>是不是和咱们想想的不一样？于是，有了 Nested Objects.</p>
<h1 id="Nested-Objects"><a href="#Nested-Objects" class="headerlink" title="Nested Objects"></a>Nested Objects</h1><p>我们POST数据之前，先创建索引，并制定其comments的type为nested，则数据变成nested对象。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">PUT</div><div class="line">my_index</div><div class="line">&#123;</div><div class="line">  &quot;mappings&quot;: &#123;</div><div class="line">    &quot;blogpost&quot;: &#123;</div><div class="line">      &quot;properties&quot;: &#123;</div><div class="line">        &quot;comments&quot;: &#123;</div><div class="line">          &quot;type&quot;: &quot;nested&quot;, //唯一的差别，就在这里，默认type是object</div><div class="line">          &quot;properties&quot;: &#123;</div><div class="line">            &quot;name&quot;:    &#123; &quot;type&quot;: &quot;string&quot;  &#125;,</div><div class="line">            &quot;comment&quot;: &#123; &quot;type&quot;: &quot;string&quot;  &#125;,</div><div class="line">            &quot;age&quot;:     &#123; &quot;type&quot;: &quot;short&quot;   &#125;,</div><div class="line">            &quot;stars&quot;:   &#123; &quot;type&quot;: &quot;short&quot;   &#125;,</div><div class="line">            &quot;date&quot;:    &#123; &quot;type&quot;: &quot;date&quot;    &#125;</div><div class="line">          &#125;</div><div class="line">        &#125;,</div><div class="line">        &quot;tags&quot;: &#123; //后面会对tags做汇聚，这里先设置fielddata</div><div class="line">          &quot;type&quot;: &quot;text&quot;,</div><div class="line">          &quot;fielddata&quot;: true</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>然后照常插入数据，再次进行刚才的查询，没了数据，但是换成Alice和31，还是没有数据！<br>为什么呢？<br>切换为nested objects后，其查询，并没有无缝切换，需要显示指定查询类型为nested：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line">GET</div><div class="line">my_index/blogpost/_search</div><div class="line">&#123;</div><div class="line">  &quot;query&quot;: &#123;</div><div class="line">    &quot;bool&quot;: &#123;</div><div class="line">      &quot;must&quot;: [</div><div class="line">        &#123;</div><div class="line">          &quot;match&quot;: &#123;</div><div class="line">            &quot;title&quot;: &quot;eggs&quot;</div><div class="line">          &#125;</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">          &quot;nested&quot;: &#123; //包裹在nested标签内，指定path为comments</div><div class="line">            &quot;path&quot;: &quot;comments&quot;,</div><div class="line">            &quot;query&quot;: &#123;</div><div class="line">              &quot;bool&quot;: &#123;</div><div class="line">                &quot;must&quot;: [</div><div class="line">                  &#123;</div><div class="line">                    &quot;match&quot;: &#123;</div><div class="line">                      &quot;comments.name&quot;: &quot;Alice&quot; //这里的key必须是全称comments.name不能省略掉comments</div><div class="line">                    &#125;</div><div class="line">                  &#125;,</div><div class="line">                  &#123;</div><div class="line">                    &quot;match&quot;: &#123;</div><div class="line">                      &quot;comments.age&quot;: 31</div><div class="line">                    &#125;</div><div class="line">                  &#125;</div><div class="line">                ]</div><div class="line">              &#125;</div><div class="line">            &#125;</div><div class="line">          &#125;</div><div class="line">        &#125;</div><div class="line">      ]</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>数据如我们想象，成功返回。</p>
<p>这些嵌套对象应该是elasticsearch自己扩展的，将嵌套对象和外层对象分开成不同的objects存储，类似这样的存储方式：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">&#123; </div><div class="line">  &quot;comments.name&quot;:    [ john, smith ],</div><div class="line">  &quot;comments.comment&quot;: [ article, great ],</div><div class="line">  &quot;comments.age&quot;:     [ 28 ],</div><div class="line">  &quot;comments.stars&quot;:   [ 4 ],</div><div class="line">  &quot;comments.date&quot;:    [ 2014-09-01 ]</div><div class="line">&#125;</div><div class="line">&#123; </div><div class="line">  &quot;comments.name&quot;:    [ alice, white ],</div><div class="line">  &quot;comments.comment&quot;: [ like, more, please, this ],</div><div class="line">  &quot;comments.age&quot;:     [ 31 ],</div><div class="line">  &quot;comments.stars&quot;:   [ 5 ],</div><div class="line">  &quot;comments.date&quot;:    [ 2014-10-22 ]</div><div class="line">&#125;</div><div class="line">&#123; </div><div class="line">  &quot;title&quot;:            [ eggs, nest ],</div><div class="line">  &quot;body&quot;:             [ making, money, work, your ],</div><div class="line">  &quot;tags&quot;:             [ cash, shares ]</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这样的结果，在指定nested query的时候，elasticsearch可以去一个comment对象里面查找，而不会跨comment查找。nested objects和外层object是属于同一个document。</p>
<p>nested objects有几个特征：</p>
<ol>
<li>你不能直接访问这些nested objects。</li>
<li>增删改任意一个nested object，整个document(外层object和所有nested objects)都会reindex。</li>
<li>查询匹配上nested object的时候，返回的是整个document，而不是nested objects。</li>
<li>nested objects上match到的score也会累积到document的score上，你可以通过设置score_mode=avg, max, sum, none来选择累积方式，默认为avg方式。</li>
</ol>
<h2 id="nested-objects-排序"><a href="#nested-objects-排序" class="headerlink" title="nested objects 排序"></a>nested objects 排序</h2><p>假设，我们查询出了很多个documents，如果想安装这些documents的nested objects的某有一个字段进行排序(不止是一个document内部排序，还要跨documents，让documents的顺序也收到nested objects内的某一字段值影响)，改如何做？</p>
<p>我们先构造数据，在刚才的基础上，插入第二条数据：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">PUT </div><div class="line">my_index/blogpost/2</div><div class="line">&#123;</div><div class="line">  &quot;title&quot;: &quot;Investment secrets&quot;,</div><div class="line">  &quot;body&quot;:  &quot;What they don&apos;t tell you ...&quot;,</div><div class="line">  &quot;tags&quot;:  [ &quot;shares&quot;, &quot;equities&quot; ],</div><div class="line">  &quot;comments&quot;: [</div><div class="line">    &#123;</div><div class="line">      &quot;name&quot;:    &quot;Mary Brown&quot;,</div><div class="line">      &quot;comment&quot;: &quot;Lies, lies, lies&quot;,</div><div class="line">      &quot;age&quot;:     42,</div><div class="line">      &quot;stars&quot;:   1,</div><div class="line">      &quot;date&quot;:    &quot;2014-10-18&quot;</div><div class="line">    &#125;,</div><div class="line">    &#123;</div><div class="line">      &quot;name&quot;:    &quot;John Smith&quot;,</div><div class="line">      &quot;comment&quot;: &quot;You&apos;re making it up!&quot;,</div><div class="line">      &quot;age&quot;:     28,</div><div class="line">      &quot;stars&quot;:   2,</div><div class="line">      &quot;date&quot;:    &quot;2014-10-16&quot;</div><div class="line">    &#125;</div><div class="line">  ]</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>此时，我们的blogpost里面有两个documents，假设我们想查询2014年10月份的评论，然后按照评论者打的星级，排序一下，看下那些文章和言论，获得了用户最糟糕的评价，可以这样写：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  &quot;query&quot;: &#123;</div><div class="line">    &quot;nested&quot;: &#123;</div><div class="line">      &quot;path&quot;: &quot;comments&quot;,</div><div class="line">      &quot;query&quot;: &#123; //官方文档这里写的是filter，我在5.3版本运行提升错误，改为query</div><div class="line">        &quot;range&quot;: &#123;</div><div class="line">          &quot;comments.date&quot;: &#123;</div><div class="line">            &quot;gte&quot;: &quot;2014-10-01&quot;,</div><div class="line">            &quot;lt&quot;: &quot;2014-11-01&quot;</div><div class="line">          &#125;</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;,</div><div class="line">  //上面的query比较好理解，就是查询出了所有包含2014年10月份评论的documents</div><div class="line">  &quot;sort&quot;: &#123;</div><div class="line">    &quot;comments.stars&quot;: &#123;</div><div class="line">      &quot;order&quot;: &quot;asc&quot;,</div><div class="line">      &quot;mode&quot;: &quot;min&quot;,</div><div class="line">      &quot;nested_filter&quot;: &#123; //这里，为什么还要filter一次？原因是上面返回的是documents，这里接收到的也是documents，再过滤一下时间段，将2014年10月份的nested objects过滤出来，不然，可能2014年5月份更低的comments.stars也被用于排序，显然不是我们想要的。</div><div class="line">        &quot;range&quot;: &#123;</div><div class="line">          &quot;comments.date&quot;: &#123;</div><div class="line">            &quot;gte&quot;: &quot;2014-10-01&quot;,</div><div class="line">            &quot;lt&quot;: &quot;2014-11-01&quot;</div><div class="line">          &#125;</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="nested-objects-聚合"><a href="#nested-objects-聚合" class="headerlink" title="nested objects 聚合"></a>nested objects 聚合</h2><p>如果想要按照nested objects聚合，需要指定nested方法并指定path参数。<br>如下，我们想根据不同月份的comments聚合，然后看一下每月评分分布情况，可以这样查询：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">GET</div><div class="line">my_index/blogpost/_search</div><div class="line">&#123;</div><div class="line">  &quot;size&quot;: 0,</div><div class="line">  &quot;aggs&quot;: &#123;</div><div class="line">    &quot;评论&quot;: &#123;</div><div class="line">      &quot;nested&quot;: &#123; //这里指定是嵌套聚合comments</div><div class="line">        &quot;path&quot;: &quot;comments&quot;</div><div class="line">      &#125;,</div><div class="line">      &quot;aggs&quot;: &#123;</div><div class="line">        &quot;不同月份的评分&quot;: &#123;</div><div class="line">          &quot;date_histogram&quot;: &#123;</div><div class="line">            &quot;field&quot;: &quot;comments.date&quot;, // field的值要带上comments本身作为路径的一部分</div><div class="line">            &quot;interval&quot;: &quot;month&quot;,</div><div class="line">            &quot;format&quot;: &quot;yyyy-MM&quot;</div><div class="line">          &#125;,</div><div class="line">          &quot;aggs&quot;: &#123;</div><div class="line">            &quot;评分分布详情&quot;: &#123;</div><div class="line">              &quot;terms&quot;: &#123;</div><div class="line">                &quot;field&quot;: &quot;comments.stars&quot;</div><div class="line">              &#125;</div><div class="line">            &#125;,</div><div class="line">            &quot;平均评分&quot;: &#123;</div><div class="line">              &quot;avg&quot;: &#123;</div><div class="line">                &quot;field&quot;: &quot;comments.stars&quot;</div><div class="line">              &#125;</div><div class="line">            &#125;</div><div class="line">          &#125;</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>返回结果：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  &quot;took&quot;: 1,</div><div class="line">  &quot;timed_out&quot;: false,</div><div class="line">  &quot;_shards&quot;: &#123;</div><div class="line">    &quot;total&quot;: 5,</div><div class="line">    &quot;successful&quot;: 5,</div><div class="line">    &quot;failed&quot;: 0</div><div class="line">  &#125;,</div><div class="line">  &quot;hits&quot;: &#123;</div><div class="line">    &quot;total&quot;: 2,</div><div class="line">    &quot;max_score&quot;: 0,</div><div class="line">    &quot;hits&quot;: [</div><div class="line"></div><div class="line">    ]</div><div class="line">  &#125;,</div><div class="line">  &quot;aggregations&quot;: &#123;</div><div class="line">    &quot;评论&quot;: &#123;</div><div class="line">      &quot;doc_count&quot;: 4,</div><div class="line">      &quot;不同月份的评分&quot;: &#123;</div><div class="line">        &quot;buckets&quot;: [</div><div class="line">          &#123;</div><div class="line">            &quot;key_as_string&quot;: &quot;2014-09&quot;,</div><div class="line">            &quot;key&quot;: 1409529600000,</div><div class="line">            &quot;doc_count&quot;: 1,</div><div class="line">            &quot;评分分布详情&quot;: &#123;</div><div class="line">              &quot;doc_count_error_upper_bound&quot;: 0,</div><div class="line">              &quot;sum_other_doc_count&quot;: 0,</div><div class="line">              &quot;buckets&quot;: [</div><div class="line">                &#123;</div><div class="line">                  &quot;key&quot;: 4,</div><div class="line">                  &quot;doc_count&quot;: 1</div><div class="line">                &#125;</div><div class="line">              ]</div><div class="line">            &#125;,</div><div class="line">            &quot;平均评分&quot;: &#123;</div><div class="line">              &quot;value&quot;: 4</div><div class="line">            &#125;</div><div class="line">          &#125;,</div><div class="line">          &#123;</div><div class="line">            &quot;key_as_string&quot;: &quot;2014-10&quot;,</div><div class="line">            &quot;key&quot;: 1412121600000,</div><div class="line">            &quot;doc_count&quot;: 3,</div><div class="line">            &quot;评分分布详情&quot;: &#123;</div><div class="line">              &quot;doc_count_error_upper_bound&quot;: 0,</div><div class="line">              &quot;sum_other_doc_count&quot;: 0,</div><div class="line">              &quot;buckets&quot;: [</div><div class="line">                &#123;</div><div class="line">                  &quot;key&quot;: 1,</div><div class="line">                  &quot;doc_count&quot;: 1</div><div class="line">                &#125;,</div><div class="line">                &#123;</div><div class="line">                  &quot;key&quot;: 2,</div><div class="line">                  &quot;doc_count&quot;: 1</div><div class="line">                &#125;,</div><div class="line">                &#123;</div><div class="line">                  &quot;key&quot;: 5,</div><div class="line">                  &quot;doc_count&quot;: 1</div><div class="line">                &#125;</div><div class="line">              ]</div><div class="line">            &#125;,</div><div class="line">            &quot;平均评分&quot;: &#123;</div><div class="line">              &quot;value&quot;: 2.6666666666666665</div><div class="line">            &#125;</div><div class="line">          &#125;</div><div class="line">        ]</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="reverse-nested"><a href="#reverse-nested" class="headerlink" title="reverse_nested"></a>reverse_nested</h2><p>和global方法有异曲同工之妙，如果进入了里层聚合，如何跳出来，使用外层的数据？<br>global是不管当前的查询结果，从整个index或type重新开始新的查询，而reverse_nested是不管当前的查询结果，从document重新开始新的查询。<br>我们看看，假设，我们按照评论者的年龄段划分，划分后，我们想知道，不通年龄段的评论者，对哪类型的文章感兴趣？聚合语句可以这样写：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line">GET</div><div class="line">my_index/blogpost/_search</div><div class="line">&#123;</div><div class="line">  &quot;size&quot;: 0,</div><div class="line">  &quot;aggs&quot;: &#123;</div><div class="line">    &quot;评论&quot;: &#123;</div><div class="line">      &quot;nested&quot;: &#123;</div><div class="line">        &quot;path&quot;: &quot;comments&quot;</div><div class="line">      &#125;,</div><div class="line">      &quot;aggs&quot;: &#123;</div><div class="line">        &quot;年龄分布&quot;: &#123;</div><div class="line">          &quot;histogram&quot;: &#123;</div><div class="line">            &quot;field&quot;: &quot;comments.age&quot;,</div><div class="line">            &quot;interval&quot;: 10</div><div class="line">          &#125;,</div><div class="line">          &quot;aggs&quot;: &#123;</div><div class="line">            &quot;博客&quot;: &#123;</div><div class="line">              &quot;reverse_nested&quot;: &#123;&#125;,</div><div class="line">              &quot;aggs&quot;: &#123;</div><div class="line">                &quot;文章标签&quot;: &#123;</div><div class="line">                  &quot;terms&quot;: &#123;</div><div class="line">                    &quot;field&quot;: &quot;tags&quot;</div><div class="line">                  &#125;</div><div class="line">                &#125;</div><div class="line">              &#125;</div><div class="line">            &#125;</div><div class="line">          &#125;</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  ...</div><div class="line">  &quot;aggregations&quot;: &#123;</div><div class="line">    &quot;评论&quot;: &#123;</div><div class="line">      &quot;doc_count&quot;: 4,</div><div class="line">      &quot;年龄分布&quot;: &#123;</div><div class="line">        &quot;buckets&quot;: [</div><div class="line">          &#123;</div><div class="line">            &quot;key&quot;: 20, // 年龄在20-30岁之间的评论，有2条，他们感兴趣的tags是shares, cash, equities</div><div class="line">            &quot;doc_count&quot;: 2,</div><div class="line">            &quot;博客&quot;: &#123;</div><div class="line">              &quot;doc_count&quot;: 2,</div><div class="line">              &quot;文章标签&quot;: &#123;</div><div class="line">                &quot;doc_count_error_upper_bound&quot;: 0,</div><div class="line">                &quot;sum_other_doc_count&quot;: 0,</div><div class="line">                &quot;buckets&quot;: [</div><div class="line">                  &#123;</div><div class="line">                    &quot;key&quot;: &quot;shares&quot;,</div><div class="line">                    &quot;doc_count&quot;: 2</div><div class="line">                  &#125;,</div><div class="line">                  &#123;</div><div class="line">                    &quot;key&quot;: &quot;cash&quot;,</div><div class="line">                    &quot;doc_count&quot;: 1</div><div class="line">                  &#125;,</div><div class="line">                  &#123;</div><div class="line">                    &quot;key&quot;: &quot;equities&quot;,</div><div class="line">                    &quot;doc_count&quot;: 1</div><div class="line">                  &#125;</div><div class="line">                ]</div><div class="line">              &#125;</div><div class="line">            &#125;</div><div class="line">          &#125;,</div><div class="line">          &#123;</div><div class="line">            &quot;key&quot;: 30,</div><div class="line">            &quot;doc_count&quot;: 1,</div><div class="line">            &quot;博客&quot;: &#123;</div><div class="line">              &quot;doc_count&quot;: 1,</div><div class="line">              &quot;文章标签&quot;: &#123;</div><div class="line">                &quot;doc_count_error_upper_bound&quot;: 0,</div><div class="line">                &quot;sum_other_doc_count&quot;: 0,</div><div class="line">                &quot;buckets&quot;: [</div><div class="line">                  &#123;</div><div class="line">                    &quot;key&quot;: &quot;cash&quot;,</div><div class="line">                    &quot;doc_count&quot;: 1</div><div class="line">                  &#125;,</div><div class="line">                  &#123;</div><div class="line">                    &quot;key&quot;: &quot;shares&quot;,</div><div class="line">                    &quot;doc_count&quot;: 1</div><div class="line">                  &#125;</div><div class="line">                ]</div><div class="line">              &#125;</div><div class="line">            &#125;</div><div class="line">          &#125;,</div><div class="line">          &#123;</div><div class="line">            &quot;key&quot;: 40,</div><div class="line">            &quot;doc_count&quot;: 1,</div><div class="line">            &quot;博客&quot;: &#123;</div><div class="line">              &quot;doc_count&quot;: 1,</div><div class="line">              &quot;文章标签&quot;: &#123;</div><div class="line">                &quot;doc_count_error_upper_bound&quot;: 0,</div><div class="line">                &quot;sum_other_doc_count&quot;: 0,</div><div class="line">                &quot;buckets&quot;: [</div><div class="line">                  &#123;</div><div class="line">                    &quot;key&quot;: &quot;equities&quot;,</div><div class="line">                    &quot;doc_count&quot;: 1</div><div class="line">                  &#125;,</div><div class="line">                  &#123;</div><div class="line">                    &quot;key&quot;: &quot;shares&quot;,</div><div class="line">                    &quot;doc_count&quot;: 1</div><div class="line">                  &#125;</div><div class="line">                ]</div><div class="line">              &#125;</div><div class="line">            &#125;</div><div class="line">          &#125;</div><div class="line">        ]</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="Parent-child-relationships"><a href="#Parent-child-relationships" class="headerlink" title="Parent/child relationships"></a>Parent/child relationships</h1><p>nested objects和Parent/child的差别在于，前者是所有的entities都存在同一个document中，而后者parent和child的entities分属于不同的documents。<br>但是，elasticsearch仍然会保证，parent/child被分到同一shard。<br>相对于nested objects，其优点是，更新某一child不会影响到parent和其他children，可单独更新，也不会导致parent/child全部reindex。child documents可以单独在查询结果中返回(nested objects是要返回外层document的)。</p>
<p>我们演示一下，三级父子关系的情况，假设，一个国家下面有不同的分支机构，不同的分支机构下面有不同的雇员，其index可以创建的时候，可以将几个type之间的关系指定好：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">PUT</div><div class="line">company</div><div class="line">&#123;</div><div class="line">  &quot;mappings&quot;: &#123;</div><div class="line">    &quot;country&quot;: &#123;</div><div class="line">      &quot;properties&quot;: &#123;</div><div class="line">        &quot;name&quot;: &#123;</div><div class="line">          &quot;type&quot;: &quot;string&quot;,</div><div class="line">          &quot;fielddata&quot;: true</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;,</div><div class="line">    &quot;branch&quot;: &#123;</div><div class="line">      &quot;_parent&quot;: &#123; // branch的parent为country</div><div class="line">        &quot;type&quot;: &quot;country&quot;</div><div class="line">      &#125;</div><div class="line">    &#125;,</div><div class="line">    &quot;employee&quot;: &#123;</div><div class="line">      &quot;_parent&quot;: &#123; // employee的parent为branch</div><div class="line">        &quot;type&quot;: &quot;branch&quot;</div><div class="line">      &#125;,</div><div class="line">      &quot;properties&quot;: &#123;</div><div class="line">        &quot;hobby&quot;: &#123;</div><div class="line">          &quot;type&quot;: &quot;string&quot;,</div><div class="line">          &quot;fielddata&quot;: true</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>插入country：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">POST </div><div class="line">company/country/_bulk</div><div class="line">&#123; &quot;index&quot;: &#123; &quot;_id&quot;: &quot;uk&quot; &#125;&#125;</div><div class="line">&#123; &quot;name&quot;: &quot;UK&quot; &#125;</div><div class="line">&#123; &quot;index&quot;: &#123; &quot;_id&quot;: &quot;france&quot; &#125;&#125;</div><div class="line">&#123; &quot;name&quot;: &quot;France&quot; &#125;</div></pre></td></tr></table></figure></p>
<p>指定了parent之后，默认的routing会设置为parent的key，根据shard算法：<br>shard = hash(routing) % number_of_primary_shards<br>可以将parent和child放到同一shard。</p>
<p>插入branch，可以通过单条方式插入(需要指定parent)，也可以通过bulk方式批量插入：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">POST </div><div class="line">company/branch/_bulk</div><div class="line">&#123; &quot;index&quot;: &#123; &quot;_id&quot;: &quot;london&quot;, &quot;parent&quot;: &quot;uk&quot; &#125;&#125;</div><div class="line">&#123; &quot;name&quot;: &quot;London Westmintster&quot; &#125;</div><div class="line">&#123; &quot;index&quot;: &#123; &quot;_id&quot;: &quot;liverpool&quot;, &quot;parent&quot;: &quot;uk&quot; &#125;&#125;</div><div class="line">&#123; &quot;name&quot;: &quot;Liverpool Central&quot; &#125;</div><div class="line">&#123; &quot;index&quot;: &#123; &quot;_id&quot;: &quot;paris&quot;, &quot;parent&quot;: &quot;france&quot; &#125;&#125;</div><div class="line">&#123; &quot;name&quot;: &quot;Champs élysées&quot; &#125;</div></pre></td></tr></table></figure></p>
<p>插入employee，可以一个一个插入(需要指定parent，将route指定为grandparent的ID，可以保证子孙三代都放到同一个shard)：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">PUT </div><div class="line">company/employee/1?parent=london&amp;routing=uk </div><div class="line">&#123;</div><div class="line">  &quot;name&quot;:  &quot;Alice Smith&quot;,</div><div class="line">  &quot;dob&quot;:   &quot;1970-10-24&quot;,</div><div class="line">  &quot;hobby&quot;: &quot;hiking&quot;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>或者使用bulk API批量插入：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">POST </div><div class="line">company/employee/_bulk</div><div class="line">&#123; &quot;index&quot;: &#123; &quot;_id&quot;: 1, &quot;parent&quot;: &quot;london&quot;, &quot;routing&quot;:&quot;uk&quot; &#125;&#125;</div><div class="line">&#123; &quot;name&quot;: &quot;Alice Smith&quot;, &quot;dob&quot;: &quot;1970-10-24&quot;, &quot;hobby&quot;: &quot;hiking&quot; &#125;</div><div class="line">&#123; &quot;index&quot;: &#123; &quot;_id&quot;: 2, &quot;parent&quot;: &quot;london&quot;, &quot;routing&quot;:&quot;uk&quot; &#125;&#125;</div><div class="line">&#123; &quot;name&quot;: &quot;Mark Thomas&quot;, &quot;dob&quot;: &quot;1982-05-16&quot;, &quot;hobby&quot;: &quot;diving&quot; &#125;</div><div class="line">&#123; &quot;index&quot;: &#123; &quot;_id&quot;: 3, &quot;parent&quot;: &quot;liverpool&quot;, &quot;routing&quot;:&quot;uk&quot; &#125;&#125;</div><div class="line">&#123; &quot;name&quot;: &quot;Barry Smith&quot;, &quot;dob&quot;: &quot;1979-04-01&quot;, &quot;hobby&quot;: &quot;hiking&quot; &#125;</div><div class="line">&#123; &quot;index&quot;: &#123; &quot;_id&quot;: 4, &quot;parent&quot;: &quot;paris&quot;, &quot;routing&quot;:&quot;france&quot; &#125;&#125;</div><div class="line">&#123; &quot;name&quot;: &quot;Adrien Grand&quot;, &quot;dob&quot;: &quot;1987-05-11&quot;, &quot;hobby&quot;: &quot;horses&quot; &#125;</div></pre></td></tr></table></figure></p>
<h2 id="has-child查询"><a href="#has-child查询" class="headerlink" title="has_child查询"></a>has_child查询</h2><p>查询父子关系的时候，使用has_child方法。<br>例如，查询，那些国家的佣员喜欢徒步旅行，可以这样：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">GET</div><div class="line">company/country/_search</div><div class="line">&#123;</div><div class="line">  &quot;query&quot;: &#123;</div><div class="line">    &quot;has_child&quot;: &#123;</div><div class="line">      &quot;type&quot;: &quot;branch&quot;,</div><div class="line">      &quot;query&quot;: &#123;</div><div class="line">        &quot;has_child&quot;: &#123;</div><div class="line">          &quot;type&quot;: &quot;employee&quot;,</div><div class="line">          &quot;query&quot;: &#123;</div><div class="line">            &quot;match&quot;: &#123;</div><div class="line">              &quot;hobby&quot;: &quot;hiking&quot;</div><div class="line">            &#125;</div><div class="line">          &#125;</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>返回结果：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  ...</div><div class="line">  &quot;hits&quot;: &#123;</div><div class="line">    &quot;total&quot;: 1,</div><div class="line">    &quot;max_score&quot;: 1,</div><div class="line">    &quot;hits&quot;: [</div><div class="line">      &#123;</div><div class="line">        &quot;_index&quot;: &quot;company&quot;,</div><div class="line">        &quot;_type&quot;: &quot;country&quot;,</div><div class="line">        &quot;_id&quot;: &quot;uk&quot;,</div><div class="line">        &quot;_score&quot;: 1,</div><div class="line">        &quot;_source&quot;: &#123;</div><div class="line">          &quot;name&quot;: &quot;UK&quot;</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    ]</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>同样可以通过设置score_mode=avg, max, sum, none来选择score累积方式，默认为none方式。</p>
<h1 id="has-parent"><a href="#has-parent" class="headerlink" title="has_parent"></a>has_parent</h1><p>了解了has_child后，has_parent自然是与之相反的，查询children的时候，看下是否有这样一个父母，例如，我们想查询所有属于London分支机构的employee<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">GET</div><div class="line">company/employee/_search</div><div class="line">&#123;</div><div class="line">  &quot;query&quot;: &#123;</div><div class="line">    &quot;has_parent&quot;: &#123;</div><div class="line">      &quot;type&quot;: &quot;branch&quot;,</div><div class="line">      &quot;score_mode&quot;: &quot;none&quot;, //默认score_mode为none，如果改为score，则会计算score。</div><div class="line">      &quot;query&quot;: &#123;</div><div class="line">        &quot;match&quot;: &#123;</div><div class="line">          &quot;name&quot;: &quot;london&quot;</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>同样可以通过设置score_mode=score, none来选择score累积方式，默认为none方式。has_child计算score是非常耗时的，所以推荐保持默认none。</p>
<h1 id="min-children-and-max-children"><a href="#min-children-and-max-children" class="headerlink" title="min_children and max_children"></a>min_children and max_children</h1><p>两个方法，都是用于匹配children的数量，比如，匹配 min_children &lt;= children_count &lt;= max_children</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">GET</div><div class="line">company/branch/_search</div><div class="line">&#123;</div><div class="line">  &quot;query&quot;: &#123;</div><div class="line">    &quot;has_child&quot;: &#123;</div><div class="line">      &quot;type&quot;: &quot;employee&quot;,</div><div class="line">      &quot;min_children&quot;: 2,</div><div class="line">      &quot;query&quot;: &#123;</div><div class="line">        &quot;match_all&quot;: &#123;&#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="children-aggregation"><a href="#children-aggregation" class="headerlink" title="children aggregation"></a>children aggregation</h1><p>对标nested objects，我们可以用 nested 方法来对嵌套对象进行聚合，parent/child关系中，我们可以用children关键字，来对children进行聚合，但是，我还没找到如何对孙子节点聚合的方法。<br>此外，nested objects有reverse_nested，parent/child关系中没有，即，在children聚合范围内，没办法回溯到parent级别。<br>假如，我们想知道不同分支机构佣员的兴趣还好情况，可以这样写：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">GET </div><div class="line">company/branch/_search</div><div class="line">&#123;</div><div class="line">  &quot;size&quot;: 0,</div><div class="line">  &quot;aggs&quot;: &#123;</div><div class="line">    &quot;分支机构&quot;: &#123;</div><div class="line">      &quot;terms&quot;: &#123;</div><div class="line">        &quot;field&quot;: &quot;name&quot;</div><div class="line">      &#125;,</div><div class="line">      &quot;aggs&quot;: &#123;</div><div class="line">        &quot;佣员列表&quot;: &#123;</div><div class="line">          &quot;children&quot;: &#123;</div><div class="line">            &quot;type&quot;: &quot;employee&quot;</div><div class="line">          &#125;,</div><div class="line">          &quot;aggs&quot;: &#123;</div><div class="line">            &quot;兴趣爱好&quot;: &#123;</div><div class="line">              &quot;terms&quot;: &#123;</div><div class="line">                &quot;field&quot;: &quot;hobby&quot;</div><div class="line">              &#125;</div><div class="line">            &#125;</div><div class="line">          &#125;</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>返回结果：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  ...</div><div class="line">  &quot;aggregations&quot;: &#123;</div><div class="line">    &quot;分支机构&quot;: &#123;</div><div class="line">      &quot;doc_count_error_upper_bound&quot;: 0,</div><div class="line">      &quot;sum_other_doc_count&quot;: 0,</div><div class="line">      &quot;buckets&quot;: [</div><div class="line">        ...</div><div class="line">        &#123;</div><div class="line">          &quot;key&quot;: &quot;liverpool&quot;,</div><div class="line">          &quot;doc_count&quot;: 1,</div><div class="line">          &quot;佣员列表&quot;: &#123;</div><div class="line">            &quot;doc_count&quot;: 1,</div><div class="line">            &quot;兴趣爱好&quot;: &#123;</div><div class="line">              &quot;doc_count_error_upper_bound&quot;: 0,</div><div class="line">              &quot;sum_other_doc_count&quot;: 0,</div><div class="line">              &quot;buckets&quot;: [</div><div class="line">                &#123;</div><div class="line">                  &quot;key&quot;: &quot;hiking&quot;,</div><div class="line">                  &quot;doc_count&quot;: 1</div><div class="line">                &#125;</div><div class="line">              ]</div><div class="line">            &#125;</div><div class="line">          &#125;</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">          &quot;key&quot;: &quot;london&quot;, //解读一下便是，在London工作的员工，有两类兴趣爱好，一是diving二是hiking，各自占一人。</div><div class="line">          &quot;doc_count&quot;: 1,</div><div class="line">          &quot;佣员列表&quot;: &#123;</div><div class="line">            &quot;doc_count&quot;: 2,</div><div class="line">            &quot;兴趣爱好&quot;: &#123;</div><div class="line">              &quot;doc_count_error_upper_bound&quot;: 0,</div><div class="line">              &quot;sum_other_doc_count&quot;: 0,</div><div class="line">              &quot;buckets&quot;: [</div><div class="line">                &#123;</div><div class="line">                  &quot;key&quot;: &quot;diving&quot;,</div><div class="line">                  &quot;doc_count&quot;: 1</div><div class="line">                &#125;,</div><div class="line">                &#123;</div><div class="line">                  &quot;key&quot;: &quot;hiking&quot;,</div><div class="line">                  &quot;doc_count&quot;: 1</div><div class="line">                &#125;</div><div class="line">              ]</div><div class="line">            &#125;</div><div class="line">          &#125;</div><div class="line">        &#125;,</div><div class="line">        ...</div></pre></td></tr></table></figure></p>
<p>Parent/child方式还有个优点就是，可以单独返回children部分，而nested objects是返回整个document。当然，Parent/child的查询有的方面也要弱一些，比如reverse_nested方法并没有支持，而且性能上，有差别：相对search-time的性能，如果你很在意index-time(插入更新建)性能，那选择Parent/child方式就比nested objects方式更好。但如果在意search-time，最好还是选择nested objects方式，其性能是Parent/child方式的5-10倍。</p>
<p>Parent/child适合有少量parent，有大量children的场景。<br>而nested objects适合，children比较少的场景。</p>
<p> Parent/child是通过global ordinals方式建立连接的。</p>
<p>缺点：<br>层次越多，耗在join上的时间就越多，每一代的parents都需要将自己的_id存储到内存，会消耗大量内存，</p>
<h1 id="global-ordinals"><a href="#global-ordinals" class="headerlink" title="global ordinals"></a>global ordinals</h1><p>默认都是lazy模式，就是有查询或者聚合的时候，才创建 global ordinals，但是，你可以通过索引字段设置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&quot;fielddata&quot;: &#123;</div><div class="line">          &quot;loading&quot;: &quot;eager_global_ordinals&quot; </div><div class="line">        &#125;</div></pre></td></tr></table></figure>
<p>来改变这一行为，让某字段的global ordinals在更新数据的时候就会创建(如果一直更新，每refresh_interval超时周期便会更新一次，比较消耗性能)</p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/ElasticSearch/" rel="tag"># ElasticSearch</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/11/14/qemu-balloon-damage-file-cache/" rel="next" title="内存气泡导致文件损坏错误分析">
                <i class="fa fa-chevron-left"></i> 内存气泡导致文件损坏错误分析
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/01/31/who-kill-me-audit/" rel="prev" title="谁KILL了进程定位工具之auditd">
                谁KILL了进程定位工具之auditd <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          
            <p class="site-author-name" itemprop="name">mnstory.net</p>
            <p class="site-description motion-element" itemprop="description"></p>
        </div>

        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
            
              <a href="/archives/">
            
                <span class="site-state-item-count">52</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">62</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#汇聚不同色系的汽车，看一下销量情况"><span class="nav-number">1.</span> <span class="nav-text">汇聚不同色系的汽车，看一下销量情况</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#汇聚不同色系的汽车，查看该色系的均价"><span class="nav-number">2.</span> <span class="nav-text">汇聚不同色系的汽车，查看该色系的均价</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#汇聚嵌套"><span class="nav-number">3.</span> <span class="nav-text">汇聚嵌套</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#汇聚不同色系的汽车，查看该色系的均价，并查看该色系下制造商的分布情况"><span class="nav-number">3.1.</span> <span class="nav-text">汇聚不同色系的汽车，查看该色系的均价，并查看该色系下制造商的分布情况</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#相同数据源多次汇聚"><span class="nav-number">4.</span> <span class="nav-text">相同数据源多次汇聚</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#汇聚不同颜色的汽车，并看一下不同颜色汽车的均价；同时针对所有汽车，查看其制造商的分布情况"><span class="nav-number">4.1.</span> <span class="nav-text">汇聚不同颜色的汽车，并看一下不同颜色汽车的均价；同时针对所有汽车，查看其制造商的分布情况</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#直方图统计"><span class="nav-number">5.</span> <span class="nav-text">直方图统计</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#以2万为一个段，统计不同价格区间，汽车的销量"><span class="nav-number">5.1.</span> <span class="nav-text">以2万为一个段，统计不同价格区间，汽车的销量</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#以2万为一个段，统计不同价格区间，汽车的销量，并且将价格详细分布展示出来"><span class="nav-number">5.2.</span> <span class="nav-text">以2万为一个段，统计不同价格区间，汽车的销量，并且将价格详细分布展示出来</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#和kibana结合"><span class="nav-number">5.3.</span> <span class="nav-text">和kibana结合</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#date-histogram"><span class="nav-number">6.</span> <span class="nav-text">date histogram</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#query-filter"><span class="nav-number">7.</span> <span class="nav-text">query filter</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#只查看ford汽车的色系销售情况"><span class="nav-number">7.1.</span> <span class="nav-text">只查看ford汽车的色系销售情况</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#全局桶"><span class="nav-number">8.</span> <span class="nav-text">全局桶</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#ford汽车的均价和所有制造商汽车的均价"><span class="nav-number">8.1.</span> <span class="nav-text">ford汽车的均价和所有制造商汽车的均价</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#match-和-non-scoring-query-filter"><span class="nav-number">8.2.</span> <span class="nav-text">match 和 non-scoring query(filter)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#桶前过滤"><span class="nav-number">8.3.</span> <span class="nav-text">桶前过滤</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#post-filter"><span class="nav-number">9.</span> <span class="nav-text">post filter</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#汇聚的排序"><span class="nav-number">10.</span> <span class="nav-text">汇聚的排序</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#按汇聚结果排序"><span class="nav-number">10.1.</span> <span class="nav-text">按汇聚结果排序</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#cardinality"><span class="nav-number">11.</span> <span class="nav-text">cardinality</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#percentile"><span class="nav-number">12.</span> <span class="nav-text">percentile</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#percentile-ranks"><span class="nav-number">12.1.</span> <span class="nav-text">percentile_ranks</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#数据关系"><span class="nav-number">13.</span> <span class="nav-text">数据关系</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#多级对象"><span class="nav-number">13.1.</span> <span class="nav-text">多级对象</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#对象数组"><span class="nav-number">13.2.</span> <span class="nav-text">对象数组</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Nested-Objects"><span class="nav-number">14.</span> <span class="nav-text">Nested Objects</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#nested-objects-排序"><span class="nav-number">14.1.</span> <span class="nav-text">nested objects 排序</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#nested-objects-聚合"><span class="nav-number">14.2.</span> <span class="nav-text">nested objects 聚合</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#reverse-nested"><span class="nav-number">14.3.</span> <span class="nav-text">reverse_nested</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Parent-child-relationships"><span class="nav-number">15.</span> <span class="nav-text">Parent/child relationships</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#has-child查询"><span class="nav-number">15.1.</span> <span class="nav-text">has_child查询</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#has-parent"><span class="nav-number">16.</span> <span class="nav-text">has_parent</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#min-children-and-max-children"><span class="nav-number">17.</span> <span class="nav-text">min_children and max_children</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#children-aggregation"><span class="nav-number">18.</span> <span class="nav-text">children aggregation</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#global-ordinals"><span class="nav-number">19.</span> <span class="nav-text">global ordinals</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">mnstory.net</span>

  
</div>



        
<div class="busuanzi-count">
  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv">
      <i class="fa fa-user"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      
    </span>
  

  
    <span class="site-pv">
      <i class="fa fa-eye"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      
    </span>
  
</div>








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.2"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.2"></script>



  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.2"></script>


  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.2"></script>



  


  




	





  





  








  




  





  

  

  

  

  

  


  <!-- 背景动画 -->
  <script type="text/javascript" src="/js/src/particle.js"></script>

</body>
</html>
